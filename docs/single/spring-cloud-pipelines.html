<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Cloud Pipelines</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>Spring Cloud Pipelines</h1></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#d0e9"></a></span></dt><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_setup">1.1. Project setup</a></span></dt><dt><span class="section"><a href="#_how_to_use_it">1.2. How to use it?</a></span></dt><dd><dl><dt><span class="section"><a href="#_centralized_pipeline_creation">1.2.1. Centralized pipeline creation</a></span></dt><dt><span class="section"><a href="#_pipeline_per_repository">1.2.2. Pipeline per repository</a></span></dt></dl></dd><dt><span class="section"><a href="#_the_flow">1.3. The flow</a></span></dt><dt><span class="section"><a href="#_environments">1.4. Environments</a></span></dt><dt><span class="section"><a href="#_tests">1.5. Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#_testing_against_stubs">1.5.1. Testing against stubs</a></span></dt><dt><span class="section"><a href="#_general_view">1.5.2. General view</a></span></dt></dl></dd><dt><span class="section"><a href="#_ci_server_worker_prerequisites">1.6. CI Server worker prerequisites</a></span></dt><dt><span class="section"><a href="#_pipeline_descriptor">1.7. Pipeline descriptor</a></span></dt><dd><dl><dt><span class="section"><a href="#_pipeline_descriptor_for_cloud_foundry">1.7.1. Pipeline descriptor for Cloud Foundry</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_opinionated_implementation">2. Opinionated implementation</a></span></dt><dd><dl><dt><span class="section"><a href="#_build">2.1. Build</a></span></dt><dt><span class="section"><a href="#_test">2.2. Test</a></span></dt><dt><span class="section"><a href="#_stage">2.3. Stage</a></span></dt><dt><span class="section"><a href="#_prod">2.4. Prod</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_project_opinions">3. Project opinions</a></span></dt><dd><dl><dt><span class="section"><a href="#_cloud_foundry_project_opinions">3.1. Cloud Foundry project opinions</a></span></dt><dt><span class="section"><a href="#_kubernetes_project_opinions">3.2. Kubernetes project opinions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#concourse-pipeline-cf">4. Concourse Pipeline (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-pipeline-step-by-step-cf">4.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-fork-cf">4.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#concourse-start-cf">4.1.2. Start Concourse and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-deploy-cf">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#concourse-pcfdev-cf">4.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#concourse-fly-cf">4.1.4. Setup the <code class="literal">fly</code> CLI</a></span></dt><dt><span class="section"><a href="#concourse-credentials-cf">4.1.5. Setup your <code class="literal">credentials.yml</code></a></span></dt><dt><span class="section"><a href="#concourse-build-cf">4.1.6. Build the pipeline</a></span></dt><dt><span class="section"><a href="#concourse-run-cf">4.1.7. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#concourse-pipeline-k8s">5. Concourse Pipeline (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-k8s">5.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-k8s">5.1.1. Fork repos</a></span></dt></dl></dd><dt><span class="section"><a href="#concourse-start-k8s">5.2. Concourse in K8S (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_artifactory_to_k8s">5.2.1. Deploying Artifactory to K8S</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-fly-k8s">5.2.2. Setup the <code class="literal">fly</code> CLI</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-credentials-k8s">5.2.3. Setup your <code class="literal">credentials.yml</code></a></span></dt><dt><span class="section"><a href="#concourse-pipeline-build-k8s">5.2.4. Build the pipeline</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-run-k8s">5.2.5. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#concourse-faq">6. Concourse FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="#_can_i_use_the_pipeline_for_some_other_repos">6.1. Can I use the pipeline for some other repos?</a></span></dt><dt><span class="section"><a href="#_will_this_work_for_any_project_out_of_the_box">6.2. Will this work for ANY project out of the box?</a></span></dt><dt><span class="section"><a href="#_can_i_modify_this_to_reuse_in_my_project">6.3. Can I modify this to reuse in my project?</a></span></dt><dt><span class="section"><a href="#_i_ran_out_of_resources_pcf_dev">6.4. I ran out of resources!! (PCF Dev)</a></span></dt><dt><span class="section"><a href="#_the_rollback_step_fails_due_to_missing_jar">6.5. The rollback step fails due to missing JAR ?!</a></span></dt><dt><span class="section"><a href="#_can_i_see_the_output_of_a_job_from_the_terminal">6.6. Can I see the output of a job from the terminal?</a></span></dt><dt><span class="section"><a href="#_i_clicked_the_job_and_it_s_constantly_pending">6.7. I clicked the job and it&#8217;s constantly pending&#8230;&#8203;</a></span></dt><dt><span class="section"><a href="#_the_route_is_already_in_use_cf">6.8. The route is already in use (CF)</a></span></dt><dt><span class="section"><a href="#_i_m_unauthorized_to_deploy_infrastructure_jars">6.9. I&#8217;m unauthorized to deploy infrastructure jars</a></span></dt><dt><span class="section"><a href="#__literal_version_literal_resource_is_broken">6.10. <code class="literal">version</code> resource is broken</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_jenkins_pipeline_common">7. Jenkins Pipeline (Common)</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_setup_2">7.1. Project setup</a></span></dt><dt><span class="section"><a href="#_optional_customization_steps">7.2. Optional customization steps</a></span></dt><dd><dl><dt><span class="section"><a href="#deploying-infra">7.2.1. Deploying infra jars to a different location</a></span></dt><dt><span class="section"><a href="#setup-settings-xml">7.2.2. Setup settings.xml for Maven deployment</a></span></dt><dt><span class="section"><a href="#setup-jenkins-env-vars">7.2.3. Setup Jenkins env vars</a></span></dt><dd><dl><dt><span class="section"><a href="#setup-seed-props">Seed properties</a></span></dt><dt><span class="section"><a href="#global-envs">Global envs</a></span></dt></dl></dd><dt><span class="section"><a href="#git-email">7.2.4. Set Git email / user</a></span></dt><dd><dl><dt><span class="section"><a href="#jenkins-credentials-github">Add Jenkins credentials for GitHub</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#_testing_jenkins_scripts">7.3. Testing Jenkins scripts</a></span></dt><dt><span class="section"><a href="#_how_to_work_with_jenkins_job_dsl_plugin">7.4. How to work with Jenkins Job DSL plugin</a></span></dt><dt><span class="section"><a href="#_docker_image">7.5. Docker Image</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-cf">8. Jenkins Pipeline (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-cf">8.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-cf">8.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#start-jenkins-cf">8.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-cf">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#start-pcf-dev-cf">8.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#jenkins-seed-cf">8.1.4. Run the seed job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-cf">8.1.5. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-cf">8.2. Declarative pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-cf">8.3. Jenkins Cloud Foundry customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-cf">8.3.1. All env vars</a></span></dt><dt><span class="section"><a href="#jenkins-credentials-cf">8.3.2. Jenkins Credentials</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-k8s">9. Jenkins Pipeline (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-k8s">9.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-k8s">9.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#start-jenkins-k8s">9.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-k8s">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#jenkins-seed-k8s">9.1.3. Run the seed job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-k8s">9.1.4. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-k8s">9.2. Declarative pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-k8s">9.3. Jenkins Kubernetes customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-k8s">9.3.1. All env vars</a></span></dt></dl></dd><dt><span class="section"><a href="#_preparing_to_connect_to_gce">9.4. Preparing to connect to GCE</a></span></dt><dt><span class="section"><a href="#_connecting_to_a_kubo_or_gce_cluster">9.5. Connecting to a Kubo or GCE cluster</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_jenkins_faq">10. Jenkins FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="#jenkins_faq">10.1. Pipeline version contains ${PIPELINE_VERSION}</a></span></dt><dt><span class="section"><a href="#_pipeline_version_is_not_passed_to_the_build">10.2. Pipeline version is not passed to the build</a></span></dt><dt><span class="section"><a href="#_the_build_times_out_with_literal_pipeline_sh_literal_info">10.3. The build times out with <code class="literal">pipeline.sh</code> info</a></span></dt><dt><span class="section"><a href="#_can_i_use_the_pipeline_for_some_other_repos_2">10.4. Can I use the pipeline for some other repos?</a></span></dt><dt><span class="section"><a href="#_will_this_work_for_any_project_out_of_the_box_2">10.5. Will this work for ANY project out of the box?</a></span></dt><dt><span class="section"><a href="#_can_i_modify_this_to_reuse_in_my_project_2">10.6. Can I modify this to reuse in my project?</a></span></dt><dt><span class="section"><a href="#_the_rollback_step_fails_due_to_missing_jar_2">10.7. The rollback step fails due to missing JAR ?!</a></span></dt><dt><span class="section"><a href="#_i_want_to_provide_a_different_jdk_version">10.8. I want to provide a different JDK version</a></span></dt><dt><span class="section"><a href="#groovy-token-macro">10.9. Enable Groovy Token Macro Processing</a></span></dt><dt><span class="section"><a href="#_i_want_deployment_to_stage_and_prod_be_automatic">10.10. I want deployment to stage and prod be automatic</a></span></dt><dt><span class="section"><a href="#_i_don_t_want_to_test_api_compativility">10.11. I don&#8217;t want to test API compativility</a></span></dt><dt><span class="section"><a href="#_i_can_t_tag_the_repo">10.12. I can&#8217;t tag the repo!</a></span></dt><dt><span class="section"><a href="#_i_m_unauthorized_to_deploy_infrastructure_jars_2">10.13. I&#8217;m unauthorized to deploy infrastructure jars</a></span></dt><dt><span class="section"><a href="#_signing_artifacts">10.14. Signing Artifacts</a></span></dt><dt><span class="section"><a href="#_using_ssh_keys_for_git">10.15. Using SSH keys for git</a></span></dt><dt><span class="section"><a href="#_deploy_to_stage_fails_and_doesn_t_redeploy_a_service_kubernetes">10.16. Deploy to stage fails and doesn&#8217;t redeploy a service (Kubernetes)</a></span></dt><dt><span class="section"><a href="#_i_ran_out_of_resources_cloud_foundry">10.17. I ran out of resources!! (Cloud Foundry)</a></span></dt><dt><span class="section"><a href="#_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry">10.18. Deploying to test / stage / prod fails - error finding space (Cloud Foundry)</a></span></dt><dt><span class="section"><a href="#_the_route_is_already_in_use_cloud_foundry">10.19. The route is already in use (Cloud Foundry)</a></span></dt><dt><span class="section"><a href="#_how_to_execute_helper_scripts_against_a_real_cf_instance_i_m_logged_into_cloud_foundry">10.20. How to execute helper scripts against a real CF instance I&#8217;m logged into (Cloud Foundry)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_kubernetes_setup">11. Kubernetes setup</a></span></dt><dd><dl><dt><span class="section"><a href="#_kubernetes_cli_installation">11.1. Kubernetes CLI Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-cli-script">11.1.1. Script Installation</a></span></dt><dt><span class="section"><a href="#kubernetes-cli-manual">11.1.2. Manual Installation</a></span></dt></dl></dd><dt><span class="section"><a href="#start-minikube-k8s">11.2. Kubernetes Cluster setup</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-minikube-script">11.2.1. Script Installation</a></span></dt><dt><span class="section"><a href="#kubernetes-minikube-manual">11.2.2. Manual Installation</a></span></dt></dl></dd><dt><span class="section"><a href="#_run_minikube">11.3. Run Minikube</a></span></dt><dt><span class="section"><a href="#_certificates_and_workers">11.4. Certificates and Workers</a></span></dt><dd><dl><dt><span class="section"><a href="#_minikube_certificates_and_workers">11.4.1. Minikube Certificates and Workers</a></span></dt><dt><span class="section"><a href="#_manual_certificates_and_workers_setup">11.4.2. Manual Certificates and Workers Setup</a></span></dt></dl></dd><dt><span class="section"><a href="#_generate_minikube_namespaces">11.5. Generate Minikube namespaces</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_cloud_foundry">12. The demo setup (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_pcf_dev">12.1. Deploying production applications to PCF Dev</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_cf">12.2. Running Prometheus on CF</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_cf">12.3. Running Grafana on CF</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_kubernetes">13. The demo setup (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_minikube">13.1. Deploying production applications to Minikube</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_kubernetes">13.2. Running Prometheus on Kubernetes</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_kubernetes">13.3. Running Grafana on Kubernetes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_step_by_step_cloud_foundry_migration">14. Step-by-step Cloud Foundry migration</a></span></dt><dd><dl><dt><span class="section"><a href="#_preview">14.1. Preview</a></span></dt><dt><span class="section"><a href="#_introduction_2">14.2. Introduction</a></span></dt><dt><span class="section"><a href="#_sample_application_initial_state">14.3. Sample application - initial state</a></span></dt><dt><span class="section"><a href="#_sample_application_end_state">14.4. Sample application - end state</a></span></dt><dt><span class="section"><a href="#_tutorial_toolset">14.5. Tutorial - toolset</a></span></dt><dt><span class="section"><a href="#_tutorial_overview">14.6. Tutorial - overview</a></span></dt><dt><span class="section"><a href="#_tutorial_step_by_step">14.7. Tutorial - step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#_prep_before_you_begin">14.7.1. Prep: Before you begin</a></span></dt><dt><span class="section"><a href="#_stage_1_scaffolding">14.7.2. Stage 1: Scaffolding</a></span></dt><dd><dl><dt><span class="section"><a href="#_1_1_create_github_branches">1.1 Create GitHub branches</a></span></dt><dt><span class="section"><a href="#_1_2_add_maven_wrapper">1.2 Add Maven wrapper</a></span></dt><dt><span class="section"><a href="#_1_3_create_bintray_maven_repo_package">1.3 Create Bintray maven repo package</a></span></dt><dt><span class="section"><a href="#_1_4_configure_distribution_management_using_bintray_maven_repo">1.4 Configure distribution management using Bintray maven repo</a></span></dt><dt><span class="section"><a href="#_1_5_push_changes_to_github">1.5 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_1_6_add_spring_cloud_pipelines_credentials_file">1.6 Add Spring Cloud Pipelines credentials file</a></span></dt><dt><span class="section"><a href="#_1_7_set_concourse_pipeline">1.7 Set Concourse pipeline</a></span></dt><dt><span class="section"><a href="#_1_8_add_cloud_foundry_manifest">1.8 Add Cloud Foundry manifest</a></span></dt><dt><span class="section"><a href="#_1_9_add_spring_cloud_pipelines_manifest">1.9 Add Spring Cloud Pipelines manifest</a></span></dt><dt><span class="section"><a href="#_1_10_push_changes_to_github">1.10 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_1_11_create_cloud_foundry_orgs_spaces">1.11 Create Cloud Foundry Orgs/Spaces</a></span></dt><dt><span class="section"><a href="#_1_12_create_cloud_foundry_stage_and_prod_service_instances">1.12 Create Cloud Foundry stage and prod service instances</a></span></dt><dt><span class="section"><a href="#_1_13_update_spring_cloud_pipelines_credentials_file">1.13 Update Spring Cloud Pipelines credentials file</a></span></dt><dt><span class="section"><a href="#_1_14_update_concourse_pipeline_with_updated_credentials_files">1.14 Update Concourse pipeline with updated credentials files</a></span></dt><dt><span class="section"><a href="#_stage_1_recap_next_steps">Stage 1 Recap &amp; next steps</a></span></dt></dl></dd><dt><span class="section"><a href="#_stage_2_tests">14.7.3. Stage 2: Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#_2_1_add_maven_profiles">2.1 Add Maven profiles</a></span></dt><dt><span class="section"><a href="#_2_2_add_organize_tests">2.2 Add/organize tests</a></span></dt><dt><span class="section"><a href="#_2_3_enable_database_versioning">2.3 Enable database versioning</a></span></dt><dt><span class="section"><a href="#_2_4_push_changes_to_github">2.4 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_2_5_re_run_the_pipelines">2.5 Re-run the pipelines</a></span></dt><dt><span class="section"><a href="#_stage_2_recap_next_steps">Stage 2 Recap &amp; next steps</a></span></dt></dl></dd><dt><span class="section"><a href="#_stage_3_contracts">14.7.4. Stage 3: Contracts</a></span></dt><dd><dl><dt><span class="section"><a href="#_3_1_create_a_contract">3.1 Create a contract</a></span></dt><dt><span class="section"><a href="#_3_2_create_a_base_class_for_contract_tests">3.2 Create a base class for contract tests</a></span></dt><dt><span class="section"><a href="#_3_3_enable_automated_contract_based_testing">3.3 Enable automated contract-based testing</a></span></dt><dt><span class="section"><a href="#_3_4_enable_backward_compatibility_api_check">3.4 Enable backward compatibility API check</a></span></dt><dt><span class="section"><a href="#_3_5_push_changes_to_github">3.5 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_3_6_re_run_the_fortune_service_pipeline">3.6 Re-run the fortune-service pipeline</a></span></dt><dt><span class="section"><a href="#_3_7_enable_stubs_for_integration_tests">3.7 Enable stubs for integration tests</a></span></dt><dt><span class="section"><a href="#_3_8_enable_stubs_for_smoke_tests">3.8 Enable stubs for smoke tests</a></span></dt><dt><span class="section"><a href="#_3_9_push_changes_to_github">3.9 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_stage_3_recap">Stage 3 Recap</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#_conclusion">14.8. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_building_the_project">15. Building the project</a></span></dt><dd><dl><dt><span class="section"><a href="#_prerequisites">15.1. Prerequisites</a></span></dt><dt><span class="section"><a href="#_bats_submodules">15.2. Bats submodules</a></span></dt><dt><span class="section"><a href="#_build_and_test">15.3. Build and test</a></span></dt><dt><span class="section"><a href="#_generate_docs">15.4. Generate docs</a></span></dt><dt><span class="section"><a href="#_making_a_release">15.5. Making a release</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_customizing_the_project">16. Customizing the project</a></span></dt><dt><span class="chapter"><a href="#_releasing_the_project">17. Releasing the project</a></span></dt><dd><dl><dt><span class="section"><a href="#_publishing_a_docker_image">17.1. Publishing A Docker Image</a></span></dt></dl></dd></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="d0e9" href="#d0e9"></a></h1></div></div></div><p><span class="emphasis"><em>Documentation Authors: Marcin Grzejszczak, Cora Iberkleid</em></span></p><p>Spring, Spring Boot and Spring Cloud are tools that allow developers speed up the
time of creating new business features. It&#8217;s common knowledge however that the
 feature is only valuable if it&#8217;s in production. That&#8217;s why companies
 spend a lot of time and resources on building their own deployment pipelines.</p><p>This project tries to solve the following problems:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Creation of a common deployment pipeline</li><li class="listitem">Propagation of good testing &amp; deployment practices</li><li class="listitem">Speed up the time required to deploy a feature to production</li></ul></div><p>A common way of running, configuring and deploying applications lowers support costs
and time needed by new developers to blend in when they change projects.</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_introduction" href="#_introduction"></a>1.&nbsp;Introduction</h1></div></div></div><p>In the following section we will describe in more depth the rationale
behind the presented opinionated pipeline. We will go through each deployment
step and describe it in details.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup" href="#_project_setup"></a>1.1&nbsp;Project setup</h2></div></div></div><pre class="programlisting">.
&#9500;&#9472;&#9472; common
&#9500;&#9472;&#9472; concourse
&#9500;&#9472;&#9472; docs
&#9492;&#9472;&#9472; jenkins</pre><p>In the <code class="literal">common</code> folder you can find all the Bash scripts containing the pipeline logic. These
scripts are reused by both Concourse and Jenkins pipelines.</p><p>In the <code class="literal">concourse</code> folder you can find all the necessary scripts and setup to run Concourse demo.</p><p>In the <code class="literal">docs</code> section you have the whole documentation of the project.</p><p>In the <code class="literal">jenkins</code> folder you can find all the necessary scripts and setup to run Jenkins demo.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_use_it" href="#_how_to_use_it"></a>1.2&nbsp;How to use it?</h2></div></div></div><p>This repository can be treated as a template for your pipeline. We provide some opinionated
implementation that you can alter to suit your needs. The best approach to use it
to build your production projects would be to download the Spring Cloud Pipelines repository as ZIP, then
init a Git project there and modify it as you wish.</p><pre class="programlisting">$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># pass the branch (e.g. master) or a particular tag (e.g. v1.0.0.RELEASE)</span>
$ SC_PIPELINES_RELEASE=...
$ curl -LOk https://github.com/spring-cloud/spring-cloud-pipelines/archive/${SC_PIPELINES_RELEASE}.zip
$ unzip ${SC_PIPELINES_RELEASE}.zip
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines-${SC_PIPELINES_RELEASE}
$ git init
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># modify the pipelines to suit your needs</span>
$ git add .
$ git commit -m <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Initial commit"</span>
$ git remote add origin ${YOUR_REPOSITORY_URL}
$ git push origin master</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Why aren&#8217;t you simply cloning the repo? This is meant to be a seed
for building new, versioned pipelines for you. You don&#8217;t want to have all of our
history dragged along with you, don&#8217;t you?</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_centralized_pipeline_creation" href="#_centralized_pipeline_creation"></a>1.2.1&nbsp;Centralized pipeline creation</h3></div></div></div><p>You can use Spring Cloud Pipelines to generate pipelines
for all projects in your system. You can scan all your
repositories (e.g. call the Stash / Github API and retrieve the list of repos)
and then&#8230;&#8203;</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">For Jenkins, call the seed job and pass the <code class="literal">REPOS</code>
parameter that would contain the list of repositories</li><li class="listitem">For Concourse, you&#8217;d have to call <code class="literal">fly</code> and set
pipeline for every single repo</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pipeline_per_repository" href="#_pipeline_per_repository"></a>1.2.2&nbsp;Pipeline per repository</h3></div></div></div><p>You can use Spring Cloud Pipelines in such a way that
each project contains its own pipeline definition in
its code. Spring Cloud Pipelines clones the code with
the pipeline definitions (the bash scripts) so the
only piece of logic that could be there in your application&#8217;s
repository would be how the pipeline should look like.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">For Jenkins, you&#8217;d have to either set up the <code class="literal">Jenkinsfile</code>
or the jobs using Jenkins Job DSL plugin in your repo.
Then in Jenkins whenever you set up a new pipeline for a repo
then you reference the pipeline definition in that repo.</li><li class="listitem">For Concourse, each project contains its own pipeline steps
and it&#8217;s up to the project to set up the pipeline.</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_flow" href="#_the_flow"></a>1.3&nbsp;The flow</h2></div></div></div><p>Let&#8217;s take a look at the flow of the opinionated pipeline</p><div class="figure"><a name="d0e108" href="#d0e108"></a><p class="title"><b>Figure&nbsp;1.1.&nbsp;Flow in Concourse</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow_concourse.png" alt="flow concourse"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e117" href="#d0e117"></a><p class="title"><b>Figure&nbsp;1.2.&nbsp;Flow in Jenkins</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow.png" alt="flow"></div></div></div><br class="figure-break"><p>We&#8217;ll first describe the overall concept behind the flow and then
we&#8217;ll split it into pieces and describe every piece independently.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_environments" href="#_environments"></a>1.4&nbsp;Environments</h2></div></div></div><p>So we&#8217;re on the same page let&#8217;s define some common vocabulary. We discern 4 typical
environments in terms of running the pipeline.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>build</strong></span> environment is a machine where the building of the application takes place.
It&#8217;s a CI / CD tool worker.</li><li class="listitem"><span class="strong"><strong>test</strong></span> is an environment where you can deploy an application to test it. It doesn&#8217;t
resemble production, we can&#8217;t be sure of it&#8217;s state (which application is deployed there
and in which version). It can be used by multiple teams at the same time.</li><li class="listitem"><span class="strong"><strong>stage</strong></span> is an environment that does resemble production. Most likely applications
are deployed there in versions that correspond to those deployed to production.
Typically databases there are filled up with (obfuscated) production data. Most
often this environment is a single, shared one between many teams. In other
words in order to run some performance, user acceptance tests you have to block
and wait until the environment is free.</li><li class="listitem"><span class="strong"><strong>prod</strong></span> is a production environment where we want our tested applications to be deployed
for our customers.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tests" href="#_tests"></a>1.5&nbsp;Tests</h2></div></div></div><p><span class="strong"><strong>Unit tests</strong></span> - tests that are executed on the application during the build phase.
No integrations with databases / HTTP server stubs etc. take place. Generally speaking your application should
 have plenty of these to have fast feedback if your features are working fine.</p><p><span class="strong"><strong>Integration tests</strong></span> - tests that are executed on the built application during the build phase.
Integrations with in memory databases / HTTP server stubs take place. According to the test
pyramid, in most cases you should have not too many of these kind of tests.</p><p><span class="strong"><strong>Smoke tests</strong></span> - tests that are executed on a deployed application. The concept of these tests
is to check the crucial parts of your application are working properly. If you have 100 features
in your application but you gain most money from e.g. 5 features then you could write smoke tests
 for those 5 features. As you can see we&#8217;re talking about smoke tests of an application, not of
 the whole system. In our understanding inside the opinionated pipeline, these tests are
 executed against an application that is surrounded with stubs.</p><p><span class="strong"><strong>End to end tests</strong></span> - tests that are executed on a system composing of multiple applications.
The idea of these tests is to check if the tested feature works when the whole system is set up.
Due to the fact that it takes a lot of time, effort, resources to maintain such an environment
and that often those tests are unreliable (due to many different moving pieces like network
database etc.) you should have a handful of those tests. Only for critical parts of your business.
Since only production is the key verifier of whether your feature works, some companies
don&#8217;t even want to do those and move directly to deployment to production. When your
system contains KPI monitoring and alerting you can quickly react when your deployed application
is not behaving properly.</p><p><span class="strong"><strong>Performance testing</strong></span> - tests executed on an application or set of applications
to check if your system can handle big load of input. In case of our opinionated pipeline
 these tests could be executed either on test (against stubbed environment) or
  stage (against the whole system)</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_testing_against_stubs" href="#_testing_against_stubs"></a>1.5.1&nbsp;Testing against stubs</h3></div></div></div><p>Before we go into details of the flow let&#8217;s take a look at the following example.</p><div class="figure"><a name="d0e182" href="#d0e182"></a><p class="title"><b>Figure&nbsp;1.3.&nbsp;Two monolithic applications deployed for end to end testing</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/monolith.png" alt="monolith"></div></div></div><br class="figure-break"><p>When having only a handful of applications, performing end to end testing is beneficial.
From the operations perspective it&#8217;s maintainable for a finite number of deployed instances.
From the developers perspective it&#8217;s nice to verify the whole flow in the system
for a feature.</p><p>In case of microservices the scale starts to be a problem:</p><div class="figure"><a name="d0e195" href="#d0e195"></a><p class="title"><b>Figure&nbsp;1.4.&nbsp;Many microservices deployed in different versions</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/many_microservices.png" alt="many microservices"></div></div></div><br class="figure-break"><p>The questions arise:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Should I queue deployments of microservices on one testing environment or should I have an environment per microservice?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I queue deployments people will have to wait for hours to have their tests ran - that can be a problem</li></ul></div></li><li class="listitem"><p class="simpara">To remove that issue I can have an environment per microservice</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Who will pay the bills (imagine 100 microservices - each having each own environment).</li><li class="listitem">Who will support each of those environments?</li><li class="listitem">Should we spawn a new environment each time we execute a new pipeline and then wrap it up or should we have
them up and running for the whole day?</li></ul></div></li><li class="listitem"><p class="simpara">In which versions should I deploy the dependent microservices - development or production versions?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I have development versions then I can test my application against a feature that is not yet on production.
That can lead to exceptions on production</li><li class="listitem">If I test against production versions then I&#8217;ll never be able to test against a feature under development
anytime before deployment to production.</li></ul></div></li></ul></div><p>One of the possibilities of tackling these problems is to&#8230;&#8203; not do end to end tests.</p><div class="figure"><a name="d0e239" href="#d0e239"></a><p class="title"><b>Figure&nbsp;1.5.&nbsp;Execute tests on a deployed microservice on stubbed dependencies</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>If we stub out all the dependencies of our application then most of the problems presented above
disappear. There is no need to start and setup infrastructure required by the dependant
microservices. That way the testing setup looks like this:</p><div class="figure"><a name="d0e250" href="#d0e250"></a><p class="title"><b>Figure&nbsp;1.6.&nbsp;We&#8217;re testing microservices in isolation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>Such an approach to testing and deployment gives the following benefits
(thanks to the usage of <a class="link" href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No need to deploy dependant services</li><li class="listitem">The stubs used for the tests ran on a deployed microservice are the same as those used during integration tests</li><li class="listitem">Those stubs have been tested against the application that produces them (check <a class="link" href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a> for more information)</li><li class="listitem">We don&#8217;t have many slow tests running on a deployed application - thus the pipeline gets executed much faster</li><li class="listitem">We don&#8217;t have to queue deployments - we&#8217;re testing in isolation thus pipelines don&#8217;t interfere with each other</li><li class="listitem">We don&#8217;t have to spawn virtual machines each time for deployment purposes</li></ul></div><p>It brings however the following challenges:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No end to end tests before production - you don&#8217;t have the full certainty that a feature is working</li><li class="listitem">First time the applications will talk in a real way will be on production</li></ul></div><p>Like every solution it has its benefits and drawbacks. The opinionated pipeline
 allows you to configure whether you want to follow this flow or not.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_general_view" href="#_general_view"></a>1.5.2&nbsp;General view</h3></div></div></div><p>The general view behind this deployment pipeline is to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">test the application in isolation</li><li class="listitem">test the backwards compatibility of the application in order to roll it back if necessary</li><li class="listitem">allow testing of the packaged app in a deployed environment</li><li class="listitem">allow user acceptance tests / performance tests in a deployed environment</li><li class="listitem">allow deployment to production</li></ul></div><p>Obviously the pipeline could have been split to more steps but it seems that all of the aforementioned
 actions comprise nicely in our opinionated proposal.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_ci_server_worker_prerequisites" href="#_ci_server_worker_prerequisites"></a>1.6&nbsp;CI Server worker prerequisites</h2></div></div></div><p>Spring Cloud Pipelines uses Bash scripts extensively. Below you can find the list of software
that needs to be installed on a CI server worker for the build to pass.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demo setup all of these libraries are already installed.</p></td></tr></table></div><pre class="programlisting"> apt-get -y install \
    bash \
    git \
    tar \
    zip \
    curl \
    ruby \
    wget \
    unzip \
    python \
    jq</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the Jenkins case you will also need <code class="literal">bats</code> and <code class="literal">shellcheck</code>. They are not
presented in the list since the installed versions by Linux distributions might be old.
That&#8217;s why this project&#8217;s Gradle tasks will download latest versions of both libraries
for you.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_descriptor" href="#_pipeline_descriptor"></a>1.7&nbsp;Pipeline descriptor</h2></div></div></div><p>Each application can contain a file called <code class="literal">sc-pipelines.yml</code> with the following structure:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName1</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service1Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service1Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service2Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service2Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName2</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service3Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service3Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service4Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service4Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value</pre><p>For a given environment we declare a list of infrastructure services that we
want to have deployed. Services have</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">type</code> (example: <code class="literal">eureka</code>, <code class="literal">mysql</code>, <code class="literal">rabbitmq</code>, <code class="literal">stubrunner</code>) - this value gets
then applied to the <code class="literal">deployService</code> Bash function</li><li class="listitem"><span class="strong"><strong>[KUBERNETES]</strong></span> for <code class="literal">mysql</code> you can pass the database name via the <code class="literal">database</code>
property</li><li class="listitem"><code class="literal">name</code> - name of the service to get deployed</li><li class="listitem"><code class="literal">coordinates</code> - coordinate that allows you to fetch the binary of the service.
Examples: It can be a maven coordinate <code class="literal">groupid:artifactid:version</code>,
 docker image <code class="literal">organization/nameOfImage</code>, etc.</li><li class="listitem">arbitrary key value pairs - you can customize the services as you wish</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pipeline_descriptor_for_cloud_foundry" href="#_pipeline_descriptor_for_cloud_foundry"></a>1.7.1&nbsp;Pipeline descriptor for Cloud Foundry</h3></div></div></div><p>When deploying to Cloud Foundry you can provide services
of the following types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><code class="literal">type: broker</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">broker</code> - name of the CF broker</li><li class="listitem"><code class="literal">plan</code> - name of the plan</li><li class="listitem"><code class="literal">params</code> - additional parameters that will be converted to JSON</li><li class="listitem"><code class="literal">useExisting</code> - should use existing one or
create a new one (defaults to <code class="literal">false</code>)</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: app</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">coordinates</code> - maven coordinates of the stub runner jar</li><li class="listitem"><code class="literal">manifestPath</code> - path to the manifest for the stub runner jar</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cups</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">params</code> - additional parameters that will be converted to JSON</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cupsSyslog</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">url</code> - URL to the syslog drain</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cupsRoute</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">url</code> - URL to the route service</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: stubrunner</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">coordinates</code> - maven coordinates of the stub runner jar</li><li class="listitem"><code class="literal">manifestPath</code> - path to the manifest for the stub runner jar</li></ul></div></li></ul></div><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># This file describes which services are required by this application</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># in order for the smoke tests on the TEST environment and end to end tests</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># on the STAGE environment to pass</span>

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># lowercase name of the environment</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">test</span>:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># list of required services</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      params</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        git</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          uri</span>: https://github.com/ciberkleid/app-config
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: cloud-bus
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: cloudamqp
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: lemur
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: io.pivotal:cloudfoundry-stub-runner-boot:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      manifestPath</span>: sc-pipelines/manifest-stubrunner.yml

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">stage</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      params</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        git</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          uri</span>: https://github.com/ciberkleid/app-config
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: cloud-bus
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: cloudamqp
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: lemur
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_opinionated_implementation" href="#_opinionated_implementation"></a>2.&nbsp;Opinionated implementation</h1></div></div></div><p>For the demo purposes we&#8217;re providing Docker Compose setup with Artifactory and Concourse / Jenkins tools.
Regardless of the picked CD application for the pipeline to pass one needs either</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">a Cloud Foundry instance (for example <a class="link" href="https://run.pivotal.io/" target="_top">Pivotal Web Services</a> or <a class="link" href="https://pivotal.io/pcf-dev" target="_top">PCF Dev</a>)</li><li class="listitem">a Kubernetes cluster (for example <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>)</li><li class="listitem">the infrastructure applications deployed to the JAR hosting application (for the demo we&#8217;re providing Artifactory).</li><li class="listitem"><code class="literal">Eureka</code> for Service Discovery</li><li class="listitem"><code class="literal">Stub Runner Boot</code> for running Spring Cloud Contract stubs.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demos we&#8217;re showing you how to first build the <code class="literal">github-webhook</code> project. That&#8217;s because
the <code class="literal">github-analytics</code> needs the stubs of <code class="literal">github-webhook</code> to pass the tests. Below you&#8217;ll find
references to <code class="literal">github-analytics</code> project since it contains more interesting pieces as far as testing
is concerned.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_build" href="#_build"></a>2.1&nbsp;Build</h2></div></div></div><div class="figure"><a name="d0e550" href="#d0e550"></a><p class="title"><b>Figure&nbsp;2.1.&nbsp;Build and upload artifacts</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/build.png" alt="build"></div></div></div><br class="figure-break"><p>In this step we&#8217;re generating a version of the pipeline, next we&#8217;re
 running unit, integration and contract tests. Finally we&#8217;re:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">publishing a fat jar of the application</li><li class="listitem">publishing a Spring Cloud Contract jar containing stubs of the application</li><li class="listitem">for Kubernetes - uploading a Docker image of the application</li></ul></div><p>During this phase we&#8217;re executing a <code class="literal">Maven</code> build using Maven Wrapper or a <code class="literal">Gradle</code> build using Gradle Wrapper
, with unit and integration tests. We&#8217;re also <span class="strong"><strong>tagging</strong></span> the repository with <code class="literal">dev/${version}</code> format. That way in each
subsequent step of the pipeline we&#8217;re able to retrieve the tagged version. Also we know
exactly which version of the pipeline corresponds to which Git hash.</p><p>Once the artifact got built we&#8217;re running API compatibility check.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">we&#8217;re searching for the latest production deployment</li><li class="listitem">we&#8217;re retrieving the contracts that were used by that deployment</li><li class="listitem">from the contracts we&#8217;re generating API tests to see if the current implementation
is fulfilling the HTTP / messaging contracts that the current production deployment
has defined (we&#8217;re checking backward compatibility of the API)</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_test" href="#_test"></a>2.2&nbsp;Test</h2></div></div></div><div class="figure"><a name="d0e600" href="#d0e600"></a><p class="title"><b>Figure&nbsp;2.2.&nbsp;Smoke test and rollback test on test environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/test.png" alt="test"></div></div></div><br class="figure-break"><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">starting a RabbitMQ service in PaaS</li><li class="listitem">deploying <code class="literal">Eureka</code> infrastructure application to PaaS</li><li class="listitem">downloading the fat jar from Nexus and we&#8217;re uploading it to PaaS. We want the application
to run in isolation (be surrounded by stubs).</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Currently due to port constraints in Cloud Foundry
we cannot run multiple stubbed HTTP services in the cloud so to fix this issue we&#8217;re running
the application with <code class="literal">smoke</code> Spring profile on which you can stub out all HTTP calls to return
a mocked response</p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">if the application is using a database then it gets upgraded at this point via Flyway, Liquibase
or any other tool once the application gets started</li><li class="listitem">from the project&#8217;s Maven or Gradle build we&#8217;re extracting <code class="literal">stubrunner.ids</code> property that contains
all the <code class="literal">groupId:artifactId:version:classifier</code> notation of dependant projects for which
the stubs should be downloaded.</li><li class="listitem">then we&#8217;re uploading <code class="literal">Stub Runner Boot</code> and pass the extracted <code class="literal">stubrunner.ids</code> to it. That way
we&#8217;ll have a running application in Cloud Foundry that will download all the necessary stubs
of our application</li><li class="listitem">from the checked out code we&#8217;re running the tests available under the <code class="literal">smoke</code> profile. In the
case of <code class="literal">GitHub Analytics</code> application we&#8217;re triggering a message from the <code class="literal">GitHub Webhook</code>
application&#8217;s stub, that is sent via RabbitMQ to GitHub Analytics. Then we&#8217;re checking if
message count has increased.</li><li class="listitem">once the tests pass we&#8217;re searching for the last production release. Once the application
is deployed to production we&#8217;re tagging it with <code class="literal">prod/${version}</code> tag. If there is no such tag
(there was no production release) there will be no rollback tests executed. If there was
a production release the tests will get executed.</li><li class="listitem">assuming that there was a production release we&#8217;re checking out the code corresponding to that
release (we&#8217;re checking out the tag), we&#8217;re downloading the appropriate artifact (either JAR for Cloud Foundry
or Docker image for Kubernetes) and we&#8217;re uploading
it to PaaS. <span class="strong"><strong>IMPORTANT</strong></span> the <span class="emphasis"><em>old</em></span> artifact is running against the <span class="strong"><strong>NEW</strong></span> version of the database.</li><li class="listitem">we&#8217;re running the <span class="emphasis"><em>old</em></span> <code class="literal">smoke</code> tests against the freshly deployed application surrounded by stubs.
If those tests pass then we have a high probability that the application is backwards compatible</li><li class="listitem">the default behaviour is that after all of those steps the user can manually click to deploy the
application to a stage environment</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_stage" href="#_stage"></a>2.3&nbsp;Stage</h2></div></div></div><div class="figure"><a name="d0e697" href="#d0e697"></a><p class="title"><b>Figure&nbsp;2.3.&nbsp;End to end tests on stage environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stage.png" alt="stage"></div></div></div><br class="figure-break"><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">starting a RabbitMQ service in PaaS</li><li class="listitem">deploying <code class="literal">Eureka</code> infrastructure application to PaaS</li><li class="listitem">downloading the artifact (either JAR for Cloud Foundry or Docker image for Kubernetes)
from and we&#8217;re uploading it to PaaS.</li></ul></div><p>Next we have a manual step in which:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">from the checked out code we&#8217;re running the tests available under the <code class="literal">e2e</code> profile. In the
case of <code class="literal">GitHub Analytics</code> application we&#8217;re sending a HTTP message to GitHub Analytic&#8217;s endpoint. Then we&#8217;re checking if
the received message count has increased.</li></ul></div><p>The step is manual by default due to the fact that stage environment is often shared between
teams and some preparations on databases / infrastructure have to take place before running the tests.
Ideally these step should be fully automatic.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prod" href="#_prod"></a>2.4&nbsp;Prod</h2></div></div></div><div class="figure"><a name="d0e738" href="#d0e738"></a><p class="title"><b>Figure&nbsp;2.4.&nbsp;Deployment to production</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/prod.png" alt="prod"></div></div></div><br class="figure-break"><p>The step to deploy to production is manual but ideally it should be automatic.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This step does deployment to production. On production you would assume
that you have the infrastructure running. That&#8217;s why before you run this step you
must execute a script that will provision the services on the production environment.
For <code class="literal">Cloud Foundry</code> just call <code class="literal">tools/cf-helper.sh setup-prod-infra</code> and
for Kubernetes <code class="literal">tools/k8s-helper.sh setup-prod-infra</code></p></td></tr></table></div><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">tagging the Git repo with <code class="literal">prod/${version}</code> tag</li><li class="listitem">downloading the application artifact (either JAR for Cloud Foundry or Docker image for Kubernetes)</li><li class="listitem">we&#8217;re doing Blue Green deployment:</li><li class="listitem"><p class="simpara">for Cloud Foundry</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re renaming the current instance of the app e.g. <code class="literal">fooService</code> to <code class="literal">fooService-venerable</code></li><li class="listitem">we&#8217;re deploying the new instance of the app under the <code class="literal">fooService</code> name</li><li class="listitem">now two instances of the same application are running on production</li></ul></div></li><li class="listitem"><p class="simpara">for Kubernetes</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re deploying a service with the name of the app e.g. <code class="literal">fooService</code></li><li class="listitem">we&#8217;re doing a deployment with the name of the app with version suffix (with the name escaped
to fulfill the DNS name requirements) e.g. <code class="literal">fooService-1-0-0-M1-123-456-VERSION</code></li><li class="listitem">all deployments of the same application have the same label <code class="literal">name</code> equal to app name e.g. <code class="literal">fooService</code></li><li class="listitem">the service is routing the traffic basing on the <code class="literal">name</code> label selector</li><li class="listitem">now two instances of the same application are running on production</li></ul></div></li><li class="listitem"><p class="simpara">in the <code class="literal">Complete switch over</code> which is a manual step</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re stopping the old instance</li><li class="listitem">remember to run this step only after you have confirmed that both instances are working fine!</li></ul></div></li><li class="listitem"><p class="simpara">in the <code class="literal">Rollback</code> which is a manual step</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">we&#8217;re routing all the traffic to the old instance</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">in CF we do that by ensuring that blue is running and removing green</li><li class="listitem">in K8S we do that by scaling the number of instances of green to 0</li></ul></div></li><li class="listitem">we&#8217;re removing the latest prod git tag</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_project_opinions" href="#_project_opinions"></a>3.&nbsp;Project opinions</h1></div></div></div><p>In this section we will go through the assumptions we&#8217;ve made in the project
structure and project properties.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cloud_foundry_project_opinions" href="#_cloud_foundry_project_opinions"></a>3.1&nbsp;Cloud Foundry project opinions</h2></div></div></div><p>We&#8217;ve taken the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application built using Maven or Gradle wrappers</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem">you application needs a <code class="literal">manifest.yml</code> Cloud Foundry descriptor</li><li class="listitem"><p class="simpara">For Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">example project</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem"><p class="simpara"><code class="literal">settings.xml</code> is parametrized to pass the credentials to push code to Artifactory</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">M2_SETTINGS_REPO_ID</code> - server id for Artifactory / Nexus deployment</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> - username for Artifactory / Nexus deployment</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> - password for Artifactory / Nexus deployment</li></ul></div></li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem"><code class="literal">repo.with.binaries</code> property - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property - (Injected by the pipeline) ID of the distribution management. Corresponds to server id in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> property - (Injected by the pipeline) Will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apicompatibility</code> Maven profile</li><li class="listitem"><code class="literal">latest.production.version</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle  (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code> env var - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> env var - Username used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> env var - Password used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apiCompatibility</code> task</li><li class="listitem"><code class="literal">latestProductionVersion</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_kubernetes_project_opinions" href="#_kubernetes_project_opinions"></a>3.2&nbsp;Kubernetes project opinions</h2></div></div></div><p>We&#8217;ve taken the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application built using Maven or Gradle wrappers</li><li class="listitem">application deployment to Kubernetes</li><li class="listitem">The produced Java Docker image needs to allow passing of system properties via <code class="literal">SYSTEM_PROPS</code> env variable</li><li class="listitem"><p class="simpara">For Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">example project</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem"><p class="simpara"><code class="literal">settings.xml</code> is parametrized to pass the credentials to push code to Artifactory and Docker repository</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">M2_SETTINGS_REPO_ID</code> - server id for Artifactory / Nexus deployment</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> - username for Artifactory / Nexus deployment</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> - password for Artifactory / Nexus deployment</li><li class="listitem"><code class="literal">DOCKER_SERVER_ID</code> - server id for Docker image pushing</li><li class="listitem"><code class="literal">DOCKER_USERNAME</code> - username for Docker image pushing</li><li class="listitem"><code class="literal">DOCKER_PASSWORD</code> - password for Docker image pushing</li><li class="listitem"><code class="literal">DOCKER_EMAIL</code> - email for Artifactory / Nexus deployment</li></ul></div></li><li class="listitem"><code class="literal">DOCKER_REGISTRY_URL</code> env var - (Overridable - defaults to DockerHub) URL of the Docker registry</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> - env var containing the organization where your Docker repo lays</li><li class="listitem">artifacts and Docker image deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem"><code class="literal">repo.with.binaries</code> property - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property - (Injected by the pipeline) ID of the distribution management. Corresponds to server id in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> property - (Injected by the pipeline) Will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor</li><li class="listitem">running API compatibility tests via the <code class="literal">apicompatibility</code> Maven profile</li><li class="listitem"><code class="literal">latest.production.version</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle  (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code> env var - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> env var - Username used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> env var - Password used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_URL</code> env var - (Overridable - defaults to DockerHub) URL of the Docker registry</li><li class="listitem"><code class="literal">DOCKER_USERNAME</code> env var - Username used to send the the Docker image</li><li class="listitem"><code class="literal">DOCKER_PASSWORD</code> env var - Password used to send the the Docker image</li><li class="listitem"><code class="literal">DOCKER_EMAIL</code> env var - Email used to send the the Docker image</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> - env var containing the organization where your Docker repo lays</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor</li><li class="listitem">running API compatibility tests via the <code class="literal">apiCompatibility</code> task</li><li class="listitem"><code class="literal">latestProductionVersion</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="concourse-pipeline-cf" href="#concourse-pipeline-cf"></a>4.&nbsp;Concourse Pipeline (Cloud Foundry)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Cloud Foundry PaaS</p></td></tr></table></div><p><a name="concourse" href="#concourse"></a> The Spring Cloud Pipelines repository contains opinionated
Concourse pipeline definition. Those jobs will form an empty pipeline and a
sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concourse-pipeline-step-by-step-cf" href="#concourse-pipeline-step-by-step-cf"></a>4.1&nbsp;Step by step</h2></div></div></div><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#concourse-fork-cf" title="4.1.1&nbsp;Fork repos">Fork repos</a></li><li class="listitem"><a class="link" href="#concourse-start-cf" title="4.1.2&nbsp;Start Concourse and Artifactory">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-deploy-cf" title="Deploy the infra JARs to Artifactory">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-pcfdev-cf" title="4.1.3&nbsp;Start PCF Dev">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#concourse-fly-cf" title="4.1.4&nbsp;Setup the fly CLI">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="#concourse-credentials-cf" title="4.1.5&nbsp;Setup your credentials.yml">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="#concourse-build-cf" title="4.1.6&nbsp;Build the pipeline">Run the seed job</a></li><li class="listitem"><a class="link" href="#concourse-run-cf" title="4.1.7&nbsp;Run the github-webhook pipeline">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-fork-cf" href="#concourse-fork-cf"></a>4.1.1&nbsp;Fork repos</h3></div></div></div><p>There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-start-cf" href="#concourse-start-cf"></a>4.1.2&nbsp;Start Concourse and Artifactory</h3></div></div></div><p>Concourse + Artifactory can be run locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/concourse
./setup_docker_compose.sh
./start.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre><p>The <code class="literal">setup_docker_compose.sh</code> script should be executed once only to allow
generation of keys.</p><p>The <code class="literal">192.168.99.100</code> param is an example of an external URL of Concourse
(equal to Docker-Machine ip in this example).</p><p>Then Concourse will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="concourse-deploy-cf" href="#concourse-deploy-cf"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p>When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pcfdev-cf" href="#concourse-pcfdev-cf"></a>4.1.3&nbsp;Start PCF Dev</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have CF installed and don&#8217;t want to use PCF Dev
The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#resources">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p>You have to download and start PCF Dev. <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">A link how to do it is available here.</a></p><p>The default credentials when using PCF Dev are:</p><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre><p>You can start the PCF Dev like this:</p><pre class="programlisting">cf dev start</pre><p>You&#8217;ll have to create 3 separate spaces (email admin, pass admin)</p><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre><p>You can also execute the <code class="literal">./tools/cf-helper.sh setup-spaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-fly-cf" href="#concourse-fly-cf"></a>4.1.4&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p>If you go to Concourse website you should see sth like this:</p><p>&nbsp;
&nbsp;</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>&nbsp;
&nbsp;</p><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you&#8217;ve downloaded that (and maybe added to your PATH) you can run:</p><pre class="programlisting">fly --version</pre><p>If <code class="literal">fly</code> is properly installed then it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-credentials-cf" href="#concourse-credentials-cf"></a>4.1.5&nbsp;Setup your <code class="literal">credentials.yml</code></h3></div></div></div><p>The repo comes with <code class="literal">credentials-sample-cf.yml</code> which is set up with sample data (most credentials) are set to be applicable for PCF Dev. Copy this file to a new file <code class="literal">credentials.yml</code> (the file is added to .gitignore so don&#8217;t worry that you&#8217;ll push it with your passwords) and edit it as you wish. For our demo just setup:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">app-url</code> - url pointing to your forked <code class="literal">github-webhook</code> repo</li><li class="listitem"><code class="literal">github-private-key</code> - your private key to clone / tag GitHub repos</li><li class="listitem"><code class="literal">repo-with-binaries</code> - the IP is set to the defaults for Docker Machine. You should update it to point to your setup</li></ul></div><p>If you don&#8217;t have a Docker Machine just execute <code class="literal">./whats_my_ip.sh</code> script to
get an external IP that you can pass to your <code class="literal">repo-with-binaries</code> instead of the default
Docker Machine IP.</p><p>Below you can see what environment variables are required by the scripts. To the right hand side you can see the default values for PCF Dev that we set in the <code class="literal">credentials-sample-cf.yml</code>.</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="" align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for TEST env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for STAGE env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for PROD env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SPACE_PREFIX</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Prefix of the name of the CF space for the test env to which the app name will be appended</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-stage</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-prod</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_FOR_UPLOAD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://192.168.99.100:8081/artifactory/libs-release-local" target="_top">http://192.168.99.100:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_HOSTNAME_UUID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JAVA_BUILDPACK_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the Java buildpack to be used by CF</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://github.com/cloudfoundry/java-buildpack.git#v3.8.1" target="_top">https://github.com/cloudfoundry/java-buildpack.git#v3.8.1</a></p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-build-cf" href="#concourse-build-cf"></a>4.1.6&nbsp;Build the pipeline</h3></div></div></div><p>Log in (e.g. for Concourse running at <code class="literal">192.168.99.100</code> - if you don&#8217;t provide any value then <code class="literal">localhost</code> is assumed). If you execute this script  (it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or it&#8217;s in the same folder as the script is):</p><pre class="programlisting">./login.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre><p>Next run the command to create the pipeline.</p><pre class="programlisting">./set_pipeline.sh</pre><p>Then you&#8217;ll create a <code class="literal">github-webhook</code> pipeline under the <code class="literal">docker</code> alias, using the provided <code class="literal">credentials.yml</code> file.
You can override these values in exactly that order (e.g. <code class="literal">./set-pipeline.sh some-project another-target some-other-credentials.yml</code>)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-run-cf" href="#concourse-run-cf"></a>4.1.7&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1757" href="#d0e1757"></a><p class="title"><b>Figure&nbsp;4.1.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1770" href="#d0e1770"></a><p class="title"><b>Figure&nbsp;4.2.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1784" href="#d0e1784"></a><p class="title"><b>Figure&nbsp;4.3.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">changeme</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1801" href="#d0e1801"></a><p class="title"><b>Figure&nbsp;4.4.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1812" href="#d0e1812"></a><p class="title"><b>Figure&nbsp;4.5.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1826" href="#d0e1826"></a><p class="title"><b>Figure&nbsp;4.6.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1837" href="#d0e1837"></a><p class="title"><b>Figure&nbsp;4.7.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1851" href="#d0e1851"></a><p class="title"><b>Figure&nbsp;4.8.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1862" href="#d0e1862"></a><p class="title"><b>Figure&nbsp;4.9.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1873" href="#d0e1873"></a><p class="title"><b>Figure&nbsp;4.10.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="concourse-pipeline-k8s" href="#concourse-pipeline-k8s"></a>5.&nbsp;Concourse Pipeline (Kubernetes)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="concourse" href="#concourse"></a> The Spring Cloud Pipelines repository contains opinionated
Concourse pipeline definition. Those jobs will form an empty pipeline and a
sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>5.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Concourse pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#concourse-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="#concourse-start-k8s" title="5.2&nbsp;Concourse in K8S (Kubernetes)">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-fly-k8s" title="5.2.2&nbsp;Setup the fly CLI">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-credentials-k8s" title="5.2.3&nbsp;Setup your credentials.yml">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="#concourse-pipeline-build-k8s" title="5.2.4&nbsp;Build the pipeline">Setup the pipeline</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-run-k8s" title="5.2.5&nbsp;Run the github-webhook pipeline">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>5.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="concourse-fork-k8s" href="#concourse-fork-k8s"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concourse-start-k8s" href="#concourse-start-k8s"></a>5.2&nbsp;Concourse in K8S (Kubernetes)</h2></div></div></div><p>The simplest way to deploy Concourse to K8S is to use <a class="link" href="https://github.com/kubernetes/helm" target="_top">Helm</a>.
Once you have Helm installed and your <code class="literal">kubectl</code> is pointing to the
cluster, just type this command to install the Concourse cluster in your K8S cluster.</p><pre class="programlisting">$ helm install stable/concourse --name concourse</pre><p>Once it&#8217;s done you&#8217;ll see the following output</p><pre class="programlisting"><span class="hl-number">1.</span> Concourse can be accessed:

  * Within your cluster, at the following DNS name at port <span class="hl-number">8080</span>:

    concourse-web.default.svc.cluster.local

  * From outside the cluster, run these commands in the same shell:

    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
    kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>

<span class="hl-number">2.</span> Login with the following credentials

  Username: concourse
  Password: concourse</pre><p>Just follow these steps and log in to Concourse under <a class="link" href="http://127.0.0.1:8080" target="_top">http://127.0.0.1:8080</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_deploying_artifactory_to_k8s" href="#_deploying_artifactory_to_k8s"></a>5.2.1&nbsp;Deploying Artifactory to K8S</h3></div></div></div><p>We can use Helm also to deploy Artifactory to K8S</p><pre class="programlisting">$ helm install --name artifactory --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span> artifactory.image.repository=docker.bintray.io/jfrog/artifactory-oss stable/artifactory</pre><p>After executing this you&#8217;ll see the following output</p><pre class="programlisting">NOTES:
Congratulations. You have just deployed JFrog Artifactory Pro!

<span class="hl-number">1.</span> Get the Artifactory URL by running these commands:

   NOTE: It may take a few minutes <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> the LoadBalancer IP to be available.
         You can watch the status of the service by running <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'kubectl get svc -w nginx'</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> SERVICE_IP=$(kubectl get svc --namespace default nginx -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.status.loadBalancer.ingress[0].ip}'</span>)
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> http://$SERVICE_IP/

<span class="hl-number">2.</span> Open Artifactory in your browser
   Default credential <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> Artifactory:
   user: admin
   password: password</pre><p>Next, we need to set up the repositories.</p><p>First, access the Artifactory URL and log in with
user, <code class="literal">admin</code> and <code class="literal">password</code> password.</p><div class="figure"><a name="d0e2034" href="#d0e2034"></a><p class="title"><b>Figure&nbsp;5.1.&nbsp;Click on the <code class="literal">Quick Setup</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_quick_setup.png" alt="artifactory quick setup"></div></div></div><br class="figure-break"><p>Then, click on the Maven setup and click <code class="literal">Create</code>.</p><div class="figure"><a name="d0e2050" href="#d0e2050"></a><p class="title"><b>Figure&nbsp;5.2.&nbsp;Create the <code class="literal">Maven</code> Repository</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_maven_repo.png" alt="artifactory maven repo"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-fly-k8s" href="#concourse-pipeline-fly-k8s"></a>5.2.2&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p><a name="fly" href="#fly"></a> If you go to Concourse website you should see sth like this:</p><p>&nbsp;
&nbsp;</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>&nbsp;
&nbsp;</p><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you&#8217;ve downloaded that (and maybe added to your PATH) you can run:</p><pre class="programlisting">fly --version</pre><p>If <code class="literal">fly</code> is properly installed then it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-credentials-k8s" href="#concourse-pipeline-credentials-k8s"></a>5.2.3&nbsp;Setup your <code class="literal">credentials.yml</code></h3></div></div></div><p>There is a sample credentials file called <code class="literal">credentials-sample-k8s.yml</code>
prepared for <code class="literal">k8s</code>. You can use it as a base for your <code class="literal">credentials.yml</code>.</p><p>To allow the Concourse worker&#8217;s spawned container to connect to
Kubernetes cluster you will need to pass the CA contents and the
auth token.</p><p>To get the contents of CA for GCE just execute</p><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.ca\.crt}'</span> | base64 --decode</pre><p>To get the token just type:</p><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.token}'</span> | base64 --decode</pre><p>Set that value under <code class="literal">paas-test-client-token</code>, <code class="literal">paas-stage-client-token</code> and <code class="literal">paas-prod-client-token</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-build-k8s" href="#concourse-pipeline-build-k8s"></a>5.2.4&nbsp;Build the pipeline</h3></div></div></div><p>After running Concourse you should get the following output in your terminal</p><pre class="programlisting">$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
$ kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>
Visit http://<span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">8080</span> to use Concourse</pre><p>Log in (e.g. for Concourse running at <code class="literal">127.0.0.1</code> - if you don&#8217;t provide any value then <code class="literal">localhost</code> is assumed). If you execute this script  (it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or it&#8217;s in the same folder as the script is):</p><pre class="programlisting">$ fly -t k8s login -c http://localhost:<span class="hl-number">8080</span> -u concourse -p concourse</pre><p>Next run the command to create the pipeline.</p><pre class="programlisting">$ ./set_pipeline.sh github-webhook k8s credentials-k8s.yml</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-run-k8s" href="#concourse-pipeline-run-k8s"></a>5.2.5&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2165" href="#d0e2165"></a><p class="title"><b>Figure&nbsp;5.3.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2178" href="#d0e2178"></a><p class="title"><b>Figure&nbsp;5.4.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2192" href="#d0e2192"></a><p class="title"><b>Figure&nbsp;5.5.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">concourse</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2209" href="#d0e2209"></a><p class="title"><b>Figure&nbsp;5.6.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2220" href="#d0e2220"></a><p class="title"><b>Figure&nbsp;5.7.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2234" href="#d0e2234"></a><p class="title"><b>Figure&nbsp;5.8.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2245" href="#d0e2245"></a><p class="title"><b>Figure&nbsp;5.9.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2259" href="#d0e2259"></a><p class="title"><b>Figure&nbsp;5.10.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2270" href="#d0e2270"></a><p class="title"><b>Figure&nbsp;5.11.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2281" href="#d0e2281"></a><p class="title"><b>Figure&nbsp;5.12.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="concourse-faq" href="#concourse-faq"></a>6.&nbsp;Concourse FAQ</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_use_the_pipeline_for_some_other_repos" href="#_can_i_use_the_pipeline_for_some_other_repos"></a>6.1&nbsp;Can I use the pipeline for some other repos?</h2></div></div></div><p>Sure! Just change the <code class="literal">app-url</code> in <code class="literal">credentials.yml</code>!</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_will_this_work_for_any_project_out_of_the_box" href="#_will_this_work_for_any_project_out_of_the_box"></a>6.2&nbsp;Will this work for ANY project out of the box?</h2></div></div></div><p>Not really. This is an <code class="literal">opinionated pipeline</code> that&#8217;s why we took some
opinionated decisions. Check out the documentation to see
what those decisions are.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_modify_this_to_reuse_in_my_project" href="#_can_i_modify_this_to_reuse_in_my_project"></a>6.3&nbsp;Can I modify this to reuse in my project?</h2></div></div></div><p>Sure! It&#8217;s open-source! The important thing is that the core part of the logic is written in
Bash scripts. That way, in the majority of cases, you could change only the bash scripts without changing the
whole pipeline. <a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines/tree/master/common/src/main/bash" target="_top">You can check out the scripts here.</a></p><p>Furthermore, if you only want to customize a particular function under <code class="literal">common/src/main/bash</code>, you can provide your own
function under <code class="literal">common/src/main/bash/&lt;some custom identifier&gt;</code> where <code class="literal">&lt;some custom identifier&gt;</code> is equal to the value of
the <code class="literal">CUSTOM_SCRIPT_IDENTIFIER</code> environment variable. It defaults to <code class="literal">custom</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_ran_out_of_resources_pcf_dev" href="#_i_ran_out_of_resources_pcf_dev"></a>6.4&nbsp;I ran out of resources!! (PCF Dev)</h2></div></div></div><p><a name="resources" href="#resources"></a> When deploying the app to stage or prod you can get an exception <code class="literal">Insufficient resources</code>. The way to
 solve it is to kill some apps from test / stage env. To achieve that just call</p><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre><p>You can also execute <code class="literal">./tools/cf-helper.sh kill-all-apps</code> that will remove
all demo-related apps deployed to PCF Dev.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_rollback_step_fails_due_to_missing_jar" href="#_the_rollback_step_fails_due_to_missing_jar"></a>6.5&nbsp;The rollback step fails due to missing JAR ?!</h2></div></div></div><p>You must have pushed some tags and have removed the Artifactory volume that
contained them. To fix this, just remove the tags</p><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_see_the_output_of_a_job_from_the_terminal" href="#_can_i_see_the_output_of_a_job_from_the_terminal"></a>6.6&nbsp;Can I see the output of a job from the terminal?</h2></div></div></div><p>Yes! Assuming that pipeline name is <code class="literal">github-webhook</code> and job name is <code class="literal">build-and-upload</code> you can running</p><pre class="programlisting">fly watch --job github-webhook/build-and-upload -t docker</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_clicked_the_job_and_it_s_constantly_pending" href="#_i_clicked_the_job_and_it_s_constantly_pending"></a>6.7&nbsp;I clicked the job and it&#8217;s constantly pending&#8230;&#8203;</h2></div></div></div><p>Don&#8217;t worry&#8230;&#8203; most likely you&#8217;ve just forgotten to click the <code class="literal">play</code> button to
unpause the pipeline. Click to the top left, expand the list of pipelines and click
the <code class="literal">play</code> button next to <code class="literal">github-webhook</code>.</p><p>Another problem that might occur is that you need to have the <code class="literal">version</code> branch.
Concourse will wait for the <code class="literal">version</code> branch to appear in your repo. So in order for
the pipeline to start ensure that when doing some git operations you haven&#8217;t
forgotten to create / copy the <code class="literal">version</code> branch too.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_route_is_already_in_use_cf" href="#_the_route_is_already_in_use_cf"></a>6.8&nbsp;The route is already in use (CF)</h2></div></div></div><p>If you play around with Jenkins / Concourse you might end up with the routes occupied</p><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre><p>Just delete the routes</p><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre><p>You can also execute the <code class="literal">./tools/cf-helper.sh delete-routes</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_m_unauthorized_to_deploy_infrastructure_jars" href="#_i_m_unauthorized_to_deploy_infrastructure_jars"></a>6.9&nbsp;I&#8217;m unauthorized to deploy infrastructure jars</h2></div></div></div><p>Most likely you&#8217;ve forgotten to update your local <code class="literal">settings.xml</code> with the Artifactory&#8217;s
setup. Check out <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code></a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="__literal_version_literal_resource_is_broken" href="#__literal_version_literal_resource_is_broken"></a>6.10&nbsp;<code class="literal">version</code> resource is broken</h2></div></div></div><p>When I click on it it looks like this:</p><pre class="programlisting">resource script <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'/opt/resource/check []'</span> failed: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">exit</span> status <span class="hl-number">128</span>

stderr:
Identity added: /tmp/git-resource-private-key (/tmp/git-resource-private-key)
Cloning into <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'/tmp/git-resource-repo-cache'</span>...
warning: Could not find remote branch version to clone.
fatal: Remote branch version not found in upstream origin</pre><p>That means that your repo doesn&#8217;t have the <code class="literal">version</code> branch. Please
set it up.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_jenkins_pipeline_common" href="#_jenkins_pipeline_common"></a>7.&nbsp;Jenkins Pipeline (Common)</h1></div></div></div><p>In this section we will present the common setup of Jenkins for any platform.
We will also provide answers to most frequently asked questions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup_2" href="#_project_setup_2"></a>7.1&nbsp;Project setup</h2></div></div></div><pre class="programlisting">.
&#9500;&#9472;&#9472; declarative-pipeline
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; Jenkinsfile-sample.groovy
&#9500;&#9472;&#9472; jobs
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_jenkinsfile_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_sample.groovy
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; jenkins_pipeline_sample_view.groovy
&#9500;&#9472;&#9472; seed
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; init.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; k8s
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; settings.xml
&#9492;&#9472;&#9472; src
    &#9500;&#9472;&#9472; main
 &nbsp;&nbsp; &#9492;&#9472;&#9472; <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span></pre><p>In the <code class="literal">declarative-pipeline</code> you can find a definition of a <code class="literal">Jenkinsfile-sample.groovy</code> declarative
pipeline. It&#8217;s used together with the Blueocean UI.</p><p>In the <code class="literal">jobs</code> folder you have all the seed jobs that will generate pipelines.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">jenkins_pipeline_empty.groovy</code> - is a template of a pipeline with empty steps using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_jenkinsfile_empty.groovy</code> - is a template of a pipeline with empty steps using the Pipeline plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample.groovy</code> - is an opinionated implementation using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample_view.groovy</code> - builds the views for the pipelines</li></ul></div><p>In the <code class="literal">seed</code> folder you have the <code class="literal">init.groovy</code> file which is executed when Jenkins starts.
That way we can configure most of Jenkins options for you (adding credentials, JDK etc.).
<code class="literal">jenkins_pipeline.groovy</code> contains logic to build a seed job (that way you don&#8217;t have to even click that
job - we generate it for you). Under the <code class="literal">k8s</code> folder there are all the configuration
files required for deployment to a Kubernetes cluster.</p><p>In the <code class="literal">src</code> folder you have production and test classes needed for you to build your own pipeline.
Currently we have tests only cause the whole logic resides in the <code class="literal">jenkins_pipeline_sample</code> file.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_optional_customization_steps" href="#_optional_customization_steps"></a>7.2&nbsp;Optional customization steps</h2></div></div></div><p><a name="jenkins_optional" href="#jenkins_optional"></a> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="deploying-infra" href="#deploying-infra"></a>7.2.1&nbsp;Deploying infra jars to a different location</h3></div></div></div><p>It&#8217;s enough to set the <code class="literal">ARTIFACTORY_URL</code> environmental variable before
executing <code class="literal">tools/deploy-infra.sh</code>. Example for deploying to Artifactory at IP <code class="literal">192.168.99.100</code></p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
ARTIFACTORY_URL=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://192.168.99.100:8081/artifactory/libs-release-local"</span> ./tools/deploy-infra.sh</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-settings-xml" href="#setup-settings-xml"></a>7.2.2&nbsp;Setup settings.xml for Maven deployment</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you want to use the default connection to the Docker version
of Artifactory you can skip this step</p></td></tr></table></div><p><a name="jenkins-settings" href="#jenkins-settings"></a> So that <code class="literal">./mvnw deploy</code> works with Artifactory from Docker we&#8217;re
already copying the missing <code class="literal">settings.xml</code> file for you. It looks more or less like this:</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;settings&gt;</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;servers&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${M2_SETTINGS_REPO_ID}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>${M2_SETTINGS_REPO_USERNAME}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>${M2_SETTINGS_REPO_PASSWORD}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${DOCKER_SERVER_ID}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>${DOCKER_USERNAME}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>${DOCKER_PASSWORD}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;email&gt;</span>${DOCKER_EMAIL}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/email&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/servers&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/settings&gt;</span></pre><p>As you can see the file is parameterized. In Maven it&#8217;s enough to pass
to <code class="literal">./mvnw</code> command the proper system property to override that value. For example to pass
a different docker email you&#8217;d have to call <code class="literal">./mvnw -DDOCKER_EMAIL=<a class="link" href="mailto:foo@bar.com" target="_top">foo@bar.com</a></code> and the value
gets updated.</p><p>If you want to use your own version of Artifactory / Nexus you have to update
the file (it&#8217;s in <code class="literal">seed/settings.xml</code>).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-jenkins-env-vars" href="#setup-jenkins-env-vars"></a>7.2.3&nbsp;Setup Jenkins env vars</h3></div></div></div><p><a name="jenkins_env" href="#jenkins_env"></a> If you want to only play around with the demo that we&#8217;ve prepared you have to set <span class="strong"><strong>ONE</strong></span> variable which is the <code class="literal">REPOS</code> variable.
That variable needs to consists of comma separated list of URLs to repositories containing business apps. So you should pass your forked repos URLs.</p><p>You can do it in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">globally via Jenkins global env vars (then when you run the seed that variable will be taken into consideration and proper pipelines will get built)</li><li class="listitem">modify the seed job parameters (you&#8217;ll have to modify the seed job configuration and change the <code class="literal">REPOS</code> property)</li><li class="listitem">provide the repos parameter when running the seed job</li></ul></div><p>For the sake of simplicity let&#8217;s go with the <span class="strong"><strong>last</strong></span> option.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re choosing the global envs, you <span class="strong"><strong>HAVE</strong></span> to remove the other approach
(e.g. if you set the global env for <code class="literal">REPOS</code>, please remove that property in the
seed job</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="setup-seed-props" href="#setup-seed-props"></a>Seed properties</h4></div></div></div><p>Click on the seed job and pick <code class="literal">Build with parameters</code>. Then as presented in the screen below (you&#8217;ll have far more properties to set) just modify the <code class="literal">REPOS</code> property by providing the comma separated list of URLs to your forks. Whatever you set will be parsed by the seed job and passed to the generated Jenkins jobs.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>This is very useful when the repos you want to build differ. E.g. use
different JDK. Then some seeds can set the <code class="literal">JDK_VERSION</code> param to one version
of Java installation and the others to another one.</p></td></tr></table></div><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div><p>In the screenshot we could parametrize the <code class="literal">REPOS</code> and <code class="literal">REPO_WITH_BINARIES</code> params.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="global-envs" href="#global-envs"></a>Global envs</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This section is presented only for informational purposes - for the sake of demo you can skip it</p></td></tr></table></div><p>You can add env vars (go to configure Jenkins &#8594; Global Properties) for the following
 properties (example with defaults for PCF Dev):</p><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/env_vars.png" alt="env vars"></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="git-email" href="#git-email"></a>7.2.4&nbsp;Set Git email / user</h3></div></div></div><p>Since our pipeline is setting the git user / name explicitly for the build step
 you&#8217;d have to go to <code class="literal">Configure</code> of the build step and modify the Git name / email.
 If you want to set it globally you&#8217;ll have to remove the section from the build
 step and follow these steps to set it globally.</p><p>You can set Git email / user globally like this:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2662" href="#d0e2662"></a><p class="title"><b>Figure&nbsp;7.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2673" href="#d0e2673"></a><p class="title"><b>Figure&nbsp;7.2.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2684" href="#d0e2684"></a><p class="title"><b>Figure&nbsp;7.3.&nbsp;Fill out Git user information</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/git.png" alt="git"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jenkins-credentials-github" href="#jenkins-credentials-github"></a>Add Jenkins credentials for GitHub</h4></div></div></div><p><a name="jenkins-credentials" href="#jenkins-credentials"></a> The scripts will need to access the credential in order to tag the repo.</p><p>You have to set credentials with id: <code class="literal">git</code>.</p><p>Below you can find instructions on how to set a credential (e.g. for Cloud Foundry <code class="literal">cf-test</code> credential but
remember to provide the one with id <code class="literal">git</code>).</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2716" href="#d0e2716"></a><p class="title"><b>Figure&nbsp;7.4.&nbsp;Click 'Credentials, System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_system.png" alt="credentials system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2727" href="#d0e2727"></a><p class="title"><b>Figure&nbsp;7.5.&nbsp;Click 'Global Credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_global.png" alt="credentials global"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2738" href="#d0e2738"></a><p class="title"><b>Figure&nbsp;7.6.&nbsp;Click 'Add credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_add.png" alt="credentials add"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2749" href="#d0e2749"></a><p class="title"><b>Figure&nbsp;7.7.&nbsp;Fill out the user / password and provide the <code class="literal">git</code> credential ID (in this example <code class="literal">cf-test</code>)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_example.png" alt="credentials example"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_testing_jenkins_scripts" href="#_testing_jenkins_scripts"></a>7.3&nbsp;Testing Jenkins scripts</h2></div></div></div><p><code class="literal">./gradlew clean build</code></p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>The ran test only checks if your scripts compile.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_work_with_jenkins_job_dsl_plugin" href="#_how_to_work_with_jenkins_job_dsl_plugin"></a>7.4&nbsp;How to work with Jenkins Job DSL plugin</h2></div></div></div><p>Check out the <a class="link" href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Tutorial---Using-the-Jenkins-Job-DSL" target="_top">tutorial</a>.
Provide the link to this repository in your Jenkins installation.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Remember that views can be overridden that&#8217;s why the suggestion is to contain in one script all the logic needed to build a view
 for a single project (check out that <code class="literal">spring_cloud_views.groovy</code> is building all the <code class="literal">spring-cloud</code> views).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_docker_image" href="#_docker_image"></a>7.5&nbsp;Docker Image</h2></div></div></div><p>If you would like to run the pre-configured Jenkins image somewhere other than your local machine, we
have an image you can pull and use on <a class="link" href="https://hub.docker.com/r/springcloud/spring-cloud-pipeline-jenkins/" target="_top">DockerHub</a>.
The <code class="literal">latest</code> tag corresponds to the latest snapshot build.  You can also find tags
corresponding to stable releases that you can use as well.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>8.&nbsp;Jenkins Pipeline (Cloud Foundry)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Cloud Foundry PaaS</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job DSL plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-cf" href="#step-by-step-cf"></a>8.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins Job DSL based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#jenkins-fork-cf">Fork repos</a></li><li class="listitem"><a class="link" href="#jenkins-start-cf">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-cf">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-pcfdev-cf">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-cf" title="8.1.4&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-cf" title="8.&nbsp;Jenkins Pipeline (Cloud Foundry)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-cf" href="#fork-repos-cf"></a>8.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-cf" href="#jenkins-fork-cf"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-cf" href="#start-jenkins-cf"></a>8.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-cf" href="#jenkins-start-cf"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-cf" href="#deploy-infra-cf"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-cf" href="#jenkins-deploy-cf"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-pcf-dev-cf" href="#start-pcf-dev-cf"></a>8.1.3&nbsp;Start PCF Dev</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have CF installed and don&#8217;t want to use PCF Dev
The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p><a name="jenkins-pcfdev-cf" href="#jenkins-pcfdev-cf"></a> You have to download and start PCF Dev. <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">A link how to do it is available here.</a></p><p>The default credentials when using PCF Dev are:</p><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre><p>You can start the PCF Dev like this:</p><pre class="programlisting">cf dev start</pre><p>You&#8217;ll have to create 3 separate spaces (email admin, pass admin)</p><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre><p>You can also execute the <code class="literal">./tools/cf-helper.sh setup-spaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-cf" href="#jenkins-seed-cf"></a>8.1.4&nbsp;Run the seed job</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and `github-analytics'.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3000" href="#d0e3000"></a><p class="title"><b>Figure&nbsp;8.1.&nbsp;Click the 'jenkins-pipeline-seed-cf' job for Cloud Foundry and <code class="literal">jenkins-pipeline-seed-k8s</code> for Kubernetes</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3014" href="#d0e3014"></a><p class="title"><b>Figure&nbsp;8.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3025" href="#d0e3025"></a><p class="title"><b>Figure&nbsp;8.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3039" href="#d0e3039"></a><p class="title"><b>Figure&nbsp;8.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>8.1.5&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3069" href="#d0e3069"></a><p class="title"><b>Figure&nbsp;8.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3080" href="#d0e3080"></a><p class="title"><b>Figure&nbsp;8.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on the <span class="strong"><strong>deploy previous version to stage</strong></span> due to missing jar,
that means that you&#8217;ve forgotten to clear the tags in your repo. Typically that&#8217;s due to the fact that
you&#8217;ve removed the Artifactory volume with deployed JAR whereas a tag in the repo is still pointing there.
<a class="link" href="#">Check out this section on how to remove the tag.</a></p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3101" href="#d0e3101"></a><p class="title"><b>Figure&nbsp;8.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Most likely you will run out of memory so when reaching the stage
environment it&#8217;s good to kill all apps on test. <a class="link" href="#">Check out the FAQ section for more details</a>!</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3123" href="#d0e3123"></a><p class="title"><b>Figure&nbsp;8.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-cf" href="#declarative-pipeline-cf"></a>8.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>. Here is a step by step guide to run a pipeline via
this approach.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL. E.g. for Docker Machine based setup <code class="literal"><a class="link" href="http://192.168.99.100:8080/blue" target="_top">http://192.168.99.100:8080/blue</a></code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3156" href="#d0e3156"></a><p class="title"><b>Figure&nbsp;8.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3169" href="#d0e3169"></a><p class="title"><b>Figure&nbsp;8.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3183" href="#d0e3183"></a><p class="title"><b>Figure&nbsp;8.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3196" href="#d0e3196"></a><p class="title"><b>Figure&nbsp;8.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3207" href="#d0e3207"></a><p class="title"><b>Figure&nbsp;8.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3220" href="#d0e3220"></a><p class="title"><b>Figure&nbsp;8.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3231" href="#d0e3231"></a><p class="title"><b>Figure&nbsp;8.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting pipeline from specific stage, after failure. Please
check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently there is no way to introduce manual steps in a performant way. Jenkins is
blocking an executor when manual step is required. That means that you&#8217;ll run out of executors
pretty fast. You can check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">issue</a> for
and this <a class="link" href="http://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-cf" href="#optional-steps-cf"></a>8.3&nbsp;Jenkins Cloud Foundry customization</h2></div></div></div><pre class="literallayout"> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-cf" href="#all-env-vars-cf"></a>8.3.1&nbsp;All env vars</h3></div></div></div><p>The env vars that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BINARY_EXTENSION</p></th><th style="" align="left" valign="top"><p>Extension of the binary uploaded to Artifactory / Nexus. Example: change this to <code class="literal">war</code> for WAR artifacts</p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for TEST env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for STAGE env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for PROD env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SPACE_PREFIX</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Prefix of the name of the CF space for the test env to which the app name will be appended</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-stage</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-prod</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_FOR_UPLOAD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://artifactory:8081/artifactory/libs-release-local" target="_top">http://artifactory:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JDK_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdk8</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PIPELINE_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>What should be the version of the pipeline (ultimately also version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:email@example.com" target="_top">email@example.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pivo Tal</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_HOSTNAME_UUID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_STAGE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_PROD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>API_COMPATIBILITY_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should api compatibility step be required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DB_ROLLBACK_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should DB rollback step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEPLOY_TO_STAGE_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deploy to stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JAVA_BUILDPACK_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the Java buildpack to be used by CF</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://github.com/cloudfoundry/java-buildpack.git#v3.8.1" target="_top">https://github.com/cloudfoundry/java-buildpack.git#v3.8.1</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-credentials-cf" href="#jenkins-credentials-cf"></a>8.3.2&nbsp;Jenkins Credentials</h3></div></div></div><p>In your scripts we reference the credentials via IDs. These are the defaults for credentials</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CREDENTIAL_ID</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Prod env access</p></th><th style="" align="left" valign="top"><p>cf-prod</p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used to tag a git repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>git</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_SSH_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SSH credential ID used to tag a git repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>gitSsh</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_USE_SSH_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>if <code class="literal">true</code> will pick to use the SSH credential id</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used for the repo with jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>repo-with-binaries</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Test env access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cf-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Stage env access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cf-stage</p></td></tr></tbody></table></div><p>If you already have in your system a credential to for example tag a repo
you can use it by passing the value of the property <code class="literal">GIT_CREDENTIAL_ID</code></p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Check out the <code class="literal">cf-helper</code> script for all the configuration options!</p></td></tr></table></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>9.&nbsp;Jenkins Pipeline (Kubernetes)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job DSL plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>9.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins Job DSL based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#jenkins-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="#jenkins-start-k8s">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-k8s">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#">Start Minikube (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-k8s" title="9.1.3&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-k8s" title="9.&nbsp;Jenkins Pipeline (Kubernetes)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>9.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-k8s" href="#jenkins-fork-k8s"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-k8s" href="#start-jenkins-k8s"></a>9.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-k8s" href="#jenkins-start-k8s"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg yourDockerRegistryOrganization yourDockerRegistryUsername yourDockerRegistryPassword yourDockerRegistryEmail</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><p>You need to pass the credentials for the Docker organization (by default we will
search for the Docker images at Docker Hub) so that the pipeline will be able
to push images to your org.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-k8s" href="#deploy-infra-k8s"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-k8s" href="#jenkins-deploy-k8s"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra-k8s.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built,
uploaded to Artifactory and their docker images will be built.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your local Docker process will be reused by the Jenkins instance running
in Docker. That&#8217;s why you don&#8217;t have to push these images to Docker Hub. On the
other hand if you run this sample in a remote Kubernetes cluster the driver
will not be shared by the Jenkins workers so you can consider pushing these
Docker images to Docker Hub too.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-k8s" href="#jenkins-seed-k8s"></a>9.1.3&nbsp;Run the seed job</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and `github-analytics'.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3793" href="#d0e3793"></a><p class="title"><b>Figure&nbsp;9.1.&nbsp;Click the 'jenkins-pipeline-seed-cf' job for Cloud Foundry and <code class="literal">jenkins-pipeline-seed-k8s</code> for Kubernetes</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3807" href="#d0e3807"></a><p class="title"><b>Figure&nbsp;9.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3818" href="#d0e3818"></a><p class="title"><b>Figure&nbsp;9.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3832" href="#d0e3832"></a><p class="title"><b>Figure&nbsp;9.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>9.1.4&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3862" href="#d0e3862"></a><p class="title"><b>Figure&nbsp;9.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3873" href="#d0e3873"></a><p class="title"><b>Figure&nbsp;9.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on the <span class="strong"><strong>deploy previous version to stage</strong></span> due to missing jar,
that means that you&#8217;ve forgotten to clear the tags in your repo. Typically that&#8217;s due to the fact that
you&#8217;ve removed the Artifactory volume with deployed JAR whereas a tag in the repo is still pointing there.
<a class="link" href="#">Check out this section on how to remove the tag.</a></p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3894" href="#d0e3894"></a><p class="title"><b>Figure&nbsp;9.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Most likely you will run out of memory so when reaching the stage
environment it&#8217;s good to kill all apps on test. <a class="link" href="#">Check out the FAQ section for more details</a>!</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3916" href="#d0e3916"></a><p class="title"><b>Figure&nbsp;9.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-k8s" href="#declarative-pipeline-k8s"></a>9.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>. Here is a step by step guide to run a pipeline via
this approach.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL. E.g. for Docker Machine based setup <code class="literal"><a class="link" href="http://192.168.99.100:8080/blue" target="_top">http://192.168.99.100:8080/blue</a></code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3949" href="#d0e3949"></a><p class="title"><b>Figure&nbsp;9.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3962" href="#d0e3962"></a><p class="title"><b>Figure&nbsp;9.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3976" href="#d0e3976"></a><p class="title"><b>Figure&nbsp;9.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3989" href="#d0e3989"></a><p class="title"><b>Figure&nbsp;9.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4000" href="#d0e4000"></a><p class="title"><b>Figure&nbsp;9.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4013" href="#d0e4013"></a><p class="title"><b>Figure&nbsp;9.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4024" href="#d0e4024"></a><p class="title"><b>Figure&nbsp;9.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting pipeline from specific stage, after failure. Please
check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently there is no way to introduce manual steps in a performant way. Jenkins is
blocking an executor when manual step is required. That means that you&#8217;ll run out of executors
pretty fast. You can check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">issue</a> for
and this <a class="link" href="http://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-k8s" href="#optional-steps-k8s"></a>9.3&nbsp;Jenkins Kubernetes customization</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-k8s" href="#all-env-vars-k8s"></a>9.3.1&nbsp;All env vars</h3></div></div></div><p>The env vars that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_ORGANIZATION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the docker organization to which Docker images should be deployed</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scpipelines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used to push Docker images</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>docker-registry</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_SERVER_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Server ID in <code class="literal">settings.xml</code> and Maven builds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>docker-repo</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Email used to connect to Docker registry` and Maven builds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:change@me.com" target="_top">change@me.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_ORGANIZATION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to Kubernetes cluster for test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scpipelines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to the docker registry</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://index.docker.io/v1/" target="_top">https://index.docker.io/v1/</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CA_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CA_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CA_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_CERT_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_CERT_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_CERT_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_KEY_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_KEY_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_KEY_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_TOKEN_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_TOKEN_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_TOKEN_PATH</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_TOKEN_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_TOKEN_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_TOKEN_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-stage</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-prod</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>KUBERNETES_MINIKUBE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Will you connect to Minikube?</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_FOR_UPLOAD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://artifactory:8081/artifactory/libs-release-local" target="_top">http://artifactory:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used for the repo with jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>repo-with-binaries</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JDK_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdk8</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PIPELINE_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>What should be the version of the pipeline (ultimately also version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:email@example.com" target="_top">email@example.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pivo Tal</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_STAGE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_PROD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>API_COMPATIBILITY_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should api compatibility step be required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DB_ROLLBACK_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should DB rollback step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEPLOY_TO_STAGE_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deploy to stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_preparing_to_connect_to_gce" href="#_preparing_to_connect_to_gce"></a>9.4&nbsp;Preparing to connect to GCE</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Skip this step if you&#8217;re not using GCE</p></td></tr></table></div><p>In order to use GCE we need to have <code class="literal">gcloud</code> running. If you already have the
CLI installed, skip this step. If not just execute to have the CLI
downloaded and an installer started</p><pre class="programlisting">$ ./tools/k8s-helper.sh download-gcloud</pre><p>Next, configure <code class="literal">gcloud</code>. Execute <code class="literal">gcloud init</code> and log in
to your cluster. You will get redirected to a login page, pick the
proper Google account and log in.</p><p>Pick an existing project or create a new one.</p><p>Go to your platform page (click on <code class="literal">Container Engine</code>) in GCP and connect to your cluster</p><pre class="programlisting">$ CLUSTER_NAME=...
$ ZONE=us-east1-b
$ PROJECT_NAME=...
$ gcloud container clusters get-credentials ${CLUSTER_NAME} --zone ${ZONE} --project ${PROJECT_NAME}
$ kubectl proxy</pre><p>The Kubernetes dashboard will be running at <code class="literal"><a class="link" href="http://localhost:8001/ui/" target="_top">http://localhost:8001/ui/</a></code>.</p><p>We&#8217;ll need a Persistent Disk for our Jenkins installation. Let&#8217;s create it</p><pre class="programlisting">$ ZONE=us-east1-b
$ gcloud compute disks create --size=<span class="hl-number">200</span>GB --zone=${ZONE} sc-pipelines-jenkins-disk</pre><p>Since the disk got created now we need to format it. You can check out
the instructions on how to do it here - <a class="link" href="https://cloud.google.com/compute/docs/disks/add-persistent-disk#formatting" target="_top">https://cloud.google.com/compute/docs/disks/add-persistent-disk#formatting</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_connecting_to_a_kubo_or_gce_cluster" href="#_connecting_to_a_kubo_or_gce_cluster"></a>9.5&nbsp;Connecting to a Kubo or GCE cluster</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Skip this step if you&#8217;re not using Kubo or GCE</p></td></tr></table></div><p>In this section a description of steps required to deploy Jenkins and
Artifactory to a Kubernetes cluster deployed via Kubo.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>To see the dashboard just do <code class="literal">kubectl proxy</code> and access <code class="literal">localhost:8081/ui</code></p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Log in to the cluster</li><li class="listitem"><p class="simpara">Deploy Jenkins and Artifactory to the cluster</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">./tools/k8s-helper.sh setup-tools-infra-vsphere</code> for a cluster deployed on VSphere</li><li class="listitem"><code class="literal">./tools/k8s-helper.sh setup-tools-infra-gce</code> for a cluster deployed to GCE</li></ul></div></li><li class="listitem">Forward the ports so that you can access the Jenkins UI from your local machine</li></ul></div><pre class="programlisting">$ NAMESPACE=default
$ JENKINS_POD=jenkins-<span class="hl-number">1430785859</span>-nfhx4
$ LOCAL_PORT=<span class="hl-number">32044</span>
$ CONTAINER_PORT=<span class="hl-number">8080</span>
$ kubectl port-forward --namespace=${NAMESPACE} ${JENKINS_POD} ${LOCAL_PORT}:${CONTAINER_PORT}</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Go to <code class="literal">Credentials</code>, click <code class="literal">System</code> and <code class="literal">Global credentials</code></li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/kubo_credentials.png" alt="kubo credentials"></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Update <code class="literal">git</code>, <code class="literal">repo-with-binaries</code> and <code class="literal">docker-registry</code> credentials</li><li class="listitem"><p class="simpara">Run the <code class="literal">jenkins-pipeline-k8s-seed</code> seed job and fill it out with the following data</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">Put <code class="literal">kubernetes.default:443</code> here (or <code class="literal">KUBERNETES_API:KUBERNETES_PORT</code>)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_API_URL</code></li><li class="listitem"><code class="literal">PAAS_STAGE_API_URL</code></li><li class="listitem"><code class="literal">PAAS_PROD_API_URL</code></li></ul></div></li><li class="listitem"><p class="simpara">Put <code class="literal">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code> data here</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_CA_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CA_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CA_PATH</code></li></ul></div></li><li class="listitem">Uncheck the <code class="literal">Kubernetes Minikube</code> value</li><li class="listitem"><p class="simpara">Clear the following vars</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_KEY_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_KEY_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLIENT_KEY_PATH</code></li></ul></div></li><li class="listitem"><p class="simpara">Set <code class="literal">/var/run/secrets/kubernetes.io/serviceaccount/token</code> value to these vars</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_TOKEN_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_TOKEN_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_TOKEN_PATH</code></li></ul></div></li><li class="listitem"><p class="simpara">Set the cluster name to these vars (you can get it by calling <code class="literal">kubectl config current-context</code>)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_CLUSTER_NAME</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLUSTER_NAME</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLUSTER_NAME</code></li></ul></div></li><li class="listitem"><p class="simpara">Set the system name to these vars (you can get it by calling <code class="literal">kubectl config current-context</code>)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">PAAS_TEST_SYSTEM_NAME</code></li><li class="listitem"><code class="literal">PAAS_STAGE_SYSTEM_NAME</code></li><li class="listitem"><code class="literal">PAAS_PROD_SYSTEM_NAME</code></li></ul></div></li><li class="listitem">Update the <code class="literal">DOCKER_EMAIL</code> property with your email</li><li class="listitem">Update the <code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> with your Docker organization name</li><li class="listitem">If you don&#8217;t want to upload the images to DockerHub update  <code class="literal">DOCKER_REGISTRY_URL</code></li></ul></div></li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pks_seed.png" alt="pks seed"></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Run the pipeline</li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_jenkins_faq" href="#_jenkins_faq"></a>10.&nbsp;Jenkins FAQ</h1></div></div></div><p>Below you can find the answers to most frequently asked questions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jenkins_faq" href="#jenkins_faq"></a>10.1&nbsp;Pipeline version contains ${PIPELINE_VERSION}</h2></div></div></div><p>You can check the Jenkins logs and you&#8217;ll see</p><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre><p>To fix it you have to do exactly what the warning suggests&#8230;&#8203; Also ensure that the <code class="literal">Groovy token macro processing</code>
checkbox is set.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_version_is_not_passed_to_the_build" href="#_pipeline_version_is_not_passed_to_the_build"></a>10.2&nbsp;Pipeline version is not passed to the build</h2></div></div></div><p>You can see that the Jenkins version is properly set but in the build version is still snapshot and
the <code class="literal">echo "${PIPELINE_VERSION}"</code> doesn&#8217;t print anything.</p><p>You can check the Jenkins logs and you&#8217;ll see</p><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre><p>To fix it you have to do exactly what the warning suggests&#8230;&#8203;</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_build_times_out_with_literal_pipeline_sh_literal_info" href="#_the_build_times_out_with_literal_pipeline_sh_literal_info"></a>10.3&nbsp;The build times out with <code class="literal">pipeline.sh</code> info</h2></div></div></div><p>Docker compose, docker compose, docker compose&#8230;&#8203; The problem is that for some reason, only in Docker, the execution of
Java hangs. But it hangs randomly and only the first time you try to execute the pipeline.</p><p>The solution to this is to run the pipeline again. If once it suddenly, magically passes then
it will pass for any subsequent build.</p><p>Another thing that you can try is to run it with plain Docker. Maybe that will help.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_use_the_pipeline_for_some_other_repos_2" href="#_can_i_use_the_pipeline_for_some_other_repos_2"></a>10.4&nbsp;Can I use the pipeline for some other repos?</h2></div></div></div><p>Sure! you can pass <code class="literal">REPOS</code> variable with comma separated list of
<code class="literal">project_name$project_url</code> format. If you don&#8217;t provide the PROJECT_NAME the
repo name will be extracted and used as the name of the project.</p><p>E.g. for <code class="literal">REPOS</code> equal to:</p><p><code class="literal"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook" target="_top">https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook</a></code></p><p>will result in the creation of pipelines with root names <code class="literal">github-analytics</code> and <code class="literal">github-webhook</code>.</p><p>E.g. for <code class="literal">REPOS</code> equal to:</p><p><code class="literal">foo$https://github.com/spring-cloud-samples/github-analytics,bar$https://github.com/spring-cloud-samples/atom-feed</code></p><p>will result in the creation of pipelines with root names <code class="literal">foo</code> for <code class="literal">github-analytics</code>
and <code class="literal">bar</code> for <code class="literal">github-webhook</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_will_this_work_for_any_project_out_of_the_box_2" href="#_will_this_work_for_any_project_out_of_the_box_2"></a>10.5&nbsp;Will this work for ANY project out of the box?</h2></div></div></div><p>Not really. This is an <code class="literal">opinionated pipeline</code> that&#8217;s why we took some
opinionated decisions like:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">usage of Spring Cloud, Spring Cloud Contract Stub Runner and Spring Cloud Eureka</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem"><p class="simpara">For Maven:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle (in the <code class="literal">github-analytics</code> application check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div><p>This is the initial approach that can be easily changed in the future.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_modify_this_to_reuse_in_my_project_2" href="#_can_i_modify_this_to_reuse_in_my_project_2"></a>10.6&nbsp;Can I modify this to reuse in my project?</h2></div></div></div><p>Sure! It&#8217;s open-source! The important thing is that the core part of the logic is written
in Bash scripts. That way, in the majority of cases, you could change only the bash
scripts without changing the whole pipeline.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_rollback_step_fails_due_to_missing_jar_2" href="#_the_rollback_step_fails_due_to_missing_jar_2"></a>10.7&nbsp;The rollback step fails due to missing JAR ?!</h2></div></div></div><p><a name="jenkins_tags" href="#jenkins_tags"></a> You must have pushed some tags and have removed the Artifactory volume that
contained them. To fix this, just remove the tags</p><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_want_to_provide_a_different_jdk_version" href="#_i_want_to_provide_a_different_jdk_version"></a>10.8&nbsp;I want to provide a different JDK version</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">by default we assume that you have jdk with id <code class="literal">jdk8</code> configured</li><li class="listitem">if you want a different one just override <code class="literal">JDK_VERSION</code> env var and point to the proper one</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The docker image comes in with Java installed at <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code>.
You can go to <code class="literal">Global Tools</code> and create a JDK with <code class="literal">jdk8</code> id and JAVA_HOME
 pointing to <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code></p></td></tr></table></div><p>To change the default one just follow these steps:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5087" href="#d0e5087"></a><p class="title"><b>Figure&nbsp;10.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5098" href="#d0e5098"></a><p class="title"><b>Figure&nbsp;10.2.&nbsp;Click 'Global Tool'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/global_tool.png" alt="global tool"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5109" href="#d0e5109"></a><p class="title"><b>Figure&nbsp;10.3.&nbsp;Click 'JDK Installations'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk_installation.png" alt="jdk installation"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5120" href="#d0e5120"></a><p class="title"><b>Figure&nbsp;10.4.&nbsp;Fill out JDK Installation with path to your JDK</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk.png" alt="jdk"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>And that&#8217;s it!</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="groovy-token-macro" href="#groovy-token-macro"></a>10.9&nbsp;Enable Groovy Token Macro Processing</h2></div></div></div><p>With scripted that but if you needed to this manually then this is how to do it:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5140" href="#d0e5140"></a><p class="title"><b>Figure&nbsp;10.5.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5151" href="#d0e5151"></a><p class="title"><b>Figure&nbsp;10.6.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5162" href="#d0e5162"></a><p class="title"><b>Figure&nbsp;10.7.&nbsp;Click 'Allow token macro processing'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/groovy_token.png" alt="groovy token"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_want_deployment_to_stage_and_prod_be_automatic" href="#_i_want_deployment_to_stage_and_prod_be_automatic"></a>10.10&nbsp;I want deployment to stage and prod be automatic</h2></div></div></div><p>No problem, just set the property / env var to true</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_STAGE</code> to automatically deploy to stage</li><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_PROD</code> to automatically deploy to prod</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_don_t_want_to_test_api_compativility" href="#_i_don_t_want_to_test_api_compativility"></a>10.11&nbsp;I don&#8217;t want to test API compativility</h2></div></div></div><p>No problem, just set the <code class="literal">API_COMPATIBILITY_STEP_REQUIRED</code> env variable
to <code class="literal">false</code> and rerun the seed (you can pick it from the seed
job&#8217;s properties too).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_can_t_tag_the_repo" href="#_i_can_t_tag_the_repo"></a>10.12&nbsp;I can&#8217;t tag the repo!</h2></div></div></div><p>When you get sth like this:</p><pre class="programlisting"><span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> stderr: remote: Invalid username or password.
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> fatal: Authentication failed <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'https://github.com/marcingrzejszczak/github-webhook/'</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:<span class="hl-number">1740</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandWithCredentials(CliGitAPIImpl.java:<span class="hl-number">1476</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.access$<span class="hl-number">300</span>(CliGitAPIImpl.java:<span class="hl-number">63</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl$<span class="hl-number">8.</span>execute(CliGitAPIImpl.java:<span class="hl-number">1816</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.plugins.git.GitPublisher.perform(GitPublisher.java:<span class="hl-number">295</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.tasks.BuildStepMonitor$<span class="hl-number">3.</span>perform(BuildStepMonitor.java:<span class="hl-number">45</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.perform(AbstractBuild.java:<span class="hl-number">779</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.performAllBuildSteps(AbstractBuild.java:<span class="hl-number">720</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Build$BuildExecution.post2(Build.java:<span class="hl-number">185</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.post(AbstractBuild.java:<span class="hl-number">665</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Run.execute(Run.java:<span class="hl-number">1745</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:<span class="hl-number">43</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.ResourceController.execute(ResourceController.java:<span class="hl-number">98</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Executor.run(Executor.java:<span class="hl-number">404</span>)</pre><p>most likely you&#8217;ve passed a wrong password. Check the <a class="link" href="#">credentials</a> section
on how to update your credentials.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_m_unauthorized_to_deploy_infrastructure_jars_2" href="#_i_m_unauthorized_to_deploy_infrastructure_jars_2"></a>10.13&nbsp;I&#8217;m unauthorized to deploy infrastructure jars</h2></div></div></div><p>Most likely you&#8217;ve forgotten to update your local <code class="literal">settings.xml</code> with the Artifactory&#8217;s
setup. Check out <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code></a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_signing_artifacts" href="#_signing_artifacts"></a>10.14&nbsp;Signing Artifacts</h2></div></div></div><p>In some cases it may be required that when performing a release that the artifacts be signed
before pushing them to the repository.
To do this you will need to import your GPG keys into the Docker image running Jenkins.
This can be done by placing a file called <code class="literal">public.key</code> containing your public key
and a file called <code class="literal">private.key</code> containing your private key in the <code class="literal">seed</code> directory.
These keys will be imported by the <code class="literal">init.groovy</code> script that is run when Jenkins starts.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_using_ssh_keys_for_git" href="#_using_ssh_keys_for_git"></a>10.15&nbsp;Using SSH keys for git</h2></div></div></div><p>The seed job checks if an env variable <code class="literal">GIT_USE_SSH_KEY</code> is set to <code class="literal">true</code>. If that&#8217;s the case
then env variable <code class="literal">GIT_SSH_CREDENTIAL_ID</code> will be chosen as the one that contains the
id of the credential that contains SSH private key. By default <code class="literal">GIT_CREDENTIAL_ID</code> will be picked
as the one that contains username and password to connect to git.</p><p>You can set these values in the seed job by filling out the form / toggling a checkbox.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploy_to_stage_fails_and_doesn_t_redeploy_a_service_kubernetes" href="#_deploy_to_stage_fails_and_doesn_t_redeploy_a_service_kubernetes"></a>10.16&nbsp;Deploy to stage fails and doesn&#8217;t redeploy a service (Kubernetes)</h2></div></div></div><p>There can be a number of reason but remember that for stage we
assume that a sequence of manual steps need to be performed. We don&#8217;t
redeploy any existing services cause most likely you deliberately
have set it up in that way or the other. If in the logs of your application
you can see that you can&#8217;t connect to a service, first ensure that
the service is forwarding traffic to a pod. Next if that&#8217;s not the case
please delete the service and re-run the step in the pipeline. That way
Spring Cloud Pipelines will redeploy the service and the underlying pods.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_ran_out_of_resources_cloud_foundry" href="#_i_ran_out_of_resources_cloud_foundry"></a>10.17&nbsp;I ran out of resources!! (Cloud Foundry)</h2></div></div></div><p>[jenkins-cf-resources]] When deploying the app to stage or prod you can get an exception <code class="literal">Insufficient resources</code>. The way to
 solve it is to kill some apps from test / stage env. To achieve that just call</p><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre><p>You can also execute <code class="literal">./tools/cf-helper.sh kill-all-apps</code> that will remove all demo-related apps
deployed to PCF Dev.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry" href="#_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry"></a>10.18&nbsp;Deploying to test / stage / prod fails - error finding space (Cloud Foundry)</h2></div></div></div><p>If you receive a similar exception:</p><pre class="programlisting"><span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> API endpoint:   https://api.local.pcfdev.io (API version: <span class="hl-number">2.58</span>.<span class="hl-number">0</span>)
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> User:           user
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Org:            pcfdev-org
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space:          No space targeted, use <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'cf target -s SPACE'</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> FAILED
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Error finding space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> not found</pre><p>It means that you&#8217;ve forgotten to <a class="link" href="#">create the spaces</a> in your PCF Dev installation.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_route_is_already_in_use_cloud_foundry" href="#_the_route_is_already_in_use_cloud_foundry"></a>10.19&nbsp;The route is already in use (Cloud Foundry)</h2></div></div></div><p>If you play around with Jenkins / Concourse you might end up with the routes occupied</p><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre><p>Just delete the routes</p><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre><p>You can also execute the <code class="literal">./tools/cf-helper.sh delete-routes</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_execute_helper_scripts_against_a_real_cf_instance_i_m_logged_into_cloud_foundry" href="#_how_to_execute_helper_scripts_against_a_real_cf_instance_i_m_logged_into_cloud_foundry"></a>10.20&nbsp;How to execute helper scripts against a real CF instance I&#8217;m logged into (Cloud Foundry)</h2></div></div></div><p>Assuming that you&#8217;re already logged into the cluster it&#8217;s enough to run the
helper script with the <code class="literal">REUSE_CF_LOGIN=true</code> env variable. Example:</p><pre class="programlisting">REUSE_CF_LOGIN=true ./tools/cf-helper.sh setup-prod-infra</pre><p>This script will create the mysql db, rabbit mq service, download and deploy Eureka
to the space and organization you&#8217;re logged into.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_kubernetes_setup" href="#_kubernetes_setup"></a>11.&nbsp;Kubernetes setup</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_kubernetes_cli_installation" href="#_kubernetes_cli_installation"></a>11.1&nbsp;Kubernetes CLI Installation</h2></div></div></div><p>First you&#8217;ll need to install the <code class="literal">kubectl</code> CLI.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-script" href="#kubernetes-cli-script"></a>11.1.1&nbsp;Script Installation</h3></div></div></div><p>You can use the <code class="literal">tools/k8s-helper.sh</code> script to install <code class="literal">kubectl</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-kubectl</pre><p>and then the <code class="literal">kubectl</code> will get downloaded</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-manual" href="#kubernetes-cli-manual"></a>11.1.2&nbsp;Manual Installation</h3></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Example for Linux</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Check out <a class="link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_top">this page</a> for more information.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="start-minikube-k8s" href="#start-minikube-k8s"></a>11.2&nbsp;Kubernetes Cluster setup</h2></div></div></div><p>We need a cluster of Kubernetes. The best choice will be <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have Kubernetes cluster installed and don&#8217;t
want to use Minikube The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#">clear some apps from Minikube and continue</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-minikube-script" href="#kubernetes-minikube-script"></a>11.2.1&nbsp;Script Installation</h3></div></div></div><p>You can use the <code class="literal">tools/k8s-helper.sh</code> script to install <code class="literal">Minikube</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-minikube</pre><p>and then the <code class="literal">Minikube</code> cluster will get downloaded</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-minikube-manual" href="#kubernetes-minikube-manual"></a>11.2.2&nbsp;Manual Installation</h3></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.</p><p>Example for Linux</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.
Check out <a class="link" href="https://github.com/kubernetes/minikube/releases" target="_top">this page</a> for more info on the installation.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_run_minikube" href="#_run_minikube"></a>11.3&nbsp;Run Minikube</h2></div></div></div><p>Just type in <code class="literal">minikube start</code> to start Kubernetes on your local box.</p><p>To add the dashboard just execute <code class="literal">minikube dashboard</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_certificates_and_workers" href="#_certificates_and_workers"></a>11.4&nbsp;Certificates and Workers</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_minikube_certificates_and_workers" href="#_minikube_certificates_and_workers"></a>11.4.1&nbsp;Minikube Certificates and Workers</h3></div></div></div><p>By default if you install Minikube all the certificates get installed in your
<code class="literal">~/.minikube</code> folder. Your <code class="literal">kubectl</code> configuration under <code class="literal">~/.kube/config</code> will also
get updated to use Minikube.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_manual_certificates_and_workers_setup" href="#_manual_certificates_and_workers_setup"></a>11.4.2&nbsp;Manual Certificates and Workers Setup</h3></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you just want to run the default, demo setup you can skip this section</p></td></tr></table></div><p>To target a given Kubernetes instance one needs to pass around Certificate Authority
key and also user keys.</p><p>You can read more about the instructions on how to generate those keys <a class="link" href="https://coreos.com/kubernetes/docs/latest/openssl.html" target="_top">here</a>.
 Generally speaking if you have a Kubernetes installation (e.g. <code class="literal">minikube</code>) this step
 has already been done for you. Time to reuse those keys on the workers.</p><p>Extracted from the <a class="link" href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html" target="_top">official docs</a>.</p><p>Configure kubectl to connect to the target cluster using the following commands, replacing several values as indicated:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Replace <code class="literal">${MASTER_HOST}</code> with the master node address or name used in previous steps</li><li class="listitem">Replace <code class="literal">${CA_CERT}</code> with the absolute path to the <code class="literal">ca.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_KEY}</code> with the absolute path to the <code class="literal">admin-key.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_CERT}</code> with the absolute path to the <code class="literal">admin.pem</code> created in previous steps</li></ul></div><pre class="screen">$ kubectl config set-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config set-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config set-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_generate_minikube_namespaces" href="#_generate_minikube_namespaces"></a>11.5&nbsp;Generate Minikube namespaces</h2></div></div></div><p>With the running Minikube cluster we need to generate namespaces. Just execute the
<code class="literal">./tools/k8s-helper.sh setup-namespaces</code> to do this.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_demo_setup_cloud_foundry" href="#_the_demo_setup_cloud_foundry"></a>12.&nbsp;The demo setup (Cloud Foundry)</h1></div></div></div><p>The demo uses 2 applications. <a class="link" href="https://github.com/spring-cloud-samples/github-webhook/" target="_top">Github Webhook</a>
and <a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github analytics code</a>. Below you can
see an image of how these application communicate with each other.</p><div class="figure"><a name="d0e5529" href="#d0e5529"></a><p class="title"><b>Figure&nbsp;12.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e5557" href="#d0e5557"></a><p class="title"><b>Figure&nbsp;12.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e5572" href="#d0e5572"></a><p class="title"><b>Figure&nbsp;12.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_pcf_dev" href="#_deploying_production_applications_to_pcf_dev"></a>12.1&nbsp;Deploying production applications to PCF Dev</h2></div></div></div><p>In the real world scenario we wouldn&#8217;t want to automatically provision services like
RabbitMQ, MySQL or Eureka each time we deploy a new application to production. Typically
production is provisioned manually (using automated solutions). In our case, before
you deploy to production you can provision the <code class="literal">pcfdev-prod</code> space using the
 <code class="literal">cf-helper.sh</code>. Just call</p><pre class="programlisting">$ ./cf-helper.sh setup-prod-infra</pre><p>What will happen is that the CF CLI will login to PCF Dev, target <code class="literal">pcfdev-prod</code> space,
setup RabbitMQ (under <code class="literal">rabbitmq-github</code> name), MySQL (under <code class="literal">mysql-github-analytics</code> name)
and Eureka (under <code class="literal">github-eureka</code> name).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_cf" href="#_running_prometheus_on_cf"></a>12.2&nbsp;Running Prometheus on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/prometheus-on-PCF" target="_top">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p><p>Go to <a class="link" href="https://prometheus.io/download/" target="_top">https://prometheus.io/download/</a> and download linux binary. Then call:</p><pre class="screen">cf push sc-pipelines-prometheus -b binary_buildpack -c './prometheus -web.listen-address=:8080' -m 64m</pre><p>Also <code class="literal">localhost:9090</code> in <code class="literal">prometheus.yml</code> should be <code class="literal">localhost:8080</code>.</p><p>The file should look like this to work with the demo setup (change <code class="literal">github-analytics-sc-pipelines.cfapps.io</code>
to your <code class="literal">github-analytics</code> installation).</p><pre class="programlisting"># my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
      monitor: 'codelab-monitor'

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first.rules"
  # - "second.rules"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:8080']

  - job_name: 'demo-app'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    metrics_path: '/prometheus'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['github-analytics-sc-pipelines.cfapps.io']</pre><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-prometheus.cfapps.io/" target="_top">here</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_cf" href="#_running_grafana_on_cf"></a>12.3&nbsp;Running Grafana on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/cf-grafana" target="_top">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p><p>Download tarball from <a class="link" href="https://grafana.com/grafana/download?platform=linux" target="_top">https://grafana.com/grafana/download?platform=linux</a>
Next set <code class="literal">http_port = 8080</code> in <code class="literal">conf/default.ini</code>. Then call</p><pre class="screen">cf push sc-pipelines-grafana -b binary_buildpack -c './bin/grafana-server web' -m 64m</pre><p>The demo is using Grafana Dashboard with ID <code class="literal">2471</code>.</p><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-grafana.cfapps.io/" target="_top">here</a></p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_demo_setup_kubernetes" href="#_the_demo_setup_kubernetes"></a>13.&nbsp;The demo setup (Kubernetes)</h1></div></div></div><p>The demo uses 2 applications. <a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes/" target="_top">Github Webhook</a>
and <a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github analytics code</a>. Below you can
see an image of how these application communicate with each other.</p><div class="figure"><a name="d0e5693" href="#d0e5693"></a><p class="title"><b>Figure&nbsp;13.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e5721" href="#d0e5721"></a><p class="title"><b>Figure&nbsp;13.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e5736" href="#d0e5736"></a><p class="title"><b>Figure&nbsp;13.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_minikube" href="#_deploying_production_applications_to_minikube"></a>13.1&nbsp;Deploying production applications to Minikube</h2></div></div></div><p>In the real world scenario we wouldn&#8217;t want to automatically provision services like
RabbitMQ, MySQL or Eureka each time we deploy a new application to production. Typically
production is provisioned manually (using automated solutions). In our case, before
you deploy to production you can provision the <code class="literal">sc-pipelines-prod</code> namespace using the
 <code class="literal">k8s-helper.sh</code>. Just call</p><pre class="programlisting">$ ./k8s-helper.sh setup-prod-infra</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_kubernetes" href="#_running_prometheus_on_kubernetes"></a>13.2&nbsp;Running Prometheus on Kubernetes</h2></div></div></div><p>Use Helm to install Prometheus. We will point it to the services
deployed to our cluster.</p><p>Create a file called <code class="literal">values.yaml</code>.</p><p><b>values.yaml.&nbsp;</b>
</p><pre class="programlisting">rbac:
  create: false

alertmanager:
  ## If false, alertmanager will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## alertmanager container name
  ##
  name: alertmanager

  ## alertmanager container image
  ##
  image:
    repository: prom/alertmanager
    tag: v0.9.1
    pullPolicy: IfNotPresent

  ## Additional alertmanager container arguments
  ##
  extraArgs: {}

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional alertmanager container environment variable
  ## For instance to add a http_proxy
  ##
  extraEnv: {}

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.alertmanager.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/alertmanager-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, alertmanager Ingress will be created
    ##
    enabled: false

    ## alertmanager Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## alertmanager Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - alertmanager.domain.com

    ## alertmanager Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - alertmanager.domain.com

  ## Alertmanager Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node labels for alertmanager pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  persistentVolume:
    ## If true, alertmanager will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## alertmanager data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## alertmanager data Persistent Volume Claim annotations
    ##
    annotations: {}

    ## alertmanager data Persistent Volume existing claim name
    ## Requires alertmanager.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## alertmanager data Persistent Volume mount root path
    ##
    mountPath: /data

    ## alertmanager data Persistent Volume size
    ##
    size: 2Gi

    ## alertmanager data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of alertmanager data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to alertmanager pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## alertmanager resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the alertmanager service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    # nodePort: 30000
    type: ClusterIP

## Monitors ConfigMap changes and POSTs to a URL
## Ref: https://github.com/jimmidyson/configmap-reload
##
configmapReload:
  ## configmap-reload container name
  ##
  name: configmap-reload

  ## configmap-reload container image
  ##
  image:
    repository: jimmidyson/configmap-reload
    tag: v0.1
    pullPolicy: IfNotPresent

  ## configmap-reload resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}

kubeStateMetrics:
  ## If false, kube-state-metrics will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## kube-state-metrics container name
  ##
  name: kube-state-metrics

  ## kube-state-metrics container image
  ##
  image:
    repository: gcr.io/google_containers/kube-state-metrics
    tag: v1.1.0-rc.0
    pullPolicy: IfNotPresent

  ## Node labels for kube-state-metrics pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to kube-state-metrics pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## kube-state-metrics resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 16Mi
    # requests:
    #   cpu: 10m
    #   memory: 16Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the kube-state-metrics service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

nodeExporter:
  ## If false, node-exporter will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## node-exporter container name
  ##
  name: node-exporter

  ## node-exporter container image
  ##
  image:
    repository: prom/node-exporter
    tag: v0.15.0
    pullPolicy: IfNotPresent

  ## Additional node-exporter container arguments
  ##
  extraArgs: {}

  ## Additional node-exporter hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: textfile-dir
    #   mountPath: /srv/txt_collector
    #   hostPath: /var/lib/node-exporter
    #   readOnly: true

  ## Node tolerations for node-exporter scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for node-exporter pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to node-exporter pods
  ##
  podAnnotations: {}

  ## node-exporter resource limits &amp; requests
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 200m
    #   memory: 50Mi
    # requests:
    #   cpu: 100m
    #   memory: 30Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the node-exporter service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    hostPort: 9100
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9100
    type: ClusterIP

server:
  ## Prometheus server container name
  ##
  name: server

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## Prometheus server container image
  ##
  image:
    repository: prom/prometheus
    tag: v1.8.0
    pullPolicy: IfNotPresent

  ## (optional) alertmanager URL
  ## only used if alertmanager.enabled = false
  alertmanagerURL: ""

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional Prometheus server container arguments
  ##
  extraArgs: {}

  ## Additional Prometheus server hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: certs-dir
    #   mountPath: /etc/kubernetes/certs
    #   hostPath: /etc/kubernetes/certs
    #   readOnly: true

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.server.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/server-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, Prometheus server Ingress will be created
    ##
    enabled: false

    ## Prometheus server Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## Prometheus server Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - prometheus.domain.com

    ## Prometheus server Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-server-tls
    #     hosts:
    #       - prometheus.domain.com

  ## Server Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node tolerations for server scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for Prometheus server pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  nodeSelector: {}

  persistentVolume:
    ## If true, Prometheus server will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## Prometheus server data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## Prometheus server data Persistent Volume annotations
    ##
    annotations: {}

    ## Prometheus server data Persistent Volume existing claim name
    ## Requires server.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## Prometheus server data Persistent Volume mount root path
    ##
    mountPath: /data

    ## Prometheus server data Persistent Volume size
    ##
    size: 8Gi

    ## Prometheus server data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of Prometheus server data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to Prometheus server pods
  ##
  podAnnotations: {}
    # iam.amazonaws.com/role: prometheus

  replicaCount: 1

  ## Prometheus server resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the Prometheus server service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

  ## Prometheus server pod termination grace period
  ##
  terminationGracePeriodSeconds: 300

  ## Prometheus data retention period (i.e 360h)
  ##
  retention: ""

pushgateway:
  ## If false, pushgateway will not be installed
  ##
  enabled: true

  ## pushgateway container name
  ##
  name: pushgateway

  ## pushgateway container image
  ##
  image:
    repository: prom/pushgateway
    tag: v0.4.0
    pullPolicy: IfNotPresent

  ## Additional pushgateway container arguments
  ##
  extraArgs: {}

  ingress:
    ## If true, pushgateway Ingress will be created
    ##
    enabled: false

    ## pushgateway Ingress annotations
    ##
    annotations:
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## pushgateway Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - pushgateway.domain.com

    ## pushgateway Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - pushgateway.domain.com

  ## Node labels for pushgateway pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to pushgateway pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## pushgateway resource requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations:
      prometheus.io/probe: pushgateway
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the pushgateway service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9091
    type: ClusterIP

## alertmanager ConfigMap entries
##
alertmanagerFiles:
  alertmanager.yml: |-
    global:
      # slack_api_url: ''
    receivers:
      - name: default-receiver
        # slack_configs:
        #  - channel: '@you'
        #    send_resolved: true
    route:
      group_wait: 10s
      group_interval: 5m
      receiver: default-receiver
      repeat_interval: 3h
## Prometheus server ConfigMap entries
##
serverFiles:
  alerts: ""
  rules: ""

  prometheus.yml: |-
    rule_files:
      - /etc/config/rules
      - /etc/config/alerts
    scrape_configs:
      - job_name: 'demo-app'
        scrape_interval: 5s
        metrics_path: '/prometheus'
        static_configs:
          - targets:
            - github-analytics.sc-pipelines-prod.svc.cluster.local:8080
      - job_name: prometheus
        static_configs:
          - targets:
            - localhost:9090
      # A scrape configuration for running Prometheus on a Kubernetes cluster.
      # This uses separate scrape configs for cluster components (i.e. API server, node)
      # and services to allow each to use different authentication configs.
      #
      # Kubernetes labels will be added as Prometheus labels on metrics via the
      # `labelmap` relabeling action.
      # Scrape config for API servers.
      #
      # Kubernetes exposes API servers as endpoints to the default/kubernetes
      # service so this uses `endpoints` role and uses relabelling to only keep
      # the endpoints associated with the default/kubernetes service using the
      # default named port `https`. This works for single API server deployments as
      # well as HA API server deployments.
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
          - role: endpoints
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # Keep only the default/kubernetes service endpoints for the https port. This
        # will add targets for each API server which Kubernetes adds an endpoint to
        # the default/kubernetes service.
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: default;kubernetes;https
      - job_name: 'kubernetes-nodes'
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics
      # Scrape config for service endpoints.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape services that have a value of `true`
      # * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need
      # to set this to `https` &amp; most likely set the `tls_config` of the scrape config.
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: If the metrics are exposed on a different port to the
      # service then set this appropriately.
      - job_name: 'kubernetes-service-endpoints'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
            action: replace
            target_label: __scheme__
            regex: (https?)
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+)(?::\d+);(\d+)
            replacement: $1:$2
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name
      - job_name: 'prometheus-pushgateway'
        honor_labels: true
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: pushgateway
      # Example scrape config for probing services via the Blackbox Exporter.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/probe`: Only probe services that have a value of `true`
      - job_name: 'kubernetes-services'
        metrics_path: /probe
        params:
          module: [http_2xx]
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: true
          - source_labels: [__address__]
            target_label: __param_target
          - target_label: __address__
            replacement: blackbox
          - source_labels: [__param_target]
            target_label: instance
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            target_label: kubernetes_name
      # Example scrape config for pods
      #
      # The relabeling allows the actual pod scrape endpoint to be configured via the
      # following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape pods that have a value of `true`
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: Scrape the pod on the indicated port instead of the default of `9102`.
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: (.+):(?:\d+);(\d+)
            replacement: ${1}:${2}
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
networkPolicy:
  ## Enable creation of NetworkPolicy resources.
  ##
  enabled: false</pre><p>
</p><p>Next, let&#8217;s create the prometheus installation with the predefined values.</p><pre class="programlisting">$ helm install --name sc-pipelines-prometheus stable/prometheus -f values.yaml</pre><p>Then you should see the following output</p><pre class="programlisting">NOTES:
The Prometheus server can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local


Get the Prometheus server URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=server"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9090</span>


The Prometheus alertmanager can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-alertmanager.default.svc.cluster.local


Get the Alertmanager URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=alertmanager"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9093</span>


The Prometheus PushGateway can be accessed via port <span class="hl-number">9091</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-pushgateway.default.svc.cluster.local


Get the PushGateway URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=pushgateway"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9093</span>

For more information on running Prometheus, visit:
https://prometheus.io/</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_kubernetes" href="#_running_grafana_on_kubernetes"></a>13.3&nbsp;Running Grafana on Kubernetes</h2></div></div></div><p>Use Helm to install Grafana</p><pre class="programlisting">$ helm install --name sc-pipelines-grafana stable/grafana</pre><pre class="programlisting">NOTES:
<span class="hl-number">1.</span> Get your <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'admin'</span> user password by running:

   kubectl get secret --namespace default sc-pipelines-grafana-grafana -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.data.grafana-admin-password}"</span> | base64 --decode ; <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span>

<span class="hl-number">2.</span> The Grafana server can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:

   sc-pipelines-grafana-grafana.default.svc.cluster.local

   Get the Grafana URL to visit by running these commands in the same shell:

     <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=sc-pipelines-grafana-grafana,component=grafana"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
     kubectl --namespace default port-forward $POD_NAME <span class="hl-number">3000</span>

<span class="hl-number">3.</span> Login with the password from step <span class="hl-number">1</span> and the username: admin</pre><p>Perform the aforementioned steps and add the Grafana&#8217;s datasource
as Prometheus with URL <code class="literal"><a class="link" href="http://sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local" target="_top">http://sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local</a></code></p><p>You can pick the dashboard via the Grafana ID (2471). This is the
default dashboard for the Spring Cloud Pipelines demo apps.</p><p>If you have both apps (<code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>) running on production
we can now trigger the messages. Download the JSON with a sample request
from <a class="link" href="https://github.com/marcingrzejszczak/github-webhook-kubernetes/blob/master/src/test/resources/github-webhook-input/hook-created.json" target="_top">the github-webhook repository</a>.
Next, pick one of the <code class="literal">github-webhook</code> pods and forward its port
locally to a port <code class="literal">9876</code> like this:</p><pre class="programlisting">$ kubectl port-forward --namespace=sc-pipelines-prod $( kubectl get pods --namespace=sc-pipelines-prod | grep github-webhook | head -<span class="hl-number">1</span> | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span> ) <span class="hl-number">9876</span>:<span class="hl-number">8080</span></pre><p>next send a couple of requests (more than 4).</p><pre class="programlisting">$ curl -X POST http://localhost:<span class="hl-number">9876</span>/ -d @path/to/issue-created.json \
--header <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Content-Type: application/json"</span></pre><p>Then if you check out Grafana you&#8217;ll see that you went above the
threshold.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_step_by_step_cloud_foundry_migration" href="#_step_by_step_cloud_foundry_migration"></a>14.&nbsp;Step-by-step Cloud Foundry migration</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_preview" href="#_preview"></a>14.1&nbsp;Preview</h2></div></div></div><p><a class="link" href="https://docs.google.com/presentation/d/e/2PACX-1vSsEHn8cJfz8oWIwwUhdULt7nZzz3bBLK7OqM8UInkZ0LbQBCpPdhMoxsYGPe_90h9OvCu7dFlAimMJ/pub?start=false&amp;loop=false&amp;delayms=3000" target="_top">Click here</a> to
check out the slides by <a class="link" href="https://twitter.com/ciberkleid" target="_top">Cora Iberkleid</a> where she
migrates a setup of applications to be compliant with Spring Cloud Pipelines.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_introduction_2" href="#_introduction_2"></a>14.2&nbsp;Introduction</h2></div></div></div><p>This tutorial covers refactoring applications to comply with, and take advantage of, Spring Cloud Pipelines.</p><p>We will use a simple 3-tier application as an example:</p><div class="figure"><a name="d0e5849" href="#d0e5849"></a><p class="title"><b>Figure&nbsp;14.1.&nbsp;Use Case - Logical View</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_logical.png" alt="use case logical"></div></div></div><br class="figure-break"><p>At the end of this tutorial, it will be possible to instantly create a Concourse pipeline for each app and run successfully through a full lifecycle, from source code commit to production deployment, following the lifecycle stages for testing and deployment recommended by Spring Cloud Pipelines. The app code bases will be improved with organized test coverage, a contract-based API, and a versioned database schema, enabling Spring Cloud Pipelines to carry out stubbed testing and to ensure backward compatibility for API and database schema changes.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_initial_state" href="#_sample_application_initial_state"></a>14.3&nbsp;Sample application - initial state</h2></div></div></div><p>The sample application is implemented using Spring Boot apps for the UI and service tiers, and MySQL for the database.</p><p>The apps are built using Maven and pushed manually to Cloud Foundry. They leverage the three Pivotal Spring Cloud Services: Config Server, Service Discovery, and Circuit Breaker Dashboard. Rabbit is used to propagate Config Server refresh triggers.</p><p>The source code for the two Spring Boot apps is stored on GitHub, as is the backing repo for Config Server.</p><div class="figure"><a name="d0e5869" href="#d0e5869"></a><p class="title"><b>Figure&nbsp;14.2.&nbsp;Use Case - Implementation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_implementation.png" alt="use case implementation"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_end_state" href="#_sample_application_end_state"></a>14.4&nbsp;Sample application - end state</h2></div></div></div><p>Through this tutorial, we will be adding Concourse and JFrog Bintray to manage the application lifecycle.</p><p>We will also be refactoring the application to comply with Spring Cloud Pipelines requirements and recommendations, including adding/organizing tests and introducing database versioning using Flyway and API contracts using Spring Cloud Contract.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_toolset" href="#_tutorial_toolset"></a>14.5&nbsp;Tutorial - toolset</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><span class="strong"><strong>GitHub</strong></span> - sample app source code and config repositories,  a sample stubrunner app repository, and the Spring Cloud Pipelines code base</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top">cloudfoundry-stub-runner-boot</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top">spring-cloud-pipelines</a></li></ul></div></li><li class="listitem"><span class="strong"><strong>Pivotal Web Services</strong></span> - public hosted Cloud Foundry offering <a class="link" href="http://run.pivotal.io" target="_top">free trial accounts</a> and including MySQL, Rabbit, and Pivotal Spring Cloud Services in the Marketplace</li><li class="listitem"><span class="strong"><strong>Concourse</strong></span></li><li class="listitem"><span class="strong"><strong>JFrog Bintray</strong></span> - public hosted Maven repository offering free <a class="link" href="https://bintray.com/signup/oss" target="_top">OSS accounts</a></li><li class="listitem"><span class="strong"><strong>Client Tools</strong></span> - on your local machine, you will need an IDE as well as the mvn, git, cf, and fly (Concourse) CLIs</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_overview" href="#_tutorial_overview"></a>14.6&nbsp;Tutorial - overview</h2></div></div></div><p>The migration steps are broken down into three stages:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara"><span class="strong"><strong>Scaffolding</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Minimal refactoring to comply with basic Spring Cloud Pipelines requirements.</li><li class="listitem">At the end of this stage, each app will have a corresponding pipeline on Concourse. The pipelines will successfully build the apps, store the artifacts in Bintray, tag the GitHub repositories, and deploy the apps to Test, Stage, and Prod spaces in Cloud Foundry.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Tests</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add/organize tests to comply with Spring Cloud Pipelines recommendations. Incorporate flyway for database schema versioning and initial data loading.</li><li class="listitem">At the end of this stage, the pipelines will trigger unit and integration tests during the Build stage, smoke tests in the Test environment, and end-to-end tests in the Stage environment. The pipelines will also ensure backward compatibility for the database, such that you can safely roll back the backend service app, even after the database schema has been updated.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Contracts</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Incorporate Spring Cloud Contract to define the API between the UI and service apps and auto-generate tests and stubs.</li><li class="listitem">At the end of this stage, the pipelines will catch breaking API changes during the Build stage and ensure backward compatibility for the API, such that you can safely roll back the backend service (producer) app, even after an API change.</li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_step_by_step" href="#_tutorial_step_by_step"></a>14.7&nbsp;Tutorial - step-by-step</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_prep_before_you_begin" href="#_prep_before_you_begin"></a>14.7.1&nbsp;Prep: Before you begin</h3></div></div></div><p>If you want to simply review the migration steps explained below, you can look at the various branches in the <a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a> and <a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a> repositories - there is a branch representing the end-state of each stage:</p><div class="figure"><a name="d0e5992" href="#d0e5992"></a><p class="title"><b>Figure&nbsp;14.3.&nbsp;GitHub Branches</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/github_branches.png" alt="github branches"></div></div></div><br class="figure-break"><p>If you want to use this tutorial as a hands-on lab, fork each of the following repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a></li></ul></div><p>Then, create a new directory on your local machine. You may name it anything you like; we will refer to it as <code class="literal">$SCP_HOME</code> throughout this tutorial.</p><p>In <code class="literal">$SCP_HOME</code>, clone your forks of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, as well as the following two repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top">cloudfoundry-stub-runner-boot</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top">spring-cloud-pipelines</a></li></ul></div><p>Finally, create a directory called <code class="literal">$SCP_HOME/credentials</code>. Leave it empty for now.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stage_1_scaffolding" href="#_stage_1_scaffolding"></a>14.7.2&nbsp;Stage 1: Scaffolding</h3></div></div></div><p>In this stage, we make minimal changes to satisfy basic Spring Cloud Pipelines requirements so that the apps can run through the entire pipeline without error. We make "scaffolding" changes only - no code changes.</p><p>The steps in this stage must be completed for both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_1_create_github_branches" href="#_1_1_create_github_branches"></a>1.1 Create GitHub branches</h4></div></div></div><pre class="programlisting">git branch version
git checkout -b sc-pipelines</pre><p>Branch <span class="strong"><strong>version</strong></span> is required to exist, though it can be created as an empty branch. It is used by Spring Coud Pipelines to generate a version number for each new pipeline execution.</p><p>Branch <span class="strong"><strong>sc-pipelines</strong></span> is optional and can be named anything you wish. The intention is for you to use it as a  working branch for the changes suggested in this tutorial (hence we create it and also check it out).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_2_add_maven_wrapper" href="#_1_2_add_maven_wrapper"></a>1.2 Add Maven wrapper</h4></div></div></div><pre class="programlisting">mvn -N io.takari:maven:wrapper</pre><p>This commands adds 4 files to a project:</p><pre class="programlisting">.
&#9500;&#9472;&#9472; mvnw
&#9500;&#9472;&#9472; mvnw.cmd
&#9492;&#9472;&#9472; .mvn
    &#9492;&#9472;&#9472; wrapper
     &nbsp;&nbsp; &#9500;&#9472;&#9472; maven-wrapper.jar
     &nbsp;&nbsp; &#9492;&#9472;&#9472; maven-wrapper.properties</pre><p>Make sure all four files are tracked by Git. For example, you can add the following to the <code class="literal">.gitignore</code> file:</p><pre class="screen">#Exceptions
!/mvnw
!/mvnw.cmd
!/.mvn/wrapper/maven-wrapper.jar
!/.mvn/wrapper/maven-wrapper.properties</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_3_create_bintray_maven_repo_package" href="#_1_3_create_bintray_maven_repo_package"></a>1.3 Create Bintray maven repo package</h4></div></div></div><p>We are using Bintray as the maven repository. Bintray requires that a package exist before any app artifacts can be uploaded.</p><p>Log into the Bintray UI and create the packages as follows. You can use the <code class="literal">Import from GitHub</code> option to create these:</p><div class="figure"><a name="d0e6100" href="#d0e6100"></a><p class="title"><b>Figure&nbsp;14.4.&nbsp;Bintray Packages</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/bintray_packages.png" alt="bintray packages"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_4_configure_distribution_management_using_bintray_maven_repo" href="#_1_4_configure_distribution_management_using_bintray_maven_repo"></a>1.4 Configure distribution management using Bintray maven repo</h4></div></div></div><p>Edit the app <code class="literal">pom.xml</code> files as follows. Make sure the Bintray URLs match the URLs of the corresponding packages created in the previous step. The values you use will be different from the example shown below.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.url&gt;</span>https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span>

...

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distributionManagement&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${distribution.management.release.id}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;url&gt;</span>${distribution.management.release.url}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distributionManagement&gt;</span></pre><p>Though not required by Spring Cloud Pipelines, it makes sense to also configure your local maven settings with the credentials to your Bintray maven repo. To do so, edit your maven settings file, usually <code class="literal">~/.m2/settings.xml</code>. If the file does not exist, create it.</p><p>Note that the <code class="literal">id</code> must match the id specified in the previous step. Also, make sure to use your username and API token (not account password) instead of the sample values shown below.</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;settings&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;servers&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>ciberkleid<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>my-super-secret-api-token<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/servers&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/settings&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_5_push_changes_to_github" href="#_1_5_push_changes_to_github"></a>1.5 Push changes to GitHub</h4></div></div></div><p>Push the above changes to GitHub. You should be pushing the following to each of the two app repos:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">4 new maven wrapper files</li><li class="listitem">a modified .gitignore file</li><li class="listitem">a modified pom.xml</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_6_add_spring_cloud_pipelines_credentials_file" href="#_1_6_add_spring_cloud_pipelines_credentials_file"></a>1.6 Add Spring Cloud Pipelines credentials file</h4></div></div></div><p>In <code class="literal">$SCP_HOME/credentials</code>, make two copies of the file <code class="literal">$SCP_HOME/spring-cloud-pipelines/concourse/credentials-sample-cf.yml</code>. Rename them as <code class="literal">credentials-fortune-service.yml</code> and <code class="literal">credentials-greeting-ui.yml</code>.</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>These files will contain credentials to you GitHub repo, your Bintray repo, and your Cloud Foundry foundation. Hence, we opt to put them in a separate directory. You may choose to store these files in a private git repo, but do not push them to a public repo.</p></td></tr></table></div><p>Edit the git properties of each credentials file. Make sure to replace the sample values shown below as appropriate. For <code class="literal">tools-branch</code>, you may opt to use a fixed release (use v1.0.0.M8 or later for Cloud Foundry). Leave other values as they are, we will update those in later steps.</p><pre class="programlisting">app-url: git@github.com:ciberkleid/fortune-service.git
app-branch: sc-pipelines
tools-scripts-url: https://github.com/spring-cloud/spring-cloud-pipelines.git
tools-branch: master
build-options: ""

github-private-key: |
  -----BEGIN RSA PRIVATE KEY-----
  MIIJKQIBAAKCAgEAvwkL97vBllOSE39Wa5ppczT1cr5Blmkhadfoa1Va2/IBVyvk
  NJ9PqoTI+BahF2EgzweyiDSvKsstlTsG7QgiM9So8Voi2PlDOrXL6uOfCuAS/G8X
  ...
  -----END RSA PRIVATE KEY-----
git-email: ciberkleid@pivotal.io
git-name: Cora Iberkleid</pre><p>Edit the maven repo properties of each credentials file. Make sure to replace the sample values shown below as appropriate. Bintray requires separate URLs for uploads and downloads. If you are using a different artifact repository, such as Artifactory or Nexus, and the repository URL is the same for uploads and downloads, then you do not need to set <code class="literal">repo-with-binaries-for-upload</code>.</p><pre class="programlisting">m2-settings-repo-id: bintray
m2-settings-repo-username: ciberkleid
m2-settings-repo-password: my-super-secret-api-token

repo-with-binaries: https://ciberkleid@my-super-secret-api-token@dl.bintray.com/ciberkleid/maven-repo

repo-with-binaries-for-upload: https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_7_set_concourse_pipeline" href="#_1_7_set_concourse_pipeline"></a>1.7 Set Concourse pipeline</h4></div></div></div><p>At this point, all of the build jobs, which run on Concourse workers, will succeed.</p><p>To verify this, log in to your Concourse target and set the Concourse pipelines. Update the target name in the example below as appropriate.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set greeting-ui pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p greeting-ui -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-greeting-ui.yml"</span> -n

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set fortune-service pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p fortune-service -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-fortune-service.yml"</span> -n</pre><p>Log into the Concourse UI and unpause the pipelines. Start each. You should see that the build jobs all succeed.</p><div class="figure"><a name="d0e6191" href="#d0e6191"></a><p class="title"><b>Figure&nbsp;14.5.&nbsp;Build Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_build_success.png" alt="concourse build success"></div></div></div><br class="figure-break"><p>In addition, you will see a new dev/&lt;version_number&gt; tag in each GitHub repo, as well as the app jars uploaded into Bintray.</p><p>The test, stage, and prod jobs will fail because we have not yet added scaffolding for deployment to Cloud Foundry. We will do that next.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_8_add_cloud_foundry_manifest" href="#_1_8_add_cloud_foundry_manifest"></a>1.8 Add Cloud Foundry manifest</h4></div></div></div><p>If you are deploying to Cloud Foundry, you may already be routinely including manifest files with your apps. Our sample apps did not have manifest files, so we add them now.</p><p>In the <code class="literal">greeting-ui</code> repo, create a <code class="literal">manifest.yml</code> file as follows:</p><pre class="programlisting">---
applications:
- name: greeting-ui
  timeout: 120
  services:
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre><p>In the <code class="literal">fortune-service</code> repo, create a <code class="literal">manifest.yml</code> file as follows:</p><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre><p>The <code class="literal">TRUST_CERTS</code> variable is used by the Pivotal Spring Cloud Services (Config Server, Service Registry, and Circuit Breaker Dashboard), which we are using in this example. The value specified above assumes deployment to Pivotal Web Services. Update it accordingly if you are deploying to a different Cloud Foundry foundation, or you can leave it out altogether if you are replacing the Pivotal Spring Cloud Services with alternative implementations (e.g. deploying apps and exposing them as user-provided services).</p><p>You may add additional values to the manifest files if you wish, for example if additional values are useful for any manual deployment you may still want to do, or desirable in your Spring Cloud Pipelines deployment. For example, an alternative manifest.yml for <code class="literal">fortune-service</code> could be as follows:</p><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  instances: 3
  memory: 1024M
  buildpack: https://github.com/cloudfoundry/java-buildpack.git
  random-route: true
  path: ./target/fortune-service-0.0.1-SNAPSHOT.jar
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: someProfile
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre><p>Note that <code class="literal">random-route</code> and <code class="literal">path</code> are ignored by Spring Cloud Pipelines. <code class="literal">instances</code> is honored in stage and prod, but overridden with a value of 1 for test.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_9_add_spring_cloud_pipelines_manifest" href="#_1_9_add_spring_cloud_pipelines_manifest"></a>1.9 Add Spring Cloud Pipelines manifest</h4></div></div></div><p>The Cloud Foundry manifest created in the previous step includes the logical names of the services to which the apps should be bound, but it does describe how the services can be provisioned. Hence, we add a second manifest file so that Spring Cloud Pipelines can provision the services.</p><p>Add a file called <code class="literal">sc-pipelines.yml</code> to each app, and include the same list of services as in the corresponding <code class="literal">manifest.yml</code>. Add the necessary details such that Spring Cloud Pipelines can construct a <code class="literal">cf create-service</code> command.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The `type: broker' parameter shown below instructs Spring Cloud Pipelines to provision a service using `cf create-service'. Other service types are also supported: cups, syslog, route, app, and stubrunner.</p></td></tr></table></div><p>More specifically, for <code class="literal">greeting-ui</code>, create an <code class="literal">sc-pipelines.yml</code> file with the following content:</p><pre class="programlisting">test:
  services:
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre><p>The <code class="literal">sc-pipelines.yml</code> file for <code class="literal">fortune-service</code> is similar, with the addition of the <code class="literal">fortune-db</code> service:</p><pre class="programlisting">test:
  # list of required services
  services:
    - name: fortune-db
      type: broker
      broker: cleardb
      plan: spark
      useExisting: true
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre><p>The values above assume deployment to Pivotal Web Services. If you are deploying to a different Cloud Foundry foundation, please update the values accordingly. Also, make sure to replace the <code class="literal">config-server</code> uri with the address of your fork of the <a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a> repo.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the <code class="literal">useExisting: true</code> parameter above. By default, Spring Cloud Pipelines will delete and recreate services in the <code class="literal">test</code> space. To override this behavior and re-use existing services, we set <code class="literal">useExisting: true</code>. This is helpful in cases where services  may take time to provision and initialize, where there is no risk in re-using them between pipeline runs, or where it is desirable to retain the service instance from the last pipeline run (e.g. a database migration).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_10_push_changes_to_github" href="#_1_10_push_changes_to_github"></a>1.10 Push changes to GitHub</h4></div></div></div><p>Push the above changes to GitHub. You should be pushing the following to each of the two app repos:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">new app manifest file</li><li class="listitem">new sc-pipelines manifest file</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_11_create_cloud_foundry_orgs_spaces" href="#_1_11_create_cloud_foundry_orgs_spaces"></a>1.11 Create Cloud Foundry Orgs/Spaces</h4></div></div></div><p>Spring Cloud Pipelines requires that the Cloud Foundry test, stage, and prod spaces exist before a pipeline is run. If you wish, you can use different foundations, orgs, and users for each. For simplicity, in this example, we use a single foundation (PWS), a single org, and a single user.</p><p>You can name the org(s) and spaces anything you like. Each app requires its own test space. The stage and prod spaces are shared.</p><p>For this example, create the following spaces:</p><pre class="programlisting">cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-greeting-ui
cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-fortune-service
cf create-space scp-stage
cf create-space scp-prod</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_12_create_cloud_foundry_stage_and_prod_service_instances" href="#_1_12_create_cloud_foundry_stage_and_prod_service_instances"></a>1.12 Create Cloud Foundry stage and prod service instances</h4></div></div></div><p>Spring Cloud Pipelines will dynamically create the services in the test spaces as per the <code class="literal">sc-pipelines.yml</code> file we created previously. Optionally, a second section can be added to the <code class="literal">sc-pipelines.yml</code> file for the stage environment, and these will be created dynamically as well. Prod services, however, must always be created manually.</p><p>For this example, we will create the stage and services manually.</p><p>Create the services listed in the app manifest files in both <code class="literal">scp-stage</code> and <code class="literal">scp-prod</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_13_update_spring_cloud_pipelines_credentials_file" href="#_1_13_update_spring_cloud_pipelines_credentials_file"></a>1.13 Update Spring Cloud Pipelines credentials file</h4></div></div></div><p>Update the <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> credentials files with Cloud Foundry information. Replace values in the example below as appropriate for your Cloud Foundry environment.</p><p>Notice that the space name specified is a prefix. Spring Cloud Pipelines will append the app name, matching the test space names created previously. The stage and prod space names are not prefixes and will not be altered by Spring Cloud Pipelines.</p><p>Note also the <code class="literal">paas-hostname-uuid</code>. The value will be included in each route created. This value is optional, but it is useful in shared/multi-tenant environments such as PWS, as it helps ensure routes are unique. Change it to a unique uuid of your choosing.</p><pre class="programlisting">pipeline-descriptor: sc-pipelines.yml

paas-type: cf

paas-hostname-uuid: cyi

# test values
paas-test-api-url: https://api.run.pivotal.io
paas-test-username: ciberkleid@pivotal.io
paas-test-password: secret
paas-test-org: S1Pdemo12
paas-test-space-prefix: scp-test

# stage values
paas-stage-api-url: https://api.run.pivotal.io
paas-stage-username: ciberkleid@pivotal.io
paas-stage-password: my-super-secret-password
paas-stage-org: S1Pdemo12
paas-stage-space: scp-stage

# prod values
paas-prod-api-url: https://api.run.pivotal.io
paas-prod-username: ciberkleid@pivotal.io
paas-prod-password: my-super-secret-password
paas-prod-org: S1Pdemo12
paas-prod-space: scp-prod</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_14_update_concourse_pipeline_with_updated_credentials_files" href="#_1_14_update_concourse_pipeline_with_updated_credentials_files"></a>1.14 Update Concourse pipeline with updated credentials files</h4></div></div></div><p>Set the Concourse pipelines again, as we did previously, to update them with the values added to the credentials files. The test, stage, and prod jobs will all now succeed.</p><div class="figure"><a name="d0e6383" href="#d0e6383"></a><p class="title"><b>Figure&nbsp;14.6.&nbsp;Test, Stage, &amp; Prod Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_test_stage_prod_success.png" alt="concourse test stage prod success"></div></div></div><br class="figure-break"><p>On Cloud Foundry, you will now see the apps deployed in the test, stage, and prod spaces. The image below shows the deploymnet of <code class="literal">fortune-service</code> to its isolated and dedicated test space, with the 5 services declared in its manifest files (<code class="literal">sc-pipelines.yml</code> for provisioning, and <code class="literal">manifest.yml</code> for binding). It also shows the deployment of the same app to the shared prod space, including the stopped instance of the previous version. If a rollback were deemed necessary, the <code class="literal">prod-rollback</code> job in the pipeline could be triggered to remove the currently running version, remove the <code class="literal">prod/&lt;version_number&gt;</code> tag from GitHub, and re-start the former (<span class="strong"><strong>"venerable"</strong></span>) version.</p><div class="figure"><a name="d0e6412" href="#d0e6412"></a><p class="title"><b>Figure&nbsp;14.7.&nbsp;Cloud Foundry Test and Prod Deployment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/cf_test_and_prod_deployed.png" alt="cf test and prod deployed"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_1_recap_next_steps" href="#_stage_1_recap_next_steps"></a>Stage 1 Recap &amp; next steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">By adding the basic scaffolding needed to enable Spring Cloud Pipelines to manage the lifecycle of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> from source code commit to production deploy, we have made it possible for the app dev teams to instantly and easily create pipelines for each app using a common, standardized template</li><li class="listitem"><p class="simpara">We can count on the pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">automatically provision services in test spaces, and optionally in stage as well</li><li class="listitem">dynamically clean up the test spaces between pipeline executions</li><li class="listitem">upload the app artifacts to the maven repo (Bintray)</li><li class="listitem">tag the GitHub repositories with <code class="literal">dev/&lt;version_number&gt;</code> and <code class="literal">prod/&lt;version_number&gt;</code></li></ul></div></li><li class="listitem">After each successful pipeline run, we are in a position to roll back to the last deployed version using the <code class="literal">prod-rollback</code> job, if necessary</li></ul></div><p>These accomplishments are extremely valuable, but in order to derive confidence and reliability from the pipelines, we need to incorporate testing. We do this in Stage 2 of the app migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stage_2_tests" href="#_stage_2_tests"></a>14.7.3&nbsp;Stage 2: Tests</h3></div></div></div><p>In this stage, we enable Spring Cloud Pipelines to execute tests so that we can increase confidence in the code being deployed. We do so by adding test profiles to the pom.xml files, and then organizing and/or adding tests in a way that corresponds to the profiles. By doing so, we are establishing standards around testing across development teams in the enterprise.</p><p>We will also enable database schema versioning in this stage, thereby providing the foundation for rollback testing during schema changes.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_1_add_maven_profiles" href="#_2_1_add_maven_profiles"></a>2.1 Add Maven profiles</h4></div></div></div><p>For both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, add a <code class="literal">profiles</code> section to the <code class="literal">pom.xml</code> file, as shown below. Note that we are adding four profiles:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">default</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For unit and integration tests. Note that this profile includes all tests except those that will explicitly be called by the smoke and e2e profiles.</li><li class="listitem">Tests matching this profile will be executed during the build-and-upload job</li></ul></div></li><li class="listitem"><p class="simpara">apicompatibility</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For ensuring backward compatibility in case of API changes. Note that this is not effective until Stage 3, when we will add contracts. However, we add this profile now to ensure the api-compatibility-check job does not execute other tests.</li></ul></div></li><li class="listitem"><p class="simpara">smoke</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the app deployed in the test space.</li></ul></div></li><li class="listitem"><p class="simpara">e2e</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the app deployed in the stage space.</li></ul></div></li></ul></div><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profiles&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>smoke<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>e2e<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profiles&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_2_add_organize_tests" href="#_2_2_add_organize_tests"></a>2.2 Add/organize tests</h4></div></div></div><p>Next, we ensure that we have a matching test package structure in our apps:</p><div class="figure"><a name="d0e6528" href="#d0e6528"></a><p class="title"><b>Figure&nbsp;14.8.&nbsp;Test Package Structure</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/test_package_structure.png" alt="test package structure"></div></div></div><br class="figure-break"><p>Note that we are creating matching packages for the default, smoke, and e2e profiles only. We will address the package for the apicompatibility profile in Stage 3.</p><p>When working with your own apps, if you have existing tests, you would now move them into one of these packages now, and rename them so that they are included in the filters declared in the profiles (i.e. the file names end in <code class="literal">Test.java</code> or <code class="literal">Tests.java</code>)</p><p>In the case of our sample apps, there are no tests, so we add some now as follows.</p><p><span class="strong"><strong>fortune-service default tests</strong></span></p><p>Add your unit and integration tests so that they match the default profile as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">fortune-service</code> application running on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we will add two tests, one that loads the context, and another that verifies the number of rows expected in the database:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.assertj.core.api.Assertions.assertThat;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.junit.Assert.*;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = FortuneServiceApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> JdbcTemplate template;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> testDefaultSettings() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {
        assertThat(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.template.queryForObject(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SELECT COUNT(*) from FORTUNE"</span>,
                Integer.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>)).isEqualTo(<span class="hl-number">7</span>);
    }

}</pre><p><span class="strong"><strong>fortune-service smoke tests</strong></span></p><p>Add your smoke tests so that they match the smoke profile as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-test-fortune-service</code> space. Two versions of these tests are executed against the app:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">the current version, in the <code class="literal">test-smoke</code> job</li><li class="listitem">the latest prod version, in the <code class="literal">test-rollback-smoke</code> job</li></ol></div><div class="figure"><a name="d0e6600" href="#d0e6600"></a><p class="title"><b>Figure&nbsp;14.9.&nbsp;fortune-service Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_smoke_tests.png" alt="fortune service smoke tests"></div></div></div><br class="figure-break"><p>In the test environment, we choose to verify that <code class="literal">fortune-service</code> is retrieving a fortune from <code class="literal">fortune-db</code>, and not returning its Hystrix fallback response:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre><p><span class="strong"><strong>fortune-service e2e tests</strong></span></p><p>Add your e2e tests so that they match the e2e profile as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">greeting-ui</code> is also present.</p><div class="figure"><a name="d0e6639" href="#d0e6639"></a><p class="title"><b>Figure&nbsp;14.10.&nbsp;fortune-service E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_e2e_tests.png" alt="fortune service e2e tests"></div></div></div><br class="figure-break"><p>In the e2e environment, we choose to use a string replacement to obtain the URL for <code class="literal">greeting-ui</code>. We also choose to verify that we are hitting <code class="literal">fortune-db</code> and not receiving Hystrix fallback responses from either application:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// The app is running in CF but the tests are executed from Concourse worker,</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// so the test will deduce the url to greeting-ui: it will assume the same host</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// as fortune-service, and simply replace "fortune-service" with "greeting-ui" in the url</span>

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl.replace(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"fortune-service"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"greeting-ui"</span>) + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback responses from both fortune and greeting</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre><p><span class="strong"><strong>greeting-ui default tests</strong></span></p><p>Add your unit and integration tests so that they match the default profile as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">greeting-ui</code> application running on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we will add one test that loads the context:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> GreetingUIApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

}</pre><p><span class="strong"><strong>greeting-ui smoke tests</strong></span></p><p>Add your smoke tests so that they match the smoke profile as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-test-greeting-ui</code> space. Two versions of these tests are executed against the app:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">the current version, in the <code class="literal">test-smoke</code> job</li><li class="listitem">the latest prod version, in the <code class="literal">test-rollback-smoke</code> job</li></ol></div><div class="figure"><a name="d0e6709" href="#d0e6709"></a><p class="title"><b>Figure&nbsp;14.11.&nbsp;greeting-ui Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_smoke_tests.png" alt="greeting ui smoke tests"></div></div></div><br class="figure-break"><p>Since <code class="literal">fortune-service</code> is not deployed to the <code class="literal">scp-test-greeting-ui</code> space, we expect to receive the Hystrix fallback response defined in <code class="literal">greeting-ui</code>. Hence, our smoke test validates that condition:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

    <em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

    RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fallback_fortune() {
        ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
                .getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

        BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Expect the hystrix fallback response</span>
        BDDAssertions.then(response.getBody()).contains(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
    }

}</pre><p><span class="strong"><strong>greeting-ui e2e tests</strong></span></p><p>Add your e2e tests so that they match the e2e profile as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These will be executed on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">fortune-service</code> is also present.</p><div class="figure"><a name="d0e6751" href="#d0e6751"></a><p class="title"><b>Figure&nbsp;14.12.&nbsp;greeting-ui E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_e2e_tests.png" alt="greeting ui e2e tests"></div></div></div><br class="figure-break"><p>In the e2e environment, we choose to verify that we are hitting <code class="literal">fortune-service</code> and not receiving the Hystrix fallback response from <code class="literal">greeting-ui</code>:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_3_enable_database_versioning" href="#_2_3_enable_database_versioning"></a>2.3 Enable database versioning</h4></div></div></div><p>At this point will also incorporate <a class="link" href="https://flywaydb.org/" target="_top">Flyway</a>, an OSS database migration tool, to track database schema versions and handle schema changes and data loading.</p><p>This change only needs to be made to <code class="literal">fortune-service</code>, since <code class="literal">fortune-service</code> owns the interaction with <code class="literal">fortune-db</code>.</p><p><span class="strong"><strong>Add Flyway dependency</strong></span></p><p>We first add the Flyway dependency to the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code>. We need not add a version as Spring Boot will take care of that for us.</p><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.flywaydb<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>flyway-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span></pre><p><span class="strong"><strong>Create Flyway migration</strong></span></p><p>Next, we create a migration directory and our initial migration file following Flyway&#8217;s file naming convention:</p><div class="figure"><a name="d0e6807" href="#d0e6807"></a><p class="title"><b>Figure&nbsp;14.13.&nbsp;fortune-service Flyway File Name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_file_name.png" alt="fortune service flyway file name"></div></div></div><br class="figure-break"><p>Note the filename specifies the version (<code class="literal">V1</code>), followed by two underscore characters.</p><p>We place our CREATE TABLE and INSERT statements in our <code class="literal">src/main/resources/db/migration/V1__init.sql</code> file:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">CREATE</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">TABLE</span> fortune (
  id <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">BIGINT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">PRIMARY</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">KEY</span> AUTO_INCREMENT,
  text <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">varchar</span>(<span class="hl-number">255</span>) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">not</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">null</span>
);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do what works.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do the right thing.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Always be kind.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You learn from your mistakes... You will learn a lot today.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You can always find happiness at work on Friday.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You will be hungry again in one hour.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Today will be an awesome day!'</span>);</pre><p><span class="strong"><strong>Disable JPA DDL initialization</strong></span></p><p>Now that we are relying on Flyway to create and populate the schema, we need to disable JPA-based database initialization. We can set <code class="literal">ddl-auto</code> to <code class="literal">validate</code>, which will validate the schema against the application entities and throw an error in case of a mismatch, but not actually generate the schema:</p><pre class="programlisting">spring:
  jpa:
    hibernate:
      ddl-auto: validate</pre><p>There are a few options for where to store the <code class="literal">ddl-auto</code> configuration, both in terms of location (in the <code class="literal">fortune-service</code> app or on the <code class="literal">app-config</code> GitHub repo) and in terms of file name. For this example, update the <code class="literal">application.yml</code> in the <code class="literal">fortune-service</code> app for local testing. additionally, save these values in a new file called <code class="literal">application-flyway.yml</code> on your fork of <a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a>.</p><p>By convention, <code class="literal">fortune-service</code> will pick up the configurations in <code class="literal">application-flyway.yml</code> if the string <code class="literal">flyway</code> is in the list of active Spring profiles. Thus, we add <code class="literal">flyway</code> to the environment variable <code class="literal">SPRING_PROFILES_ACTIVE</code> via the <code class="literal">fortune-service</code> <code class="literal">manifest.yml</code>:</p><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: flyway
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre><p><span class="strong"><strong>Remove non-Flyway data loading</strong></span></p><p>We can now remove the old code that populated the database. In our sample app, this was found in class <code class="literal">io.pivotal.FortuneServiceApplication</code>. The following shows the code we now remove:</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    CommandLineRunner loadDatabase(FortuneRepository fortuneRepo) {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> args -&gt; {
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            logger.debug("loading database..");</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(1L, "Do what works."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(2L, "Do the right thing."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(3L, "Always be kind."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(4L, "You learn from your mistakes... You will learn a lot today."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(5L, "You can always find happiness at work on Friday."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(6L, "You will be hungry again in one hour."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(7L, "Today will be an awesome day!"));</span>
            logger.debug(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"record count: {}"</span>, fortuneRepo.count());
            fortuneRepo.findAll().forEach(x -&gt; logger.debug(x.toString()));
        };

    }</pre><p>We also no longer need the Fortune entity constructors, so we can comment these out in class <code class="literal">io.pivotal.fortune.Fortune</code> as shown below:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune() {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune(Long id, String text) {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        super();</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.id = id;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.text = text;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span></pre><p><span class="strong"><strong>Flyway integration summary</strong></span></p><p>With that, we have completed the setup for Flyway and our database schema is now versioned. From this point onward, Spring Boot will call <code class="literal">Flyway.migrate()</code> to perform the database migration. As long as we follow Flyway conventions for future schema changes, Flyway will take care of tracking the schema version and migrating the database for us.</p><p>From a rollback perspective, Spring Cloud Pipelines includes two jobs in the <code class="literal">test</code> phase - <code class="literal">test-rollback-deploy</code> and <code class="literal">test-rollback-smoke</code> - wherein it validates that the latest prod jar works against the newly updated database. The purpose is to ensure that we can roll back the application in prod if a problem is discovered after the prod database schema has been updated, and avoid the burden of rolling back the database.</p><p>Read more about <a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-use-a-higher-level-database-migration-tool" target="_top">Spring Boot database initialization with Flyway</a> for further information, including Flyway configuration options.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_4_push_changes_to_github" href="#_2_4_push_changes_to_github"></a>2.4 Push changes to GitHub</h4></div></div></div><p>For <code class="literal">greeting-ui</code>, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">pom.xml</li><li class="listitem">src/test/java/e2e/E2eTests.java</li><li class="listitem">src/test/java/io/pivotal/GreetingUIApplicationTests.java</li><li class="listitem">src/test/java/smoke/SmokeTests.java</li></ul></div><p>For <code class="literal">fortune-service</code>, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">pom.xml</li><li class="listitem">src/test/java/e2e/E2eTests.java</li><li class="listitem">src/test/java/io/pivotal/FortuneServiceApplicationTests.java</li><li class="listitem">src/test/java/smoke/SmokeTests.java</li><li class="listitem">src/main/resources/db/migration/V1__init.sql</li><li class="listitem">src/main/resources/application.yml</li><li class="listitem">manifest.yml</li><li class="listitem">src/main/java/io/pivotal/FortuneServiceApplication.java</li><li class="listitem">src/main/java/io/pivotal/fortune/Fortune.java</li></ul></div><p>For <code class="literal">app-config</code>, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application-flyway.yml</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_5_re_run_the_pipelines" href="#_2_5_re_run_the_pipelines"></a>2.5 Re-run the pipelines</h4></div></div></div><p>Run through the pipelines again and view the output for the jobs that run the default, smoke, and e2e tests. You will see that the tests we added in this stage were executed.</p><p>As you run through the pipelines a second time, you will see the smoke tests from the latest prod version run against the database in the <code class="literal">test-rollback-smoke</code> job. In this case there is no schema upgrade, but nonetheless the tests confirm that the latest prod version of the app can be used with the current database schema.</p><p>You can see the database version information stored in the database by Flyway either by querying the database itself or by hitting the flyway endpoint on the <code class="literal">fortune-service</code> URL. Here is an example from the scp-stage environment:</p><div class="figure"><a name="d0e7008" href="#d0e7008"></a><p class="title"><b>Figure&nbsp;14.14.&nbsp;fortune-service Flyway Schema Info</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_schema_info.png" alt="fortune service flyway schema info"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_2_recap_next_steps" href="#_stage_2_recap_next_steps"></a>Stage 2 Recap &amp; next steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">By integrating our applications with the testing strategy built into Spring Cloud Pipelines, we have increased the effectiveness of the pipelines, as well as our confidence in them</li><li class="listitem">Established a standard approach to organizing tests that will bring consistency within and across development teams</li><li class="listitem">Enabled auto-managed database versioning and backward compatibility testing that will alleviate database schema management throughout the release management lifecycle</li></ul></div><p>We are now positioned to add any unit, integration, smoke, and end-to-end tests to our code base and extract a very high level of reliability and confidence from our pipelines. We are also better positioned to ensure that our dev teams conform to these practices, given the structure imposed by Spring Cloud Pipelines and the fast feedback and visibility we gain from the pipelines as they execute the tests.</p><p>However, we could benefit further by incorporating contracts to define and test the API integration points between applications. We do this in Stage 3 of the app migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stage_3_contracts" href="#_stage_3_contracts"></a>14.7.4&nbsp;Stage 3: Contracts</h3></div></div></div><p>In this stage, we introduce contract-based programming practices into our sample application. Doing so improves API management capabilities, including defining, communicating, and testing API semantics. It also enables us to catch breaking API changes (i.e. validate API backward compatibility) in the build phase. This will extend the effectiveness of the pipelines, encourage better communication and programming practices across development teams, and provide faster feedback to developers.</p><p>We will integrate Spring Cloud Contract and add contracts, stubs, and a stub runner. We will also now complete and make use of the apicompatibility profile defined in Stage 2.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_1_create_a_contract" href="#_3_1_create_a_contract"></a>3.1 Create a contract</h4></div></div></div><p>Let&#8217;s start by creating the contract for the interaction between <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>. The contract should describe the following expectation:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">greeting-ui</code> makes a <code class="literal">GET</code> request to the root URL of <code class="literal">fortune-service</code> and expects a response with status 200 and a string ("foo fortune") in the body</li></ul></div><p>We codify this using groovy syntax as follows:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.spec.Contract

Contract.make {
    description(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"
</span>should <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> a fortune string
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">")
</span>    request {
        method GET()
        url <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>
    }
    response {
        status <span class="hl-number">200</span>
        body <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>
    }
}</pre><p>Save this contract in the <code class="literal">fortune-service</code> code base in the following location, which is compliant with Spring Cloud Contract convention (<code class="literal">src/test/resources/contracts/&lt;service-name&gt;/&lt;contract-file&gt;</code>):</p><div class="figure"><a name="d0e7078" href="#d0e7078"></a><p class="title"><b>Figure&nbsp;14.15.&nbsp;fortune-service Flyway Contract File</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_contract_file.png" alt="fortune service contract file"></div></div></div><br class="figure-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can optionally enable your IDE to assist with contract syntax by adding the Spring Cloud Contract Verifier to your <code class="literal">pom.xml</code> file. It is pluggable, and includes groovy and pact by default.</p></td></tr></table></div><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_2_create_a_base_class_for_contract_tests" href="#_3_2_create_a_base_class_for_contract_tests"></a>3.2 Create a base class for contract tests</h4></div></div></div><p>Now that we have a codified contract, we want to enable auto-generation of contract-based tests. The auto-generation, which we will configure in the next steps, requires a base class that stubs out the service that satisfies the API call, so that we can run the test without external dependencies (e.g. the DB). The objective is to focus on testing API semantics.</p><p>We create the base class in the <code class="literal">fortune-service</code> test package as follows:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.restassured.module.mockmvc.RestAssuredMockMvc;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Before;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.mockito.BDDMockito;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> BaseClass {

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> setup() {
        FortuneService service = BDDMockito.mock(FortuneService.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
        BDDMockito.given(service.getFortune()).willReturn(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
        RestAssuredMockMvc.standaloneSetup(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> FortuneController(service));
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_3_enable_automated_contract_based_testing" href="#_3_3_enable_automated_contract_based_testing"></a>3.3 Enable automated contract-based testing</h4></div></div></div><p>Now that we have a contract and a base class, we can use the <span class="strong"><strong>Spring Cloud Contract maven plugin</strong></span> to auto-generate contract tests, stubs, and a stub jar.</p><p>First we add the Spring Cloud Contract version to the list of properties in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file, since we will reference it when we enable the Spring Cloud Contract maven plugin:</p><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;spring-cloud-contract.version&gt;</span>1.2.1.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/spring-cloud-contract.version&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre><p>Next, we edit the <code class="literal">default</code> profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract maven plugin</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests</li><li class="listitem">Configure it to place auto-generated tests in the test package <code class="literal">io.pivotal.fortune.contracttests</code></li></ul></div><p>Note that the package of the contracttests will be included by the <code class="literal">include</code> filter in the <code class="literal">default</code> profile, so these tests will be run against the app during the <code class="literal">build-and-upload</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the app conforms to the contract.</p><p>Here is the complete profile:</p><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre><p>When the app is built, the Spring Cloud Contract maven plugin will also now produce a stub and a stub jar containing the contract and stub. This stub jar will be uploaded to Bintray, along with the usual app jar. As we will see shortly, this stub jar can be used by the <code class="literal">greeting-ui</code> dev team while they wait for <code class="literal">fortune-service</code> to be completed. Note that this gives the <code class="literal">greeting-ui</code> dev team a producer to test against that is based on a mutually agreed-upon contract without the lead time of having to wait for <code class="literal">fortune-service</code> to implement anything more than a base class, and without having to manually stub out calls to <code class="literal">fortune-service</code> based on arbitrary or static responses.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Package the project locally (run <code class="literal">mvn package</code>) to observe the tests, stubs, and stub jar that the Spring Cloud Contract maven plugin generates. See the image below for reference.</p></td></tr></table></div><div class="figure"><a name="d0e7192" href="#d0e7192"></a><p class="title"><b>Figure&nbsp;14.16.&nbsp;Generated Tests and Stubs</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_generated_tests.png" alt="fortune service generated tests"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_4_enable_backward_compatibility_api_check" href="#_3_4_enable_backward_compatibility_api_check"></a>3.4 Enable backward compatibility API check</h4></div></div></div><p>To enable Spring Cloud Pipelines to catch any breaking API changes during the <code class="literal">build-api-compatibility-check</code> job, we add the Spring Cloud Contract maven plugin to the <code class="literal">apicompatibility</code> profile as well.</p><p>In this case, we want the plugin to generate tests based on contracts outside of the project (the ones from the latest prod version), so we configure the plugin to download the latest prod stub jar, which contains the old contract. The plugin will use the old contract and the specified base class, which in our example is the same as the one in the previous step, to generate contract tests. These tests are run against the new code to validate that it is still compatible with consumers complying with the prior contract. This ensures backward compatibility for the API.</p><p>In short, we edit the apicompatibility profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract maven plugin</li><li class="listitem">Configure it to download the latest prod stub jar from Bintray to obtain the old contract</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests (we are using the same one as in the prrior step)</li><li class="listitem">Configure it to place auto-generated tests in the test package <code class="literal">io.pivotal.fortune.contracttests</code></li></ul></div><p>Note that the package of the contracttests matches the <code class="literal">include</code> filter in the <code class="literal">apicompatibility</code> profile, so these tests will be run against the app during the <code class="literal">build-api-compatibility-check</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the app conforms to the old contract.</p><p>Here is the complete profile:</p><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsRepositoryUrl&gt;</span>${repo.with.binaries}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsRepositoryUrl&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractDependency&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>${project.groupId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>${project.artifactId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;classifier&gt;</span>stubs<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/classifier&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${latest.production.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractDependency&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsPath&gt;</span>/<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsPath&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre><p>The values for <code class="literal">${repo.with.binaries}</code> and <code class="literal">${latest.production.version}</code> will be injected dynamically by Spring Cloud Pipelines. You can run this locally by providing these values manually as system properties in the maven command.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_5_push_changes_to_github" href="#_3_5_push_changes_to_github"></a>3.5 Push changes to GitHub</h4></div></div></div><p>All changes in Stage 3 thus far are in <code class="literal">fortune-service</code>. At this point, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">pom.xml</li><li class="listitem">src/test/resources/contracts/greeting-ui/shouldReturnAFortune.groovy</li><li class="listitem">src/test/java/io/pivotal/fortune/BaseClass.java</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_6_re_run_the_fortune_service_pipeline" href="#_3_6_re_run_the_fortune_service_pipeline"></a>3.6 Re-run the fortune-service pipeline</h4></div></div></div><p>Run through the <code class="literal">fortune-service</code> pipeline to generate stubs. The following output from the <code class="literal">build-and-upload</code> job shows the auto-generation of tests and stubs:</p><div class="figure"><a name="d0e7295" href="#d0e7295"></a><p class="title"><b>Figure&nbsp;14.17.&nbsp;fortune-service build-and-upload Test and Stub Generation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_build_and_upload_test_and_stub_generation.png" alt="fortune service build and upload test and stub generation"></div></div></div><br class="figure-break"><p>You will also see output in the <code class="literal">build-and-upload</code> job showing the execution of these tests against the code.</p><p>Additionally, you will see the stub jar uploaded to Bintray along with the usual app jar.</p><p>Finally, as you run through the pipeline a second time, you will see the contract tests from the latest prod version run against the new code in the output of the <code class="literal">build-api-compatibility-check</code> job. In this case there is no API change, but nonetheless the tests confirm that the latest prod version of the API can be used with the current code base.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_7_enable_stubs_for_integration_tests" href="#_3_7_enable_stubs_for_integration_tests"></a>3.7 Enable stubs for integration tests</h4></div></div></div><p>We are in the home stretch! Let&#8217;s turn our attention to <code class="literal">greeting-ui</code>.</p><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the build phase, both with and without stubs.</p><div class="figure"><a name="d0e7329" href="#d0e7329"></a><p class="title"><b>Figure&nbsp;14.18.&nbsp;greeting-ui Build Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_build_flow.png" alt="greeting ui build flow"></div></div></div><br class="figure-break"><p>Without stubs, we expect the response to be the hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract. In this case, the stubs are loaded into the <code class="literal">greeting-ui</code> process. This leads us to our next task: load the stubs produced by <code class="literal">fortune-service</code>.</p><p><span class="strong"><strong>Enable in-process stub runner</strong></span></p><p>To load the stubs into the <code class="literal">greeting-ui</code> process, we must enable the Spring Cloud Contract Stub Runner dependency. This dependency will start an in-process stub runner that automatically configures Wiremock.</p><p>Add the following to the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-stub-runner<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p><span class="strong"><strong>Add integration tests aligned with the contract</strong></span></p><p>Next, we add integration tests to <code class="literal">greeting-ui</code> that test for the expected response declared in the contract.</p><p>Add the following class to the test package in <code class="literal">greeting-ui</code>:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.pivotal.GreetingUIApplication;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class, webEnvironment = SpringBootTest.WebEnvironment.NONE,
        properties = {"spring.application.name=greeting-ui", "spring.cloud.circuit.breaker.enabled=false", "hystrix.stream.queue.enabled=false"})</span></em>
<em><span class="hl-annotation" style="color: gray">@AutoConfigureStubRunner(ids = {"io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION"},
        repositoryRoot = "${REPO_WITH_BINARIES}"
        //workOffline = true
)</span></em>

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> FortuneService fortuneService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> shouldSendRequestToFortune() {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// when</span>
        String fortune = fortuneService.getFortune();
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// then</span>
        BDDAssertions.then(fortune).isEqualTo(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
    }

}</pre><p>At this point, we can get through the build phase for <code class="literal">greeting-ui</code>, and the integration tests will be executed against the <code class="literal">fortune-service</code> stubs running in the <code class="literal">greeting-ui</code> process on the Concourse worker.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the configuration of <code class="literal">@AutoConfigureStubRunner</code> - you can replace the version with a <code class="literal">+</code> sign if using Artifactory or Nexus and it will automatically choose the latest available version on the maven repo.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Setting <code class="literal">workOffline=true</code> (commented out but shown for informational purposes above) would make the stub runner get the stubs from the local maven repo. This is useful for local testing. Alternatively, set the <code class="literal">$REPO_WITH_BINARIES</code> environment variable to the value used in the credentials file before doing a local maven build, and the local build will download the stubs from your remote maven repo (e.g. Bintray).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_8_enable_stubs_for_smoke_tests" href="#_3_8_enable_stubs_for_smoke_tests"></a>3.8 Enable stubs for smoke tests</h4></div></div></div><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the test phase, both with and without stubs. Note that in the build phase, where the app process is running on the Concourse worker, we ran the stubs in the same process. In the test environment (Cloud Foundry), we will run the stubs in a separate process using a standalone stub runner application.</p><div class="figure"><a name="d0e7419" href="#d0e7419"></a><p class="title"><b>Figure&nbsp;14.19.&nbsp;greeting-ui Test Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_test_flow.png" alt="greeting ui test flow"></div></div></div><br class="figure-break"><p>As in the build phase, without stubs we expect the response to be the hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract.</p><p>We will rely on Spring Cloud Pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Deploy a stub runner application</li><li class="listitem">Provide the stub runner application the necessary information to download the stubs</li><li class="listitem">Open a port on the stub runner application for each stub</li></ul></div><p>We will rely on the stub runner application to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Download the stubs from our maven repo (Bintray)</li><li class="listitem">Expose each stub on a separate port</li><li class="listitem">Register each stub in the Service Discovery server</li></ul></div><p>The following steps describe how to configure this.</p><p><span class="strong"><strong>Provide standalone stub runner app jar</strong></span></p><p>In the Prep step for this tutorial, you cloned the <a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top">cloudfoundry-stub-runner-boot</a> repo to your local machine. The next step is to build this app and upload it to Bintray to make the jar available to Spring Cloud Pipelines.</p><p>As mentioned in Stage 1 of this tutorial, Bintray requires that a package exist before any app artifacts can be uploaded. Log into the Bintray UI and create a package for <code class="literal">cloudfoundry-stub-runner-boot</code>. If you forked this repo, you can use the <code class="literal">Import from GitHub</code> option. Otherwise, create the package manually and choose any license (e.g. Apache 2.0).</p><p>Now you are ready to build and upload this app to Bintray. The following script shows cloning, building and uploading. Edit as appropriate to match your Bintray URL, the Bintray ID in your <code class="literal">~/.m2/settings/xml</code> file, and the <code class="literal">cloudfoundry-stub-runner-boot</code> repo URL if you chose to fork it.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Edit to match your Bintray URL and M2 repo ID setting (check your ~/.m2/settings.xml file)</span>
MAVEN_REPO_URL=https://api.bintray.com/maven/ciberkleid/maven-repo/cloudfoundry-stub-runner-boot
MAVEN_REPO_ID=bintray

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Clone cloudfoundry-stub-runner-boot</span>
git clone https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot.git
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> cloudfoundry-stub-runner-boot

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Build and upload</span>
./mvnw clean deploy -Ddistribution.management.release.url=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_URL}"</span> -Ddistribution.management.release.id=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_ID}"</span></pre><p>You should now see the <code class="literal">cloudfoundry-stub-runner-boot</code> artifacts uploaded on Bintray.</p><p><span class="strong"><strong>Provide standalone stub runner app manifest</strong></span></p><p>Next, we add a manifest file for the stub runner app for deployment to Cloud Foundry.</p><p>We will place this file in the <code class="literal">greeting-ui</code> repo. The file name and location can be your choice. For this example, we will use <code class="literal">sc-pipelines/manifest-stubrunner.yml</code>:</p><div class="figure"><a name="d0e7503" href="#d0e7503"></a><p class="title"><b>Figure&nbsp;14.20.&nbsp;greeting-ui Stub Runner Manifest</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stubrunner_manifest.png" alt="greeting ui stubrunner manifest"></div></div></div><br class="figure-break"><p>We populate this <code class="literal">manifest-stubrunner.yml</code> with the content shown below so that the stub runner binds to <code class="literal">service-registry</code>. The stub runner will register the <code class="literal">fortune-service</code> stub there so that <code class="literal">greeting-ui</code> can discover it in the same way it will discover the actual <code class="literal">fortune-service</code> app endpoint in stage and prod. From the <code class="literal">greeting-ui</code> perspective, there is no difference in how it interacts with Eureka and the stub runner app in test and the way it will interact with Eureka and the <code class="literal">fortune-service</code> app in stage and prod.</p><pre class="programlisting">---
applications:
- name: stubrunner
  timeout: 120
  services:
  - service-registry
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre><p><span class="strong"><strong>Provide stub runner jar and manifest info to the pipeline</strong></span></p><p>Now that we have a jar file and manifest file for our stub runner app, we need to provide this information to our <code class="literal">greeting-ui</code> pipeline so that the pipeline downloads the jar from Bintray and deploys it to Cloud Foundry. We do this through the <code class="literal">greeting-ui</code> <code class="literal">sc-pipelines.yml</code> file. We add an entry to the list of services in the <code class="literal">test</code> section, as follows:</p><pre class="programlisting">    - name: stubrunner
      type: stubrunner
      coordinates: io.pivotal:cloudfoundry-stub-runner-boot:0.0.1.M1
      pathToManifest: sc-pipelines/manifest-stubrunner.yml</pre><p>Notice that <code class="literal">name</code> matches the name of the app in <code class="literal">manifest-stubrunner.yml</code>, <code class="literal">coordinates</code> corresponds to the jar coordinates on the maven repo, and <code class="literal">pathToManifest</code> matches our chosen fie name for the stub runner app manifest.</p><p>Note also the <code class="literal">type</code> is set to <code class="literal">stubrunner</code>, which Spring Cloud Pipelines will recognize as a stanalone stub runner app and treat accordingly.</p><p><span class="strong"><strong>Provide stub configuration for stub runner app</strong></span></p><p>The final steps in the configuration of the standalone stub runner app are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Enable the stub runner app to download the <code class="literal">fortune-service</code> stub from Bintray</li><li class="listitem">Open a second port on the container to receive requests for this stub</li></ul></div><p>To accomplish this, we put stub and port configuration information into the properties section of the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file, using a property called <code class="literal">stubrunner.ids</code>. This property can accept a list of stubrunner ids, but for this tutorial, we only have one:</p><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Tell stub runner app to start this stub--&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;stubrunner.ids&gt;</span>io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION:stubs:10000<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/stubrunner.ids&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre><p>Spring Cloud Pipelines will use this information in two ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">It will provide this information to the stub runner app via the app&#8217;s environment variables</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Spring Cloud Pipelines will aslo provide the <code class="literal">$REPO_WITH_BINARIES</code> as an env var for the stub runner app</li><li class="listitem">The stub runner app will use this information to download the stub from Bintray and expose it on the specified port</li></ul></div></li><li class="listitem"><p class="simpara">It will open the additional port specified on the stub runner app and map a new route to it</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The format for each route will be <code class="literal">&lt;stub-runner-app-name&gt;-&lt;hostname-uuid&gt;-&lt;env&gt;-&lt;app-name&gt;-&lt;port&gt;.&lt;domain&gt;</code></li><li class="listitem">In our example, this would be <code class="literal">stubrunner-cyi-test-greeting-ui-10000.cfapps.io</code></li></ul></div></li></ol></div><p>Since we bound our stub runner app to <code class="literal">service-registry</code> (Eureka), the stub runner app will register the stub URL under the application name <code class="literal">FORTUNE-SERVICE</code> on Eureka:</p><div class="figure"><a name="d0e7644" href="#d0e7644"></a><p class="title"><b>Figure&nbsp;14.21.&nbsp;greeting-ui Stub Runner Eureka Registration</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stub_runner_eureka_registration.png" alt="greeting ui stub runner eureka registration"></div></div></div><br class="figure-break"><p>This completes the process of configuring the standalone stub runner application.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The port configuration may be automated by Spring Cloud Pipelines in the future, such that it will not be necessary to include the port in the <code class="literal">stubrunner.ids</code>, but for the moment, we are required to specify the port each stub should use.</p></td></tr></table></div><p><span class="strong"><strong>Edit smoke tests to align with the contract</strong></span></p><p>Finally, we edit our smoke tests for <code class="literal">greeting-ui</code> to ensure the response does <span class="strong"><strong>not</strong></span> contain the hystrix fallback, since we are noe expecting a response from the stub.</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre><p>In this case, in contrast to the integration test we created earlier for <code class="literal">greeting-ui</code>, we do not include <code class="literal">@AutoConfigureStubRunner</code> since we are using a standalone stub runner application.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_9_push_changes_to_github" href="#_3_9_push_changes_to_github"></a>3.9 Push changes to GitHub</h4></div></div></div><p>Push contract-based changes for <code class="literal">greeting-ui</code>. You should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">pom.xml</li><li class="listitem">sc-pipelines.yml</li><li class="listitem">sc-pipelines/manifest-stubrunner.yml</li><li class="listitem">src/test/java/io/pivotal/fortune/FortuneServiceTests.java</li><li class="listitem">src/test/java/smoke/SmokeTests.java</li></ul></div><p>At this point, we can run through the full pipeline for <code class="literal">greeting-ui</code> and leverage the contract-based stub in both the build and test environments.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_3_recap" href="#_stage_3_recap"></a>Stage 3 Recap</h4></div></div></div><p>What have we accomplished?</p><p>By implementing a contract-driven approach with auto-generation of tests and stubs, we have introduced a clean, structured, and reliable way to define, communicate, document, manage and test APIs</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Inter-team communication will be simpler</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Consumer and producer teams can now communicate requirements through codified contracts</li><li class="listitem">The inventory of contracts serves as a record and reference for the agreed upon APIs</li></ul></div></li><li class="listitem"><p class="simpara">Developer productivity will increase</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Producers can quickly and easily generate contract-based stubs</li><li class="listitem">Consumers no longer have to manually stub out APIs and write tests with arbitrary hard-coded responses - instead they can use the auto-generated stubs and test for contract-based responses</li><li class="listitem">Both producers and consumers can validate they are compliant with the contract</li><li class="listitem">Producers can verify backward compatibility of API changes</li><li class="listitem">Troubleshooting will be easier</li><li class="listitem">Failure and feedback will be faster</li></ul></div></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_conclusion" href="#_conclusion"></a>14.8&nbsp;Conclusion</h2></div></div></div><p>This concludes the tutorial on migrating apps for Spring Cloud Pipelines for Cloud Foundry.</p><p>Moving forward, the refactoring work needed here can be incorporated into your and/or your team&#8217;s standard practices. In short:</p><p><span class="strong"><strong>Good:</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use maven or gradle wrappers</li><li class="listitem">Include a Cloud Foundry manifest file in your app repo</li><li class="listitem">Include a pipeline descriptor (<code class="literal">sc-manifest.yml</code>) in your app repo</li><li class="listitem">Create an empty <code class="literal">version</code> branch in your app repo</li><li class="listitem">Include artifact repository configuration in the pom.xml file</li><li class="listitem">Align your Cloud Foundry spaces with Spring Cloud Pipelines model (isolated test space, shared stage and prod)</li></ul></div><p><span class="strong"><strong>Better</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Include default, apicompatibility, smoke, and e2e profiles in the pom.xml file</li><li class="listitem">Organize tests accordingly in your app repo</li></ul></div><p><span class="strong"><strong>Best</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use a database migration tool like flyway</li><li class="listitem">Use contract-based API programming</li></ul></div><p>Implementing all the <span class="strong"><strong>"good"</strong></span> practices above already positions you to instantly create pipelines for your apps usign Spring Cloud Pipelines. This is a huge win in terms of consistency and productivity, and standardization across development teams. Of course, this is an open source project, so it can be modified to meet your needs.</p><p>Implementing the <span class="strong"><strong>"better"</strong></span> practices will ensure the proper tests get run at the proper time. At that point you can add as much test coverage as you need to have high confidence in your pipelines.</p><p>Implementing the <span class="strong"><strong>"best"</strong></span> practices will give you additional confidence in your pipeline and encourage better programming practices for database version and API management across development teams. It will also give you higher confidence in your pipelines and enable you to avoid the cumbersome business of rolling back a database.</p><p>Happy coding!</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_building_the_project" href="#_building_the_project"></a>15.&nbsp;Building the project</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prerequisites" href="#_prerequisites"></a>15.1&nbsp;Prerequisites</h2></div></div></div><p>As prerequisites you need to have <a class="link" href="http://www.shellcheck.net/" target="_top">shellcheck</a>,
<a class="link" href="https://github.com/sstephenson/bats" target="_top">bats</a>, <a class="link" href="https://stedolan.github.io/jq/" target="_top">jq</a>
 and <a class="link" href="https://rubyinstaller.org/downloads/" target="_top">ruby</a> installed. If you&#8217;re on a Linux
 machine then <code class="literal">bats</code> and <code class="literal">shellcheck</code> will be installed for you.</p><p>To install the required software on Linux just type the following commands</p><pre class="programlisting">$ sudo apt-get install -y ruby jq</pre><p>If you&#8217;re on a Mac then just execute these commands to install the missing software</p><pre class="programlisting">$ brew install jq
$ brew install ruby
$ brew install bats
$ brew install shellcheck</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_bats_submodules" href="#_bats_submodules"></a>15.2&nbsp;Bats submodules</h2></div></div></div><p>To make <code class="literal">bats</code> work properly we needed to attach Git submodules. To have them
initialized either clone with appropriate command</p><pre class="programlisting">$ git clone --recursive https://github.com/spring-cloud/spring-cloud-pipelines.git</pre><p>or if you have already cloned the project and are just pulling changes</p><pre class="programlisting">$ git submodule init
$ git submodule update</pre><p>If you forget about this step, then Gradle will execute these steps for you.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_build_and_test" href="#_build_and_test"></a>15.3&nbsp;Build and test</h2></div></div></div><p>Once you have installed all the prerequisites you can execute</p><pre class="programlisting">$ ./gradlew clean build</pre><p>to build and test the project.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_generate_docs" href="#_generate_docs"></a>15.4&nbsp;Generate docs</h2></div></div></div><p>To generate docs just run</p><pre class="programlisting">$ ./gradlew generateDocs</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_making_a_release" href="#_making_a_release"></a>15.5&nbsp;Making a release</h2></div></div></div><p>It&#8217;s enough to execute the <code class="literal">release</code> task that will automatically
change the versions, build the docs, upload them to Spring Cloud Static,
tag the repo and then revert the changed versions back to default.</p><pre class="programlisting">$ ./gradlew release -PnewVersion=<span class="hl-number">1.0</span>.<span class="hl-number">0.</span>RELEASE</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_customizing_the_project" href="#_customizing_the_project"></a>16.&nbsp;Customizing the project</h1></div></div></div><p>If you want to pick only pieces (e.g. you&#8217;re interested only in <code class="literal">Cloud Foundry</code> with
<code class="literal">Concourse</code> combination) it&#8217;s enough to execute this command:</p><pre class="programlisting">$ ./gradlew customize</pre><p>You&#8217;ll see a screen looking more or less like this:</p><pre class="programlisting">:customize
  ___          _              ___ _             _   ___ _           _ _
 / __|_ __ _ _(_)_ _  __ _   / __| |___ _  _ __| | | _ (_)_ __  ___| (_)_ _  ___ ___
 \__ \ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'_ \ '</span>_| | <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">' \/ _` | | (__| / _ \ || / _` | |  _/ | '</span>_ \/ -_) | | <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">' \/ -_|_-&lt;
 |___/ .__/_| |_|_||_\__, |  \___|_\___/\_,_\__,_| |_| |_| .__/\___|_|_|_||_\___/__/
     |_|             |___/                               |_|



Follow the instructions presented in the console or terminate the process to quit (ctrl + c)


=== PAAS TYPE ===
Which PAAS type do you want to use? Options: [CF, K8S, BOTH]
&lt;-------------&gt; 0% EXECUTING
&gt; :customize</span></pre><p>Now you need to answer a couple of questions. That way whole files and its pieces
will get removed / updated accordingly. If you provide <code class="literal">CF</code> and <code class="literal">Concourse</code> options
thn <code class="literal">Kubernetes</code> and <code class="literal">Jenkins</code> configuration / folders / pieces of code in
the project will get removed.</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_releasing_the_project" href="#_releasing_the_project"></a>17.&nbsp;Releasing the project</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_publishing_a_docker_image" href="#_publishing_a_docker_image"></a>17.1&nbsp;Publishing A Docker Image</h2></div></div></div><p>When doing a release you also need to push a Docker image to Dockerhub.
From the project root, run the following commands replacing <code class="literal">&lt;version&gt;</code> with the
version of the release.</p><pre class="programlisting">docker login
docker build -t springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt; ./jenkins
docker push springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt;</pre></div></div></div></body></html>