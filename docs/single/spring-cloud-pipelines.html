<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Cloud Pipelines</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>Spring Cloud Pipelines</h1></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#d0e9"></a></span></dt><dt><span class="part"><a href="#_spring_cloud_pipelines">I. Spring Cloud Pipelines</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_five_second_introduction">1.1. Five-second Introduction</a></span></dt><dt><span class="section"><a href="#_five_minute_introduction">1.2. Five-minute Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_how_to_use_it">1.2.1. How to Use It</a></span></dt><dt><span class="section"><a href="#_how_it_works">1.2.2. How It Works</a></span></dt><dt><span class="section"><a href="#_supported_languages">1.2.3. Supported Languages</a></span></dt><dt><span class="section"><a href="#_centralized_pipeline_creation">1.2.4. Centralized Pipeline Creation</a></span></dt><dt><span class="section"><a href="#_a_pipeline_for_each_repository">1.2.5. A Pipeline for Each Repository</a></span></dt></dl></dd><dt><span class="section"><a href="#_the_flow">1.3. The Flow</a></span></dt><dd><dl><dt><span class="section"><a href="#_environments">1.3.1. Environments</a></span></dt><dt><span class="section"><a href="#_tests">1.3.2. Tests</a></span></dt><dt><span class="section"><a href="#_testing_against_stubs">1.3.3. Testing against Stubs</a></span></dt><dt><span class="section"><a href="#_general_view">1.3.4. General View</a></span></dt></dl></dd><dt><span class="section"><a href="#_pipeline_descriptor">1.4. Pipeline Descriptor</a></span></dt><dd><dl><dt><span class="section"><a href="#_pipeline_descriptor_for_cloud_foundry">1.4.1. Pipeline Descriptor for Cloud Foundry</a></span></dt></dl></dd><dt><span class="section"><a href="#_project_setup">1.5. Project Setup</a></span></dt></dl></dd><dt><span class="chapter"><a href="#how-do-the-scripts-work">2. How the Scripts Work</a></span></dt><dd><dl><dt><span class="section"><a href="#build-and-deployment">2.1. Build and Deployment</a></span></dt><dt><span class="section"><a href="#project-crawler">2.2. Project Crawler</a></span></dt><dt><span class="section"><a href="#how-do-the-scripts-work-with-spinanker">2.3. How Scripts Work with Spinnaker</a></span></dt><dt><span class="section"><a href="#deployment-languages-compatibility-matrix">2.4. Deployment &amp; languages compatibility matrix</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_opinionated_implementation">3. Opinionated Implementation</a></span></dt><dd><dl><dt><span class="section"><a href="#_build">3.1. Build</a></span></dt><dt><span class="section"><a href="#_test">3.2. Test</a></span></dt><dt><span class="section"><a href="#_stage">3.3. Stage</a></span></dt><dt><span class="section"><a href="#_prod">3.4. Prod</a></span></dt></dl></dd><dt><span class="chapter"><a href="#project-opinions">4. Project Opinions</a></span></dt><dd><dl><dt><span class="section"><a href="#_cloud_foundry_project_opinions">4.1. Cloud Foundry Project Opinions</a></span></dt><dt><span class="section"><a href="#_kubernetes_project_opinions">4.2. Kubernetes Project Opinions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_customizing_the_project">5. Customizing the Project</a></span></dt><dd><dl><dt><span class="section"><a href="#customization-overriding-scripts">5.1. Overriding Scripts</a></span></dt><dt><span class="section"><a href="#customization-overriding-pipelines">5.2. Overriding Pipelines</a></span></dt><dd><dl><dt><span class="section"><a href="#_overriding_jenkins_job_dsl_pipelines">5.2.1. Overriding Jenkins Job DSL pipelines</a></span></dt></dl></dd><dt><span class="section"><a href="#customization-picking-features">5.3. Picking Features</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_step_by_step_cloud_foundry_migration">6. Step-by-step Cloud Foundry Migration</a></span></dt><dd><dl><dt><span class="section"><a href="#_preview">6.1. Preview</a></span></dt><dt><span class="section"><a href="#_introduction_2">6.2. Introduction</a></span></dt><dt><span class="section"><a href="#_sample_application_initial_state">6.3. Sample Application&#8201;&#8212;&#8201;Initial State</a></span></dt><dt><span class="section"><a href="#_sample_application_end_state">6.4. Sample Application&#8201;&#8212;&#8201;End State</a></span></dt><dt><span class="section"><a href="#_tutorial_toolset">6.5. Tutorial&#8201;&#8212;&#8201;Toolset</a></span></dt><dt><span class="section"><a href="#_tutorial_overview">6.6. Tutorial&#8201;&#8212;&#8201;Overview</a></span></dt><dt><span class="section"><a href="#_tutorial_step_by_step">6.7. Tutorial&#8201;&#8212;&#8201;Step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#tutorial-prep">6.7.1. Prep: Before you begin</a></span></dt><dt><span class="section"><a href="#tutorial-stage-one">6.7.2. Stage One: Scaffolding</a></span></dt><dd><dl><dt><span class="section"><a href="#_1_1_create_github_branches">1.1 Create GitHub Branches</a></span></dt><dt><span class="section"><a href="#_1_2_add_maven_wrapper">1.2 Add Maven Wrapper</a></span></dt><dt><span class="section"><a href="#_1_3_create_the_bintray_maven_repository_package">1.3 Create the Bintray Maven Repository Package</a></span></dt><dt><span class="section"><a href="#_1_4_configure_distribution_management_by_using_the_bintray_maven_repository">1.4 Configure Distribution Management by Using the Bintray Maven Repository</a></span></dt><dt><span class="section"><a href="#_1_5_push_changes_to_github">1.5 Push Changes to GitHub</a></span></dt><dt><span class="section"><a href="#_1_6_add_a_spring_cloud_pipelines_credentials_file">1.6 Add a Spring Cloud Pipelines Credentials File</a></span></dt><dt><span class="section"><a href="#_1_7_set_the_concourse_pipeline">1.7 Set the Concourse Pipeline</a></span></dt><dt><span class="section"><a href="#_1_8_add_cloud_foundry_manifest">1.8 Add Cloud Foundry manifest</a></span></dt><dt><span class="section"><a href="#_1_9_add_the_spring_cloud_pipelines_manifest">1.9 Add the Spring Cloud Pipelines Manifest</a></span></dt><dt><span class="section"><a href="#_1_10_push_changes_to_github">1.10 Push changes to GitHub</a></span></dt><dt><span class="section"><a href="#_1_11_create_cloud_foundry_orgs_and_spaces">1.11 Create Cloud Foundry Orgs and Spaces</a></span></dt><dt><span class="section"><a href="#_1_12_create_cloud_foundry_stage_and_prod_service_instances">1.12 Create Cloud Foundry Stage and Prod Service Instances</a></span></dt><dt><span class="section"><a href="#_1_13_update_the_spring_cloud_pipelines_credentials_file">1.13 Update the Spring Cloud Pipelines Credentials File</a></span></dt><dt><span class="section"><a href="#_1_14_update_the_concourse_pipeline_with_updated_credentials_files">1.14 Update the Concourse Pipeline with Updated Credentials Files</a></span></dt><dt><span class="section"><a href="#_stage_one_recap_and_next_steps">Stage One Recap and Next Steps</a></span></dt></dl></dd><dt><span class="section"><a href="#tutorial-stage-two">6.7.3. Stage Two: Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#_2_1_add_maven_profiles">2.1 Add Maven Profiles</a></span></dt><dt><span class="section"><a href="#_2_2_add_and_organize_tests">2.2 Add and Organize Tests</a></span></dt><dt><span class="section"><a href="#_2_3_enable_database_versioning">2.3 Enable Database Versioning</a></span></dt><dt><span class="section"><a href="#_2_4_push_changes_to_github">2.4 Push Changes to GitHub</a></span></dt><dt><span class="section"><a href="#_2_5_re_run_the_pipelines">2.5 Re-run the Pipelines</a></span></dt><dt><span class="section"><a href="#_stage_two_recap_and_next_steps">Stage Two Recap and Next Steps</a></span></dt></dl></dd><dt><span class="section"><a href="#tutorial-stage-three">6.7.4. Stage Three: Contracts</a></span></dt><dd><dl><dt><span class="section"><a href="#_3_1_create_a_contract">3.1 Create a Contract</a></span></dt><dt><span class="section"><a href="#_3_2_create_a_base_class_for_contract_tests">3.2 Create a Base Class for Contract Tests</a></span></dt><dt><span class="section"><a href="#_3_3_enable_automated_contract_based_testing">3.3 Enable Automated Contract-based Testing</a></span></dt><dt><span class="section"><a href="#_3_4_enable_backward_compatibility_api_check">3.4 Enable backward compatibility API check</a></span></dt><dt><span class="section"><a href="#_3_5_push_changes_to_github">3.5 Push Changes to GitHub</a></span></dt><dt><span class="section"><a href="#_3_6_re_run_the_literal_fortune_service_literal_pipeline">3.6 Re-run the <code class="literal">fortune-service</code> Pipeline</a></span></dt><dt><span class="section"><a href="#_3_7_enable_stubs_for_integration_tests">3.7 Enable Stubs for Integration Tests</a></span></dt><dt><span class="section"><a href="#_3_8_enable_stubs_for_smoke_tests">3.8 Enable Stubs for Smoke Tests</a></span></dt><dt><span class="section"><a href="#_3_9_push_changes_to_github">3.9 Push Changes to GitHub</a></span></dt><dt><span class="section"><a href="#_stage_three_recap">Stage Three Recap</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#_conclusion">6.8. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#concourse-pipeline-cf">7. Concourse Pipeline (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-pipeline-step-by-step-cf">7.1. Step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-fork-cf">7.1.1. Fork Repositories</a></span></dt><dt><span class="section"><a href="#concourse-start-cf">7.1.2. Start Concourse and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#concourse-deploy-cf">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#concourse-pcfdev-cf">7.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#concourse-fly-cf">7.1.4. Setup the <code class="literal">fly</code> CLI</a></span></dt><dt><span class="section"><a href="#concourse-credentials-cf">7.1.5. Set up Your <code class="literal">credentials.yml</code> File</a></span></dt><dt><span class="section"><a href="#concourse-build-cf">7.1.6. Build the Pipeline</a></span></dt><dt><span class="section"><a href="#concourse-run-cf">7.1.7. Run the <code class="literal">github-webhook</code> Pipeline</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#concourse-pipeline-k8s">8. Concourse Pipeline (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-k8s">8.1. Step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-k8s">8.1.1. Fork Repositories</a></span></dt></dl></dd><dt><span class="section"><a href="#concourse-start-k8s">8.2. Concourse in K8S (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_artifactory_to_k8s">8.2.1. Deploying Artifactory to K8S</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-fly-k8s">8.2.2. Setup the <code class="literal">fly</code> CLI</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-credentials-k8s">8.2.3. Setup your <code class="literal">credentials.yml</code></a></span></dt><dt><span class="section"><a href="#concourse-pipeline-build-k8s">8.2.4. Build the pipeline</a></span></dt><dt><span class="section"><a href="#concourse-pipeline-run-k8s">8.2.5. Run the <code class="literal">github-webhook</code> Pipeline</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_jenkins_pipeline_common">9. Jenkins Pipeline (Common)</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_setup_2">9.1. Project setup</a></span></dt><dt><span class="section"><a href="#_optional_customization_steps">9.2. Optional customization steps</a></span></dt><dd><dl><dt><span class="section"><a href="#deploying-infra">9.2.1. Deploying infra jars to a different location</a></span></dt><dt><span class="section"><a href="#setup-settings-xml">9.2.2. Setup settings.xml for Maven deployment</a></span></dt><dt><span class="section"><a href="#setup-jenkins-env-vars">9.2.3. Setup Jenkins env vars</a></span></dt><dd><dl><dt><span class="section"><a href="#setup-seed-props">Seed properties</a></span></dt><dt><span class="section"><a href="#global-envs">Global envs</a></span></dt></dl></dd><dt><span class="section"><a href="#git-email">9.2.4. Set Git email / user</a></span></dt><dd><dl><dt><span class="section"><a href="#jenkins-credentials-github">Add Jenkins credentials for GitHub</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#_testing_jenkins_scripts">9.3. Testing Jenkins scripts</a></span></dt><dt><span class="section"><a href="#_how_to_work_with_jenkins_job_dsl_plugin">9.4. How to work with Jenkins Job DSL plugin</a></span></dt><dt><span class="section"><a href="#_docker_image">9.5. Docker Image</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-cf">10. Jenkins Pipeline (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-cf">10.1. Step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-cf">10.1.1. Fork Repositories</a></span></dt><dt><span class="section"><a href="#start-jenkins-cf">10.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-cf">Deploy the Infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#start-pcf-dev-cf">10.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#jenkins-seed-cf">10.1.4. Run the Seed Job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-cf">10.1.5. Run the <code class="literal">github-webhook</code> Pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-cf">10.2. Declarative Pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-cf">10.3. Jenkins Cloud Foundry Customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-cf">10.3.1. Environment Variable Summary</a></span></dt><dt><span class="section"><a href="#jenkins-credentials-cf">10.3.2. Jenkins Credentials</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-k8s">11. Jenkins Pipeline (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-k8s">11.1. Step-by-step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-k8s">11.1.1. Fork Repositories</a></span></dt><dt><span class="section"><a href="#start-jenkins-k8s">11.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-k8s">Deploy the Infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#jenkins-seed-k8s">11.1.3. Run the seed job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-k8s">11.1.4. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-k8s">11.2. Declarative pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-k8s">11.3. Jenkins Kubernetes customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-k8s">11.3.1. All env vars</a></span></dt></dl></dd><dt><span class="section"><a href="#_preparing_to_connect_to_gce">11.4. Preparing to Connect to GCE</a></span></dt><dt><span class="section"><a href="#_connecting_to_a_kubo_or_gce_cluster">11.5. Connecting to a Kubo or GCE Cluster</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_kubernetes_setup">12. Kubernetes Setup</a></span></dt><dd><dl><dt><span class="section"><a href="#_kubernetes_cli_installation">12.1. Kubernetes CLI Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-cli-script">12.1.1. Script Installation</a></span></dt><dt><span class="section"><a href="#kubernetes-cli-manual">12.1.2. Manual Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#_example_for_osx">Example for OSX</a></span></dt><dt><span class="section"><a href="#_example_for_linux">Example for Linux</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#start-minikube-k8s">12.2. Kubernetes Cluster Setup</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-minikube-script">12.2.1. Script Installation</a></span></dt><dt><span class="section"><a href="#kubernetes-minikube-manual">12.2.2. Manual Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#_example_for_osx_2">Example for OSX</a></span></dt></dl></dd><dt><span class="section"><a href="#_example_for_linux_2">12.2.3. Example for Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#_run_minikube">12.3. Run Minikube</a></span></dt><dt><span class="section"><a href="#_certificates_and_workers">12.4. Certificates and Workers</a></span></dt><dd><dl><dt><span class="section"><a href="#_minikube_certificates_and_workers">12.4.1. Minikube Certificates and Workers</a></span></dt><dt><span class="section"><a href="#_manual_certificates_and_workers_setup">12.4.2. Manual Certificates and Workers Setup</a></span></dt></dl></dd><dt><span class="section"><a href="#_generate_minikube_namespaces">12.5. Generate Minikube Namespaces</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_cloud_foundry">13. The demo setup (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_pcf_dev">13.1. Deploying Production Applications to PCF Dev</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_cf">13.2. Running Prometheus on CF</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_cf">13.3. Running Grafana on CF</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_kubernetes">14. The demo setup (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_minikube">14.1. Deploying Production Applications to Minikube</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_kubernetes">14.2. Running Prometheus on Kubernetes</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_kubernetes">14.3. Running Grafana on Kubernetes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_building_the_project">15. Building the Project</a></span></dt><dd><dl><dt><span class="section"><a href="#building-project-setup">15.1. Project Setup</a></span></dt><dt><span class="section"><a href="#building-prerequisites">15.2. Prerequisites</a></span></dt><dt><span class="section"><a href="#building-bats-submodules">15.3. Bats Submodules</a></span></dt><dt><span class="section"><a href="#building-build-and-test">15.4. Build and test</a></span></dt><dt><span class="section"><a href="#building-generate-documentation">15.5. Generate Documentation</a></span></dt><dt><span class="section"><a href="#building-distributions">15.6. Distributions</a></span></dt><dt><span class="section"><a href="#building-making-a-release">15.7. Making a Release</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_releasing_the_project">16. Releasing the Project</a></span></dt><dd><dl><dt><span class="section"><a href="#_publishing_a_docker_image">16.1. Publishing A Docker Image</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_ci_server_worker_prerequisites">17. CI Server Worker Prerequisites</a></span></dt><dt><span class="chapter"><a href="#concourse-faq">18. Concourse FAQ</a></span></dt><dt><span class="chapter"><a href="#jenkins_faq">19. Jenkins FAQ</a></span></dt></dl></dd></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="d0e9" href="#d0e9"></a></h1></div></div></div><p>Marcin Grzejszczak; Cora Iberkleid; Jay Bryant
:docinfo: shared
:doctype: book
:stylesdir: stylesheets
:stylesheet: spring.css
:toc: left
:toclevels: 4
:source-highlighter: prettify
:numbered:
:icons: font
:sectanchors:</p></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_cloud_pipelines" href="#_spring_cloud_pipelines"></a>Part&nbsp;I.&nbsp;Spring Cloud Pipelines</h1></div></div></div><div class="partintro"><div></div><p>Spring, Spring Boot, and Spring Cloud are tools that let developers speed up the
time of creating new business features. It is common knowledge, however, that the
feature is only valuable if it is in production. That is why companies
spend a lot of time and resources on building their own deployment pipelines.</p><p>This project tries to solve the following problems:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Creation of a common deployment pipeline.</li><li class="listitem">Propagation of good testing and deployment practices.</li><li class="listitem">Reducing the time required to deploy a feature to production.</li></ul></div><p>A common way of running, configuring, and deploying applications lowers support costs
and time needed by new developers to blend in when they change projects.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_introduction" href="#_introduction"></a>1.&nbsp;Introduction</h2></div></div></div><p>This section describes the rationale
behind the opinionated pipeline. We go through each deployment
step and describe it in detail.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>You do not need to use all the pieces of Spring Cloud Pipelines. You
can (and should) gradually migrate your applications to use those pieces of
Spring Cloud Pipelines that you think best suit your needs.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_five_second_introduction" href="#_five_second_introduction"></a>1.1&nbsp;Five-second Introduction</h2></div></div></div><p>Spring Cloud Pipelines provides scripts, configuration, and convention for automated
deployment pipeline creation for Jenkins and Concourse with Cloud Foundry or Kubernetes.
We support JVM languages, PHP, and NodeJS. Since SC-Pipelines uses bash scripts,
you can use it with whatever automation server you have.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_five_minute_introduction" href="#_five_minute_introduction"></a>1.2&nbsp;Five-minute Introduction</h2></div></div></div><p>Spring Cloud Pipelines comes with bash scripts (available under <code class="literal">common/src/main/bash</code>)
that represent the logic of all steps in our opinionated deployment pipeline.
Since we believe in convention over configuration, for the supported framework and
languages, we assume that the projects follow certain conventions of task naming,
profile setting, and so on. That way, if you create a new application,
your application can follow those conventions and the deployment pipeline works.
Since no one pipeline can serve the purposes of all
teams in a company, we believe that minor deployment pipeline tweaking should take place.
That is why we allow the usage of that <code class="literal">sc-pipelines.yml</code> descriptor, which allows for
provide some customization.</p><p>From the pipeline visualization perspective, we have prepared templates for Concourse
and Jenkins (through the Jenkins Job DSL and Jenkinsfile). That means you can reuse them
immediately to visualize a deployment pipeline. If you use some other tool for
continuous delivery, you can set the visualization yourself and reference the
bash scripts for each step. In other words, Spring Cloud Pipelines can be reused
with any continuous delivery tool.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_how_to_use_it" href="#_how_to_use_it"></a>1.2.1&nbsp;How to Use It</h3></div></div></div><p>This repository can be treated as a template for your pipeline. We provide some opinionated
implementation that you can alter to suit your needs. To use it, we recommend downloading
the Spring Cloud Pipelines repository as a zip file, unzipping it in a directory,
initializing a Git project in that directory, and then modifying the project to suit your
needs. The following bash script shows how to do so:</p><div class="informalexample"><pre class="programlisting">$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># pass the branch (e.g. master) or a particular tag (e.g. v1.0.0.RELEASE)</span>
$ SC_PIPELINES_RELEASE=...
$ curl -LOk https://github.com/spring-cloud/spring-cloud-pipelines/archive/${SC_PIPELINES_RELEASE}.zip
$ unzip ${SC_PIPELINES_RELEASE}.zip
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines-${SC_PIPELINES_RELEASE}
$ git init
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># modify the pipelines to suit your needs</span>
$ git add .
$ git commit -m <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Initial commit"</span>
$ git remote add origin ${YOUR_REPOSITORY_URL}
$ git push origin master</pre></div><p>To keep your repository aligned with the changes in the upstream repository, you can also
clone the repository. To not have many merge conflicts, we recommend using the <code class="literal">custom</code>
folder hooks to override functions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_how_it_works" href="#_how_it_works"></a>1.2.2&nbsp;How It Works</h3></div></div></div><p>As the following image shows, Spring Cloud Pipelines contains logic to generate a
pipeline and the runtime to execute pipeline steps.</p><div class="figure"><a name="d0e77" href="#d0e77"></a><p class="title"><b>Figure&nbsp;1.1.&nbsp;How Spring Cloud Pipelines works</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/how.png" alt="how"></div></div></div><br class="figure-break"><p>Once a pipeline is created (for example, by using the Jenkins Job DSL or from a Concourse
templated pipeline), when the jobs are ran, they clone or download Spring Cloud Pipelines
code to run each step. Those steps run functions that are
defined in the <code class="literal">commons</code> module of Spring Cloud Pipelines.</p><p>Spring Cloud Pipelines performs steps to guess what kind of a project your
repository is (for example, JVM or PHP) and what framework it uses (Maven or Gradle), and it
can deploy your application to a cloud (Cloud Foundry or Kubernetes). You can read about how
it works by reading the <a class="xref" href="#how-do-the-scripts-work" title="2.&nbsp;How the Scripts Work">Chapter&nbsp;2, <i>How the Scripts Work</i></a> section.</p><p>All of that happens automatically if your application follows the conventions.
You can read about them in the <a class="xref" href="#project-opinions" title="4.&nbsp;Project Opinions">Chapter&nbsp;4, <i>Project Opinions</i></a> section.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_supported_languages" href="#_supported_languages"></a>1.2.3&nbsp;Supported Languages</h3></div></div></div><p>Currently, we support the following languages:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">JVM</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Maven wrapper-based project</li><li class="listitem">Gradle wrapper-based project</li></ul></div></li><li class="listitem"><p class="simpara">PHP</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Composer-based project</li></ul></div></li><li class="listitem">NPM</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_centralized_pipeline_creation" href="#_centralized_pipeline_creation"></a>1.2.4&nbsp;Centralized Pipeline Creation</h3></div></div></div><p>You can use Spring Cloud Pipelines to generate pipelines
for all the projects in your system. You can scan all your
repositories (for example, you can call the Stash or Github API to retrieve the list of repositories)
and then:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">For Jenkins, call the seed job and pass the <code class="literal">REPOS</code>
parameter, which contains the list of repositories.</li><li class="listitem">For Concourse, call <code class="literal">fly</code> and set the
pipeline for every repository.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>We recommend using Spring Cloud Pipelines this way.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_a_pipeline_for_each_repository" href="#_a_pipeline_for_each_repository"></a>1.2.5&nbsp;A Pipeline for Each Repository</h3></div></div></div><p>You can use Spring Cloud Pipelines in such a way that
each project contains its own pipeline definition in
its code. Spring Cloud Pipelines clones the code with
the pipeline definitions (the bash scripts), so the
only piece of logic that needs to be in your application&#8217;s
repository is the pipeline definition.</p><p>For Jenkins, you need to either set up the <code class="literal">Jenkinsfile</code>
or the jobs by using the Jenkins Job DSL plugin in your repo.
Then, in Jenkins, whenever you set up a new pipeline for a repository,
you can reference the pipeline definition in that repo.
For Concourse, each project contains its own pipeline steps,
and it is up to the project to set up the pipeline.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_flow" href="#_the_flow"></a>1.3&nbsp;The Flow</h2></div></div></div><p>The following images show the flow of the opinionated pipeline:</p><div class="figure"><a name="d0e161" href="#d0e161"></a><p class="title"><b>Figure&nbsp;1.2.&nbsp;Flow in Concourse</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow_concourse.png" alt="flow concourse"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e170" href="#d0e170"></a><p class="title"><b>Figure&nbsp;1.3.&nbsp;Flow in Jenkins</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow.png" alt="flow"></div></div></div><br class="figure-break"><p>We first describe the overall concept behind the flow and then
split it into pieces and describe each piece independently.</p><p>===Vocabulary</p><p>This section defines some common vocabulary. We describe four typical
environments in terms of running the pipeline.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_environments" href="#_environments"></a>1.3.1&nbsp;Environments</h3></div></div></div><p>We typically encounter the following environments:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>build</strong></span> environment is a machine where the building of the application takes place.
It is a continuous integration or continuous delivery tool worker.</li><li class="listitem"><span class="strong"><strong>test</strong></span> is an environment where you can deploy an application to test it. It does not
resemble production, because we cannot be sure of its state (which application is deployed
there and in which version). It can be used by multiple teams at the same time.</li><li class="listitem"><span class="strong"><strong>stage</strong></span> is an environment that does resemble production. Most likely, applications
are deployed there in versions that correspond to those deployed to production.
Typically, staging databases hold (often obfuscated) production data. Most
often, this environment is a single environment shared between many teams. In other
words, in order to run some performance and user acceptance tests, you have to block
and wait until the environment is free.</li><li class="listitem"><span class="strong"><strong>prod</strong></span> is the production environment where we want our tested applications to be
deployed for our customers.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tests" href="#_tests"></a>1.3.2&nbsp;Tests</h3></div></div></div><p>We typically encounter the following kinds of tests:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>Unit tests</strong></span>: Tests that run on the application during the build phase.
No integrations with databases or HTTP server stubs or other resources take place.
Generally speaking, your application should have plenty of these tests to provide fast
feedback about whether your features work.</li><li class="listitem"><span class="strong"><strong>Integration tests</strong></span>: Tests that run on the built application during the build phase.
Integrations with in-memory databases and HTTP server stubs take place. According to the
<a class="link" href="https://martinfowler.com/bliki/TestPyramid.html" target="_top">test pyramid</a>, in most cases, you should
not have many of these kind of tests.</li><li class="listitem"><span class="strong"><strong>Smoke tests</strong></span>: Tests that run on a deployed application. The concept of these tests
is to check that the crucial parts of your application are working properly. If you have 100 features
in your application but you gain the most money from five features, you could write smoke tests
for those five features. We are talking about smoke tests of an application, not of
the whole system. In our understanding inside the opinionated pipeline, these tests are
executed against an application that is surrounded with stubs.</li><li class="listitem"><span class="strong"><strong>End-to-end tests</strong></span>: Tests that run on a system composed of multiple applications.
These tests ensure that the tested feature works when the whole system is set up.
Due to the fact that it takes a lot of time, effort, and resources to maintain such an environment
and that these tests are often unreliable (due to many different moving pieces, such as network,
database, and others), you should have a handful of those tests. They should be only for critical parts of your business.
Since only production is the key verifier of whether your feature works, some companies
do not even want to have these tests and move directly to deployment to production. When your
system contains KPI monitoring and alerting, you can quickly react when your deployed application
does not behave properly.</li><li class="listitem"><span class="strong"><strong>Performance testing</strong></span>: Tests run on an application or set of applications
to check if your system can handle a big load. In the case of our opinionated pipeline,
these tests can run either on test (against a stubbed environment) or on
staging (against the whole system).</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_testing_against_stubs" href="#_testing_against_stubs"></a>1.3.3&nbsp;Testing against Stubs</h3></div></div></div><p>Before we go into the details of the flow, consider the example described by the following image:</p><div class="figure"><a name="d0e250" href="#d0e250"></a><p class="title"><b>Figure&nbsp;1.4.&nbsp;Two monolithic applications deployed for end to end testing</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/monolith.png" alt="monolith"></div></div></div><br class="figure-break"><p>When you have only a handful of applications, end-to-end testing is beneficial.
From the operations perspective, it is maintainable for a finite number of deployed instances.
From the developers perspective, it is nice to verify the whole flow in the system
for a feature.</p><p>In the case of microservices, the scale starts to be a problem, as the following image shows:</p><div class="figure"><a name="d0e263" href="#d0e263"></a><p class="title"><b>Figure&nbsp;1.5.&nbsp;Many microservices deployed in different versions</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/many_microservices.png" alt="many microservices"></div></div></div><br class="figure-break"><p>The following questions arise:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Should I queue deployments of microservices on one testing environment or should I have an environment per microservice?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I queue deployments, people have to wait for hours to have their tests run. That can be a problem</li></ul></div></li><li class="listitem"><p class="simpara">To remove that issue, I can have an environment for each microservice.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Who will pay the bills? (Imagine 100 microservices, each having each own environment).</li><li class="listitem">Who will support each of those environments?</li><li class="listitem">Should we spawn a new environment each time we execute a new pipeline and then wrap it up or should we have
them up and running for the whole day?</li></ul></div></li><li class="listitem"><p class="simpara">In which versions should I deploy the dependent microservices - development or production versions?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I have development versions, I can test my application against a feature that is not yet on production.
That can lead to exceptions in production.</li><li class="listitem">If I test against production versions, I can never test against a feature under development
anytime before deployment to production.</li></ul></div></li></ul></div><p>One of the possibilities of tackling these problems is to not do end-to-end tests.</p><p>The following image shows one solution to the problem, in the form of stubbed dependencies:</p><div class="figure"><a name="d0e309" href="#d0e309"></a><p class="title"><b>Figure&nbsp;1.6.&nbsp;Execute tests on a deployed microservice on stubbed dependencies</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>If we stub out all the dependencies of our application, most of the problems presented earlier
disappear. There is no need to start and setup the infrastructure required by the dependent
microservices. That way, the testing setup looks like the following image:</p><div class="figure"><a name="d0e320" href="#d0e320"></a><p class="title"><b>Figure&nbsp;1.7.&nbsp;We&#8217;re testing microservices in isolation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>Such an approach to testing and deployment gives the following benefits
(thanks to the usage of <a class="link" href="https://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No need to deploy dependent services.</li><li class="listitem">The stubs used for the tests run on a deployed microservice are the same as those used during integration tests.</li><li class="listitem">Those stubs have been tested against the application that produces them (see <a class="link" href="https://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a> for more information).</li><li class="listitem">We do not have many slow tests running on a deployed application, so the pipeline gets executed much faster.</li><li class="listitem">We do not have to queue deployments. We test in isolation so that pipelines do not interfere with each other.</li><li class="listitem">We do not have to spawn virtual machines each time for deployment purposes.</li></ul></div><p>However, this approach brings the following challenges:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No end-to-end tests before production. You do not have full certainty that a feature is working.</li><li class="listitem">The first time the applications interact in a real way is on production.</li></ul></div><p>As with every solution, it has its benefits and drawbacks. The opinionated pipeline
lets you configure whether you want to follow this flow or not.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_general_view" href="#_general_view"></a>1.3.4&nbsp;General View</h3></div></div></div><p>The general view behind this deployment pipeline is to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Test the application in isolation.</li><li class="listitem">Test the backwards compatibility of the application, in order to roll it back if necessary.</li><li class="listitem">Allow testing of the packaged application in a deployed environment.</li><li class="listitem">Allow user acceptance tests and performance tests in a deployed environment.</li><li class="listitem">Allow deployment to production.</li></ul></div><p>The pipeline could have been split to more steps, but it seems that all of the aforementioned
actions fit nicely in our opinionated proposal.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_descriptor" href="#_pipeline_descriptor"></a>1.4&nbsp;Pipeline Descriptor</h2></div></div></div><p>Each application can contain a file (called <code class="literal">sc-pipelines.yml</code>) with the following structure:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">language_type</span>: jvm
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">pipeline</span>:
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># used for multi module projects</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	main_module</span>: things/thing
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># used for multi projects</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	project_names</span>:
		- monoRepoA
		- monoRepoB
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should deploy to stage automatically and run e2e tests</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	auto_stage</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should deploy to production automatically</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	auto_prod</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should the api compatibility check be there</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	api_compatibility_step</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should the test rollback step be there</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	rollback_step</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should the stage step be there</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	stage_step</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># should the test step (including rollback) be there</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	test_step</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName1</span>:
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># used by spinnaker</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	deployment_strategy</span>: HIGHlANDER
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># list of services to be deployed</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		- type</span>: service1Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  name</span>: service1Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		- type</span>: service2Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  name</span>: service2Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  key</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName2</span>:
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># used by spinnaker</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	deployment_strategy</span>: HIGHlANDER
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># list of services to be deployed</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">	services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		- type</span>: service3Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  name</span>: service3Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		- type</span>: service4Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  name</span>: service4Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">		  key</span>: value</pre></div><p>If you have a multi-module project, you should point to the folder that contains the
module that produces the fat jar. In the preceding example, that module
would be present under the <code class="literal">things/thing</code> folder. If you have a single module project,
you need not create this section.</p><p>For a given environment, we declare a list of infrastructure services that we
want to have deployed. Services have:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">type</code> (examples: <code class="literal">eureka</code>, <code class="literal">mysql</code>, <code class="literal">rabbitmq</code>, and <code class="literal">stubrunner</code>): This value gets
then applied to the <code class="literal">deployService</code> Bash function</li><li class="listitem"><span class="strong"><strong>[KUBERNETES]</strong></span>: For <code class="literal">mysql</code>, you can pass the database name in the <code class="literal">database</code> property.</li><li class="listitem"><code class="literal">name</code>: The name of the service to get deployed.</li><li class="listitem"><code class="literal">coordinates</code>: The coordinates that let you fetch the binary of the service.
It can be a Maven coordinate (<code class="literal">groupid:artifactid:version</code>),
a docker image (<code class="literal">organization/nameOfImage</code>), and so on.</li><li class="listitem">Arbitrary key value pairs, which let you customize the services as you wish.</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pipeline_descriptor_for_cloud_foundry" href="#_pipeline_descriptor_for_cloud_foundry"></a>1.4.1&nbsp;Pipeline Descriptor for Cloud Foundry</h3></div></div></div><p>When deploying to Cloud Foundry you can provide services
of the following types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><code class="literal">type: broker</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">broker</code>: The name of the CF broker</li><li class="listitem"><code class="literal">plan</code>: The name of the plan</li><li class="listitem"><code class="literal">params</code>: Additional parameters are converted to JSON</li><li class="listitem"><code class="literal">useExisting</code>: Whether to use an existing one or
create a new one (defaults to <code class="literal">false</code>)</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: app</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">coordinates</code>: The Maven coordinates of the stub runner jar</li><li class="listitem"><code class="literal">manifestPath</code>: The path to the manifest for the stub runner jar</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cups</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">params</code>: Additional parameters are converted to JSON</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cupsSyslog</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">url</code>: The URL to the syslog drain</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: cupsRoute</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">url</code>: The URL to the route service</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">type: stubrunner</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">coordinates</code>: The Maven coordinates of the stub runner jar</li><li class="listitem"><code class="literal">manifestPath</code>: The path to the manifest for the stub runner jar</li></ul></div></li></ul></div><p>The following example shows the contents of a YAML file that defines the preceding values:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># This file describes which services are required by this application</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># in order for the smoke tests on the TEST environment and end to end tests</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># on the STAGE environment to pass</span>

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># lowercase name of the environment</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">test</span>:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># list of required services</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      params</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        git</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          uri</span>: https://github.com/ciberkleid/app-config
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: cloud-bus
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: cloudamqp
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: lemur
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useExisting</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: io.pivotal:cloudfoundry-stub-runner-boot:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      manifestPath</span>: sc-pipelines/manifest-stubrunner.yml

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">stage</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-config-server
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      params</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        git</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          uri</span>: https://github.com/ciberkleid/app-config
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: cloud-bus
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: cloudamqp
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: lemur
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-service-registry
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - name</span>: circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      type</span>: broker
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      broker</span>: p-circuit-breaker-dashboard
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      plan</span>: standard</pre></div><p>Another CF specific property is <code class="literal">artifact_type</code>. Its value can be either <code class="literal">binary</code> or <code class="literal">source</code>.
Certain languages (such as Java) require a binary to be uploaded, but others (such as PHP)
require you to push the sources. The default value is <code class="literal">binary</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup" href="#_project_setup"></a>1.5&nbsp;Project Setup</h2></div></div></div><p>Spring Cloud Pipelines supports three main types of project setup:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">Single Project</code></li><li class="listitem"><code class="literal">Multi Module</code></li><li class="listitem"><code class="literal">Multi Project</code> (also known as mono repo)</li></ul></div><p>A <code class="literal">Single Project</code> is a project that contains a single module that gets
built and packaged into a single, executable artifact.</p><p>A <code class="literal">Multi Module</code> project is a project that contains multiple modules.
After building all modules, one gets packaged into a single, executable artifact.
You have to point to that module in your pipeline descriptor.</p><p>A <code class="literal">Multi Project</code> is a project that contains multiple projects. Each of those
projects can in turn be a <code class="literal">Single Project</code> or a <code class="literal">Multi Module</code> project. Spring
Cloud Pipelines assume that, if a <code class="literal">PROJECT_NAME</code> environment
variable corresponds to a folder with the same name in the root of the
repository, this is the project it should build. For example, for
<code class="literal">PROJECT_NAME=something</code>, if there&#8217;s a folder named <code class="literal">something</code>, then Spring Cloud Pipelines
treats the <code class="literal">something</code> directory as the root of the <code class="literal">something</code> project.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="how-do-the-scripts-work" href="#how-do-the-scripts-work"></a>2.&nbsp;How the Scripts Work</h2></div></div></div><p>This section describes how the scripts and jobs correspond to each other.
If you need to see detailed documentation of the bash scripts, go to the
code repository and read <code class="literal">common/src/main/bash/README.adoc</code>.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="build-and-deployment" href="#build-and-deployment"></a>2.1&nbsp;Build and Deployment</h2></div></div></div><p>The following text image (created via <a class="link" href="https://textart.io/sequence" target="_top">textart.io</a>) shows a high-level overview:</p><pre class="screen">+---------+                      +-----------+                      +-----------+ +-------+ +---------------+
| script  |                      | language  |                      | framework | | paas  | | customization |
+---------+                      +-----------+                      +-----------+ +-------+ +---------------+
     |                                 |                                  |           |             |
     | What is your language?          |                                  |           |             |
     |--------------------------------&gt;|                                  |           |             |
     |                                 |                                  |           |             |
     |       I'm written in X language |                                  |           |             |
     |&lt;--------------------------------|                                  |           |             |
     |                                 |                                  |           |             |
     |                                 | What framework do you use?       |           |             |
     |                                 |---------------------------------&gt;|           |             |
     |                                 |                                  |           |             |
     |                                 |                I use Y framework |           |             |
     |&lt;-------------------------------------------------------------------|           |             |
     |                                 |                                  |           |             |
     | I know that you use Z PAAS?     |                                  |           |             |
     |-------------------------------------------------------------------------------&gt;|             |
     |                                 |                                  |           |             |
     |                                 |  Here are all Z-related deployment functions |             |
     |&lt;-------------------------------------------------------------------------------|             |
     |                                 |                                  |           |             |
     | Anything custom to override in bash?                               |           |             |
     |---------------------------------------------------------------------------------------------&gt;|
     |                                 |                                  |           |             |
     |                                 |                                  |        Not this time... |
     |&lt;---------------------------------------------------------------------------------------------|
     |                                 |                                  |           |             |
     | Ok, run the script              |                                  |           |             |
     |-------------------              |                                  |           |             |
     |                  |              |                                  |           |             |
     |&lt;------------------              |                                  |           |             |
     |                                 |                                  |           |             |</pre><p>Before we run the script, we need to answer a few questions related to your repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">What is your language (for example, <code class="literal">jvm</code>,<code class="literal">php</code>, or something else)?</li><li class="listitem">what framework do you use (for example, <code class="literal">maven</code> or <code class="literal">gradle</code>)?</li><li class="listitem">what PAAS do you use (for example, <code class="literal">cf</code> or <code class="literal">k8s</code>)?</li></ul></div><p>The following sequence diagram (created via <a class="link" href="https://textart.io/sequence" target="_top">textart.io</a>) describes how the sourcing of bash scripts takes place:</p><pre class="screen">+---------+                                         +-----------+                                            +-------------+                   +-----------+            +-----------+                                   +-------+                            +---------+
| script  |                                         | pipeline  |                                            | projectType |                   | language  |            | framework |                                   | paas  |                            | custom  |
+---------+                                         +-----------+                                            +-------------+                   +-----------+            +-----------+                                   +-------+                            +---------+
     |                                                    |                                                         |                                |                        |                                             |                                     |
     | [source pipeline.sh]                               |                                                         |                                |                        |                                             |                                     |
     |---------------------------------------------------&gt;|                                                         |                                |                        |                                             |                                     |
     |                                                    | ------------------------------\                         |                                |                        |                                             |                                     |
     |                                                    |-| loading functions, env vars |                         |                                |                        |                                             |                                     |
     |                                                    | |-----------------------------|                         |                                |                        |                                             |                                     |
     |         -----------------------------------------\ |                                                         |                                |                        |                                             |                                     |
     |         | hopefully all functions get overridden |-|                                                         |                                |                        |                                             |                                     |
     |         | otherwise nothing will work            | |                                                         |                                |                        |                                             |                                     |
     |         |----------------------------------------| |                                                         |                                |                        |                                             |                                     |
     |                                                    | Source the [projectType/pipeline-projectType.sh]        |                                |                        |                                             |                                     |
     |                                                    |--------------------------------------------------------&gt;|                                |                        |                                             |                                     |
     |                                                    |                        -------------------------------\ |                                |                        |                                             |                                     |
     |                                                    |                        | What do we have here...?     |-|                                |                        |                                             |                                     |
     |                                                    |                        | A [mvnw] file,               | |                                |                        |                                             |                                     |
     |                                                    |                        | it has to be a [jvm] project | |                                |                        |                                             |                                     |
     |                                                    |                        |------------------------------| | Source [pipeline-jvm.sh]       |                        |                                             |                                     |
     |                                                    |                                                         |-------------------------------&gt;|                        |                                             |                                     |
     |                                                    |                                                         |                                |                        |                                             |                                     |
     |                                                    |                                                         |                                | Maven or Gradle?       |                                             |                                     |
     |                                                    |                                                         |                                |-----------------------&gt;|                                             |                                     |
     |                                                    |                                                         |                                |                        | ----------------------------------------\   |                                     |
     |                                                    |                                                         |                                |                        |-| There's a [mvnw] file?                |   |                                     |
     |                                                    |                                                         |                                |                        | | So the [PROJECT_TYPE] must be [maven] |   |                                     |
     |                                                    |                                                         |                                |                        | |---------------------------------------|   |                                     |
     |                                                    |                                                         |                                |   It's a Maven project |                                             |                                     |
     |                                                    |&lt;------------------------------------------------------------------------------------------------------------------|                                             |                                     |
     |                                                    |                                                         |                                |                        |                                             |                                     |
     |                                                    | The [PAAS_TYPE] is [cf] so I'll source [pipeline-cf.sh] |                                |                        |                                             |                                     |
     |                                                    |----------------------------------------------------------------------------------------------------------------------------------------------------------------&gt;|                                     |
     |                                                    |                                                         |                                |                        |                                             | -------------------------------\    |
     |                                                    |                                                         |                                |                        |                                             |-| Loading all                  |    |
     |                                                    |                                                         |                                |                        |                                             | | deployment-related functions |    |
     |                   -------------------------------\ |                                                         |                                |                        |                                             | |------------------------------|    |
     |                   | Ok, we know that it's Maven  |-|                                                         |                                |                        |                                             |                                     |
     |                   | and should be deployed to CF | |                                                         |                                |                        |                                             |                                     |
     |                   |------------------------------| |                                                         |                                |                        |                                             |                                     |
     |                                                    | Try to source [custom/build_and_upload.sh]              |                                |                        |                                             |                                     |
     |                                                    |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&gt;|
     |                                                    |                                                         |                                |                        |                                             |                                     | ----------------------------\
     |                                                    |                                                         |                                |                        |                                             |                                     |-| No such file so           |
     |                                                    |                                                         |                                |                        |                                             |                                     | | nothing custom to be done |
     | ---------------------------------------------\     |                                                         |                                |                        |                                             |                                     | |---------------------------|
     |-| All build related functions                |     |                                                         |                                |                        |                                             |                                     |
     | | overridden by language / framework scripts |     |                                                         |                                |                        |                                             |                                     |
     | -------------------------------\-------------|     |                                                         |                                |                        |                                             |                                     |
     |-| All deploy related functions |                   |                                                         |                                |                        |                                             |                                     |
     | | overridden by paas scripts   |                   |                                                         |                                |                        |                                             |                                     |
     | |------------------------------|                   |                                                         |                                |                        |                                             |                                     |
     | run [build] function                               |                                                         |                                |                        |                                             |                                     |
     |---------------------                               |                                                         |                                |                        |                                             |                                     |
     |                    |                               |                                                         |                                |                        |                                             |                                     |
     |&lt;--------------------                               |                                                         |                                |                        |                                             |                                     |
     |                                                    |                                                         |                                |                        |                                             |                                     |</pre><p>The process works as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">A script (for example, <code class="literal">build_and_upload.sh</code>) is called.</li><li class="listitem">It sources the <code class="literal">pipeline.sh</code> script that contains all the essential function &#8220;interfaces&#8221; and
environment variables.</li><li class="listitem"><code class="literal">pipeline.sh</code> needs information about the project type. It
sources <code class="literal">projectType/pipeline-projectType.sh</code>.</li><li class="listitem"><p class="simpara"><code class="literal">projectType/pipeline-projectType.sh</code> contains logic to determine the language.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">Verify whether a repository contains files that correspond to the given languages (for example, <code class="literal">mvnw</code> or <code class="literal">composer.json</code>).</li><li class="listitem">Verify whether a concrete framework that we support (for example, <code class="literal">maven</code> or <code class="literal">gradle</code>) is present.</li></ol></div></li><li class="listitem">Once we know what the project type is, we can deal with PAAS. Depending on the value of the <code class="literal">PAAS_TYPE</code> environment
variable, we can source proper PAAS functions (for example, <code class="literal">pipeline-cf.sh</code> for Cloud Foundry).</li><li class="listitem"><p class="simpara">Determine whether we can do some further customization.</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">Search for a file called <code class="literal">${sc-pipelines-root}/common/src/main/bash/custom/build_and_upload.sh</code>
to override any functions you want.</li></ol></div></li><li class="listitem">Run the <code class="literal">build</code> function from <code class="literal">build_and_upload.sh</code></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="project-crawler" href="#project-crawler"></a>2.2&nbsp;Project Crawler</h2></div></div></div><p>In Jenkins, you can generate the deployment pipelines by passing an environment variable
with a comma-separated list of repositories. This, however, does not scale. We would like to automatically fetch
a list of all repositories from a given organization and team.</p><p>To do so, we use the <a class="link" href="https://github.com/spring-cloud/project-crawler" target="_top">Project Crawler</a>
library, which can:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Fetch all projects for a given organization.</li><li class="listitem">Fetch contents of a file for a given repository.</li></ul></div><p>The following diagram depicts this situation:</p><pre class="screen">+---------+                                                  +-------+                                                                           +-------------+ +---------+
| Jenkins |                                                  | Seed  |                                                                           | SCPipelines | | Github  |
+---------+                                                  +-------+                                                                           +-------------+ +---------+
     |                                                           |                                                                                      |             |
     | Copy the seed job from the repo                           |                                                                                      |             |
     |-------------------------------------------------------------------------------------------------------------------------------------------------&gt;|             |
     |                                                           |                                                                                      |             |
     | Run seed job to generate Spinnaker pipelines and jobs     |                                                                                      |             |
     |----------------------------------------------------------&gt;|                                                                                      |             |
     |                                                           |                                                                                      |             |
     |                                                           | Crawl org [foo] and fetch all repositories                                           |             |
     |                                                           |---------------------------------------------------------------------------------------------------&gt;|
     |                                                           |                                                                                      |             |
     |                                                           |                                                                   In org [foo] there [a,b,c] repos |
     |                                                           |&lt;---------------------------------------------------------------------------------------------------|
     |                                                           |                                                                                      |             |
     |                                                           | For each repo fetch pipeline descriptor                                              |             |
     |                                                           |---------------------------------------------------------------------------------------------------&gt;|
     |                                                           |                                                                                      |             |
     |                                                           |                      There you go. [a] wants no [test] env, [b] no [stage] env, [c] wants all envs |
     |                                                           |&lt;---------------------------------------------------------------------------------------------------|
     |                                                           |                                                                                      |             |
     |                                                           | Build pipelines. For [a] without [test], for [b] without [stage]. All for [c]        |             |
     |                                                           |------------------------------------------------------------------------------        |             |
     |                                                           |                                                                             |        |             |
     |                                                           |&lt;-----------------------------------------------------------------------------        |             |
     |                             ----------------------------\ |                                                                                      |             |
     |                             | By having descriptors,    |-|                                                                                      |             |
     |                             | we can tune the pipelines | |                                                                                      |             |
     |                             | as the app wanted it to.  | |                                                                                      |             |
     |                             |---------------------------| | Build jobs / pipelines for [a,b,c] repos                                             |             |
     |                                                           |-----------------------------------------                                             |             |
     |                                                           |                                        |                                             |             |
     |                                                           |&lt;----------------------------------------                                             |             |
     |                                                           |                                                                                      |             |</pre><p>Thanks to the Project Crawler, you can run the seed job, and ,automatically, all the new repositories
are picked and pipelines are created for them. Project Crawler supports repositories
stored at Github, Gitlab, and Bitbucket. You can also register your own implementation. See the
<a class="link" href="https://github.com/spring-cloud/project-crawler" target="_top">Project Crawler</a> repository for more information.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="how-do-the-scripts-work-with-spinanker" href="#how-do-the-scripts-work-with-spinanker"></a>2.3&nbsp;How Scripts Work with Spinnaker</h2></div></div></div><p>With Spinnaker, the deployment pipeline is inside of Spinnaker. No longer do we treat
Jenkins or Concourse as a tool that does deployments. In Jenkins, we create only
the CI jobs (that is, build and test) and prepare the JSON definitions of Spinnaker pipelines.</p><p>The following diagram shows how Jenkins, the seed job for Spinnaker, and Spinnaker cooperate:</p><pre class="screen">+---------+                                                  +-------+                                                                           +-------------+                          +---------+ +-----------+
| Jenkins |                                                  | Seed  |                                                                           | SCPipelines |                          | Github  | | Spinnaker |
+---------+                                                  +-------+                                                                           +-------------+                          +---------+ +-----------+
     |                                                           |                                                                                      |                                      |            |
     | Copy the seed job from the repo                           |                                                                                      |                                      |            |
     |-------------------------------------------------------------------------------------------------------------------------------------------------&gt;|                                      |            |
     |                                                           |                                                                                      |                                      |            |
     | Run seed job to generate Spinnaker pipelines and jobs     |                                                                                      |                                      |            |
     |----------------------------------------------------------&gt;|                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           | Crawl org [foo] and fetch all repositories                                           |                                      |            |
     |                                                           |----------------------------------------------------------------------------------------------------------------------------&gt;|            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |     In org [foo] there [a,b,c] repos |            |
     |                                                           |&lt;----------------------------------------------------------------------------------------------------------------------------|            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           | For each repo fetch pipeline descriptor                                              |                                      |            |
     |                                                           |----------------------------------------------------------------------------------------------------------------------------&gt;|            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                            There you go. [a] wants no [test], [b] no [stage], [c] wants all |            |
     |                                                           |&lt;----------------------------------------------------------------------------------------------------------------------------|            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           | Build pipelines. For [a] without [test], for [b] without [stage]. All for [c]        |                                      |            |
     |                                                           |------------------------------------------------------------------------------        |                                      |            |
     |                                                           |                                                                             |        |                                      |            |
     |                                                           |&lt;-----------------------------------------------------------------------------        |                                      |            |
     |                             ----------------------------\ |                                                                                      |                                      |            |
     |                             | By having descriptors,    |-|                                                                                      |                                      |            |
     |                             | we can tune the pipelines | |                                                                                      |                                      |            |
     |                             | as the app wanted it to.  | |                                                                                      |                                      |            |
     |                             |---------------------------| | Build CI jobs for [a,b,c] repos                                                      |                                      |            |
     |                                                           |--------------------------------                                                      |                                      |            |
     |                                                           |                               |                                                      |                                      |            |
     |                                                           |&lt;-------------------------------                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            |
     |                                                           | Build Spinnaker pipelines JSON definitions                                           |                                      |            |
     |                                                           |-------------------------------------------                                           |                                      |            |
     |                                                           |                                          |                                           |                                      |            |
     |                                                           |&lt;------------------------------------------                                           |                                      |            |
     |                                                           |                                                                                      |                                      |            |
     |                                             Seed job done |                                                                                      |                                      |            |
     |&lt;----------------------------------------------------------|                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            |
     | Upload JSON pipelines to Spinnaker                        |                                                                                      |                                      |            |
     |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&gt;|
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            | The pipelines for [a,b,c] successfully created
     |                                                           |                                                                                      |                                      |            |-----------------------------------------------
     |                                                           |                                                                                      |                                      |            |                                              |
     |                                                           |                                                                                      |                                      |            |&lt;----------------------------------------------
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                Waiting for [spinnaker-a-build] build to start &amp; complete |
     |&lt;-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
     |                                                           |                                                                                      |                                      |            |
     | New commit! Running a build [spinnaker-a-build]           |                                                                                      |                                      |            |
     |------------------------------------------------           |                                                                                      |                                      |            |
     |                                               |           |                                                                                      |                                      |            |
     |&lt;-----------------------------------------------           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            |
     | Run the [build_and_upload.sh] script                      |                                                                                      |                                      |            |
     |-------------------------------------------------------------------------------------------------------------------------------------------------&gt;|                                      |            |
     |                                                           |                                                                                      | --------------------------------\    |            |
     |                                                           |                                                                                      |-| Proceed with all the sourcing |    |            |
     |                                                           |                                                                                      | | depending on language etc.    |    |            |
     |                                                           |                                                                                      | |-------------------------------|    |            |
     |                                                           |                                                                     Build completed! |                                      |            |
     |&lt;-------------------------------------------------------------------------------------------------------------------------------------------------|                                      |            |
     |                                                           |                                                                                      |                                      |            |
     | [spinnaker-a-build] started and completed                 |                                                                                      |                                      |            |
     |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&gt;|
     |                                                           |                                                                                      |                                      |            | ------------------------------------\
     |                                                           |                                                                                      |                                      |            |-| Running the rest of the pipeline! |
     |                                                           |                                                                                      |                                      |            | |-----------------------------------|
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            | Pipeline for [a] in progress. Deploy [a] to test env
     |                                                           |                                                                                      |                                      |            |-----------------------------------------------------
     |                                                           |                                                                                      |                                      |            |                                                    |
     |                                                           |                                                                                      |                                      |            |&lt;----------------------------------------------------
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                   Calling [spinnaker-a-test-on-test] to run test on test |
     |&lt;-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
     |                                                           |                                                                                      |                                      |            |
     | [spinnaker-a-test-on-test] started and completed          |                                                                                      |                                      |            |
     |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&gt;|
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            | ... we continue like this throughout the pipeline ...
     |                                                           |                                                                                      |                                      |            |------------------------------------------------------
     |                                                           |                                                                                      |                                      |            |                                                     |
     |                                                           |                                                                                      |                                      |            |&lt;-----------------------------------------------------
     |                                                           |                                                                                      |                                      |            |
     |                                                           |                                                                                      |                                      |            | ... and the pipeline is done
     |                                                           |                                                                                      |                                      |            |-----------------------------
     |                                                           |                                                                                      |                                      |            |                            |
     |                                                           |                                                                                      |                                      |            |&lt;----------------------------
     |                                                           |                                                                                      |                                      |            |</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="deployment-languages-compatibility-matrix" href="#deployment-languages-compatibility-matrix"></a>2.4&nbsp;Deployment &amp; languages compatibility matrix</h2></div></div></div><p>In the following table we present which language is supported by which deployment
mechanism.</p><div class="table"><a name="d0e796" href="#d0e796"></a><p class="title"><b>Table&nbsp;2.1.&nbsp;Deployment &amp; languages compatibility matrix</b></p><div class="table-contents"><table summary="Deployment &amp; languages compatibility matrix" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Language</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">CF</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">K8S</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Ansible</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JVM with Gradle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JVM with Maven</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PHP with Composer</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#10060;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>NodeJS with NPM</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#10060;</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Dotnet core</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&#9989;</p></td><td style="" align="left" valign="top"><p>&#10060;</p></td></tr></tbody></table></div></div><br class="table-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>For K8S, a deployment unit is a docker image so any language and framework
can be used.</p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_opinionated_implementation" href="#_opinionated_implementation"></a>3.&nbsp;Opinionated Implementation</h2></div></div></div><p>This section describes a full flow of the demo applications.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your applications need not have the same dependencies (such as <code class="literal">Eureka</code>) as this demo.</p></td></tr></table></div><p>For demo purposes, we provide Docker Compose setup with Artifactory, Concourse, and Jenkins tools.
Regardless of the CD application, for the pipeline to pass, you need one of the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">A Cloud Foundry instance (for example, <a class="link" href="https://run.pivotal.io/" target="_top">Pivotal Web Services</a> or <a class="link" href="https://pivotal.io/pcf-dev" target="_top">PCF Dev</a>).</li><li class="listitem">A Kubernetes cluster (for example, <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>).</li><li class="listitem">The infrastructure applications deployed to the JAR hosting application (for the demo, we provide Artifactory).</li><li class="listitem"><code class="literal">Eureka</code> for Service Discovery.</li><li class="listitem"><code class="literal">Stub Runner Boot</code> for running Spring Cloud Contract stubs.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demos, we show you how to first build the <code class="literal">github-webhook</code> project. That is because
the <code class="literal">github-analytics</code> needs the stubs of <code class="literal">github-webhook</code> to pass the tests. We also use
references to the <code class="literal">github-analytics</code> project, since it contains more interesting pieces as far as testing
is concerned.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_build" href="#_build"></a>3.1&nbsp;Build</h2></div></div></div><p>The following image shows the results of building the demo pipeline (which the rest of this chapter describes):</p><div class="figure"><a name="d0e945" href="#d0e945"></a><p class="title"><b>Figure&nbsp;3.1.&nbsp;Build and upload artifacts</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/build.png" alt="build"></div></div></div><br class="figure-break"><p>In this step, we  generate a version of the pipeline. Next, we
run unit, integration, and contract tests. Finally, we:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Publish a fat jar of the application.</li><li class="listitem">Publish a Spring Cloud Contract jar containing stubs of the application.</li><li class="listitem">For Kubernetes, upload a Docker image of the application.</li></ul></div><p>During this phase, we run a <code class="literal">Maven</code> build by using Maven Wrapper or a <code class="literal">Gradle</code> build by using Gradle Wrapper,
with unit and integration tests. We also tag the repository with <code class="literal">dev/${version}</code>. That way, in each
subsequent step of the pipeline, we can retrieve the tagged version. Also, we know
exactly which version of the pipeline corresponds to which Git hash.</p><p>Once the artifact is built, we run API compatibility check, as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">We search for the latest production deployment.</li><li class="listitem">We retrieve the contracts that were used by that deployment.</li><li class="listitem">From the contracts, we generat API tests to see if the current implementation
is fulfilling the HTTP and messaging contracts that the current production deployment
has defined (we check backward compatibility of the API).</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_test" href="#_test"></a>3.2&nbsp;Test</h2></div></div></div><p>The following image shows the result of doing smoke tests and rolling back:</p><div class="figure"><a name="d0e994" href="#d0e994"></a><p class="title"><b>Figure&nbsp;3.2.&nbsp;Smoke test and rollback test on test environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/test.png" alt="test"></div></div></div><br class="figure-break"><p>Here, we:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Start a RabbitMQ service in PaaS.</li><li class="listitem">Deploying <code class="literal">Eureka</code> infrastructure application to PaaS.</li><li class="listitem">Download the fat jar from Nexus and upload it to PaaS. We want the application
to run in isolation (be surrounded by stubs).</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Currently, due to port constraints in Cloud Foundry,
we cannot run multiple stubbed HTTP services in the cloud. To fix this issue, we run
the application with the <code class="literal">smoke</code> Spring profile, on which you can stub out all HTTP calls to return
a mocked response.</p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">If the application uses a database, it gets upgraded at this point by Flyway, Liquibase,
or any other migration tool once the application gets started.</li><li class="listitem">From the project&#8217;s Maven or Gradle build, we extract the <code class="literal">stubrunner.ids</code> property that contains
all the <code class="literal">groupId:artifactId:version:classifier</code> notations of dependent projects for which
the stubs should be downloaded.</li><li class="listitem">We upload <code class="literal">Stub Runner Boot</code> and pass the extracted <code class="literal">stubrunner.ids</code> to it. That way,
we have a running application in Cloud Foundry that downloads all the necessary stubs
of our application.</li><li class="listitem">From the checked-out code, we run the tests available under the <code class="literal">smoke</code> profile. In the
case of the <code class="literal">GitHub Analytics</code> application, we trigger a message from the <code class="literal">GitHub Webhook</code>
application&#8217;s stub and send the message by RabbitMQ to GitHub Analytics. Then we check whether the
message count has increased.</li><li class="listitem">Once the tests pass, we search for the last production release. Once the application
is deployed to production, we tag it with <code class="literal">prod/${version}</code>. If there is no such tag
(there was no production release), no rollback tests are run. If there was
a production release, the tests get executed.</li><li class="listitem">Assuming that there was a production release, we check out the code that corresponds to that
release (we check out the tag), download the appropriate artifact (either a JAR for Cloud Foundry
or a Docker image for Kubernetes), and we upload
it to PaaS.</li></ul></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>The old artifact runs against the <span class="strong"><strong>NEW</strong></span> version of the database.</p></td></tr></table></div><p>We run the old <code class="literal">smoke</code> tests against the freshly deployed application, surrounded by stubs.
If those tests pass, we have a high probability that the application is backwards compatible.
* The default behavior is that, after all of those steps, the user can manually click to deploy the
application to a stage environment.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_stage" href="#_stage"></a>3.3&nbsp;Stage</h2></div></div></div><p>The following image shows the result of deploying to a stage environment:</p><div class="figure"><a name="d0e1083" href="#d0e1083"></a><p class="title"><b>Figure&nbsp;3.3.&nbsp;End to end tests on stage environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stage.png" alt="stage"></div></div></div><br class="figure-break"><p>Here, we:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Start a RabbitMQ service in PaaS.</li><li class="listitem">Deploy <code class="literal">Eureka</code> infrastructure application to PaaS.</li><li class="listitem">Download the artifact (either a JAR for Cloud Foundry or a Docker image for Kubernetes)
upload it to PaaS.</li></ul></div><p>Next, we have a manual step in which, from the checked-out code, we run the tests available under the <code class="literal">e2e</code> profile. In the
case of the <code class="literal">GitHub Analytics</code> application, we send an HTTP message to the GitHub Analytics endpoint. Then we check whether
the received message count has increased.</p><p>By default, this step is manual, because the stage environment is often shared between
teams and some preparations on databases and infrastructure have to take place before the tests can be run.
Ideally, these step should be fully automatic.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prod" href="#_prod"></a>3.4&nbsp;Prod</h2></div></div></div><p>The following image shows the result of deploying to a production environment:</p><div class="figure"><a name="d0e1122" href="#d0e1122"></a><p class="title"><b>Figure&nbsp;3.4.&nbsp;Deployment to production</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/prod.png" alt="prod"></div></div></div><br class="figure-break"><p>The step to deploy to production is manual. However, ideally, it should be automatic.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This step does deployment to production. On production, we assume
that you have the infrastructure running. That is why, before you run this step, you
must run a script that provisions the services on the production environment.
For <code class="literal">Cloud Foundry</code>, call <code class="literal">tools/cf-helper.sh setup-prod-infra</code>.
For Kubernetes, call <code class="literal">tools/k8s-helper.sh setup-prod-infra</code>.</p></td></tr></table></div><p>Here, we:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Tag the Git repo with <code class="literal">prod/${version}</code>.</li><li class="listitem">Download the application artifact (either a JAR for Cloud Foundry or a Docker image for Kubernetes).</li><li class="listitem"><p class="simpara">We do Blue Green deployment:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">For Cloud Foundry:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">We rename the current instance of the application (for example, <code class="literal">myService</code> to <code class="literal">myService-venerable</code>).</li><li class="listitem">We deploy the new instance of the app under the <code class="literal">fooService</code> name</li><li class="listitem">Now, two instances of the same application are running on production.</li></ul></div></li><li class="listitem"><p class="simpara">For Kubernetes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">We deploy a service with the name of the application (for example, <code class="literal">myService</code>)</li><li class="listitem">We do a deployment with the name of the application with version suffix,with the name escaped
to fulfill the DNS name requirements (for example, <code class="literal">fooService-1-0-0-M1-123-456-VERSION</code>).</li><li class="listitem">All deployments of the same application have the same label <code class="literal">name</code>, which is equal to the application name (for example, <code class="literal">myService</code>).</li><li class="listitem">The service routes the traffic by basing on the <code class="literal">name</code> label selector.</li><li class="listitem">Now two instances of the same application are running in production.</li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">In the <code class="literal">Complete switch over</code>, which is a manual step, we stop the old instance.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Remember to run this step only after you have confirmed that both instances work.</p></td></tr></table></div></li><li class="listitem"><p class="simpara">In the <code class="literal">Rollback</code>, which is a manual step,</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">We route all the traffic to the old instance.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">In CF, we do that by ensuring that blue is running and removing green.</li><li class="listitem">In K8S, we do that by scaling the number of instances of green to 0.</li></ul></div></li><li class="listitem">We remov the latest prod Git tag.</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="project-opinions" href="#project-opinions"></a>4.&nbsp;Project Opinions</h2></div></div></div><p>This section goes through the assumptions we made in the project
structure and project properties.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cloud_foundry_project_opinions" href="#_cloud_foundry_project_opinions"></a>4.1&nbsp;Cloud Foundry Project Opinions</h2></div></div></div><p>We take the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The application is built by using the Maven or Gradle wrapper.</li><li class="listitem">The application is deployed to Cloud Foundry.</li><li class="listitem">Your application needs a <code class="literal">manifest.yml</code> Cloud Foundry descriptor.</li><li class="listitem"><p class="simpara">For the Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">example project</a>), we assume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of the Maven Wrapper.</li><li class="listitem"><p class="simpara"><code class="literal">settings.xml</code> is parametrized to pass the credentials to push code to Artifactory:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">M2_SETTINGS_REPO_ID</code> contains the server ID for Artifactory or Nexus deployment.</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> contains the username for Artifactory or Nexus deployment.</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> contains the password for Artifactory or Nexus deployment.</li></ul></div></li><li class="listitem">Artifacts are deployed by <code class="literal">./mvnw clean deploy</code>.</li><li class="listitem">We use the <code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded.</li><li class="listitem"><code class="literal">repo.with.binaries</code> property (injected by the pipeline): Contains the URL to the repo containing binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property (injected by the pipeline): Contains the ID of the distribution management. It corresponds to server ID in <code class="literal">settings.xml</code>.</li><li class="listitem"><code class="literal">distribution.management.release.url</code> property (injected by the pipeline): Contains the URL of the repository that contains binaries (for example, Artifactory).</li><li class="listitem">Running API compatibility tests with the <code class="literal">apicompatibility</code> Maven profile.</li><li class="listitem"><code class="literal">latest.production.version</code> property (injected by the pipeline): Contains the latest production version for the repo (retrieved from Git tags).</li><li class="listitem">Running smoke tests on a deployed app with the <code class="literal">smoke</code> Maven profile.</li><li class="listitem">Running end to end tests on a deployed app with the <code class="literal">e2e</code> Maven profile.</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file), we assume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of the Gradlew Wrapper.</li><li class="listitem">A <code class="literal">deploy</code> task for artifact deployment.</li><li class="listitem">The <code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code> environment variable (Injected by the pipeline) contains the URL to the repository that contains binaries (for example, Artifactory).</li><li class="listitem">The <code class="literal">M2_SETTINGS_REPO_USERNAME</code> environment variable contains the user name used to send the binary to the repository that contains binaries (for exampl,e Artifactory).</li><li class="listitem">The <code class="literal">M2_SETTINGS_REPO_PASSWORD</code> environment variable contains the password used to send the binary to the repository that contains binaries (for example, Artifactory).</li><li class="listitem">Running API compatibility tests with the <code class="literal">apiCompatibility</code> task.</li><li class="listitem"><code class="literal">latestProductionVersion</code> property (injected by the pipeline): Contains the latest production version for the repository (retrieved from Git tags).</li><li class="listitem">Running smoke tests on a deployed app with the <code class="literal">smoke</code> task.</li><li class="listitem">Running end to end tests on a deployed app with the <code class="literal">e2e</code> task.</li><li class="listitem"><code class="literal">groupId</code> task to retrieve the group ID.</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve the artifact ID.</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version.</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve the list of collaborators for which stubs should be downloaded.</li></ul></div></li><li class="listitem"><p class="simpara">For PHP (<a class="link" href="https://github.com/spring-cloud-samples/cf-php-example" target="_top">example project</a>), we asssume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of <a class="link" href="https://getcomposer.org/" target="_top">Composer</a>.</li><li class="listitem"><code class="literal">composer install</code> is called to fetch libraries.</li><li class="listitem"><p class="simpara">The whole application is compressed to <code class="literal">tar.gz</code> and uploaded to binary storage.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code> environment variable (injected by the pipeline): Contains the URL of the repository that contains binaries (for example, Artifactory)</li><li class="listitem">The <code class="literal">M2_SETTINGS_REPO_USERNAME</code> environment variable contains the user name used to send the binary to the repo containing binaries (for example, Artifactory).</li><li class="listitem">The <code class="literal">M2_SETTINGS_REPO_PASSWORD</code> environment variable contains the password used to send the binary to the repo containing binaries (for example, Artifactory).</li></ul></div></li><li class="listitem"><code class="literal">group-id</code>: Composer task that echoes the group ID.</li><li class="listitem"><code class="literal">app-name</code>: Composer task that echoes application name.</li><li class="listitem"><code class="literal">stub-ids</code>: Composer task that echoes stub runner ids.</li><li class="listitem"><code class="literal">test-apicompatibility</code>: Composer task that is executed for api compatibility tests.</li><li class="listitem"><code class="literal">test-smoke</code>: Composer task that is executed for smoke testing (the <code class="literal">APPLICATION_URL</code> and <code class="literal">STUBRUNNER_URL</code> environment variables are available here to be used).</li><li class="listitem"><code class="literal">test-e2e</code>: Composer task that is executed for end-to-end testing (<code class="literal">APPLICATION_URL</code> env vars is available here to be used)</li><li class="listitem"><code class="literal">target</code> is assumed to be the output folder. Put it in <code class="literal">.gitignore</code></li></ul></div></li><li class="listitem"><p class="simpara">For NodeJS (<a class="link" href="https://github.com/spring-cloud-samples/spring-cloud-contract-nodejs/tree/sc-pipelines" target="_top">example project</a>), we assume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of <a class="link" href="https://www.npmjs.com/" target="_top">npm</a></li><li class="listitem"><code class="literal">npm install</code> is called to fetch libraries.</li><li class="listitem"><code class="literal">npm test</code> is called to run tests.</li><li class="listitem"><code class="literal">npm run group-id</code>: npm task that echoes the group ID.</li><li class="listitem"><code class="literal">npm run app-name</code>: npm task that echoes application name.</li><li class="listitem"><code class="literal">npm run stub-ids</code>: npm task that echoes stub runner IDs.</li><li class="listitem"><code class="literal">npm run test-apicompatibility</code>: npm task that is executed for api compatibility tests.</li><li class="listitem"><code class="literal">npm run test-smoke</code>: npm task that is executed for smoke testing.</li><li class="listitem"><code class="literal">npm run test-e2e</code>: npm task that is executed for end-to-end testing.</li><li class="listitem"><code class="literal">target</code> is assumed to be the output folder. Put it in <code class="literal">.gitignore</code></li></ul></div></li><li class="listitem"><p class="simpara">For .Net (<a class="link" href="https://github.com/spring-cloud-samples/AspNetCoreExample" target="_top">example project</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of <a class="link" href="https://www.microsoft.com/net/core" target="_top">ASP.NET core</a></li><li class="listitem"><code class="literal">dotnet build</code> is called to build the project.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPUnitTests</code> is called to run unit tests.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPIntegrationTests</code> is called to run integration tests.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPPublish /p:Configuration=Release</code> is called to publish a
ZIP with a self-contained DLL, together with all manifests and deployment files.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPGroupId</code> is the npm task that echos the group ID.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPAppName</code> is the npm task that echos application name.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPStubIds</code> is the npm task that echos stub runner IDs.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPApiCompatibilityTest</code> is run for API compatibility tests.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPSmokeTests</code> is executed for smoke testing.</li><li class="listitem"><code class="literal">dotnet msbuild /nologo /t:CFPE2eTests</code> is executed for end-to-end testing.</li><li class="listitem"><code class="literal">target</code> is assumed to be the output folder. Add it to <code class="literal">.gitignore</code>.</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_kubernetes_project_opinions" href="#_kubernetes_project_opinions"></a>4.2&nbsp;Kubernetes Project Opinions</h2></div></div></div><p>We use the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The application is built by using the Maven or Gradle wrappers.</li><li class="listitem">The application is deployed to Kubernetes.</li><li class="listitem">The Java Docker image needs to allow passing of system properties through the <code class="literal">SYSTEM_PROPS</code> environment variable.</li><li class="listitem"><p class="simpara">For Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">example project</a>), we assume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of the Maven Wrapper.</li><li class="listitem"><p class="simpara"><code class="literal">settings.xml</code> is parametrized to pass the credentials to push code to Artifactory and Docker repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><code class="literal">M2_SETTINGS_REPO_ID</code>: Server ID for Artifactory or Nexus deployment.</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code>: User name for Artifactory or Nexus deployment.</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code>: Password for Artifactory or Nexus deployment.</li><li class="listitem"><code class="literal">DOCKER_SERVER_ID</code>: Server ID for Docker image pushing.</li><li class="listitem"><code class="literal">DOCKER_USERNAME</code>: User name for Docker image pushing.</li><li class="listitem"><code class="literal">DOCKER_PASSWORD</code>: Password for Docker image pushing.</li><li class="listitem"><code class="literal">DOCKER_EMAIL</code>: Email for Artifactory or Nexus deployment</li></ul></div></li><li class="listitem"><code class="literal">DOCKER_REGISTRY_URL</code> environment variable: Contains (Overridable - defaults to DockerHub) URL of the Docker registry.</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> environment variable: Contains the organization where your Docker repository resides.</li><li class="listitem">Artifacts and Docker image deployment is done by using <code class="literal">./mvnw clean deploy</code>.</li><li class="listitem"><code class="literal">stubrunner.ids</code> property: To retrieve list of collaborators for which stubs should be downloaded.</li><li class="listitem"><code class="literal">repo.with.binaries</code> property (injected by the pipeline): Contains the URL to the repo containing binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property (injected by the pipeline): Contains the ID of the distribution management. Corresponds to the server ID in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> property (injected by the pipeline): Contains the URL or the repository that contains binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor.</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor.</li><li class="listitem">running API compatibility tests with the <code class="literal">apicompatibility</code> Maven profile.</li><li class="listitem"><code class="literal">latest.production.version</code> property (injected by the pipeline): Contains the latest production version for the repository (retrieved from Git tags).</li><li class="listitem">Running smoke tests on a deployed app with the <code class="literal">smoke</code> Maven profile.</li><li class="listitem">Running end to end tests on a deployed app with the <code class="literal">e2e</code> Maven profile.</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle  (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file), we assume:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Usage of the Gradlew Wrapper.</li><li class="listitem"><code class="literal">deploy</code> task for artifact deployment.</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code> env var (injected by the pipeline): Contains the URL to the repository that contains binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> environment variable: User name used to send the binary to the repository that contains binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> environment variable: Password used to send the binary to the repository that contains binaries (for example, Artifactory).</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_URL</code> environment variable: (Overridable - defaults to DockerHub) URL of the Docker registry.</li><li class="listitem"><code class="literal">DOCKER_USERNAME</code> environment variable: User name used to send the the Docker image.</li><li class="listitem"><code class="literal">DOCKER_PASSWORD</code> environment variable: Password used to send the the Docker image.</li><li class="listitem"><code class="literal">DOCKER_EMAIL</code> environment variable: Email used to send the the Docker image.</li><li class="listitem"><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> environment variable: Contains the organization where your Docker repo resides.</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor.</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor.</li><li class="listitem">Running API compatibility tests with the <code class="literal">apiCompatibility</code> task.</li><li class="listitem"><code class="literal">latestProductionVersion</code> property (injected by the pipeline): Contains the latest production version for the repositoryi (retrieved from Git tags).</li><li class="listitem">Running smoke tests on a deployed application with the <code class="literal">smoke</code> task.</li><li class="listitem">Running end to end tests on a deployed application with the <code class="literal">e2e</code> task.</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group ID.</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact ID.</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version.</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve the list of collaborators for which stubs should be downloaded.</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_customizing_the_project" href="#_customizing_the_project"></a>5.&nbsp;Customizing the Project</h2></div></div></div><p>Spring Cloud Pipelines offers a number of ways to customize a Pipelines project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="xref" href="#customization-overriding-scripts" title="5.1&nbsp;Overriding Scripts">Section&nbsp;5.1, &#8220;Overriding Scripts&#8221;</a></li><li class="listitem"><a class="xref" href="#customization-overriding-pipelines" title="5.2&nbsp;Overriding Pipelines">Section&nbsp;5.2, &#8220;Overriding Pipelines&#8221;</a></li><li class="listitem"><a class="xref" href="#customization-picking-features" title="5.3&nbsp;Picking Features">Section&nbsp;5.3, &#8220;Picking Features&#8221;</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customization-overriding-scripts" href="#customization-overriding-scripts"></a>5.1&nbsp;Overriding Scripts</h2></div></div></div><p>Since Spring Cloud Pipelines evolves, you may want to pull the most recent changes to your
Spring Cloud Pipelines fork. To not have merge conflicts, the best approach
to extending the functionality is to use a separate script with customizations.</p><p>When we execute a script that represents a step (for example, a script named <code class="literal">build_and_upload.sh</code>),
after we source all the deployment and build-specific scripts (such as <code class="literal">pipeline-cf.sh</code>
and <code class="literal">projectType/pipeline-jvm.sh</code> with <code class="literal">projectType/pipeline-gradle.sh</code>), we set
a hook that lets you customize the behavior. If the script that we run
is <code class="literal">common/src/main/bash/build_and_upload.sh</code>, we search for a script in the
Spring Cloud Pipelines repository under <code class="literal">common/src/main/bash/custom/build_and_upload.sh</code>,
and we source that script just before running any functions.</p><p>The following example shows such a customization:</p><div class="example"><a name="d0e1943" href="#d0e1943"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;custom/build_and_upload.sh</b></p><div class="example-contents"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">#!/bin/bash</span>

function build() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"I am executing a custom build function"</span>
}

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> -f build</pre></div></div><br class="example-break"><p>when the <code class="literal">build</code> function is called for our Gradle project, instead of
calling the Gradle build process, we echo the following text: <code class="literal">I am executing a custom build function</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customization-overriding-pipelines" href="#customization-overriding-pipelines"></a>5.2&nbsp;Overriding Pipelines</h2></div></div></div><p>Currently, the best way to extend the Concourse and Jenkins Jenkinsfile pipelines is to make
a copy of the Concourse pipeline <code class="literal">yaml</code> files and the Jenkins seed and pipeline jobs.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_overriding_jenkins_job_dsl_pipelines" href="#_overriding_jenkins_job_dsl_pipelines"></a>5.2.1&nbsp;Overriding Jenkins Job DSL pipelines</h3></div></div></div><p>We provide an interface (called <code class="literal">org.springframework.cloud.pipelines.common.JobCustomizer</code>)
that lets you provide customization for:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">all jobs</li><li class="listitem">build jobs</li><li class="listitem">test jobs</li><li class="listitem">stage jobs</li><li class="listitem">prod jobs</li></ul></div><p>We use the JDK&#8217;s <code class="literal">java.util.ServiceLoader</code> mechanism to achieve extensibility.</p><p>You can write an implementation of that interface (for example, <code class="literal">com.example.MyJubCustomizer</code>)
and create a <code class="literal">META-INF/org.springframework.cloud.pipelines.common.JobCustomizer</code> file in which you put the
<code class="literal">com.example.MyJubCustomizer</code> line.</p><p>If you create a JAR with your class (for example <code class="literal">com.example:my-customizer:1.0.0</code>),
put it on the build classpath, as the following example shows:</p><div class="informalexample"><pre class="programlisting">dependencies {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// ...</span>
    libs <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"com.example:my-customizer:1.0.0"</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// ...</span>
}</pre></div><p>If you do not want to create a separate library, you can create an implementation in the
sources under <code class="literal">src/main/resources/META-INF</code>.</p><p>Regardless of what you chose, your implementation runs for each job. You can add notifications
or any other customizations of your choosing.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customization-picking-features" href="#customization-picking-features"></a>5.3&nbsp;Picking Features</h2></div></div></div><p>If you want to pick only pieces (for example you want only <code class="literal">Cloud Foundry</code> combined with
<code class="literal">Concourse</code>), you can run the following command:</p><div class="informalexample"><pre class="programlisting">$ ./gradlew customize</pre></div><p>A screen resembling the following appears:</p><div class="informalexample"><pre class="programlisting">:customize
  ___          _              ___ _             _   ___ _           _ _
 / __|_ __ _ _(_)_ _  __ _   / __| |___ _  _ __| | | _ (_)_ __  ___| (_)_ _  ___ ___
 \__ \ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'_ \ '</span>_| | <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">' \/ _` | | (__| / _ \ || / _` | |  _/ | '</span>_ \/ -_) | | <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">' \/ -_|_-&lt;
 |___/ .__/_| |_|_||_\__, |  \___|_\___/\_,_\__,_| |_| |_| .__/\___|_|_|_||_\___/__/
     |_|             |___/                               |_|



Follow the instructions presented in the console or terminate the process to quit (ctrl + c)


=== PAAS TYPE ===
Which PAAS type do you want to use? Options: [CF, K8S, BOTH]
&lt;-------------&gt; 0% EXECUTING
&gt; :customize</span></pre></div><p>Now you need to answer a couple of questions. Depending on your choices, whole files and their pieces
get removed and updated accordingly. For example, if you choose the <code class="literal">CF</code> and <code class="literal">Concourse</code> options,
the <code class="literal">Kubernetes</code> and <code class="literal">Jenkins</code> configuration and folders and pieces of code in
the project get removed.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_step_by_step_cloud_foundry_migration" href="#_step_by_step_cloud_foundry_migration"></a>6.&nbsp;Step-by-step Cloud Foundry Migration</h2></div></div></div><p>This section details how to migrate applications such that they become compatible with  Spring Cloud Pipelines.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_preview" href="#_preview"></a>6.1&nbsp;Preview</h2></div></div></div><p><a class="link" href="https://docs.google.com/presentation/d/e/2PACX-1vSsEHn8cJfz8oWIwwUhdULt7nZzz3bBLK7OqM8UInkZ0LbQBCpPdhMoxsYGPe_90h9OvCu7dFlAimMJ/pub?start=false&amp;loop=false&amp;delayms=3000" target="_top">Click here</a> to
check out the slides by <a class="link" href="https://twitter.com/ciberkleid" target="_top">Cora Iberkleid</a> where she
migrates a set of applications to be compliant with Spring Cloud Pipelines.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_introduction_2" href="#_introduction_2"></a>6.2&nbsp;Introduction</h2></div></div></div><p>This tutorial covers refactoring applications to be compatible with, and take advantage of, Spring Cloud Pipelines.</p><p>As an example, we use a simple three-tier application, shown in the following image:</p><div class="figure"><a name="d0e2074" href="#d0e2074"></a><p class="title"><b>Figure&nbsp;6.1.&nbsp;Use Case - Logical View</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_logical.png" alt="use case logical"></div></div></div><br class="figure-break"><p>At the end of this tutorial, you will be able to quickly create a Concourse pipeline for each application and run successfully through a full lifecycle, from source code commit to production deployment, following the lifecycle stages for testing and deployment recommended by Spring Cloud Pipelines. You will be able to improve application code bases with organized test coverage, a contract-based API, and a versioned database schema, letting Spring Cloud Pipelines carry out stubbed testing and ensure backward compatibility for API and database schema changes.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_initial_state" href="#_sample_application_initial_state"></a>6.3&nbsp;Sample Application&#8201;&#8212;&#8201;Initial State</h2></div></div></div><p>The sample application is implemented by using Spring Boot applications for the UI and service tiers and MySQL for the database.</p><p>The apps are built with Maven and manually pushed to Cloud Foundry. They leverage the three Pivotal Spring Cloud Services: Config Server, Service Discovery, and Circuit Breaker Dashboard. We use Rabbit to propagate Config Server refresh triggers.</p><p>The source code for the two Spring Boot applications is stored on GitHub, as is the backing repo for Config Server.</p><p>The following image shows an implementation view of the applications and their ancillary services:</p><div class="figure"><a name="d0e2096" href="#d0e2096"></a><p class="title"><b>Figure&nbsp;6.2.&nbsp;Use Case - Implementation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_implementation.png" alt="use case implementation"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_end_state" href="#_sample_application_end_state"></a>6.4&nbsp;Sample Application&#8201;&#8212;&#8201;End State</h2></div></div></div><p>Throughout this tutorial, we add Concourse and JFrog Bintray to manage the application lifecycle.</p><p>We also refactor the applications so that they become compatible with Spring Cloud Pipelines requirements and recommendations, including adding and organizing tests and introducing database versioning by using Flyway and introducing API contracts by using Spring Cloud Contract.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_toolset" href="#_tutorial_toolset"></a>6.5&nbsp;Tutorial&#8201;&#8212;&#8201;Toolset</h2></div></div></div><p>Throughout this tutorial, we use the following tools:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><span class="strong"><strong>GitHub</strong></span>: Sample application source code and configuration repositories, a sample stubrunner application repository, and the Spring Cloud Pipelines code base, including the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top"><code class="literal">greeting-ui</code></a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top"><code class="literal">fortune-service</code></a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">`app-confi`g</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top"><code class="literal">cloudfoundry-stub-runner-boot</code></a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top"><code class="literal">spring-cloud-pipelines</code></a></li></ul></div></li><li class="listitem"><span class="strong"><strong>Pivotal Web Services</strong></span>: Publicly hosted Cloud Foundry offering <a class="link" href="https://run.pivotal.io" target="_top">free trial accounts</a> and including MySQL, Rabbit, and Pivotal Spring Cloud Services in the Marketplace</li><li class="listitem"><span class="strong"><strong>Concourse</strong></span></li><li class="listitem"><span class="strong"><strong>JFrog Bintray</strong></span>: Publicly hosted Maven repository offering free <a class="link" href="https://bintray.com/signup/oss" target="_top">OSS accounts</a></li><li class="listitem"><span class="strong"><strong>Client Tools</strong></span>: On your local machine, you need an IDE as well as the mvn, git, cf, and fly (Concourse) CLIs</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_overview" href="#_tutorial_overview"></a>6.6&nbsp;Tutorial&#8201;&#8212;&#8201;Overview</h2></div></div></div><p>We separate the migration steps into three stages:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara"><span class="strong"><strong>Scaffolding</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Minimal refactoring to be compatible with basic Spring Cloud Pipelines requirements.</li><li class="listitem">At the end of this stage, each application has a corresponding pipeline on Concourse. The pipelines successfully build the applications, store the artifacts in Bintray, tag the GitHub repositories, and deploy the applications to the Test, Stage, and Prod spaces in Cloud Foundry.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Tests</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add and organize tests to be compatible with Spring Cloud Pipelines recommendations.</li><li class="listitem">Incorporate flyway for database schema versioning and initial data loading.</li><li class="listitem">At the end of this stage, the pipelines trigger unit and integration tests during the Build stage, smoke tests in the Test environment, and end-to-end tests in the Stage environment. The pipelines also ensure backward compatibility for the database, such that you can safely roll back the backend service application, even after the database schema has been updated.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Contracts</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Incorporate Spring Cloud Contract to define the API between the UI and service apps and auto-generate tests and stubs.</li><li class="listitem">At the end of this stage, the pipelines catch breaking API changes during the Build stage and ensure backward compatibility for the API, such that you can safely roll back the backend service (producer) app, even after an API change.</li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_step_by_step" href="#_tutorial_step_by_step"></a>6.7&nbsp;Tutorial&#8201;&#8212;&#8201;Step-by-step</h2></div></div></div><p>The remainder of this chapter is the actual tutorial, which consists of a preparation stage and three main stages:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="xref" href="#tutorial-prep" title="6.7.1&nbsp;Prep: Before you begin">Section&nbsp;6.7.1, &#8220;Prep: Before you begin&#8221;</a></li><li class="listitem"><a class="xref" href="#tutorial-stage-one" title="6.7.2&nbsp;Stage One: Scaffolding">Section&nbsp;6.7.2, &#8220;Stage One: Scaffolding&#8221;</a></li><li class="listitem"><a class="xref" href="#tutorial-stage-two" title="6.7.3&nbsp;Stage Two: Tests">Section&nbsp;6.7.3, &#8220;Stage Two: Tests&#8221;</a></li><li class="listitem"><a class="xref" href="#tutorial-stage-three" title="6.7.4&nbsp;Stage Three: Contracts">Section&nbsp;6.7.4, &#8220;Stage Three: Contracts&#8221;</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-prep" href="#tutorial-prep"></a>6.7.1&nbsp;Prep: Before you begin</h3></div></div></div><p>If you want to simply review the migration steps explained below, you can look at the various branches in the <a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a> and <a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a> repositories. A branch represents the end-state of each stage, as the following image shows:</p><div class="figure"><a name="d0e2243" href="#d0e2243"></a><p class="title"><b>Figure&nbsp;6.3.&nbsp;GitHub Branches</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/github_branches.png" alt="github branches"></div></div></div><br class="figure-break"><p>If you want to use this tutorial as a hands-on lab, fork each of the following repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a></li></ul></div><p>Then create a new directory on your local machine. You may name it anything you like. We refer to it as <code class="literal">$SCP_HOME</code> throughout this tutorial.</p><p>In <code class="literal">$SCP_HOME</code>, clone your forks of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, as well as the following two repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top">cloudfoundry-stub-runner-boot</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top">spring-cloud-pipelines</a></li></ul></div><p>Finally, create a directory called <code class="literal">$SCP_HOME/credentials</code>. Leave it empty for now.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-one" href="#tutorial-stage-one"></a>6.7.2&nbsp;Stage One: Scaffolding</h3></div></div></div><p>In this stage, we make minimal changes to satisfy basic Spring Cloud Pipelines requirements so that the applications can run through the entire pipeline without error. We make &#8220;scaffolding&#8221; changes only&#8201;&#8212;&#8201;no code changes.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>You must complete the steps in this stage for both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_1_create_github_branches" href="#_1_1_create_github_branches"></a>1.1 Create GitHub Branches</h4></div></div></div><p>Create branches in GitHub by using the following git commands:</p><div class="informalexample"><pre class="programlisting">git branch version
git checkout -b sc-pipelines</pre></div><p>The <code class="literal">version</code> branch is required to exist, though it can be created as an empty branch. It is used by Spring Coud Pipelines to generate a version number for each new pipeline execution.</p><p>The <code class="literal">sc-pipelines</code> branch is optional and can be named anything you wish. The intention is for you to use it as a working branch for the changes suggested in this tutorial (hence, you should both create it and check it out).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_2_add_maven_wrapper" href="#_1_2_add_maven_wrapper"></a>1.2 Add Maven Wrapper</h4></div></div></div><p>This step covers how to add the Maven wrapper (which lets your users build without having Maven on the path). To add the Maven wrapper, run the following command:</p><div class="informalexample"><pre class="programlisting">mvn -N io.takari:maven:wrapper</pre></div><p>This commands adds four files to a project:</p><div class="informalexample"><pre class="screen">.
&#9500;&#9472;&#9472; mvnw
&#9500;&#9472;&#9472; mvnw.cmd
&#9492;&#9472;&#9472; .mvn
    &#9492;&#9472;&#9472; wrapper
     &nbsp;&nbsp; &#9500;&#9472;&#9472; maven-wrapper.jar
     &nbsp;&nbsp; &#9492;&#9472;&#9472; maven-wrapper.properties</pre></div><p>Make sure all four files are tracked by Git. One way to do so is to add the following lines to the <code class="literal">.gitignore</code> file:</p><div class="informalexample"><pre class="screen">#Exceptions
!/mvnw
!/mvnw.cmd
!/.mvn/wrapper/maven-wrapper.jar
!/.mvn/wrapper/maven-wrapper.properties</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_3_create_the_bintray_maven_repository_package" href="#_1_3_create_the_bintray_maven_repository_package"></a>1.3 Create the Bintray Maven Repository Package</h4></div></div></div><p>We use Bintray as the Maven repository. Bintray requires that a package exist before any application artifacts can be uploaded.</p><p>Log into the Bintray UI and create the packages as follows (you can use the &#8220;Import from GitHub&#8221; option to create these):</p><div class="figure"><a name="d0e2357" href="#d0e2357"></a><p class="title"><b>Figure&nbsp;6.4.&nbsp;Bintray Packages</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/bintray_packages.png" alt="bintray packages"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_4_configure_distribution_management_by_using_the_bintray_maven_repository" href="#_1_4_configure_distribution_management_by_using_the_bintray_maven_repository"></a>1.4 Configure Distribution Management by Using the Bintray Maven Repository</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>You must do this step for both application repositories.</p></td></tr></table></div><p>Edit the application <code class="literal">pom.xml</code> files. Make sure that the Bintray URLs match the URLs of the corresponding packages created in the previous step. The values you use should differ from the following example in that they should point to your repository:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.url&gt;</span>https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span>

...

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distributionManagement&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${distribution.management.release.id}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;url&gt;</span>${distribution.management.release.url}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distributionManagement&gt;</span></pre></div><p>Though not required by Spring Cloud Pipelines, it makes sense to also configure your local maven settings with the credentials to your Bintray maven repository. To do so, edit your maven settings file (usually <code class="literal">~/.m2/settings.xml</code>). If the file does not exist, create it.</p><p>Note that the <code class="literal">id</code> must match the <code class="literal">id</code> specified in the previous step. Also, make sure to use your username and API token (not your account password) instead of the sample values shown in the following example:</p><div class="informalexample"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;settings&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;servers&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>ciberkleid<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>my-super-secret-api-token<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/servers&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/settings&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_5_push_changes_to_github" href="#_1_5_push_changes_to_github"></a>1.5 Push Changes to GitHub</h4></div></div></div><p>Push the changes you made in the preceding step to GitHub. You should be pushing the following to each of the two application repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Four new Maven wrapper files</li><li class="listitem">A modified <code class="literal">.gitignore</code> file</li><li class="listitem">A modified <code class="literal">pom.xml</code> file</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_6_add_a_spring_cloud_pipelines_credentials_file" href="#_1_6_add_a_spring_cloud_pipelines_credentials_file"></a>1.6 Add a Spring Cloud Pipelines Credentials File</h4></div></div></div><p>In <code class="literal">$SCP_HOME/credentials</code>, make two copies of the <code class="literal">$SCP_HOME/spring-cloud-pipelines/concourse/credentials-sample-cf.yml</code> file. Rename them as <code class="literal">credentials-fortune-service.yml</code> and <code class="literal">credentials-greeting-ui.yml</code>.</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>These files will contain credentials to your GitHub repository, your Bintray repository, and your Cloud Foundry foundation. Hence, we opt to put them in a separate directory. You may choose to store these files in a private Git repository, but do not push them to a public repository.</p></td></tr></table></div><p>Edit the Git properties of each credentials file. Make sure to replace the sample values shown in our example. For <code class="literal">tools-branch</code>, you can use a fixed release (use v1.0.0.M8 or later for Cloud Foundry). Leave the other values as they are. We update those in later steps. The following listing shows a credentials file:</p><div class="informalexample"><pre class="programlisting">app-url: git@github.com:ciberkleid/fortune-service.git
app-branch: sc-pipelines
tools-scripts-url: https://github.com/spring-cloud/spring-cloud-pipelines.git
tools-branch: master
build-options: ""

github-private-key: |
  -----BEGIN RSA PRIVATE KEY-----
  MIIJKQIBAAKCAgEAvwkL97vBllOSE39Wa5ppczT1cr5Blmkhadfoa1Va2/IBVyvk
  NJ9PqoTI+BahF2EgzweyiDSvKsstlTsG7QgiM9So8Voi2PlDOrXL6uOfCuAS/G8X
  ...
  -----END RSA PRIVATE KEY-----
git-email: ciberkleid@pivotal.io
git-name: Cora Iberkleid</pre></div><p>Edit the Maven repository properties of each credentials file. Make sure to replace the sample values shown in our example. Bintray requires separate URLs for uploads and downloads. If you use a different artifact repository, such as Artifactory or Nexus, and the repository URL is the same for uploads and downloads, you do not need to set <code class="literal">repo-with-binaries-for-upload</code>. The following listing shows the values to add or edit in your credentials file:</p><div class="informalexample"><pre class="programlisting">m2-settings-repo-id: bintray
m2-settings-repo-username: ciberkleid
m2-settings-repo-password: my-super-secret-api-token

repo-with-binaries: https://ciberkleid:my-super-secret-api-token@dl.bintray.com/ciberkleid/maven-repo

repo-with-binaries-for-upload: https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_7_set_the_concourse_pipeline" href="#_1_7_set_the_concourse_pipeline"></a>1.7 Set the Concourse Pipeline</h4></div></div></div><p>At this point, all of the build jobs, which run on Concourse workers, should succeed.</p><p>To verify this, log in to your Concourse target and set the Concourse pipelines. Update the target name in the following example:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set greeting-ui pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p greeting-ui -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-greeting-ui.yml"</span> -n

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set fortune-service pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p fortune-service -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-fortune-service.yml"</span> -n</pre></div><p>Log into the Concourse UI and un-pause the pipelines. Start each pipeline. You should see that the build jobs all succeed, similar to the following image:</p><div class="figure"><a name="d0e2465" href="#d0e2465"></a><p class="title"><b>Figure&nbsp;6.5.&nbsp;Build Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_build_success.png" alt="concourse build success"></div></div></div><br class="figure-break"><p>In addition, you should see a new <code class="literal">dev/&lt;version_number&gt;</code> tag in each GitHub repository and see the app jars uploaded into Bintray.</p><p>The test, stage, and prod jobs fail, because we have not yet added scaffolding for deployment to Cloud Foundry. We do that next.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_8_add_cloud_foundry_manifest" href="#_1_8_add_cloud_foundry_manifest"></a>1.8 Add Cloud Foundry manifest</h4></div></div></div><p>If you are deploying to Cloud Foundry, you may already be routinely including manifest files with your applications. Our sample applications did not have manifest files, so we add them now.</p><p>In the <code class="literal">greeting-ui</code> repository, create a <code class="literal">manifest.yml</code> file as follows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: greeting-ui
  timeout: 120
  services:
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>In the <code class="literal">fortune-service</code> repository, create a <code class="literal">manifest.yml</code> file as follows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>The <code class="literal">TRUST_CERTS</code> variable is used by the Pivotal Spring Cloud Services (Config Server, Service Registry, and Circuit Breaker Dashboard), which we use in this example. The value specified in the preceding example assumes deployment to Pivotal Web Services. Update it accordingly if you are deploying to a different Cloud Foundry foundation, or you can leave it out altogether if you are replacing the Pivotal Spring Cloud Services with alternative implementations (for example, deploying the services as applications and exposing them as user-provided services).</p><p>If you wishi, you can add additional values to the manifest files&#8201;&#8212;&#8201;for example, if additional values are useful for any manual deployment you may still want to do or if you need additional values in your Spring Cloud Pipelines deployment. For example, the following file could be an alternative <code class="literal">manifest.yml</code> for <code class="literal">fortune-service</code>:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  instances: 3
  memory: 1024M
  buildpack: https://github.com/cloudfoundry/java-buildpack.git
  random-route: true
  path: ./target/fortune-service-0.0.1-SNAPSHOT.jar
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: someProfile
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>Note that Spring Cloud Pipelines ignores <code class="literal">random-route</code> and <code class="literal">path</code>. <code class="literal">instances</code> is honored in stage and prod but is overridden with a value of 1 for test.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_9_add_the_spring_cloud_pipelines_manifest" href="#_1_9_add_the_spring_cloud_pipelines_manifest"></a>1.9 Add the Spring Cloud Pipelines Manifest</h4></div></div></div><p>The Cloud Foundry manifest created in the previous step includes the logical names of the services to which the applications should be bound, but it does not describe how the services can be provisioned. Hence, we add a second manifest file so that Spring Cloud Pipelines can provision the services.</p><p>Add a file called <code class="literal">sc-pipelines.yml</code> to each application and include the same list of services as in the corresponding <code class="literal">manifest.yml</code>. Add the necessary details such that Spring Cloud Pipelines can construct a <code class="literal">cf create-service</code> command.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The `type: broker' parameter in the next example instructs Spring Cloud Pipelines to provision a service by using `cf create-service'. Other service types are also supported: cups, syslog, route, app, and stubrunner.</p></td></tr></table></div><p>More specifically, for <code class="literal">greeting-ui</code>, create an <code class="literal">sc-pipelines.yml</code> file with the following content:</p><div class="informalexample"><pre class="programlisting">test:
  services:
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre></div><p>The <code class="literal">sc-pipelines.yml</code> file for <code class="literal">fortune-service</code> is similar, with the addition of the <code class="literal">fortune-db</code> service, as follows:</p><div class="informalexample"><pre class="programlisting">test:
  # list of required services
  services:
    - name: fortune-db
      type: broker
      broker: cleardb
      plan: spark
      useExisting: true
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre></div><p>The values in the preceding two examples assume deployment to Pivotal Web Services. If you are deploying to a different Cloud Foundry foundation, update the values accordingly. Also, make sure to replace the <code class="literal">config-server</code> URI with the address of your fork of the <a class="link" href="https://github.com/ciberkleid/app-config" target="_top"><code class="literal">app-config</code></a> repository.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the <code class="literal">useExisting: true</code> parameter in the preceding example. By default, Spring Cloud Pipelines deletes and re-creates services in the <code class="literal">test</code> space. To override this behavior and re-use existing services, we set <code class="literal">useExisting: true</code>. This is helpful in cases where services  may take time to provision and initialize, where there is no risk in re-using them between pipeline runs, or where it is desirable to retain the service instance from the last pipeline run (for example, a database migration).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_10_push_changes_to_github" href="#_1_10_push_changes_to_github"></a>1.10 Push changes to GitHub</h4></div></div></div><p>Push the preceding changes to GitHub. You should be pushing the following to each of the two application repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">A new app manifest file</li><li class="listitem">A new sc-pipelines manifest file</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_11_create_cloud_foundry_orgs_and_spaces" href="#_1_11_create_cloud_foundry_orgs_and_spaces"></a>1.11 Create Cloud Foundry Orgs and Spaces</h4></div></div></div><p>Spring Cloud Pipelines requires that the Cloud Foundry test, stage, and prod spaces exist before a pipeline is run. If you wish, you can use different foundations, orgs, and users for each. For simplicity, in this example, we use a single foundation (PWS), a single org, and a single user.</p><p>You can name the orgs and spaces anything you like. Each app requires its own test space. The stage and prod spaces are shared.</p><p>For this example, use the following commands to create spaces:</p><div class="informalexample"><pre class="programlisting">cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-greeting-ui
cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-fortune-service
cf create-space scp-stage
cf create-space scp-prod</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_12_create_cloud_foundry_stage_and_prod_service_instances" href="#_1_12_create_cloud_foundry_stage_and_prod_service_instances"></a>1.12 Create Cloud Foundry Stage and Prod Service Instances</h4></div></div></div><p>Spring Cloud Pipelines dynamically creates the services in the test spaces, as defined by the <code class="literal">sc-pipelines.yml</code> file we created previously. Optionally, you can add a second section to the <code class="literal">sc-pipelines.yml</code> file for the stage environment, and these are created dynamically as well. However, you must always crate prod manually.</p><p>For this example, we create both the stage and prod services manually.</p><p>Create the services listed in the application manifest files in both <code class="literal">scp-stage</code> and <code class="literal">scp-prod</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_13_update_the_spring_cloud_pipelines_credentials_file" href="#_1_13_update_the_spring_cloud_pipelines_credentials_file"></a>1.13 Update the Spring Cloud Pipelines Credentials File</h4></div></div></div><p>Update the <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> credentials files with Cloud Foundry information. Replace values in the next example as appropriate for your Cloud Foundry environment.</p><p>Notice that the test space name specified is a prefix, unlike the stage and prod space names, which are literals. Spring Cloud Pipelines append the application name to the test space name, thereby matching the test space names we created manually. The stage and prod space names are not prefixes and are not altered by Spring Cloud Pipelines.</p><p>Note also the <code class="literal">paas-hostname-uuid</code>. The value is included in each created route. This value is optional, but it is useful in shared or multi-tenant environments (such as PWS), as it helps to ensure routes are unique. Change it to a unique uuid.</p><p>The following example shows an updated credentials file:</p><div class="informalexample"><pre class="programlisting">pipeline-descriptor: sc-pipelines.yml

paas-type: cf

paas-hostname-uuid: cyi

# test values
paas-test-api-url: https://api.run.pivotal.io
paas-test-username: ciberkleid@pivotal.io
paas-test-password: secret
paas-test-org: S1Pdemo12
paas-test-space-prefix: scp-test

# stage values
paas-stage-api-url: https://api.run.pivotal.io
paas-stage-username: ciberkleid@pivotal.io
paas-stage-password: my-super-secret-password
paas-stage-org: S1Pdemo12
paas-stage-space: scp-stage

# prod values
paas-prod-api-url: https://api.run.pivotal.io
paas-prod-username: ciberkleid@pivotal.io
paas-prod-password: my-super-secret-password
paas-prod-org: S1Pdemo12
paas-prod-space: scp-prod</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_14_update_the_concourse_pipeline_with_updated_credentials_files" href="#_1_14_update_the_concourse_pipeline_with_updated_credentials_files"></a>1.14 Update the Concourse Pipeline with Updated Credentials Files</h4></div></div></div><p>Set the Concourse pipelines again, as we did previously, to update them with the values added to the credentials files. The test, stage, and prod jobs should all now succeed and result in output similar to the following image:</p><div class="figure"><a name="d0e2673" href="#d0e2673"></a><p class="title"><b>Figure&nbsp;6.6.&nbsp;Test, Stage, &amp; Prod Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_test_stage_prod_success.png" alt="concourse test stage prod success"></div></div></div><br class="figure-break"><p>On Cloud Foundry, you should now see the apps deployed in the test, stage, and prod spaces. The following image shows the deployment of <code class="literal">fortune-service</code> to its dedicated test space:</p><div class="figure"><a name="d0e2687" href="#d0e2687"></a><p class="title"><b>Figure&nbsp;6.7.&nbsp;Cloud Foundry Test and Prod Deployment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/cf_test_and_prod_deployed.png" alt="cf test and prod deployed"></div></div></div><br class="figure-break"><p>Notice that the five services declared in its manifest files (<code class="literal">sc-pipelines.yml</code> for provisioning and <code class="literal">manifest.yml</code> for binding) have also been automatically provisioned. The image also shows the deployment of the same app to the shared prod space. Notice that the instance of the previous version has been renamed as <code class="literal">venerable</code> and stopped. If a rollback were deemed necessary, the <code class="literal">prod-rollback</code> job in the pipeline could be triggered to remove the currently running version, remove the <code class="literal">prod/&lt;version_number&gt;</code> tag from GitHub, and re-start the former (<code class="literal">venerable</code>) version.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_one_recap_and_next_steps" href="#_stage_one_recap_and_next_steps"></a>Stage One Recap and Next Steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">By adding the basic scaffolding needed to enable Spring Cloud Pipelines to manage the lifecycle of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> from source code commit to production deploy, we have made it possible for the application development teams to instantly and easily create pipelines for each application by using a common, standardized template.</li><li class="listitem"><p class="simpara">We can count on the pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Automatically provision services in test spaces and, optionally, in stage spaces as well.</li><li class="listitem">Dynamically clean up the test spaces between pipeline executions.</li><li class="listitem">Upload the app artifacts to the maven repo (for example, Bintray).</li><li class="listitem">Tag the git repositories with <code class="literal">dev/&lt;version_number&gt;</code> and <code class="literal">prod/&lt;version_number&gt;</code>.</li></ul></div></li><li class="listitem">After each successful pipeline run, we can, if necessary, to roll back to the last deployed version byusing the <code class="literal">prod-rollback</code> job.</li></ul></div><p>These accomplishments are extremely valuable. However, to derive confidence and reliability from the pipelines, we need to incorporate testing. We do this in Stage Two of the application migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-two" href="#tutorial-stage-two"></a>6.7.3&nbsp;Stage Two: Tests</h3></div></div></div><p>In this stage, we enable Spring Cloud Pipelines to execute tests so that we can increase confidence in the code being deployed. We do so by adding test profiles to the <code class="literal">pom.xml</code> files and then organizing or adding tests in a way that corresponds to the profiles. By doing so, we establish standards around testing across development teams in the enterprise.</p><p>We will also enable database schema versioning in this stage, thereby providing the foundation for rollback testing during schema changes.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_1_add_maven_profiles" href="#_2_1_add_maven_profiles"></a>2.1 Add Maven Profiles</h4></div></div></div><p>For both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, add a <code class="literal">profiles</code> section to the <code class="literal">pom.xml</code> file, as shown in the next listing. Note that we are adding four profiles:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><code class="literal">default</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For unit and integration tests. Note that this profile includes all tests except those that are explicitly called by the smoke and e2e profiles.</li><li class="listitem">Tests matching this profile run during the build-and-upload job.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">apicompatibility</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For ensuring backward compatibility in case of API changes. Note that this is not effective until Stage Three, when we will add contracts. However, we add this profile now to ensure the api compatibility check during the <code class="literal">build-and-upload</code> job does not run other tests.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">smoke</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the application deployed in the test space.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">e2e</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the application deployed in the stage space.</li></ul></div></li></ul></div><p>The following listing shows the necessary <code class="literal">profiles</code> element of a <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profiles&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>smoke<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>e2e<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profiles&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_2_add_and_organize_tests" href="#_2_2_add_and_organize_tests"></a>2.2 Add and Organize Tests</h4></div></div></div><p>Next, we ensure that we have a matching test package structure in our apps, as the following image shows:</p><div class="figure"><a name="d0e2843" href="#d0e2843"></a><p class="title"><b>Figure&nbsp;6.8.&nbsp;Test Package Structure</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/test_package_structure.png" alt="test package structure"></div></div></div><br class="figure-break"><p>Note that we are creating matching packages only for the default, smoke, and e2e profiles. We will address the package for the <code class="literal">apicompatibility</code> profile in Stage Three.</p><p>When working with your own applications, if you have existing tests, you would move the files into one of these packages now and rename them so that they are included by the filters declared in the profiles (that is, the file names end in <code class="literal">Test.java</code> or <code class="literal">Tests.java</code>)</p><p>In the case of our sample apps, we have no tests, so we add some now.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_default_tests" href="#__literal_fortune_service_literal_default_tests"></a><code class="literal">fortune-service</code> Default Tests</h5></div></div></div><p>Add your unit and integration tests so that they match the default profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These are run on Concourse against the <code class="literal">fortune-service</code> application that runs on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we add two tests, one that loads the context and another that verifies the number of rows expected in the database. The following example defines these tests:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.assertj.core.api.Assertions.assertThat;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.junit.Assert.*;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = FortuneServiceApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> JdbcTemplate template;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> testDefaultSettings() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {
        assertThat(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.template.queryForObject(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SELECT COUNT(*) from FORTUNE"</span>,
                Integer.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>)).isEqualTo(<span class="hl-number">7</span>);
    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_smoke_tests" href="#__literal_fortune_service_literal_smoke_tests"></a><code class="literal">fortune-service</code> Smoke Tests</h5></div></div></div><p>Add your smoke tests so that they match the smoke profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-test-fortune-service</code> space. Two versions of these tests are executed against the application:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">the current version, in the <code class="literal">test-smoke</code> job.</li><li class="listitem">the latest prod version, in the <code class="literal">test-rollback-smoke</code> job.</li></ul></div><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e2925" href="#d0e2925"></a><p class="title"><b>Figure&nbsp;6.9.&nbsp;fortune-service Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_smoke_tests.png" alt="fortune service smoke tests"></div></div></div><br class="figure-break"><p>In the test environment, we choose to verify that <code class="literal">fortune-service</code> is retrieving a fortune from <code class="literal">fortune-db</code>, and not returning its Hystrix fallback response. The following example defines this test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_end_to_end_literal_e2e_literal_tests" href="#__literal_fortune_service_literal_end_to_end_literal_e2e_literal_tests"></a><code class="literal">fortune-service</code> End-to-end (<code class="literal">e2e</code>) Tests</h5></div></div></div><p>Add your end-to-end tests so that they match the <code class="literal">e2e</code> profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These tests run on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">greeting-ui</code> is also present.</p><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e2975" href="#d0e2975"></a><p class="title"><b>Figure&nbsp;6.10.&nbsp;fortune-service E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_e2e_tests.png" alt="fortune service e2e tests"></div></div></div><br class="figure-break"><p>In the <code class="literal">e2e</code> environment, we choose to use a string replacement to obtain the URL for <code class="literal">greeting-ui</code>. We also choose to verify that we hit <code class="literal">fortune-db</code> and do not receive Hystrix fallback responses from either application. The following example shows this test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// The app is running in CF but the tests are executed from Concourse worker,</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// so the test will deduce the url to greeting-ui: it will assume the same host</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// as fortune-service, and simply replace "fortune-service" with "greeting-ui" in the url</span>

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl.replace(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"fortune-service"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"greeting-ui"</span>) + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback responses from both fortune and greeting</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_default_tests" href="#__literal_greeting_ui_literal_default_tests"></a><code class="literal">greeting-ui</code> Default Tests</h5></div></div></div><p>Add your unit and integration tests so that they match the default profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application that runs on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we add one test that loads the context:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> GreetingUIApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_smoke_tests" href="#__literal_greeting_ui_literal_smoke_tests"></a><code class="literal">greeting-ui</code> Smoke Tests</h5></div></div></div><p>Add your smoke tests so that they match the smoke profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-test-greeting-ui</code> space. Two versions of these tests run against the app:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The current version, in the <code class="literal">test-smoke</code> job.</li><li class="listitem">The latest prod version, in the <code class="literal">test-rollback-smoke</code> job.</li></ul></div><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e3056" href="#d0e3056"></a><p class="title"><b>Figure&nbsp;6.11.&nbsp;greeting-ui Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_smoke_tests.png" alt="greeting ui smoke tests"></div></div></div><br class="figure-break"><p>Since <code class="literal">fortune-service</code> is not deployed to the <code class="literal">scp-test-greeting-ui</code> space, we expect to receive the Hystrix fallback response defined in <code class="literal">greeting-ui</code>. Hence, our smoke test validates that condition:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

    <em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

    RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fallback_fortune() {
        ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
                .getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

        BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Expect the hystrix fallback response</span>
        BDDAssertions.then(response.getBody()).contains(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_end_to_end_literal_e2e_literal_tests" href="#__literal_greeting_ui_literal_end_to_end_literal_e2e_literal_tests"></a><code class="literal">greeting-ui</code> End-to-end (<code class="literal">e2e</code>) Tests</h5></div></div></div><p>Add your end-to-end tests so that they match the <code class="literal">e2e</code> profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">fortune-service</code> is also present.</p><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e3109" href="#d0e3109"></a><p class="title"><b>Figure&nbsp;6.12.&nbsp;greeting-ui E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_e2e_tests.png" alt="greeting ui e2e tests"></div></div></div><br class="figure-break"><p>In the <code class="literal">e2e</code> environment, we choose to verify that we hit <code class="literal">fortune-service</code> and do not receive the Hystrix fallback response from <code class="literal">greeting-ui</code>. The following example shows the test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_3_enable_database_versioning" href="#_2_3_enable_database_versioning"></a>2.3 Enable Database Versioning</h4></div></div></div><p>At this point, we also incorporate <a class="link" href="https://flywaydb.org/" target="_top">Flyway</a>, an OSS database migration tool, to track database schema versions and handle schema changes and data loading.</p><p>This change needs to be made only to <code class="literal">fortune-service</code>, since <code class="literal">fortune-service</code> owns the interaction with <code class="literal">fortune-db</code>.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_add_flyway_dependency" href="#_add_flyway_dependency"></a>Add Flyway Dependency</h5></div></div></div><p>We first add the Flyway dependency to the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code>. We need not add a version as Spring Boot takes care of that for us. The following listing shows the Flyway dependency:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.flywaydb<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>flyway-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_create_flyway_migration" href="#_create_flyway_migration"></a>Create Flyway Migration</h5></div></div></div><p>Next, we create a migration directory and our initial migration file, following Flyway&#8217;s file naming convention. The following image shows the name of the file in context:</p><div class="figure"><a name="d0e3170" href="#d0e3170"></a><p class="title"><b>Figure&nbsp;6.13.&nbsp;fortune-service Flyway File Name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_file_name.png" alt="fortune service flyway file name"></div></div></div><br class="figure-break"><p>Note that the filename specifies the version (<code class="literal">V1</code>), followed by two underscore characters.</p><p>We place our <code class="literal">CREATE TABLE</code> and <code class="literal">INSERT</code> statements in our <code class="literal">src/main/resources/db/migration/V1__init.sql</code> file, as the following listing shows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">CREATE</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">TABLE</span> fortune (
  id <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">BIGINT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">PRIMARY</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">KEY</span> AUTO_INCREMENT,
  text <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">varchar</span>(<span class="hl-number">255</span>) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">not</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">null</span>
);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do what works.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do the right thing.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Always be kind.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You learn from your mistakes... You will learn a lot today.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You can always find happiness at work on Friday.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You will be hungry again in one hour.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Today will be an awesome day!'</span>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_disable_jpa_ddl_initialization" href="#_disable_jpa_ddl_initialization"></a>Disable JPA DDL Initialization</h5></div></div></div><p>Because we rely on Flyway to create and populate the schema, we need to disable JPA-based database initialization. We can set <code class="literal">ddl-auto</code> to <code class="literal">validate</code>, which validates the schema against the application entities and throws an error in case of a mismatch but does not actually generate the schema. The following snippet shows how to do so:</p><div class="informalexample"><pre class="programlisting">spring:
  jpa:
    hibernate:
      ddl-auto: validate</pre></div><p>There are a few options for where to store the <code class="literal">ddl-auto</code> configuration, both in terms of location (in the <code class="literal">fortune-service</code> app or on the <code class="literal">app-config</code> GitHub repo) and in terms of file name. For this example, update the <code class="literal">application.yml</code> in the <code class="literal">fortune-service</code> app for local testing. Additionally, save these values in a new file called <code class="literal">application-flyway.yml</code> on your fork of <a class="link" href="https://github.com/ciberkleid/app-config" target="_top"><code class="literal">app-config</code></a>.</p><p>By convention, <code class="literal">fortune-service</code> picks up the configurations in <code class="literal">application-flyway.yml</code> if the string <code class="literal">flyway</code> is in the list of active Spring profiles. Consequently, we can add <code class="literal">flyway</code> to the <code class="literal">SPRING_PROFILES_ACTIVE</code> environment variable in the <code class="literal">fortune-service</code> <code class="literal">manifest.yml</code>, as the following listing shows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: flyway
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_remove_non_flyway_data_loading" href="#_remove_non_flyway_data_loading"></a>Remove Non-Flyway Data Loading</h5></div></div></div><p>We can now remove the old code that populated the database. In our sample app, this was found in the <code class="literal">io.pivotal.FortuneServiceApplication</code> class. The following listing shows the code we now remove:</p><div class="informalexample"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    CommandLineRunner loadDatabase(FortuneRepository fortuneRepo) {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> args -&gt; {
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            logger.debug("loading database..");</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(1L, "Do what works."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(2L, "Do the right thing."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(3L, "Always be kind."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(4L, "You learn from your mistakes... You will learn a lot today."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(5L, "You can always find happiness at work on Friday."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(6L, "You will be hungry again in one hour."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(7L, "Today will be an awesome day!"));</span>
            logger.debug(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"record count: {}"</span>, fortuneRepo.count());
            fortuneRepo.findAll().forEach(x -&gt; logger.debug(x.toString()));
        };

    }</pre></div><p>We also no longer need the <code class="literal">Fortune</code> entity constructors, so we can comment these out in the <code class="literal">io.pivotal.fortune.Fortune</code> class as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune() {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune(Long id, String text) {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        super();</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.id = id;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.text = text;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_flyway_integration_summary" href="#_flyway_integration_summary"></a>Flyway Integration Summary</h5></div></div></div><p>With that, we have completed the setup for Flyway, and our database schema is now versioned. From this point onward, Spring Boot calls <code class="literal">Flyway.migrate()</code> to perform the database migration. As long as we follow Flyway conventions for future schema changes, Flyway takes care of tracking the schema version and migrating the database for us.</p><p>From a rollback perspective, Spring Cloud Pipelines includes two jobs in the <code class="literal">test</code> phase (<code class="literal">test-rollback-deploy</code> and <code class="literal">test-rollback-smoke</code>), wherein it validates that the latest prod jar works against the newly updated database. The purpose is to ensure that we can roll back the application in prod if a problem is discovered after the prod database schema has been updated and avoid the burden of rolling back the database.</p><p>See <a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-use-a-higher-level-database-migration-tool" target="_top">Spring Boot database initialization with Flyway</a> for further information, including Flyway configuration options.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_4_push_changes_to_github" href="#_2_4_push_changes_to_github"></a>2.4 Push Changes to GitHub</h4></div></div></div><p>For <code class="literal">greeting-ui</code>, you should push the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/java/e2e/E2eTests.java</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/GreetingUIApplicationTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li></ul></div><p>For <code class="literal">fortune-service</code>, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/java/e2e/E2eTests.java</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/FortuneServiceApplicationTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li><li class="listitem"><code class="literal">src/main/resources/db/migration/V1__init.sql</code></li><li class="listitem"><code class="literal">src/main/resources/application.yml</code></li><li class="listitem"><code class="literal">manifest.yml</code></li><li class="listitem"><code class="literal">src/main/java/io/pivotal/FortuneServiceApplication.java</code></li><li class="listitem"><code class="literal">src/main/java/io/pivotal/fortune/Fortune.java</code></li></ul></div><p>For <code class="literal">app-config</code>, you should be pushing the following new:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">application-flyway.yml</code></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_5_re_run_the_pipelines" href="#_2_5_re_run_the_pipelines"></a>2.5 Re-run the Pipelines</h4></div></div></div><p>Run through the pipelines again and view the output for the jobs that run the default, smoke, and end-to-end (<code class="literal">e2e</code>) tests. You should see that the tests we added in this stage were run.</p><p>As you run through the pipelines a second time, you should see the smoke tests from the latest prod version run against the database in the <code class="literal">test-rollback-smoke</code> job. In this case, there is no schema upgrade. Nonetheless, the tests confirm that the latest prod version of the app can be used with the current database schema.</p><p>You can see the database version information stored in the database by Flyway either by querying the database itself or by hitting the flyway endpoint on the <code class="literal">fortune-service</code> URL. The following image shows an example from the <code class="literal">scp-stage</code> environment:</p><div class="figure"><a name="d0e3406" href="#d0e3406"></a><p class="title"><b>Figure&nbsp;6.14.&nbsp;fortune-service Flyway Schema Info</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_schema_info.png" alt="fortune service flyway schema info"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_two_recap_and_next_steps" href="#_stage_two_recap_and_next_steps"></a>Stage Two Recap and Next Steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Increased the effectiveness of the pipelines and our confidence in them by integrating our applications with the testing strategy built into Spring Cloud Pipelines.</li><li class="listitem">Established a standard approach to organizing tests, which brings consistency within and across development teams.</li><li class="listitem">Enabled auto-managed database versioning and backward compatibility testing that alleviates database schema management throughout the release management lifecycle.</li></ul></div><p>We can now add any unit, integration, smoke, and end-to-end tests to our code base and have a high level of reliability and confidence in our pipelines. We are also better positioned to ensure that our development teams conform to these practices, given the structure established by Spring Cloud Pipelines and the fast feedback and visibility we gain from the pipelines as they execute the tests.</p><p>However, we could benefit further by incorporating contracts to define and test the API integration points between applications. We do this in Stage Three of the application migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-three" href="#tutorial-stage-three"></a>6.7.4&nbsp;Stage Three: Contracts</h3></div></div></div><p>In this stage, we introduce contract-based programming practices into our sample application. Doing so improves API management capabilities, including defining, communicating, and testing API semantics. It also lets us catch breaking API changes (that is, we can validate API backward compatibility) in the build phase. This extends the effectiveness of the pipelines, encourages better communication and programming practices across development teams, and provides faster feedback to developers.</p><p>We will integrate Spring Cloud Contract and add contracts, stubs, and a stub runner. We will also now complete and make use of the <code class="literal">apicompatibility</code> profile defined in <a class="xref" href="#tutorial-stage-two" title="6.7.3&nbsp;Stage Two: Tests">Section&nbsp;6.7.3, &#8220;Stage Two: Tests&#8221;</a>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_1_create_a_contract" href="#_3_1_create_a_contract"></a>3.1 Create a Contract</h4></div></div></div><p>We start by creating the contract for the interaction between <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>. The contract should describe the following expectation: <code class="literal">greeting-ui</code> makes a <code class="literal">GET</code> request to the root URL of <code class="literal">fortune-service</code> and expects a response with status 200 and a string (<code class="literal">new fortune</code>) in the body</p><p>We code this buy using groovy syntax as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.spec.Contract

Contract.make {
    description(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"
</span>should <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> a fortune string
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">")
</span>    request {
        method GET()
        url <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>
    }
    response {
        status <span class="hl-number">200</span>
        body <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"new fortune"</span>
    }
}</pre></div><p>Save this contract in the <code class="literal">fortune-service</code> code base in the following location (which is compliant with Spring Cloud Contract convention): <code class="literal">src/test/resources/contracts/&lt;service-name&gt;/&lt;contract-file&gt;</code>. The following image shows the contract file in its location within an IDE:</p><div class="figure"><a name="d0e3482" href="#d0e3482"></a><p class="title"><b>Figure&nbsp;6.15.&nbsp;fortune-service Flyway Contract File</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_contract_file.png" alt="fortune service contract file"></div></div></div><br class="figure-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can optionally enable your IDE to assist with contract syntax by adding the Spring Cloud Contract Verifier to your <code class="literal">pom.xml</code> file. It is pluggable, and includes groovy and pact by default. The following element shows the dependency to add:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_2_create_a_base_class_for_contract_tests" href="#_3_2_create_a_base_class_for_contract_tests"></a>3.2 Create a Base Class for Contract Tests</h4></div></div></div><p>Now that we have a coded contract, we want to enable auto-generation of contract-based tests. The auto-generation, which we will configure in the next steps, requires a base class that stubs out the service that satisfies the API call, so that we can run the test without external dependencies (for example, the database). The objective is to focus on testing API semantics.</p><p>We create the base class in the <code class="literal">fortune-service</code> test package as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.restassured.module.mockmvc.RestAssuredMockMvc;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Before;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.mockito.BDDMockito;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> BaseClass {

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> setup() {
        FortuneService service = BDDMockito.mock(FortuneService.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
        BDDMockito.given(service.getFortune()).willReturn(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
        RestAssuredMockMvc.standaloneSetup(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> FortuneController(service));
    }
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_3_enable_automated_contract_based_testing" href="#_3_3_enable_automated_contract_based_testing"></a>3.3 Enable Automated Contract-based Testing</h4></div></div></div><p>Now that we have a contract and a base class, we can use the Spring Cloud Contract Maven plugin to auto-generate contract tests, stubs, and a stub jar.</p><p>First we add the Spring Cloud Contract version to the list of properties in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file, since we will reference it when we enable the Spring Cloud Contract maven plugin. To do so, we add the <code class="literal">&lt;spring-cloud-contract.version&gt;</code> to the <code class="literal">properties</code> element, as follows:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;spring-cloud-contract.version&gt;</span>1.2.1.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/spring-cloud-contract.version&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre></div><p>Next, we edit the <code class="literal">default</code> profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract maven plugin.</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests.</li><li class="listitem">Configure it to place auto-generated tests in the <code class="literal">io.pivotal.fortune.contracttests</code> test package.</li></ul></div><p>Note that the package of the contract tests is included by the <code class="literal">include</code> filter in the <code class="literal">default</code> profile, so these tests run against the application during the <code class="literal">build-and-upload</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the application conforms to the contract.</p><p>The following listing shows the complete profile:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre></div><p>When the app is built, the Spring Cloud Contract maven plugin also now produces a stub and a stub jar that contains the contract and stub. This stub jar is uploaded to Bintray, along with the usual app jar. As we see shortly, this stub jar can be used by the <code class="literal">greeting-ui</code> development team while they wait for <code class="literal">fortune-service</code> to be completed. In other words, this gives the <code class="literal">greeting-ui</code> development team a producer to test against that is based on a mutually agreed-upon contract without the lead time of having to wait for <code class="literal">fortune-service</code> team to implement anything more than a base class and without having to manually stub out calls to <code class="literal">fortune-service</code> based on arbitrary or static responses.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Package the project locally (run <code class="literal">mvn package</code>) to observe the tests, stubs, and stub jar that the Spring Cloud Contract Maven plugin generates. See the following image for reference:</p></td></tr></table></div><div class="figure"><a name="d0e3604" href="#d0e3604"></a><p class="title"><b>Figure&nbsp;6.16.&nbsp;Generated Tests and Stubs</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_generated_tests.png" alt="fortune service generated tests"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_4_enable_backward_compatibility_api_check" href="#_3_4_enable_backward_compatibility_api_check"></a>3.4 Enable backward compatibility API check</h4></div></div></div><p>To enable Spring Cloud Pipelines to catch any breaking API changes during the the API compatibility check in the <code class="literal">build-and-upload</code> job, we add the Spring Cloud Contract Maven plugin to the <code class="literal">apicompatibility</code> profile as well.</p><p>In this case, we want the plugin to generate tests based on contracts outside of the project (the ones from the latest prod version), so we configure the plugin to download the latest prod stub jar, which contains the old contract. The plugin uses the old contract and the specified base class (which, in our example, is the same as the one in the previous step) to generate contract tests. These tests are run against the new code to validate that it is still compatible with consumers that comply with the prior contract. This ensures backward compatibility for the API.</p><p>In short, we edit the <code class="literal">apicompatibility</code> profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract Maven plugin.</li><li class="listitem">Configure it to download the latest prod stub jar from Bintray to obtain the old contract.</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests (we use the same one as in the prior step).</li><li class="listitem">Configure it to place auto-generated tests in the <code class="literal">io.pivotal.fortune.contracttests</code> test package.</li></ul></div><p>Note that the package of the contract tests matches the <code class="literal">include</code> filter in the <code class="literal">apicompatibility</code> profile, so these tests run against the app during the the API compatibility check during the <code class="literal">build-and-upload</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the app conforms to the old contract.</p><p>The following listing shows the complete profile:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsRepositoryUrl&gt;</span>${repo.with.binaries}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsRepositoryUrl&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractDependency&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>${project.groupId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>${project.artifactId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;classifier&gt;</span>stubs<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/classifier&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${latest.production.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractDependency&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsPath&gt;</span>/<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsPath&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre></div><p>Spring Cloud Pipelines dynamically injects the values for <code class="literal">${repo.with.binaries}</code> and <code class="literal">${latest.production.version}</code>. You can run this locally by providing these values manually as system properties in the Maven command.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_5_push_changes_to_github" href="#_3_5_push_changes_to_github"></a>3.5 Push Changes to GitHub</h4></div></div></div><p>All changes in Stage Three thus far are in <code class="literal">fortune-service</code>. At this point, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/resources/contracts/greeting-ui/shouldReturnAFortune.groovy</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/fortune/BaseClass.java</code></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_6_re_run_the_literal_fortune_service_literal_pipeline" href="#_3_6_re_run_the_literal_fortune_service_literal_pipeline"></a>3.6 Re-run the <code class="literal">fortune-service</code> Pipeline</h4></div></div></div><p>Run through the <code class="literal">fortune-service</code> pipeline to generate stubs. The following output from the <code class="literal">build-and-upload</code> job shows the auto-generation of tests and stubs:</p><div class="figure"><a name="d0e3718" href="#d0e3718"></a><p class="title"><b>Figure&nbsp;6.17.&nbsp;fortune-service build-and-upload Test and Stub Generation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_build_and_upload_test_and_stub_generation.png" alt="fortune service build and upload test and stub generation"></div></div></div><br class="figure-break"><p>You should also see output in the <code class="literal">build-and-upload</code> job that shows the execution of these tests against the code.</p><p>Additionally, you should see the stub jar uploaded to Bintray along with the usual app jar.</p><p>Finally, as you run through the pipeline a second time, you should see that the contract tests from the latest prod version run against the new code in the output of the the API compatibility check during the <code class="literal">build-and-upload</code> job. In this case, there is no API change. Nonetheless, the tests confirm that the latest prod version of the API can be used with the current code base.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_7_enable_stubs_for_integration_tests" href="#_3_7_enable_stubs_for_integration_tests"></a>3.7 Enable Stubs for Integration Tests</h4></div></div></div><p>Now we turn our attention to <code class="literal">greeting-ui</code>.</p><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the build phase, both with and without stubs:</p><div class="figure"><a name="d0e3752" href="#d0e3752"></a><p class="title"><b>Figure&nbsp;6.18.&nbsp;greeting-ui Build Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_build_flow.png" alt="greeting ui build flow"></div></div></div><br class="figure-break"><p>Without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract. In this case, the stubs are loaded into the <code class="literal">greeting-ui</code> process. This leads us to our next task: Loading the stubs produced by <code class="literal">fortune-service</code>.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_enable_the_in_process_stub_runner" href="#_enable_the_in_process_stub_runner"></a>Enable the in-process Stub Runner</h5></div></div></div><p>To load the stubs into the <code class="literal">greeting-ui</code> process, we must enable the Spring Cloud Contract Stub Runner dependency. This dependency start ans in-process stub runner that automatically configures Wiremock.</p><p>Add the following dependency to the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-stub-runner<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_add_integration_tests_aligned_with_the_contract" href="#_add_integration_tests_aligned_with_the_contract"></a>Add Integration Tests Aligned with the Contract</h5></div></div></div><p>Next, we add integration tests to <code class="literal">greeting-ui</code> to test for the expected response declared in the contract.</p><p>Add the following class to the <code class="literal">test</code> package in <code class="literal">greeting-ui</code>:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.pivotal.GreetingUIApplication;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class, webEnvironment = SpringBootTest.WebEnvironment.NONE,
        properties = {"spring.application.name=greeting-ui", "spring.cloud.circuit.breaker.enabled=false", "hystrix.stream.queue.enabled=false"})</span></em>
<em><span class="hl-annotation" style="color: gray">@AutoConfigureStubRunner(ids = {"io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION"},
        repositoryRoot = "${REPO_WITH_BINARIES}"
        //workOffline = true
)</span></em>

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> FortuneService fortuneService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> shouldSendRequestToFortune() {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// when</span>
        String fortune = fortuneService.getFortune();
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// then</span>
        BDDAssertions.then(fortune).isEqualTo(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
    }

}</pre></div><p>At this point, we can get through the build phase for <code class="literal">greeting-ui</code>, and the integration tests run against the <code class="literal">fortune-service</code> stubs that runs in the <code class="literal">greeting-ui</code> process on the Concourse worker.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the configuration of <code class="literal">@AutoConfigureStubRunner</code>. You can replace the version with a <code class="literal">+</code> sign if using Artifactory or Nexus and it automatically chooses the latest available version on the maven repo.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Setting <code class="literal">workOffline=true</code> (commented out but shown earlier for informational purposes) would make the stub runner get the stubs from the local Maven repository. This is useful for local testing. Alternatively, set the <code class="literal">$REPO_WITH_BINARIES</code> environment variable to the value used in the credentials file before doing a local Maven build. Then the local build will download the stubs from your remote Maven repository (for example, Bintray).</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_8_enable_stubs_for_smoke_tests" href="#_3_8_enable_stubs_for_smoke_tests"></a>3.8 Enable Stubs for Smoke Tests</h4></div></div></div><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the test phase, both with and without stubs. Note that in the build phase, where the app process runS on the Concourse worker, we ran the stubs in the same process. In the test environment (Cloud Foundry), we run the stubs in a separate process by using a standalone stub runner application. The following image shows the test flow for the <code class="literal">greeting-ui</code> application:</p><div class="figure"><a name="d0e3850" href="#d0e3850"></a><p class="title"><b>Figure&nbsp;6.19.&nbsp;greeting-ui Test Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_test_flow.png" alt="greeting ui test flow"></div></div></div><br class="figure-break"><p>As in the build phase, without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract.</p><p>We rely on Spring Cloud Pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Deploy a stub runner application.</li><li class="listitem">Provide the stub runner application with the necessary information to download the stubs.</li><li class="listitem">Open a port on the stub runner application for each stub.</li></ul></div><p>We rely on the stub runner application to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Download the stubs from our Maven repository (Bintray).</li><li class="listitem">Expose each stub on a separate port.</li><li class="listitem">Register each stub in the Service Discovery server.</li></ul></div><p>The following steps describe how to configure stubs for smoke tests.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_a_stand_alone_stub_runner_app_jar" href="#_provide_a_stand_alone_stub_runner_app_jar"></a>Provide a Stand-alone Stub Runner App Jar</h5></div></div></div><p>In the <a class="link" href="#tutorial-prep" title="6.7.1&nbsp;Prep: Before you begin">Prep step</a> for this tutorial, you cloned the <a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top"><code class="literal">cloudfoundry-stub-runner-boot</code></a> repo to your local machine. The next step is to build this application and upload it to Bintray to make the jar available to Spring Cloud Pipelines.</p><p>As mentioned in <a class="xref" href="#tutorial-stage-one" title="6.7.2&nbsp;Stage One: Scaffolding">Section&nbsp;6.7.2, &#8220;Stage One: Scaffolding&#8221;</a> of this tutorial, Bintray requires that a package exist before any application artifacts can be uploaded. Log into the Bintray UI and create a package for <code class="literal">cloudfoundry-stub-runner-boot</code>. If you forked this repo, you can use the <code class="literal">Import from GitHub</code> option. Otherwise, create the package manually and choose any license (for example, Apache 2.0).</p><p>Now you are ready to build and upload this app to Bintray. Edit the following script (which shows cloning, building, and uploading) to match your Bintray URL, the Bintray ID in your <code class="literal">~/.m2/settings/xml</code> file, and the <code class="literal">cloudfoundry-stub-runner-boot</code> repository URL (if you chose to fork it):</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Edit to match your Bintray URL and M2 repo ID setting (check your ~/.m2/settings.xml file)</span>
MAVEN_REPO_URL=https://api.bintray.com/maven/ciberkleid/maven-repo/cloudfoundry-stub-runner-boot
MAVEN_REPO_ID=bintray

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Clone cloudfoundry-stub-runner-boot</span>
git clone https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot.git
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> cloudfoundry-stub-runner-boot

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Build and upload</span>
./mvnw clean deploy -Ddistribution.management.release.url=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_URL}"</span> -Ddistribution.management.release.id=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_ID}"</span></pre></div><p>You should now see the <code class="literal">cloudfoundry-stub-runner-boot</code> artifacts uploaded on Bintray.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_stand_alone_stub_runner_application_manifest" href="#_provide_stand_alone_stub_runner_application_manifest"></a>Provide Stand-alone Stub Runner Application Manifest</h5></div></div></div><p>Next, we add a manifest file for the stub runner application for deployment to Cloud Foundry.</p><p>Place this file in the <code class="literal">greeting-ui</code> repo. The file name and location can be your choice. For this example, we use <code class="literal">sc-pipelines/manifest-stubrunner.yml</code>. The following image shows the file in the appropriate folder:</p><div class="figure"><a name="d0e3941" href="#d0e3941"></a><p class="title"><b>Figure&nbsp;6.20.&nbsp;greeting-ui Stub Runner Manifest</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stubrunner_manifest.png" alt="greeting ui stubrunner manifest"></div></div></div><br class="figure-break"><p>We populate this <code class="literal">manifest-stubrunner.yml</code> with the content shown in the next listing so that the stub runner binds to <code class="literal">service-registry</code>. The stub runner registers the <code class="literal">fortune-service</code> stub there so that <code class="literal">greeting-ui</code> can discover it in the same way it discovers the actual <code class="literal">fortune-service</code> app endpoint in stage and prod. From the <code class="literal">greeting-ui</code> perspective, there is no difference in how it interacts with Eureka and the stub runner application in test and the way it interacts with Eureka and the <code class="literal">fortune-service</code> application in stage and prod. The following listing shows the content of <code class="literal">manifest-stubrunner.yml</code>:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: stubrunner
  timeout: 120
  services:
  - service-registry
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io
----</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_a_stub_runner_jar_and_manifest_information_to_the_pipeline" href="#_provide_a_stub_runner_jar_and_manifest_information_to_the_pipeline"></a>Provide a Stub Runner Jar and Manifest Information to the Pipeline</h5></div></div></div><p>Now that we have a jar file and a manifest file for our stub runner application, we need to provide this information to our <code class="literal">greeting-ui</code> pipeline so that the pipeline downloads the jar from Bintray and deploys it to Cloud Foundry. We do this through the <code class="literal">greeting-ui</code> <code class="literal">sc-pipelines.yml</code> file. We add an entry to the list of services in the <code class="literal">test</code> section, as follows:</p><div class="informalexample"><pre class="programlisting">    - name: stubrunner
      type: stubrunner
      coordinates: io.pivotal:cloudfoundry-stub-runner-boot:0.0.1.M1
      pathToManifest: sc-pipelines/manifest-stubrunner.yml</pre></div><p>Notice that <code class="literal">name</code> matches the name of the application in <code class="literal">manifest-stubrunner.yml</code>, <code class="literal">coordinates</code> corresponds to the jar coordinates of the Maven repository, and <code class="literal">pathToManifest</code> matches our chosen fie name for the stub runner application manifest.</p><p>Note also the <code class="literal">type</code> is set to <code class="literal">stubrunner</code>, which Spring Cloud Pipelines will recognize as a stanalone stub runner app and treat accordingly.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_stub_configuration_for_the_stub_runner_application" href="#_provide_stub_configuration_for_the_stub_runner_application"></a>Provide Stub Configuration for the Stub Runner Application</h5></div></div></div><p>The final steps in the configuration of the stand-alone stub runner app are as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Enable the stub runner app to download the <code class="literal">fortune-service</code> stub from Bintray.</li><li class="listitem">Open a second port on the container to receive requests for this stub.</li></ul></div><p>To accomplish this, we put stub and port configuration information into the properties section of the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file, by using a property called <code class="literal">stubrunner.ids</code>. This property can accept a list of stubrunner IDs. However, for this tutorial, we only have one, as follows:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Tell stub runner app to start this stub--&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;stubrunner.ids&gt;</span>io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION:stubs:10000<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/stubrunner.ids&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre></div><p>Spring Cloud Pipelines uses this information in two ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">It provides this information to the stub runner application through the application&#8217;s environment variables.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Spring Cloud Pipelines also provides the <code class="literal">$REPO_WITH_BINARIES</code> as an environment variable for the stub runner application.</li><li class="listitem">The stub runner application uses this information to download the stub from Bintray and expose it on the specified port.</li></ul></div></li><li class="listitem"><p class="simpara">It opens the additional port specified on the stub runner app and map a new route to it.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">The format for each route is <code class="literal">&lt;stub-runner-app-name&gt;-&lt;hostname-uuid&gt;-&lt;env&gt;-&lt;app-name&gt;-&lt;port&gt;.&lt;domain&gt;</code>.</li><li class="listitem">In our example, this would be <code class="literal">stubrunner-cyi-test-greeting-ui-10000.cfapps.io</code>.</li></ul></div></li></ul></div><p>Since we bound our stub runner application to <code class="literal">service-registry</code> (Eureka), the stub runner application registers the stub URL under the <code class="literal">FORTUNE-SERVICE</code> application name on Eureka, as the following image shows:</p><div class="figure"><a name="d0e4090" href="#d0e4090"></a><p class="title"><b>Figure&nbsp;6.21.&nbsp;greeting-ui Stub Runner Eureka Registration</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stub_runner_eureka_registration.png" alt="greeting ui stub runner eureka registration"></div></div></div><br class="figure-break"><p>This completes the process of configuring the stand-alone stub runner application.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can automate the port configuration by Spring Cloud Pipelines in the future such that you need not include the port in <code class="literal">stubrunner.ids</code>. However, for the moment, we are required to specify the port each stub should use.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_edit_smoke_tests_to_align_with_the_contract" href="#_edit_smoke_tests_to_align_with_the_contract"></a>Edit Smoke Tests to Align with the Contract</h5></div></div></div><p>Finally, we edit our smoke tests for <code class="literal">greeting-ui</code> to ensure the response does not contain the Hystrix fallback, since we are now expecting a response from the stub. The following listing shows the edited smoke tests:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre></div><p>In this case, in contrast to the integration test we created earlier for <code class="literal">greeting-ui</code>, we do not include <code class="literal">@AutoConfigureStubRunner</code>, because we are using a standalone stub runner application.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_9_push_changes_to_github" href="#_3_9_push_changes_to_github"></a>3.9 Push Changes to GitHub</h4></div></div></div><p>Push contract-based changes for <code class="literal">greeting-ui</code>. You should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">sc-pipelines.yml</code></li><li class="listitem"><code class="literal">sc-pipelines/manifest-stubrunner.yml</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/fortune/FortuneServiceTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li></ul></div><p>At this point, we can run through the full pipeline for <code class="literal">greeting-ui</code> and leverage the contract-based stub in both the build and test environments.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_three_recap" href="#_stage_three_recap"></a>Stage Three Recap</h4></div></div></div><p>What have we accomplished?</p><p>By implementing a contract-driven approach with auto-generation of tests and stubs, we have introduced a clean, structured, and reliable way to define, communicate, document, manage, and test APIs. The benefits include the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Inter-team communication can be simpler.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Consumer and producer teams can now communicate requirements through coded contracts.</li><li class="listitem">The inventory of contracts serves as a record and reference of the agreed-upon APIs.</li></ul></div></li><li class="listitem"><p class="simpara">Developer productivity will increase.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Producers can quickly and easily generate contract-based stubs.</li><li class="listitem">Consumers no longer have to manually stub out APIs and write tests with arbitrary hard-coded responses. Instead, they can use the auto-generated stubs and test for contract-based responses.</li><li class="listitem">Both producers and consumers can validate their code complies with the contract.</li><li class="listitem">Producers can verify backward compatibility of API changes.</li><li class="listitem">Troubleshooting will be easier.</li><li class="listitem">Failure and feedback will be faster.</li></ul></div></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_conclusion" href="#_conclusion"></a>6.8&nbsp;Conclusion</h2></div></div></div><p>This concludes the tutorial on migrating apps for Spring Cloud Pipelines for Cloud Foundry.</p><p>Moving forward, the refactoring work shown here can be incorporated into your and your team&#8217;s standard practices. We recommend the following practices:</p><p><span class="strong"><strong>Good:</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use Maven or Gradle wrappers.</li><li class="listitem">Include a Cloud Foundry manifest file in your application repository.</li><li class="listitem">Include a pipeline descriptor (<code class="literal">sc-manifest.yml</code>) in your app repository.</li><li class="listitem">Create an empty <code class="literal">version</code> branch in your application repository.</li><li class="listitem">Include artifact repository configuration in the <code class="literal">pom.xml</code> file.</li><li class="listitem">Align your Cloud Foundry spaces with the Spring Cloud Pipelines model (isolated test space and shared stage and prod spaces).</li></ul></div><p><span class="strong"><strong>Better</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Include <code class="literal">default</code>, <code class="literal">apicompatibility</code>, <code class="literal">smoke</code>, and <code class="literal">e2e</code> profiles in the <code class="literal">pom.xml</code> file.</li><li class="listitem">Organize tests accordingly in your application repository.</li></ul></div><p><span class="strong"><strong>Best</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use a database migration tool, such as Flyway.</li><li class="listitem">Use contract-based API programming.</li></ul></div><p>Implementing all the <span class="strong"><strong>&#8220;good&#8221;</strong></span> practices positions you to instantly create pipelines for your applications by using Spring Cloud Pipelines. This is a huge win in terms of consistency and productivity and standardization across development teams. Of course, this is an open source project, so you can modify it to meet your needs.</p><p>Implementing the <span class="strong"><strong>&#8220;better&#8221;</strong></span> practices ensures the proper tests get run at the proper time. At that point, you can add as much test coverage as you need to have high confidence in your pipelines.</p><p>Implementing the <span class="strong"><strong>&#8220;best&#8221;</strong></span> practices gives you additional confidence in your pipeline and encourages better programming practices for database version and API management across development teams. It also gives you higher confidence in your pipelines and lets you avoid the cumbersome business of rolling back a database.</p><p>Happy coding!</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="concourse-pipeline-cf" href="#concourse-pipeline-cf"></a>7.&nbsp;Concourse Pipeline (Cloud Foundry)</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter, we assume that you deploy your application
to Cloud Foundry PaaS.</p></td></tr></table></div><p><a name="concourse" href="#concourse"></a>The Spring Cloud Pipelines repository contains opinionated
Concourse pipeline definitions. Those jobs form an empty pipeline and an
opinionated sample pipeline one that you can use in your company.</p><p>There following projects take part in the  <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github Analytics</a>: The app that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concourse-pipeline-step-by-step-cf" href="#concourse-pipeline-step-by-step-cf"></a>7.1&nbsp;Step-by-step</h2></div></div></div><p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="#concourse-fork-cf" title="7.1.1&nbsp;Fork Repositories">Fork repos</a></li><li class="listitem"><a class="link" href="#concourse-start-cf" title="7.1.2&nbsp;Start Concourse and Artifactory">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-deploy-cf" title="Deploy the infra JARs to Artifactory">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-pcfdev-cf" title="7.1.3&nbsp;Start PCF Dev">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#concourse-fly-cf" title="7.1.4&nbsp;Setup the fly CLI">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="#concourse-credentials-cf" title="7.1.5&nbsp;Set up Your credentials.yml File">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="#concourse-build-cf" title="7.1.6&nbsp;Build the Pipeline">Build the Pipeline</a></li><li class="listitem"><a class="link" href="#concourse-run-cf" title="7.1.7&nbsp;Run the github-webhook Pipeline">Run the <code class="literal">github-webhook</code> Pipeline</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-fork-cf" href="#concourse-fork-cf"></a>7.1.1&nbsp;Fork Repositories</h3></div></div></div><p>Four applications compose the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only the following repositories, because only then can you tag and push the tag to the repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-start-cf" href="#concourse-start-cf"></a>7.1.2&nbsp;Start Concourse and Artifactory</h3></div></div></div><p>You can run Concourse + Artifactory locally. To do so, run the
<code class="literal">start.sh</code> script from this repository. The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/concourse
./setup_docker_compose.sh
./start.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre></div><p>The <code class="literal">setup_docker_compose.sh</code> script should be run only once, to allow
generation of keys.</p><p>The <code class="literal">192.168.99.100</code> param is an example of an external URL of Concourse
(equal to the Docker-Machine IP in this example).</p><p>Then Concourse runs on port <code class="literal">8080</code>, and Artifactory runs on <code class="literal">8081</code>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="concourse-deploy-cf" href="#concourse-deploy-cf"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p>When Artifactory is running, run the <code class="literal">tools/deploy-infra.sh</code> script from this repo.
The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre></div><p>As a result, both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos are cloned, built,
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pcfdev-cf" href="#concourse-pcfdev-cf"></a>7.1.3&nbsp;Start PCF Dev</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have CF installed and do not want to use PCF Dev.
The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Servers often run run out of resources at the stage step.
If that happens, <a class="link" href="#resources">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p>You have to download and start PCF Dev, as described  <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">here.</a></p><p>The default credentials for PCF Dev are as follows:</p><div class="informalexample"><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre></div><p>You can start the PCF Dev as follows:</p><div class="informalexample"><pre class="programlisting">cf dev start</pre></div><p>You must create three separate spaces, as follows:</p><div class="informalexample"><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre></div><p>You can also run the <code class="literal">./tools/cf-helper.sh setup-spaces</code> script to create the spaces.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-fly-cf" href="#concourse-fly-cf"></a>7.1.4&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p>If you go to the Concourse website, you should see something resembling the following image:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you download that (and maybe, depending on your OS, add it to your PATH) you can run the following command:</p><div class="informalexample"><pre class="programlisting">fly --version</pre></div><p>If <code class="literal">fly</code> is properly installed, it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-credentials-cf" href="#concourse-credentials-cf"></a>7.1.5&nbsp;Set up Your <code class="literal">credentials.yml</code> File</h3></div></div></div><p>The repository comes with <code class="literal">credentials-sample-cf.yml</code>, which is set up with sample data (mostly credentials) that are applicable for PCF Dev. Copy this file to a new file called <code class="literal">credentials.yml</code> (the file is added to <code class="literal">.gitignore</code> so that you cannot push it with your passwords) and edit it as you wish. For our demo, set up the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">app-url</code>: URL pointing to your forked <code class="literal">github-webhook</code> repository.</li><li class="listitem"><code class="literal">github-private-key</code>: Your private key to clone and tag GitHub repositorys.</li><li class="listitem"><code class="literal">repo-with-binaries</code>: The IP is set to the defaults for Docker Machine. You should update it to point to your setup.</li></ul></div><p>If you do not have a Docker Machine, run th <code class="literal">./whats_my_ip.sh</code> script to
get an external IP that you can pass to your <code class="literal">repo-with-binaries</code>, instead of the default
Docker Machine IP.</p><p>The following table describes the environment variables required by the scripts:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BUILD_OPTIONS</code></p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for TEST env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for STAGE env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for PROD env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_SPACE_PREFIX</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Prefix of the name of the CF space for the test env to which the app name will be appended</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-test</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_SPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-stage</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_SPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-prod</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://192.168.99.100:8081/artifactory/libs-release-local" target="_top">https://192.168.99.100:8081/artifactory/libs-release-local</a></code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">M2_SETTINGS_REPO_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">artifactory-local</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_HOSTNAME_UUID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr></tbody></table></div><p>The right column shows the default values for PCF Dev that we set in the <code class="literal">credentials-sample-cf.yml</code>. <code class="literal">PAAS_HOSTNAME_UUID</code> and <code class="literal">BUILD_OPTIONS</code> have no default values.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-build-cf" href="#concourse-build-cf"></a>7.1.6&nbsp;Build the Pipeline</h3></div></div></div><p>Log in (for example, for a Concourse instance running at <code class="literal">192.168.99.100</code>&#8201;&#8212;&#8201;if you do not provide any value, <code class="literal">localhost</code> is assumed). If you run the login script, it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or it is in the same folder as the script. The following example shows how to specify an IP address for the login script:</p><div class="informalexample"><pre class="programlisting">./login.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre></div><p>Next, run the command to create the pipeline, as follows:</p><div class="informalexample"><pre class="programlisting">./set_pipeline.sh</pre></div><p>Then you can create a <code class="literal">github-webhook</code> pipeline under the <code class="literal">docker</code> alias, using the provided <code class="literal">credentials.yml</code> file.
You can override these values in exactly that order (for example <code class="literal">./set-pipeline.sh some-project another-target some-other-credentials.yml</code>)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-run-cf" href="#concourse-run-cf"></a>7.1.7&nbsp;Run the <code class="literal">github-webhook</code> Pipeline</h3></div></div></div><p>The following images show the various steps involved in running the <code class="literal">github-webhook</code> pipeline:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4790" href="#d0e4790"></a><p class="title"><b>Figure&nbsp;7.1.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4803" href="#d0e4803"></a><p class="title"><b>Figure&nbsp;7.2.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4817" href="#d0e4817"></a><p class="title"><b>Figure&nbsp;7.3.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">changeme</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4834" href="#d0e4834"></a><p class="title"><b>Figure&nbsp;7.4.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4845" href="#d0e4845"></a><p class="title"><b>Figure&nbsp;7.5.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4859" href="#d0e4859"></a><p class="title"><b>Figure&nbsp;7.6.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4870" href="#d0e4870"></a><p class="title"><b>Figure&nbsp;7.7.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4884" href="#d0e4884"></a><p class="title"><b>Figure&nbsp;7.8.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4895" href="#d0e4895"></a><p class="title"><b>Figure&nbsp;7.9.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4906" href="#d0e4906"></a><p class="title"><b>Figure&nbsp;7.10.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="concourse-pipeline-k8s" href="#concourse-pipeline-k8s"></a>8.&nbsp;Concourse Pipeline (Kubernetes)</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter, we assume that you deploy your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="concourse" href="#concourse"></a>The Spring Cloud Pipelines repository contains opinionated
Concourse pipeline definitions. Those jobs form an empty pipeline and an
opinionated sample pipeline that you can use in your company.</p><p>The following projects take part in the <code class="literal">microservice setup</code> for this demo:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github Analytics</a>: The application that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>8.1&nbsp;Step-by-step</h2></div></div></div><p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="#concourse-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="#concourse-start-k8s" title="8.2&nbsp;Concourse in K8S (Kubernetes)">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-fly-k8s" title="8.2.2&nbsp;Setup the fly CLI">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-credentials-k8s" title="8.2.3&nbsp;Setup your credentials.yml">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="#concourse-pipeline-build-k8s" title="8.2.4&nbsp;Build the pipeline">Setup the pipeline</a></li><li class="listitem"><a class="link" href="#concourse-pipeline-run-k8s" title="8.2.5&nbsp;Run the github-webhook Pipeline">Run the <code class="literal">github-webhook</code> pipeline</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>8.1.1&nbsp;Fork Repositories</h3></div></div></div><p><a name="concourse-fork-k8s" href="#concourse-fork-k8s"></a>Four applications compose the pipeline:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only the following repositories, because only then can you tag and push the tag to the repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concourse-start-k8s" href="#concourse-start-k8s"></a>8.2&nbsp;Concourse in K8S (Kubernetes)</h2></div></div></div><p>The simplest way to deploy Concourse to K8S is to use <a class="link" href="https://github.com/kubernetes/helm" target="_top">Helm</a>.
Once you have Helm installed and your <code class="literal">kubectl</code> is pointing to the
cluster, run the following command to install the Concourse cluster in your K8S cluster:</p><div class="informalexample"><pre class="programlisting">$ helm install stable/concourse --name concourse</pre></div><p>Once the script is done, you should see the following output</p><div class="informalexample"><pre class="programlisting"><span class="hl-number">1.</span> Concourse can be accessed:

  * Within your cluster, at the following DNS name at port <span class="hl-number">8080</span>:

    concourse-web.default.svc.cluster.local

  * From outside the cluster, run these commands in the same shell:

    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
    kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>

<span class="hl-number">2.</span> Login with the following credentials

  Username: concourse
  Password: concourse</pre></div><p>Follow the steps and log in to Concourse under <a class="link" href="http://127.0.0.1:8080" target="_top">http://127.0.0.1:8080</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_deploying_artifactory_to_k8s" href="#_deploying_artifactory_to_k8s"></a>8.2.1&nbsp;Deploying Artifactory to K8S</h3></div></div></div><p>You can use Helm also to deploy Artifactory to K8S, as follows:</p><div class="informalexample"><pre class="programlisting">$ helm install --name artifactory --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span> artifactory.image.repository=docker.bintray.io/jfrog/artifactory-oss stable/artifactory</pre></div><p>After you run this command, you should see the following output:</p><div class="informalexample"><pre class="programlisting">NOTES:
Congratulations. You have just deployed JFrog Artifactory Pro!

<span class="hl-number">1.</span> Get the Artifactory URL by running these commands:

   NOTE: It may take a few minutes <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> the LoadBalancer IP to be available.
         You can watch the status of the service by running <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'kubectl get svc -w nginx'</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> SERVICE_IP=$(kubectl get svc --namespace default nginx -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.status.loadBalancer.ingress[0].ip}'</span>)
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> http://$SERVICE_IP/

<span class="hl-number">2.</span> Open Artifactory in your browser
   Default credential <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> Artifactory:
   user: admin
   password: password</pre></div><p>Next, you need to set up the repositories.</p><p>First, access the Artifactory URL and log in with
a user name of <code class="literal">admin</code> and a password of <code class="literal">password</code>.</p><div class="figure"><a name="d0e5067" href="#d0e5067"></a><p class="title"><b>Figure&nbsp;8.1.&nbsp;Click on Quick Setup</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_quick_setup.png" alt="artifactory quick setup"></div></div></div><br class="figure-break"><p>Then, click on Maven setup and click <code class="literal">Create</code>.</p><div class="figure"><a name="d0e5081" href="#d0e5081"></a><p class="title"><b>Figure&nbsp;8.2.&nbsp;Create the <code class="literal">Maven</code> Repository</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_maven_repo.png" alt="artifactory maven repo"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-fly-k8s" href="#concourse-pipeline-fly-k8s"></a>8.2.2&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p><a name="fly" href="#fly"></a> If you go to the Concourse website you should see something resembling the following:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you download that (and maybe added it to your PATH, depending on your OS) you can run the following command:</p><div class="informalexample"><pre class="programlisting">fly --version</pre></div><p>If <code class="literal">fly</code> is properly installed, it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-credentials-k8s" href="#concourse-pipeline-credentials-k8s"></a>8.2.3&nbsp;Setup your <code class="literal">credentials.yml</code></h3></div></div></div><p>We made a sample credentials file called <code class="literal">credentials-sample-k8s.yml</code>
prepared for <code class="literal">k8s</code>. You can use it as a base for your <code class="literal">credentials.yml</code>.</p><p>To allow the Concourse worker&#8217;s spawned container to connect to the
Kubernetes cluster, you must pass the CA contents and the
auth token.</p><p>To get the contents of CA for GCE, run the following command:</p><div class="informalexample"><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.ca\.crt}'</span> | base64 --decode</pre></div><p>To get the auth token, run the following command:</p><div class="informalexample"><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.token}'</span> | base64 --decode</pre></div><p>Set that value under <code class="literal">paas-test-client-token</code>, <code class="literal">paas-stage-client-token</code>, and <code class="literal">paas-prod-client-token</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-build-k8s" href="#concourse-pipeline-build-k8s"></a>8.2.4&nbsp;Build the pipeline</h3></div></div></div><p>After running Concourse, you should get the following output in your terminal:</p><div class="informalexample"><pre class="programlisting">$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
$ kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>
Visit http://<span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">8080</span> to use Concourse</pre></div><p>Log in (for example, for Concourse running at <code class="literal">127.0.0.1</code>&#8201;&#8212;&#8201;if you do not provide any value, <code class="literal">localhost</code> is assumed). If you run this script, it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or that it is in the same folder as the script:</p><div class="informalexample"><pre class="programlisting">$ fly -t k8s login -c http://localhost:<span class="hl-number">8080</span> -u concourse -p concourse</pre></div><p>Next, run the following command to create the pipeline:</p><div class="informalexample"><pre class="programlisting">$ ./set_pipeline.sh github-webhook k8s credentials-k8s.yml</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-run-k8s" href="#concourse-pipeline-run-k8s"></a>8.2.5&nbsp;Run the <code class="literal">github-webhook</code> Pipeline</h3></div></div></div><p>The following images show the various steps involved in runnig the <code class="literal">github-webhook</code> pipeline:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5203" href="#d0e5203"></a><p class="title"><b>Figure&nbsp;8.3.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5216" href="#d0e5216"></a><p class="title"><b>Figure&nbsp;8.4.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5230" href="#d0e5230"></a><p class="title"><b>Figure&nbsp;8.5.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">concourse</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5247" href="#d0e5247"></a><p class="title"><b>Figure&nbsp;8.6.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5258" href="#d0e5258"></a><p class="title"><b>Figure&nbsp;8.7.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5272" href="#d0e5272"></a><p class="title"><b>Figure&nbsp;8.8.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5283" href="#d0e5283"></a><p class="title"><b>Figure&nbsp;8.9.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5297" href="#d0e5297"></a><p class="title"><b>Figure&nbsp;8.10.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5308" href="#d0e5308"></a><p class="title"><b>Figure&nbsp;8.11.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5319" href="#d0e5319"></a><p class="title"><b>Figure&nbsp;8.12.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_jenkins_pipeline_common" href="#_jenkins_pipeline_common"></a>9.&nbsp;Jenkins Pipeline (Common)</h2></div></div></div><p>In this section we will present the common setup of Jenkins for any platform.
We will also provide answers to most frequently asked questions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup_2" href="#_project_setup_2"></a>9.1&nbsp;Project setup</h2></div></div></div><pre class="programlisting">.
&#9500;&#9472;&#9472; declarative-pipeline
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; Jenkinsfile-sample.groovy
&#9500;&#9472;&#9472; jobs
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_jenkinsfile_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_sample.groovy
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; jenkins_pipeline_sample_view.groovy
&#9500;&#9472;&#9472; seed
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; init.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; k8s
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; settings.xml
&#9492;&#9472;&#9472; src
    &#9500;&#9472;&#9472; main
 &nbsp;&nbsp; &#9492;&#9472;&#9472; <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span></pre><p>In the <code class="literal">declarative-pipeline</code> you can find a definition of a <code class="literal">Jenkinsfile-sample.groovy</code> declarative
pipeline. It&#8217;s used together with the Blueocean UI.</p><p>In the <code class="literal">jobs</code> folder you have all the seed jobs that will generate pipelines.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">jenkins_pipeline_empty.groovy</code> - is a template of a pipeline with empty steps using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_jenkinsfile_empty.groovy</code> - is a template of a pipeline with empty steps using the Pipeline plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample.groovy</code> - is an opinionated implementation using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample_view.groovy</code> - builds the views for the pipelines</li></ul></div><p>In the <code class="literal">seed</code> folder you have the <code class="literal">init.groovy</code> file which is executed when Jenkins starts.
That way we can configure most of Jenkins options for you (adding credentials, JDK etc.).
<code class="literal">jenkins_pipeline.groovy</code> contains logic to build a seed job (that way you don&#8217;t have to even click that
job - we generate it for you). Under the <code class="literal">k8s</code> folder there are all the configuration
files required for deployment to a Kubernetes cluster.</p><p>In the <code class="literal">src</code> folder you have production and test classes needed for you to build your own pipeline.
Currently we have tests only cause the whole logic resides in the <code class="literal">jenkins_pipeline_sample</code> file.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_optional_customization_steps" href="#_optional_customization_steps"></a>9.2&nbsp;Optional customization steps</h2></div></div></div><p><a name="jenkins_optional" href="#jenkins_optional"></a> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="deploying-infra" href="#deploying-infra"></a>9.2.1&nbsp;Deploying infra jars to a different location</h3></div></div></div><p>It&#8217;s enough to set the <code class="literal">ARTIFACTORY_URL</code> environmental variable before
executing <code class="literal">tools/deploy-infra.sh</code>. Example for deploying to Artifactory at IP <code class="literal">192.168.99.100</code></p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
ARTIFACTORY_URL=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"https://192.168.99.100:8081/artifactory/libs-release-local"</span> ./tools/deploy-infra.sh</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-settings-xml" href="#setup-settings-xml"></a>9.2.2&nbsp;Setup settings.xml for Maven deployment</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you want to use the default connection to the Docker version
of Artifactory you can skip this step</p></td></tr></table></div><p><a name="jenkins-settings" href="#jenkins-settings"></a> So that <code class="literal">./mvnw deploy</code> works with Artifactory from Docker we&#8217;re
already copying the missing <code class="literal">settings.xml</code> file for you. It looks more or less like this:</p><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;settings&gt;</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;servers&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${M2_SETTINGS_REPO_ID}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>${M2_SETTINGS_REPO_USERNAME}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>${M2_SETTINGS_REPO_PASSWORD}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${DOCKER_SERVER_ID}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>${DOCKER_USERNAME}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>${DOCKER_PASSWORD}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
				<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;email&gt;</span>${DOCKER_EMAIL}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/email&gt;</span>
			<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/servers&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/settings&gt;</span></pre><p>As you can see the file is parameterized. In Maven it&#8217;s enough to pass
to <code class="literal">./mvnw</code> command the proper system property to override that value. For example to pass
a different docker email you&#8217;d have to call <code class="literal">./mvnw -DDOCKER_EMAIL=<a class="link" href="mailto:foo@bar.com" target="_top">foo@bar.com</a></code> and the value
gets updated.</p><p>If you want to use your own version of Artifactory / Nexus you have to update
the file (it&#8217;s in <code class="literal">seed/settings.xml</code>).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-jenkins-env-vars" href="#setup-jenkins-env-vars"></a>9.2.3&nbsp;Setup Jenkins env vars</h3></div></div></div><p><a name="jenkins_env" href="#jenkins_env"></a> If you want to only play around with the demo that we&#8217;ve prepared you have to set <span class="strong"><strong>ONE</strong></span> variable which is the <code class="literal">REPOS</code> variable.
That variable needs to consists of comma separated list of URLs to repositories containing business apps. So you should pass your forked repos URLs.</p><p>You can do it in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">globally via Jenkins global env vars (then when you run the seed that variable will be taken into consideration and proper pipelines will get built)</li><li class="listitem">modify the seed job parameters (you&#8217;ll have to modify the seed job configuration and change the <code class="literal">REPOS</code> property)</li><li class="listitem">provide the repos parameter when running the seed job</li></ul></div><p>For the sake of simplicity let&#8217;s go with the <span class="strong"><strong>last</strong></span> option.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re choosing the global envs, you <span class="strong"><strong>HAVE</strong></span> to remove the other approach
(e.g. if you set the global env for <code class="literal">REPOS</code>, please remove that property in the
seed job</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="setup-seed-props" href="#setup-seed-props"></a>Seed properties</h4></div></div></div><p>Click on the seed job and pick <code class="literal">Build with parameters</code>. Then as presented in the screen below (you&#8217;ll have far more properties to set) just modify the <code class="literal">REPOS</code> property by providing the comma separated list of URLs to your forks. Whatever you set will be parsed by the seed job and passed to the generated Jenkins jobs.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>This is very useful when the repos you want to build differ. E.g. use
different JDK. Then some seeds can set the <code class="literal">JDK_VERSION</code> param to one version
of Java installation and the others to another one.</p></td></tr></table></div><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div><p>In the screenshot we could parametrize the <code class="literal">REPOS</code> and <code class="literal">REPO_WITH_BINARIES</code> params.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="global-envs" href="#global-envs"></a>Global envs</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This section is presented only for informational purposes - for the sake of demo you can skip it</p></td></tr></table></div><p>You can add env vars (go to configure Jenkins &#8594; Global Properties) for the following
 properties (example with defaults for PCF Dev):</p><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/env_vars.png" alt="env vars"></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="git-email" href="#git-email"></a>9.2.4&nbsp;Set Git email / user</h3></div></div></div><p>Since our pipeline is setting the git user / name explicitly for the build step
 you&#8217;d have to go to <code class="literal">Configure</code> of the build step and modify the Git name / email.
 If you want to set it globally you&#8217;ll have to remove the section from the build
 step and follow these steps to set it globally.</p><p>You can set Git email / user globally like this:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5551" href="#d0e5551"></a><p class="title"><b>Figure&nbsp;9.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5562" href="#d0e5562"></a><p class="title"><b>Figure&nbsp;9.2.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5573" href="#d0e5573"></a><p class="title"><b>Figure&nbsp;9.3.&nbsp;Fill out Git user information</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/git.png" alt="git"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jenkins-credentials-github" href="#jenkins-credentials-github"></a>Add Jenkins credentials for GitHub</h4></div></div></div><p><a name="jenkins-credentials" href="#jenkins-credentials"></a> The scripts will need to access the credential in order to tag the repo.</p><p>You have to set credentials with id: <code class="literal">git</code>.</p><p>Below you can find instructions on how to set a credential (e.g. for Cloud Foundry <code class="literal">cf-test</code> credential but
remember to provide the one with id <code class="literal">git</code>).</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5605" href="#d0e5605"></a><p class="title"><b>Figure&nbsp;9.4.&nbsp;Click 'Credentials, System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_system.png" alt="credentials system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5616" href="#d0e5616"></a><p class="title"><b>Figure&nbsp;9.5.&nbsp;Click 'Global Credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_global.png" alt="credentials global"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5627" href="#d0e5627"></a><p class="title"><b>Figure&nbsp;9.6.&nbsp;Click 'Add credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_add.png" alt="credentials add"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5638" href="#d0e5638"></a><p class="title"><b>Figure&nbsp;9.7.&nbsp;Fill out the user / password and provide the <code class="literal">git</code> credential ID (in this example <code class="literal">cf-test</code>)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_example.png" alt="credentials example"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_testing_jenkins_scripts" href="#_testing_jenkins_scripts"></a>9.3&nbsp;Testing Jenkins scripts</h2></div></div></div><p><code class="literal">./gradlew clean build</code></p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>The ran test only checks if your scripts compile.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_work_with_jenkins_job_dsl_plugin" href="#_how_to_work_with_jenkins_job_dsl_plugin"></a>9.4&nbsp;How to work with Jenkins Job DSL plugin</h2></div></div></div><p>Check out the <a class="link" href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Tutorial---Using-the-Jenkins-Job-DSL" target="_top">tutorial</a>.
Provide the link to this repository in your Jenkins installation.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Remember that views can be overridden that&#8217;s why the suggestion is to contain in one script all the logic needed to build a view
 for a single project (check out that <code class="literal">spring_cloud_views.groovy</code> is building all the <code class="literal">spring-cloud</code> views).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_docker_image" href="#_docker_image"></a>9.5&nbsp;Docker Image</h2></div></div></div><p>If you would like to run the pre-configured Jenkins image somewhere other than your local machine, we
have an image you can pull and use on <a class="link" href="https://hub.docker.com/r/springcloud/spring-cloud-pipeline-jenkins/" target="_top">DockerHub</a>.
The <code class="literal">latest</code> tag corresponds to the latest snapshot build.  You can also find tags
corresponding to stable releases that you can use as well.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>The Jenkins docker image is setup for demo purposes. For example it has the following
system property <code class="literal">-Dpermissive-script-security.enabled=no_security</code> that disables script
security. <span class="strong"><strong>YOU SHOULD NOT USE IT ON PRODUCTION UNLESS YOU KNOW WHAT YOU&#8217;RE DOING</strong></span>.</p></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>10.&nbsp;Jenkins Pipeline (Cloud Foundry)</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter, we assume that you deploy your application
to Cloud Foundry PaaS.</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline, which uses the <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job DSL plugin</a>. Those jobs form an empty pipeline and a opinionated sample pipeline that you can use in your company.</p><p>The following projects take part in the <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github Analytics</a>: The app that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part off our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and using Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-cf" href="#step-by-step-cf"></a>10.1&nbsp;Step-by-step</h2></div></div></div><p>This is a guide for the Jenkins Job DSL based pipeline.</p><p>If you want only to run the demo as far as possible using PCF Dev and Docker Compose, do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="#jenkins-fork-cf">Fork Repositories</a></li><li class="listitem"><a class="link" href="#jenkins-start-cf">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-cf">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-pcfdev-cf">Start PCF Dev (if you do not want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-cf" title="10.1.4&nbsp;Run the Seed Job">Run the Seed Job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-cf" title="10.&nbsp;Jenkins Pipeline (Cloud Foundry)">Run the <code class="literal">github-webhook</code> Pipeline</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-cf" href="#fork-repos-cf"></a>10.1.1&nbsp;Fork Repositories</h3></div></div></div><p><a name="jenkins-fork-cf" href="#jenkins-fork-cf"></a>Four applications compose the pipeline:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only the following, because only then can you tag and push the tag to your repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-cf" href="#start-jenkins-cf"></a>10.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-cf" href="#jenkins-start-cf"></a>Jenkins + Artifactory can be ran locally. To do so, run the
<code class="literal">start.sh</code> script from this repository. The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg</pre></div><p>Then Jenkins runs on port <code class="literal">8080</code>, and Artifactory runs on port <code class="literal">8081</code>.
The parameters are passed as environment variables to the Jenkins VM,
and credentials are set. That way, you need not do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be <code class="literal">yourForkedGithubOrg</code> or <code class="literal">yourGithubUsername</code>. Also the <code class="literal">REPOS</code> environment variable
contains your GitHub org (in which you have the forked repos).</p><p>Instead of the Git username and password parameters, you could pass <code class="literal">-key &lt;path_to_private_key&gt;</code>
(if you prefer to use key-based authentication with your Git repositories).</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-cf" href="#deploy-infra-cf"></a>Deploy the Infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-cf" href="#jenkins-deploy-cf"></a>When Artifactory is running, run the <code class="literal">tools/deploy-infra.sh</code> script from this repo. The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre></div><p>As a result, both the <code class="literal">eureka</code> and <code class="literal">stub runner</code> repositories are cloned, built,
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-pcf-dev-cf" href="#start-pcf-dev-cf"></a>10.1.3&nbsp;Start PCF Dev</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have CF installed and do not want to use PCF Dev.
In that case, the only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Servers often run run out of resources at the stage step.
If that happens <a class="link" href="#">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p><a name="jenkins-pcfdev-cf" href="#jenkins-pcfdev-cf"></a>You have to download and start PCF Dev, as described <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">here.</a></p><p>The default credentials when using PCF Dev are as follows:</p><div class="informalexample"><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre></div><p>You can start PCF Dev as follows:</p><div class="informalexample"><pre class="programlisting">cf dev start</pre></div><p>You must create three separate spaces, as follows:</p><div class="informalexample"><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre></div><p>You can also run the <code class="literal">./tools/cf-helper.sh setup-spaces</code> script to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-cf" href="#jenkins-seed-cf"></a>10.1.4&nbsp;Run the Seed Job</h3></div></div></div><p>We created the seed job for you, but you have to run it. When you do
run it, you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global environment variables, you have to remove them from the
seed.</p><p>To run the demo, provide a comma-separated
list of the URLs of the two aforementioned forks (<code class="literal">github-webhook</code> and <code class="literal">github-analytics') in the `REPOS</code> variable.</p><p>The following images shows the steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5912" href="#d0e5912"></a><p class="title"><b>Figure&nbsp;10.1.&nbsp;Click the 'jenkins-pipeline-seed-cf' job for Cloud Foundry and <code class="literal">jenkins-pipeline-seed-k8s</code> for Kubernetes</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5926" href="#d0e5926"></a><p class="title"><b>Figure&nbsp;10.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5937" href="#d0e5937"></a><p class="title"><b>Figure&nbsp;10.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5951" href="#d0e5951"></a><p class="title"><b>Figure&nbsp;10.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>10.1.5&nbsp;Run the <code class="literal">github-webhook</code> Pipeline</h3></div></div></div><p>We already created the seed job for you, but you have to run it. When you do
run it, you have to provide some properties. By default, we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global environment variables, you have to remove them from the
seed.</p><p>To run the demo, provide a comma-separated
 list of URLs of the two aforementioned forks (<code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>) in the <code class="literal">REPOS</code> variable.</p><p>The following images shows the steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5983" href="#d0e5983"></a><p class="title"><b>Figure&nbsp;10.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5994" href="#d0e5994"></a><p class="title"><b>Figure&nbsp;10.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on <span class="strong"><strong>deploy previous version to stage</strong></span> due to a missing jar,
that means that you forgot to clear the tags in your repository. Typically, that happens because
you removed the Artifactory volume with a deployed jar while a tag in the repository still points there.
See <a class="link" href="#">here</a> for how to remove the tag.</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6016" href="#d0e6016"></a><p class="title"><b>Figure&nbsp;10.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Servers often run run out of resources at the stage step.
For that reason, we suggest killing all applications on test. See the <a class="link" href="#">FAQ</a> for more detail.</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6038" href="#d0e6038"></a><p class="title"><b>Figure&nbsp;10.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-cf" href="#declarative-pipeline-cf"></a>10.2&nbsp;Declarative Pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL (for example, for Docker Machine-based setup: <code class="literal"><a class="link" href="https://192.168.99.100:8080/blue" target="_top">https://192.168.99.100:8080/blue</a></code>).</p><p>The following images show the various steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6073" href="#d0e6073"></a><p class="title"><b>Figure&nbsp;10.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6086" href="#d0e6086"></a><p class="title"><b>Figure&nbsp;10.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6100" href="#d0e6100"></a><p class="title"><b>Figure&nbsp;10.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6113" href="#d0e6113"></a><p class="title"><b>Figure&nbsp;10.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6124" href="#d0e6124"></a><p class="title"><b>Figure&nbsp;10.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6137" href="#d0e6137"></a><p class="title"><b>Figure&nbsp;10.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6148" href="#d0e6148"></a><p class="title"><b>Figure&nbsp;10.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting a pipeline from a specific stage after failure.
See <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">this issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently, there is no way to introduce manual steps in a performant way. Jenkins
blocks an executor when a manual step is required. That means that you run out of executors
pretty quickly. See <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">this issue</a>
and <a class="link" href="https://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">this StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-cf" href="#optional-steps-cf"></a>10.3&nbsp;Jenkins Cloud Foundry Customization</h2></div></div></div><p>You can customize Jenkins for Cloud Foundry by setting a variety of environment variables.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You need not see all the environment variables described in this section to run the demo. They are needed only
when you want to make custom changes.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-cf" href="#all-env-vars-cf"></a>10.3.1&nbsp;Environment Variable Summary</h3></div></div></div><p>The environment variables that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BINARY_EXTENSION</code></p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Extension of the binary uploaded to Artifactory / Nexus. Example: <code class="literal">war</code> for WAR artifacts</p></th><th style="" align="left" valign="top"><p><code class="literal">jar</code></p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF API for the TEST environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF API for the STAGE environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF API for the PROD environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">api.local.pcfdev.io</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_SPACE_PREFIX</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Prefix of the name of the CF space for the test environment to which the app name is appended</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-test</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_SPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-stage</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_ORG</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pcfdev-org</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_SPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-prod</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the repository with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://artifactory:8081/artifactory/libs-release-local" target="_top">https://artifactory:8081/artifactory/libs-release-local</a></code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">M2_SETTINGS_REPO_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The ID of server from Maven <code class="literal">settings.xml</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">artifactory-local</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JDK_VERSION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">jdk8</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PIPELINE_VERSION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The version of the pipeline (ultimately, also the version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_EMAIL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag the repository</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">email@example.com</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag the repository</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">Pivo Tal</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_HOSTNAME_UUID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment, the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AUTO_DEPLOY_TO_STAGE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AUTO_DEPLOY_TO_PROD</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">API_COMPATIBILITY_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether the API compatibility step is required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DB_ROLLBACK_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether the DB rollback step is present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DEPLOY_TO_STAGE_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether to the deploy-to-stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BUILD_OPTIONS</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-credentials-cf" href="#jenkins-credentials-cf"></a>10.3.2&nbsp;Jenkins Credentials</h3></div></div></div><p>Our scripts reference the credentials by IDs. The following table describes the defaults for the credentials:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CREDENTIAL_ID</code></p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Prod environment access</p></th><th style="" align="left" valign="top"><p><code class="literal">cf-prod</code></p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used to tag a Git repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">git</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_SSH_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SSH credential ID used to tag a Git repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">gitSsh</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_USE_SSH_KEY</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If <code class="literal">true</code>, pick the SSH credential id to use</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REPO_WITH_BINARIES_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used for the repository with jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">repo-with-binaries</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Test environment access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">cf-test</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Stage environment access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">cf-stage</code></p></td></tr></tbody></table></div><p>If you already have in your system a credential to (for example) tag a repository,
you can use it by passing the value of the <code class="literal">GIT_CREDENTIAL_ID</code> property.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>See the <code class="literal">cf-helper</code> script for all the configuration options.</p></td></tr></table></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>11.&nbsp;Jenkins Pipeline (Kubernetes)</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter, we assume that you deploy your application
to Kubernetes PaaS.</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a>The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline that uses <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job DSL plugin</a>. Those jobs form an empty pipeline and an opinionated sample pipeline that you can use in your company.</p><p>The following projects take part in the <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github Analytics</a>: The app that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics ad uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>11.1&nbsp;Step-by-step</h2></div></div></div><p>This is a guide for a Jenkins Job DSL based pipeline.</p><p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="#jenkins-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="#jenkins-start-k8s">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-k8s">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#">Start Minikube (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-k8s" title="11.1.3&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-k8s" title="11.&nbsp;Jenkins Pipeline (Kubernetes)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>11.1.1&nbsp;Fork Repositories</h3></div></div></div><p><a name="jenkins-fork-k8s" href="#jenkins-fork-k8s"></a>Four applications compose the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only the following repositories, because only then can you tag and push the tag to your repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-k8s" href="#start-jenkins-k8s"></a>11.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-k8s" href="#jenkins-start-k8s"></a>Jenkins and Artifactory can be ran locally. To do so, run the
<code class="literal">start.sh</code> script from this repo. The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg yourDockerRegistryOrganization yourDockerRegistryUsername yourDockerRegistryPassword yourDockerRegistryEmail</pre></div><p>Then Jenkins runs on port <code class="literal">8080</code>, and Artifactory runs on port <code class="literal">8081</code>.
The provided parameters are passed as environment variables to the Jenkins VM
and credentials are set. That way, you need not do
any manual work on the Jenkins side. In the preceding script, the third parameter
could be <code class="literal">yourForkedGithubOrg</code> or <code class="literal">yourGithubUsername</code>. Also the <code class="literal">REPOS</code> environment variable
contains your GitHub org in which you have the forked repositories.</p><p>Instead of the Git username and password parameters, you could pass <code class="literal">-key &lt;path_to_private_key&gt;</code>
if you prefer to use the key-based authentication with your Git repositories.</p><p>You need to pass the credentials for the Docker organization (by default, we
search for the Docker images at Docker Hub) so that the pipeline can
push images to your org.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-k8s" href="#deploy-infra-k8s"></a>Deploy the Infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-k8s" href="#jenkins-deploy-k8s"></a>When Artifactory is running, run the <code class="literal">tools/deploy-infra.sh</code> script from this repo.
The following listing shows the script:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra-k8s.sh</pre></div><p>As a result, both the <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos are cloned, built, and
uploaded to Artifactory and their docker images are built.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your local Docker process is reused by the Jenkins instance running
in Docker. That is why you do not have to push these images to Docker Hub. On the
other hand, if you run this sample in a remote Kubernetes cluster, the driver
is not shared by the Jenkins workers, so you can consider pushing these
Docker images to Docker Hub too.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-k8s" href="#jenkins-seed-k8s"></a>11.1.3&nbsp;Run the seed job</h3></div></div></div><p>We created the seed job for you, but you have to run it. When you do
run it, you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global environment variables, you have to remove them from the
seed.</p><p>To run the demo, provide a comma-separated
list of the URLs of the two aforementioned forks (<code class="literal">github-webhook</code> and <code class="literal">github-analytics') in the `REPOS</code> variable.</p><p>The following images shows the steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6775" href="#d0e6775"></a><p class="title"><b>Figure&nbsp;11.1.&nbsp;Click the 'jenkins-pipeline-seed-cf' job for Cloud Foundry and <code class="literal">jenkins-pipeline-seed-k8s</code> for Kubernetes</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6789" href="#d0e6789"></a><p class="title"><b>Figure&nbsp;11.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6800" href="#d0e6800"></a><p class="title"><b>Figure&nbsp;11.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6814" href="#d0e6814"></a><p class="title"><b>Figure&nbsp;11.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>11.1.4&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already created the seed job for you, but you have to run it. When you do
run it, you have to provide some properties. By default, we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global environment variables, you have to remove them from the
seed.</p><p>To run the demo, provide a comma-separated
 list of URLs of the two aforementioned forks (<code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>) in the <code class="literal">REPOS</code> variable.</p><p>The following images shows the steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6846" href="#d0e6846"></a><p class="title"><b>Figure&nbsp;11.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6857" href="#d0e6857"></a><p class="title"><b>Figure&nbsp;11.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on <span class="strong"><strong>deploy previous version to stage</strong></span> due to a missing jar,
that means that you forgot to clear the tags in your repository. Typically, that happens because
you removed the Artifactory volume with a deployed jar while a tag in the repository still points there.
See <a class="link" href="#">here</a> for how to remove the tag.</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6879" href="#d0e6879"></a><p class="title"><b>Figure&nbsp;11.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Servers often run run out of resources at the stage step.
For that reason, we suggest killing all applications on test. See the <a class="link" href="#">FAQ</a> for more detail.</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6901" href="#d0e6901"></a><p class="title"><b>Figure&nbsp;11.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-k8s" href="#declarative-pipeline-k8s"></a>11.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL (for example, for Docker Machine-based setup: <code class="literal"><a class="link" href="https://192.168.99.100:8080/blue" target="_top">https://192.168.99.100:8080/blue</a></code>).</p><p>The following images show the various steps involved:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6936" href="#d0e6936"></a><p class="title"><b>Figure&nbsp;11.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6949" href="#d0e6949"></a><p class="title"><b>Figure&nbsp;11.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6963" href="#d0e6963"></a><p class="title"><b>Figure&nbsp;11.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6976" href="#d0e6976"></a><p class="title"><b>Figure&nbsp;11.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e6987" href="#d0e6987"></a><p class="title"><b>Figure&nbsp;11.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e7000" href="#d0e7000"></a><p class="title"><b>Figure&nbsp;11.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e7011" href="#d0e7011"></a><p class="title"><b>Figure&nbsp;11.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting a pipeline from a specific stage after failure.
See <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">this issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently, there is no way to introduce manual steps in a performant way. Jenkins
blocks an executor when a manual step is required. That means that you run out of executors
pretty quickly. See <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">this issue</a>
and <a class="link" href="https://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">this StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-k8s" href="#optional-steps-k8s"></a>11.3&nbsp;Jenkins Kubernetes customization</h2></div></div></div><p>You can customize Jenkins for Cloud Foundry by setting a variety of environment variables.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You need not see all the environment variables described in this section to run the demo. They are needed only
when you want to make custom changes.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-k8s" href="#all-env-vars-k8s"></a>11.3.1&nbsp;All env vars</h3></div></div></div><p>The environment variables that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BUILD_OPTIONS</code></p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the docker organization to which Docker images should be deployed</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scpipelines</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_REGISTRY_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used to push Docker images</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">docker-registry</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_SERVER_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Server ID in <code class="literal">settings.xml</code> and Maven builds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">docker-repo</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_EMAIL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Email used to connect to Docker registry and Maven builds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">change@me.com</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_REGISTRY_ORGANIZATION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the Kubernetes cluster for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scpipelines</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOCKER_REGISTRY_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the docker registry</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://index.docker.io/v1/" target="_top">https://index.docker.io/v1/</a></code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">192.168.99.100:8443</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">192.168.99.100:8443</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_API_URL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">192.168.99.100:8443</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CA_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for test the environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/ca.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CA_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for stage the environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/ca.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CA_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/ca.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLIENT_CERT_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLIENT_CERT_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLIENT_CERT_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.crt</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLIENT_KEY_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.key</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLIENT_KEY_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.key</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLIENT_KEY_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/usr/share/jenkins/cert/apiserver.key</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLIENT_TOKEN_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLIENT_TOKEN_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLIENT_TOKEN_PATH</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the file containing the token for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLIENT_TOKEN_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLIENT_TOKEN_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLIENT_TOKEN_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ID of the credential containing access token for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLUSTER_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLUSTER_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLUSTER_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_CLUSTER_USERNAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_CLUSTER_USERNAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_CLUSTER_USERNAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_SYSTEM_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_SYSTEM_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_SYSTEM_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">minikube</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_TEST_NAMESPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for the test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-test</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_STAGE_NAMESPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for the stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-stage</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PAAS_PROD_NAMESPACE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for the prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">sc-pipelines-prod</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">KUBERNETES_MINIKUBE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether to connect to Minikube</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REPO_WITH_BINARIES_FOR_UPLOAD</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the repository with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://artifactory:8081/artifactory/libs-release-local" target="_top">https://artifactory:8081/artifactory/libs-release-local</a></code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REPO_WITH_BINARIES_CREDENTIAL_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used for the repository with jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">repo-with-binaries</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">M2_SETTINGS_REPO_ID</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The ID of server from Maven <code class="literal">settings.xml</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">artifactory-local</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JDK_VERSION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">jdk8</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PIPELINE_VERSION</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The version of the pipeline (ultimately, also the version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_EMAIL</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag the repository</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">email@example.com</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GIT_NAME</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag the repository</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">Pivo Tal</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AUTO_DEPLOY_TO_STAGE</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AUTO_DEPLOY_TO_PROD</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">API_COMPATIBILITY_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether the API compatibility step is required</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DB_ROLLBACK_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether the DB rollback step is present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DEPLOY_TO_STAGE_STEP_REQUIRED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether the deploy-to-stage step is present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code></p></td></tr></tbody></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_preparing_to_connect_to_gce" href="#_preparing_to_connect_to_gce"></a>11.4&nbsp;Preparing to Connect to GCE</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Skip this step if you do not use GCE</p></td></tr></table></div><p>In order to use GCE, we need to have <code class="literal">gcloud</code> running. If you already have the
CLI installed, skip this step. If not run the following command to have the CLI
downloaded and an installer started:</p><div class="informalexample"><pre class="programlisting">$ ./tools/k8s-helper.sh download-gcloud</pre></div><p>Next, configure <code class="literal">gcloud</code>. Run <code class="literal">gcloud init</code> and log in
to your cluster. You are redirected to a login page. Pick the
proper Google account and log in.</p><p>Pick an existing project or create a new one.</p><p>Go to your platform page (click on <code class="literal">Container Engine</code>) in GCP and connect to your cluster with the following values:</p><div class="informalexample"><pre class="programlisting">$ CLUSTER_NAME=...
$ ZONE=us-east1-b
$ PROJECT_NAME=...
$ gcloud container clusters get-credentials ${CLUSTER_NAME} --zone ${ZONE} --project ${PROJECT_NAME}
$ kubectl proxy</pre></div><p>The Kubernetes dashboard runs at <code class="literal"><a class="link" href="http://localhost:8001/ui/" target="_top">http://localhost:8001/ui/</a></code>.</p><p>We need a Persistent Disk for our Jenkins installation. Create it as follows:</p><div class="informalexample"><pre class="programlisting">$ ZONE=us-east1-b
$ gcloud compute disks create --size=<span class="hl-number">200</span>GB --zone=${ZONE} sc-pipelines-jenkins-disk</pre></div><p>Once the disk has been created, you need to format it. See
the instructions at <a class="link" href="https://cloud.google.com/compute/docs/disks/add-persistent-disk#formatting" target="_top">https://cloud.google.com/compute/docs/disks/add-persistent-disk#formatting</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_connecting_to_a_kubo_or_gce_cluster" href="#_connecting_to_a_kubo_or_gce_cluster"></a>11.5&nbsp;Connecting to a Kubo or GCE Cluster</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Skip this step if you do not use Kubo or GCE</p></td></tr></table></div><p>This section describes how to deploy Jenkins and
Artifactory to a Kubernetes cluster deployed with Kubo.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>To see the dashboard, run <code class="literal">kubectl proxy</code> and access <code class="literal">localhost:8081/ui</code>.</p></td></tr></table></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Log in to the cluster.</li><li class="listitem"><p class="simpara">Deploy Jenkins and Artifactory to the cluster:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">./tools/k8s-helper.sh setup-tools-infra-vsphere</code> for a cluster deployed on VSphere</li><li class="listitem"><code class="literal">./tools/k8s-helper.sh setup-tools-infra-gce</code> for a cluster deployed to GCE</li></ul></div></li><li class="listitem">Forward the ports so that you can access the Jenkins UI from your local machine, by using the following settings</li></ol></div><div class="informalexample"><pre class="programlisting">$ NAMESPACE=default
$ JENKINS_POD=jenkins-<span class="hl-number">1430785859</span>-nfhx4
$ LOCAL_PORT=<span class="hl-number">32044</span>
$ CONTAINER_PORT=<span class="hl-number">8080</span>
$ kubectl port-forward --namespace=${NAMESPACE} ${JENKINS_POD} ${LOCAL_PORT}:${CONTAINER_PORT}
----</pre></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Go to <code class="literal">Credentials</code>, click <code class="literal">System</code> and <code class="literal">Global credentials</code>, as the following image shows:
image::https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/kubo_credentials.png[caption="Click `Global credentials`"]</li><li class="listitem">Update <code class="literal">git</code>, <code class="literal">repo-with-binaries</code> and <code class="literal">docker-registry</code> credentials</li><li class="listitem">Run the <code class="literal">jenkins-pipeline-k8s-seed</code> seed job and fill it out with the following data</li><li class="listitem"><p class="simpara">Put <code class="literal">kubernetes.default:443</code> here (or <code class="literal">KUBERNETES_API:KUBERNETES_PORT</code>)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PAAS_TEST_API_URL</code></li><li class="listitem"><code class="literal">PAAS_STAGE_API_URL</code></li><li class="listitem"><code class="literal">PAAS_PROD_API_URL</code></li></ul></div></li><li class="listitem"><p class="simpara">Put <code class="literal">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code> data here:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PAAS_TEST_CA_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CA_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CA_PATH</code></li></ul></div></li><li class="listitem"><p class="simpara">Uncheck the <code class="literal">Kubernetes Minikube</code> value.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Clear the following variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLIENT_CERT_PATH</code></li><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_KEY_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_KEY_PATH</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLIENT_KEY_PATH</code></li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">Set <code class="literal">/var/run/secrets/kubernetes.io/serviceaccount/token</code> value to these variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PAAS_TEST_CLIENT_TOKEN_PATH</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLIENT_TOKEN_PATH</code></li><li class="listitem"><p class="simpara"><code class="literal">PAAS_STAGE_CLIENT_TOKEN_PATH</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Set the cluster name to these variables (you can get the cluster name by calling <code class="literal">kubectl config current-context</code>):</li></ul></div></li><li class="listitem"><code class="literal">PAAS_TEST_CLUSTER_NAME</code></li><li class="listitem"><code class="literal">PAAS_STAGE_CLUSTER_NAME</code></li><li class="listitem"><code class="literal">PAAS_PROD_CLUSTER_NAME</code></li></ul></div></li><li class="listitem"><p class="simpara">Set the system name to these variables (you can get the system name by calling <code class="literal">kubectl config current-context</code>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PAAS_TEST_SYSTEM_NAME</code></li><li class="listitem"><code class="literal">PAAS_STAGE_SYSTEM_NAME</code></li><li class="listitem"><code class="literal">PAAS_PROD_SYSTEM_NAME</code></li></ul></div></li><li class="listitem">Update the <code class="literal">DOCKER_EMAIL</code> property with your email address.</li><li class="listitem">Update the <code class="literal">DOCKER_REGISTRY_ORGANIZATION</code> with your Docker organization name.</li><li class="listitem">If you do not want to upload the images to DockerHub, update <code class="literal">DOCKER_REGISTRY_URL</code>.
image::https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pks_seed.png[caption="Example of a filled out seed job"]</li><li class="listitem">Run the pipeline</li></ol></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_kubernetes_setup" href="#_kubernetes_setup"></a>12.&nbsp;Kubernetes Setup</h2></div></div></div><p>This section describes how to set up Kubernetes.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_kubernetes_cli_installation" href="#_kubernetes_cli_installation"></a>12.1&nbsp;Kubernetes CLI Installation</h2></div></div></div><p>First, you need to install the <code class="literal">kubectl</code> command-line interface (CLI).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-script" href="#kubernetes-cli-script"></a>12.1.1&nbsp;Script Installation</h3></div></div></div><p>You can use the <code class="literal">tools/k8s-helper.sh</code> script to install <code class="literal">kubectl</code>. To do so, run the following script:</p><div class="informalexample"><pre class="programlisting">$ ./tools/minikube-helper download-kubectl</pre></div><p>Then the <code class="literal">kubectl</code> gets downloaded.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-manual" href="#kubernetes-cli-manual"></a>12.1.2&nbsp;Manual Installation</h3></div></div></div><p>You can perform a manual installation for either OSX or Linux.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_example_for_osx" href="#_example_for_osx"></a>Example for OSX</h4></div></div></div><p>The following listing shows how to manually install on OSX:</p><div class="informalexample"><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
----</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_example_for_linux" href="#_example_for_linux"></a>Example for Linux</h4></div></div></div><p>The following listing shows how to manually install on Linux:</p><div class="informalexample"><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre></div><p>See <a class="link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_top">this page</a> for more information.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="start-minikube-k8s" href="#start-minikube-k8s"></a>12.2&nbsp;Kubernetes Cluster Setup</h2></div></div></div><p>We need a cluster of Kubernetes. The best choice is <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have a Kubernetes cluster installed and do not
want to use Minikube. In that case, the only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Servers often run run out of resources at the stage step.
If that happens, <a class="link" href="#">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-minikube-script" href="#kubernetes-minikube-script"></a>12.2.1&nbsp;Script Installation</h3></div></div></div><p>You can use the <code class="literal">tools/k8s-helper.sh</code> script to install <code class="literal">Minikube</code>. To do so, run the following script:</p><div class="informalexample"><pre class="programlisting">$ ./tools/minikube-helper download-minikube</pre></div><p>Then the <code class="literal">Minikube</code> cluster gets downloaded.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-minikube-manual" href="#kubernetes-minikube-manual"></a>12.2.2&nbsp;Manual Installation</h3></div></div></div><p>You can perform a manual installation for either OSX or Linux.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_example_for_osx_2" href="#_example_for_osx_2"></a>Example for OSX</h4></div></div></div><p>The following listing shows how to manually install on OSX:</p><div class="informalexample"><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre></div><p>Feel free to skip running <code class="literal">sudo mv minikube /usr/local/bin</code> if you want to add minikube to your path manually.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_example_for_linux_2" href="#_example_for_linux_2"></a>12.2.3&nbsp;Example for Linux</h3></div></div></div><p>The following listing shows how to manually install on Linux:</p><div class="informalexample"><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre></div><p>You can skip running <code class="literal">sudo mv minikube /usr/local/bin</code> if you want to add minikube to your path manually.
See <a class="link" href="https://github.com/kubernetes/minikube/releases" target="_top">this page</a> for more information on the installation.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_run_minikube" href="#_run_minikube"></a>12.3&nbsp;Run Minikube</h2></div></div></div><p>To start Kubernetes on your local box, run <code class="literal">minikube start</code>.</p><p>To add the dashboard, run <code class="literal">minikube dashboard</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_certificates_and_workers" href="#_certificates_and_workers"></a>12.4&nbsp;Certificates and Workers</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_minikube_certificates_and_workers" href="#_minikube_certificates_and_workers"></a>12.4.1&nbsp;Minikube Certificates and Workers</h3></div></div></div><p>By default, if you install Minikube, all the certificates get installed in your
<code class="literal">~/.minikube</code> folder. Your <code class="literal">kubectl</code> configuration under <code class="literal">~/.kube/config</code> also
gets updated to use Minikube.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_manual_certificates_and_workers_setup" href="#_manual_certificates_and_workers_setup"></a>12.4.2&nbsp;Manual Certificates and Workers Setup</h3></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you want to run the default demo setup, you can skip this section.</p></td></tr></table></div><p>To target a given Kubernetes instance, you need to pass around Certificate Authority
key and also user keys.</p><p>You can read more about the instructions on how to generate those keys <a class="link" href="https://coreos.com/kubernetes/docs/latest/openssl.html" target="_top">here</a>.
Generally speaking, if you have a Kubernetes installation (such as <code class="literal">minikube</code>), this step
has already been done for you. Now you can reuse those keys on the workers.</p><p>The following inormation has been extracted from the <a class="link" href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html" target="_top">Kubernetes official documentation</a>.</p><p>Configure <code class="literal">kubectl</code> to connect to the target cluster using the following commands, replacing the following values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Replace <code class="literal">${MASTER_HOST}</code> with the master node address or name used in previous steps.</li><li class="listitem">Replace <code class="literal">${CA_CERT}</code> with the absolute path to the <code class="literal">ca.pem</code> created in previous steps.</li><li class="listitem">Replace <code class="literal">${ADMIN_KEY}</code> with the absolute path to the <code class="literal">admin-key.pem</code> created in previous steps.</li><li class="listitem">Replace <code class="literal">${ADMIN_CERT}</code> with the absolute path to the <code class="literal">admin.pem</code> created in previous steps.</li></ul></div><p>The following commands show how to perform these steps:</p><div class="informalexample"><pre class="programlisting">$ kubectl config <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_generate_minikube_namespaces" href="#_generate_minikube_namespaces"></a>12.5&nbsp;Generate Minikube Namespaces</h2></div></div></div><p>With the Minikube cluster running, we need to generate namespaces. To do so, run the
<code class="literal">./tools/k8s-helper.sh setup-namespaces</code>.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_the_demo_setup_cloud_foundry" href="#_the_demo_setup_cloud_foundry"></a>13.&nbsp;The demo setup (Cloud Foundry)</h2></div></div></div><p>The demo uses two applications: <a class="link" href="https://github.com/spring-cloud-samples/github-webhook/" target="_top">Github Webhook</a>
and <a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github analytics code</a>. The following
image shows how these application communicate with each other:</p><div class="figure"><a name="d0e8166" href="#d0e8166"></a><p class="title"><b>Figure&nbsp;13.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e8194" href="#d0e8194"></a><p class="title"><b>Figure&nbsp;13.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e8209" href="#d0e8209"></a><p class="title"><b>Figure&nbsp;13.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_pcf_dev" href="#_deploying_production_applications_to_pcf_dev"></a>13.1&nbsp;Deploying Production Applications to PCF Dev</h2></div></div></div><p>In a real-world scenario, we would not want to automatically provision services such as
RabbitMQ, MySQL, or Eureka each time we deploy a new application to production. Typically,
production is provisioned manually (often by using automated solutions). In our case, before
you deploy to production, you can provision the <code class="literal">pcfdev-prod</code> space by using the
 <code class="literal">cf-helper.sh</code>. To do so, call the following script:</p><div class="informalexample"><pre class="programlisting">$ ./cf-helper.sh setup-prod-infra</pre></div><p>The CF CLI:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Logs in to PCF Dev,</li><li class="listitem">Targets the <code class="literal">pcfdev-prod</code> space</li><li class="listitem"><p class="simpara">Sets up:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">RabbitMQ (under the <code class="literal">rabbitmq-github</code> name)</li><li class="listitem">MySQL (under <code class="literal">mysql-github-analytics</code> name)</li><li class="listitem">Eureka (under <code class="literal">github-eureka</code> name)</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_cf" href="#_running_prometheus_on_cf"></a>13.2&nbsp;Running Prometheus on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/prometheus-on-PCF" target="_top">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p><p>Go to <a class="link" href="https://prometheus.io/download/" target="_top">https://prometheus.io/download/</a> and download the Linux binary. Then run the following command:</p><div class="informalexample"><pre class="programlisting">cf push sc-pipelines-prometheus -b binary_buildpack -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'./prometheus -web.listen-address=:8080'</span> -m <span class="hl-number">64</span>m</pre></div><p>Also, <code class="literal">localhost:9090</code> in <code class="literal">prometheus.yml</code> should be <code class="literal">localhost:8080</code>.</p><p>The file should resemble the following listing to work with the demo setup (change <code class="literal">github-analytics-sc-pipelines.cfapps.io</code>
to your <code class="literal">github-analytics</code> installation).</p><div class="informalexample"><pre class="programlisting"># my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
      monitor: 'codelab-monitor'

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first.rules"
  # - "second.rules"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:8080']

  - job_name: 'demo-app'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    metrics_path: '/prometheus'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['github-analytics-sc-pipelines.cfapps.io']</pre></div><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-prometheus.cfapps.io/" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_cf" href="#_running_grafana_on_cf"></a>13.3&nbsp;Running Grafana on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/cf-grafana" target="_top">Toshiaki Maki&#8217;s code</a> to see how to automate Prometheus installation on CF.</p><p>Download the tarball from <a class="link" href="https://grafana.com/grafana/download?platform=linux" target="_top">https://grafana.com/grafana/download?platform=linux</a>
and set <code class="literal">http_port = 8080</code> in <code class="literal">conf/default.ini</code>. Then run the following the command:</p><div class="informalexample"><pre class="programlisting">cf push sc-pipelines-grafana -b binary_buildpack -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'./bin/grafana-server web'</span> -m <span class="hl-number">64</span>m</pre></div><p>The demo uses Grafana Dashboard with an ID of <code class="literal">2471</code>.</p><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-grafana.cfapps.io/" target="_top">here</a></p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_the_demo_setup_kubernetes" href="#_the_demo_setup_kubernetes"></a>14.&nbsp;The demo setup (Kubernetes)</h2></div></div></div><p>The demo uses two applications: <a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes/" target="_top">Github Webhook</a>
and <a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github analytics code</a>. The following
image shows how these application communicate with each other:</p><div class="figure"><a name="d0e8355" href="#d0e8355"></a><p class="title"><b>Figure&nbsp;14.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e8383" href="#d0e8383"></a><p class="title"><b>Figure&nbsp;14.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e8398" href="#d0e8398"></a><p class="title"><b>Figure&nbsp;14.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_minikube" href="#_deploying_production_applications_to_minikube"></a>14.1&nbsp;Deploying Production Applications to Minikube</h2></div></div></div><p>In a real-world scenario, we would not want to automatically provision services such as
RabbitMQ, MySQL, or Eureka each time we deploy a new application to production. Typically,
production is provisioned manually (often by using automated solutions). In our case, before
you deploy to production, you can provision the <code class="literal">sc-pipelines-prod</code> namespace by using the
 <code class="literal">k8s-helper.sh</code>. To do so, call the following script:</p><div class="informalexample"><pre class="programlisting">$ ./k8s-helper.sh setup-prod-infra</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_kubernetes" href="#_running_prometheus_on_kubernetes"></a>14.2&nbsp;Running Prometheus on Kubernetes</h2></div></div></div><p>Use Helm to install Prometheus. Later in this demo, we point it to the services
deployed to our cluster.</p><p>Create a file called <code class="literal">values.yaml</code> with the following content:</p><div class="example"><a name="d0e8435" href="#d0e8435"></a><p class="title"><b>Example&nbsp;14.1.&nbsp;values.yaml</b></p><div class="example-contents"><pre class="programlisting">rbac:
  create: false

alertmanager:
  ## If false, alertmanager will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## alertmanager container name
  ##
  name: alertmanager

  ## alertmanager container image
  ##
  image:
    repository: prom/alertmanager
    tag: v0.9.1
    pullPolicy: IfNotPresent

  ## Additional alertmanager container arguments
  ##
  extraArgs: {}

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional alertmanager container environment variable
  ## For instance to add a http_proxy
  ##
  extraEnv: {}

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.alertmanager.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/alertmanager-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, alertmanager Ingress will be created
    ##
    enabled: false

    ## alertmanager Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## alertmanager Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - alertmanager.domain.com

    ## alertmanager Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - alertmanager.domain.com

  ## Alertmanager Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node labels for alertmanager pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  persistentVolume:
    ## If true, alertmanager will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## alertmanager data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: https://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## alertmanager data Persistent Volume Claim annotations
    ##
    annotations: {}

    ## alertmanager data Persistent Volume existing claim name
    ## Requires alertmanager.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## alertmanager data Persistent Volume mount root path
    ##
    mountPath: /data

    ## alertmanager data Persistent Volume size
    ##
    size: 2Gi

    ## alertmanager data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of alertmanager data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to alertmanager pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## alertmanager resource requests and limits
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the alertmanager service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    # nodePort: 30000
    type: ClusterIP

## Monitors ConfigMap changes and POSTs to a URL
## Ref: https://github.com/jimmidyson/configmap-reload
##
configmapReload:
  ## configmap-reload container name
  ##
  name: configmap-reload

  ## configmap-reload container image
  ##
  image:
    repository: jimmidyson/configmap-reload
    tag: v0.1
    pullPolicy: IfNotPresent

  ## configmap-reload resource requests and limits
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}

kubeStateMetrics:
  ## If false, kube-state-metrics will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## kube-state-metrics container name
  ##
  name: kube-state-metrics

  ## kube-state-metrics container image
  ##
  image:
    repository: gcr.io/google_containers/kube-state-metrics
    tag: v1.1.0-rc.0
    pullPolicy: IfNotPresent

  ## Node labels for kube-state-metrics pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to kube-state-metrics pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## kube-state-metrics resource requests and limits
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 16Mi
    # requests:
    #   cpu: 10m
    #   memory: 16Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the kube-state-metrics service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

nodeExporter:
  ## If false, node-exporter will not be installed
  ##
  enabled: true

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## node-exporter container name
  ##
  name: node-exporter

  ## node-exporter container image
  ##
  image:
    repository: prom/node-exporter
    tag: v0.15.0
    pullPolicy: IfNotPresent

  ## Additional node-exporter container arguments
  ##
  extraArgs: {}

  ## Additional node-exporter hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: textfile-dir
    #   mountPath: /srv/txt_collector
    #   hostPath: /var/lib/node-exporter
    #   readOnly: true

  ## Node tolerations for node-exporter scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for node-exporter pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to node-exporter pods
  ##
  podAnnotations: {}

  ## node-exporter resource limits &amp; requests
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 200m
    #   memory: 50Mi
    # requests:
    #   cpu: 100m
    #   memory: 30Mi

  service:
    annotations:
      prometheus.io/scrape: "true"
    labels: {}

    clusterIP: None

    ## List of IP addresses at which the node-exporter service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    hostPort: 9100
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9100
    type: ClusterIP

server:
  ## Prometheus server container name
  ##
  name: server

  # Defines the serviceAccountName to use when `rbac.create=false`
  serviceAccountName: default

  ## Prometheus server container image
  ##
  image:
    repository: prom/prometheus
    tag: v1.8.0
    pullPolicy: IfNotPresent

  ## (optional) alertmanager URL
  ## only used if alertmanager.enabled = false
  alertmanagerURL: ""

  ## The URL prefix at which the container can be accessed. Useful in the case the '-web.external-url' includes a slug
  ## so that the various internal URLs are still able to access as they are in the default case.
  ## (Optional)
  baseURL: ""

  ## Additional Prometheus server container arguments
  ##
  extraArgs: {}

  ## Additional Prometheus server hostPath mounts
  ##
  extraHostPathMounts: []
    # - name: certs-dir
    #   mountPath: /etc/kubernetes/certs
    #   hostPath: /etc/kubernetes/certs
    #   readOnly: true

  ## ConfigMap override where fullname is {{.Release.Name}}-{{.Values.server.configMapOverrideName}}
  ## Defining configMapOverrideName will cause templates/server-configmap.yaml
  ## to NOT generate a ConfigMap resource
  ##
  configMapOverrideName: ""

  ingress:
    ## If true, Prometheus server Ingress will be created
    ##
    enabled: false

    ## Prometheus server Ingress annotations
    ##
    annotations: {}
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## Prometheus server Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - prometheus.domain.com

    ## Prometheus server Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-server-tls
    #     hosts:
    #       - prometheus.domain.com

  ## Server Deployment Strategy type
  # strategy:
  #   type: Recreate

  ## Node tolerations for server scheduling to nodes with taints
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  tolerations: []
    # - key: "key"
    #   operator: "Equal|Exists"
    #   value: "value"
    #   effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"

  ## Node labels for Prometheus server pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  nodeSelector: {}

  persistentVolume:
    ## If true, Prometheus server will create/use a Persistent Volume Claim
    ## If false, use emptyDir
    ##
    enabled: true

    ## Prometheus server data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: https://kubernetes.io/docs/user-guide/persistent-volumes/
    ##
    accessModes:
      - ReadWriteOnce

    ## Prometheus server data Persistent Volume annotations
    ##
    annotations: {}

    ## Prometheus server data Persistent Volume existing claim name
    ## Requires server.persistentVolume.enabled: true
    ## If defined, PVC must be created manually before volume will be bound
    existingClaim: ""

    ## Prometheus server data Persistent Volume mount root path
    ##
    mountPath: /data

    ## Prometheus server data Persistent Volume size
    ##
    size: 8Gi

    ## Prometheus server data Persistent Volume Storage Class
    ## If defined, storageClassName: &lt;storageClass&gt;
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS &amp; OpenStack)
    ##
    # storageClass: "-"

    ## Subdirectory of Prometheus server data Persistent Volume to mount
    ## Useful if the volume's root directory is not empty
    ##
    subPath: ""

  ## Annotations to be added to Prometheus server pods
  ##
  podAnnotations: {}
    # iam.amazonaws.com/role: prometheus

  replicaCount: 1

  ## Prometheus server resource requests and limits
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi

  service:
    annotations: {}
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the Prometheus server service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP

  ## Prometheus server pod termination grace period
  ##
  terminationGracePeriodSeconds: 300

  ## Prometheus data retention period (i.e 360h)
  ##
  retention: ""

pushgateway:
  ## If false, pushgateway will not be installed
  ##
  enabled: true

  ## pushgateway container name
  ##
  name: pushgateway

  ## pushgateway container image
  ##
  image:
    repository: prom/pushgateway
    tag: v0.4.0
    pullPolicy: IfNotPresent

  ## Additional pushgateway container arguments
  ##
  extraArgs: {}

  ingress:
    ## If true, pushgateway Ingress will be created
    ##
    enabled: false

    ## pushgateway Ingress annotations
    ##
    annotations:
    #   kubernetes.io/ingress.class: nginx
    #   kubernetes.io/tls-acme: 'true'

    ## pushgateway Ingress hostnames
    ## Must be provided if Ingress is enabled
    ##
    hosts: []
    #   - pushgateway.domain.com

    ## pushgateway Ingress TLS configuration
    ## Secrets must be manually created in the namespace
    ##
    tls: []
    #   - secretName: prometheus-alerts-tls
    #     hosts:
    #       - pushgateway.domain.com

  ## Node labels for pushgateway pod assignment
  ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
  ##
  nodeSelector: {}

  ## Annotations to be added to pushgateway pods
  ##
  podAnnotations: {}

  replicaCount: 1

  ## pushgateway resource requests and limits
  ## Ref: https://kubernetes.io/docs/user-guide/compute-resources/
  ##
  resources: {}
    # limits:
    #   cpu: 10m
    #   memory: 32Mi
    # requests:
    #   cpu: 10m
    #   memory: 32Mi

  service:
    annotations:
      prometheus.io/probe: pushgateway
    labels: {}
    clusterIP: ""

    ## List of IP addresses at which the pushgateway service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    servicePort: 9091
    type: ClusterIP

## alertmanager ConfigMap entries
##
alertmanagerFiles:
  alertmanager.yml: |-
    global:
      # slack_api_url: ''
    receivers:
      - name: default-receiver
        # slack_configs:
        #  - channel: '@you'
        #    send_resolved: true
    route:
      group_wait: 10s
      group_interval: 5m
      receiver: default-receiver
      repeat_interval: 3h
## Prometheus server ConfigMap entries
##
serverFiles:
  alerts: ""
  rules: ""

  prometheus.yml: |-
    rule_files:
      - /etc/config/rules
      - /etc/config/alerts
    scrape_configs:
      - job_name: 'demo-app'
        scrape_interval: 5s
        metrics_path: '/prometheus'
        static_configs:
          - targets:
            - github-analytics.sc-pipelines-prod.svc.cluster.local:8080
      - job_name: prometheus
        static_configs:
          - targets:
            - localhost:9090
      # A scrape configuration for running Prometheus on a Kubernetes cluster.
      # This uses separate scrape configs for cluster components (i.e. API server, node)
      # and services to allow each to use different authentication configs.
      #
      # Kubernetes labels will be added as Prometheus labels on metrics via the
      # `labelmap` relabeling action.
      # Scrape config for API servers.
      #
      # Kubernetes exposes API servers as endpoints to the default/kubernetes
      # service so this uses `endpoints` role and uses relabelling to only keep
      # the endpoints associated with the default/kubernetes service using the
      # default named port `https`. This works for single API server deployments as
      # well as HA API server deployments.
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
          - role: endpoints
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        # Keep only the default/kubernetes service endpoints for the https port. This
        # will add targets for each API server which Kubernetes adds an endpoint to
        # the default/kubernetes service.
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: default;kubernetes;https
      - job_name: 'kubernetes-nodes'
        # Default to scraping over https. If required, just disable this or change to
        # `http`.
        scheme: https
        # This TLS &amp; bearer token file config is used to connect to the actual scrape
        # endpoints for cluster components. This is separate to discovery auth
        # configuration because discovery &amp; scraping are two separate concerns in
        # Prometheus. The discovery auth config is automatic if Prometheus runs inside
        # the cluster. Otherwise, more config options have to be provided within the
        # &lt;kubernetes_sd_config&gt;.
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # If your node certificates are self-signed or use a different CA to the
          # master CA, then disable certificate verification below. Note that
          # certificate verification is an integral part of a secure infrastructure
          # so this should only be disabled in a controlled environment. You can
          # disable certificate verification by uncommenting the line below.
          #
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics
      # Scrape config for service endpoints.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape services that have a value of `true`
      # * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need
      # to set this to `https` &amp; most likely set the `tls_config` of the scrape config.
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: If the metrics are exposed on a different port to the
      # service then set this appropriately.
      - job_name: 'kubernetes-service-endpoints'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
            action: replace
            target_label: __scheme__
            regex: (https?)
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+)(?::\d+);(\d+)
            replacement: $1:$2
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name
      - job_name: 'prometheus-pushgateway'
        honor_labels: true
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: pushgateway
      # Example scrape config for probing services via the Blackbox Exporter.
      #
      # The relabeling allows the actual service scrape endpoint to be configured
      # via the following annotations:
      #
      # * `prometheus.io/probe`: Only probe services that have a value of `true`
      - job_name: 'kubernetes-services'
        metrics_path: /probe
        params:
          module: [http_2xx]
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
            action: keep
            regex: true
          - source_labels: [__address__]
            target_label: __param_target
          - target_label: __address__
            replacement: blackbox
          - source_labels: [__param_target]
            target_label: instance
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_service_name]
            target_label: kubernetes_name
      # Example scrape config for pods
      #
      # The relabeling allows the actual pod scrape endpoint to be configured via the
      # following annotations:
      #
      # * `prometheus.io/scrape`: Only scrape pods that have a value of `true`
      # * `prometheus.io/path`: If the metrics path is not `/metrics` override this.
      # * `prometheus.io/port`: Scrape the pod on the indicated port instead of the default of `9102`.
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: (.+):(?:\d+);(\d+)
            replacement: ${1}:${2}
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
networkPolicy:
  ## Enable creation of NetworkPolicy resources.
  ##
  enabled: false</pre></div></div><br class="example-break"><p>Next, create the prometheus installation with the predefined values. To do so, run the following command:</p><div class="informalexample"><pre class="programlisting">$ helm install --name sc-pipelines-prometheus stable/prometheus -f values.yaml</pre></div><p>Then you should see the following output:</p><div class="informalexample"><pre class="programlisting">NOTES:
The Prometheus server can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local


Get the Prometheus server URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=server"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9090</span>


The Prometheus alertmanager can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-alertmanager.default.svc.cluster.local


Get the Alertmanager URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=alertmanager"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9093</span>


The Prometheus PushGateway can be accessed via port <span class="hl-number">9091</span> on the following DNS name from within your cluster:
sc-pipelines-prometheus-prometheus-pushgateway.default.svc.cluster.local


Get the PushGateway URL by running these commands in the same shell:
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=prometheus,component=pushgateway"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
  kubectl --namespace default port-forward $POD_NAME <span class="hl-number">9093</span>

For more information on running Prometheus, visit:
https://prometheus.io/</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_kubernetes" href="#_running_grafana_on_kubernetes"></a>14.3&nbsp;Running Grafana on Kubernetes</h2></div></div></div><p>Use Helm to install Grafana, by running the following command:</p><div class="informalexample"><pre class="programlisting">$ helm install --name sc-pipelines-grafana stable/grafana</pre></div><p>You should see the following output:</p><div class="informalexample"><pre class="programlisting">NOTES:
<span class="hl-number">1.</span> Get your <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'admin'</span> user password by running:

   kubectl get secret --namespace default sc-pipelines-grafana-grafana -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.data.grafana-admin-password}"</span> | base64 --decode ; <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span>

<span class="hl-number">2.</span> The Grafana server can be accessed via port <span class="hl-number">80</span> on the following DNS name from within your cluster:

   sc-pipelines-grafana-grafana.default.svc.cluster.local

   Get the Grafana URL to visit by running these commands in the same shell:

     <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=sc-pipelines-grafana-grafana,component=grafana"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
     kubectl --namespace default port-forward $POD_NAME <span class="hl-number">3000</span>

<span class="hl-number">3.</span> Login with the password from step <span class="hl-number">1</span> and the username: admin</pre></div><p>Perform the steps listed in the preceding output and add the Grafana&#8217;s datasource
as Prometheus with the following URL: <code class="literal"><a class="link" href="https://sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local" target="_top">https://sc-pipelines-prometheus-prometheus-server.default.svc.cluster.local</a></code></p><p>You can pick up the dashboard with the Grafana ID (2471). This is the
default dashboard for the Spring Cloud Pipelines demo apps.</p><p>If you have both apps (<code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>) running on production,
you can now trigger the messages. Download the JSON with a sample request
from <a class="link" href="https://github.com/marcingrzejszczak/github-webhook-kubernetes/blob/master/src/test/resources/github-webhook-input/hook-created.json" target="_top">the github-webhook repository</a>.
Next, pick one of the <code class="literal">github-webhook</code> pods and forward its port
locally to a port <code class="literal">9876</code>, as follows:</p><div class="informalexample"><pre class="programlisting">$ kubectl port-forward --namespace=sc-pipelines-prod $( kubectl get pods --namespace=sc-pipelines-prod | grep github-webhook | head -<span class="hl-number">1</span> | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span> ) <span class="hl-number">9876</span>:<span class="hl-number">8080</span></pre></div><p>Next, send a couple of requests (more than four), by using cURL as follows:</p><div class="informalexample"><pre class="programlisting">$ curl -X POST http://localhost:<span class="hl-number">9876</span>/ -d @path/to/issue-created.json \
--header <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Content-Type: application/json"</span></pre></div><p>Then, if you use Grafana, you can see that you went above the threshold.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_building_the_project" href="#_building_the_project"></a>15.&nbsp;Building the Project</h2></div></div></div><p>This section covers how to build the project. It covers:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="xref" href="#building-project-setup" title="15.1&nbsp;Project Setup">Section&nbsp;15.1, &#8220;Project Setup&#8221;</a></li><li class="listitem"><a class="xref" href="#building-prerequisites" title="15.2&nbsp;Prerequisites">Section&nbsp;15.2, &#8220;Prerequisites&#8221;</a></li><li class="listitem"><a class="xref" href="#building-bats-submodules" title="15.3&nbsp;Bats Submodules">Section&nbsp;15.3, &#8220;Bats Submodules&#8221;</a></li><li class="listitem"><a class="xref" href="#building-build-and-test" title="15.4&nbsp;Build and test">Section&nbsp;15.4, &#8220;Build and test&#8221;</a></li><li class="listitem"><a class="xref" href="#building-generate-documentation" title="15.5&nbsp;Generate Documentation">Section&nbsp;15.5, &#8220;Generate Documentation&#8221;</a></li><li class="listitem"><a class="xref" href="#building-distributions" title="15.6&nbsp;Distributions">Section&nbsp;15.6, &#8220;Distributions&#8221;</a></li><li class="listitem"><a class="xref" href="#building-making-a-release" title="15.7&nbsp;Making a Release">Section&nbsp;15.7, &#8220;Making a Release&#8221;</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-project-setup" href="#building-project-setup"></a>15.1&nbsp;Project Setup</h2></div></div></div><p>The following diagram shows the folder structure of Spring Cloud Pipelines:</p><div class="informalexample"><pre class="programlisting">.
&#9500;&#9472;&#9472; common
&#9500;&#9472;&#9472; concourse
&#9500;&#9472;&#9472; dist
&#9500;&#9472;&#9472; docs
&#9500;&#9472;&#9472; docs-sources
&#9492;&#9472;&#9472; jenkins</pre></div><p>In the <code class="literal">common</code> folder, you can find all the Bash scripts that contain the pipeline logic. These
scripts are reused by both the Concourse and Jenkins pipelines.</p><p>In the <code class="literal">concourse</code> folder, you can find all the necessary scripts and setup information to run the Concourse demo.</p><p>In the <code class="literal">dist</code> folder, you can find the packaged sources of the project. Since the package
contains no tests or documentation, it is extremely small and can be used in the pipelines.</p><p>In the <code class="literal">docs</code> folder, you can find the whole generated documentation of the project.</p><p>In the <code class="literal">docs-source</code> folder, you can find the sources required to generate the documentation.</p><p>In the <code class="literal">jenkins</code> folder, you can find all the necessary scripts and setup information to run the Jenkins demo.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-prerequisites" href="#building-prerequisites"></a>15.2&nbsp;Prerequisites</h2></div></div></div><p>As prerequisites, you need to have <a class="link" href="https://www.shellcheck.net/" target="_top">shellcheck</a>,
<a class="link" href="https://github.com/sstephenson/bats" target="_top">bats</a>, <a class="link" href="https://stedolan.github.io/jq/" target="_top">jq</a>
and <a class="link" href="https://rubyinstaller.org/downloads/" target="_top">ruby</a> installed. If you use a Linux
machine, <code class="literal">bats</code> and <code class="literal">shellcheck</code> are installed for you.</p><p>To install the required software on Linux, type the following command:</p><div class="informalexample"><pre class="programlisting">$ sudo apt-get install -y ruby jq</pre></div><p>If you use a Mac, run the following commands to install the missing software:</p><pre class="programlisting">$ brew install jq
$ brew install ruby
$ brew install bats
$ brew install shellcheck</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-bats-submodules" href="#building-bats-submodules"></a>15.3&nbsp;Bats Submodules</h2></div></div></div><p>To make <code class="literal">bats</code> work properly, we needed to attach Git submodules. To have them
initialized, either clone the project or (if you have already cloned the project)
pull to update it. The following command clones the project:</p><div class="informalexample"><pre class="programlisting">$ git clone --recursive https://github.com/spring-cloud/spring-cloud-pipelines.git</pre></div><p>The following commands pull the project:</p><div class="informalexample"><pre class="programlisting">$ git submodule init
$ git submodule update</pre></div><p>If you forget about this step, Gradle runs these steps for you.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-build-and-test" href="#building-build-and-test"></a>15.4&nbsp;Build and test</h2></div></div></div><p>Once you have installed all the prerequisites, you can run the following command to build and test the project:</p><div class="informalexample"><pre class="programlisting">$ ./gradlew clean build</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-generate-documentation" href="#building-generate-documentation"></a>15.5&nbsp;Generate Documentation</h2></div></div></div><p>To generate the documentation, run the following command:</p><div class="informalexample"><pre class="programlisting">$ ./gradlew generateDocs</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-distributions" href="#building-distributions"></a>15.6&nbsp;Distributions</h2></div></div></div><p>Spring Cloud Pipelines has a lot of tests, including Git repositories. Those
and the documentation &#8220;weigh&#8221; a lot. That is why, under the <code class="literal">dist</code> folder, we
publish <code class="literal">zip</code> and <code class="literal">tar.gz</code> distributions of the sources without tests and documentation.
Whenever we release a distribution, we attach a <code class="literal">VERSION</code> file to it that contains
build and SCM information (build time, revision number, and other details). To skip the
distribution generation pass the <code class="literal">skipDist</code> property on the command line, as follows:</p><div class="informalexample"><pre class="programlisting">$ ./gradlew build -PskipDist</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building-making-a-release" href="#building-making-a-release"></a>15.7&nbsp;Making a Release</h2></div></div></div><p>You can run the <code class="literal">release</code> task to automatically test the project,
build the distributions, change the versions, build the docs, upload the docs to Spring Cloud Static,
tag the repo, and then revert the changed versions back to default. To do so, run the
following command:</p><div class="informalexample"><pre class="programlisting">$ ./gradlew release -PnewVersion=<span class="hl-number">1.0</span>.<span class="hl-number">0.</span>RELEASE</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_releasing_the_project" href="#_releasing_the_project"></a>16.&nbsp;Releasing the Project</h2></div></div></div><p>This section covers how to release the project by publishing a Docker image.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_publishing_a_docker_image" href="#_publishing_a_docker_image"></a>16.1&nbsp;Publishing A Docker Image</h2></div></div></div><p>When doing a release, you also need to push a Docker image to Dockerhub.
From the project root, run the following commands, replacing <code class="literal">&lt;version&gt;</code> with the
version of the release:</p><div class="informalexample"><pre class="programlisting">$ docker login
$ docker build -t springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt; ./jenkins
$ docker push springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt;</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_ci_server_worker_prerequisites" href="#_ci_server_worker_prerequisites"></a>17.&nbsp;CI Server Worker Prerequisites</h2></div></div></div><p>Spring Cloud Pipelines uses Bash scripts extensively. The following list shows the software
that needs to be installed on a CI server worker for the build to pass:</p><div class="informalexample"><pre class="programlisting"> apt-get -y install \
    bash \
    git \
    tar \
    zip \
    curl \
    ruby \
    wget \
    unzip \
    python \
    jq</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demo setup all of these libraries are already installed.</p></td></tr></table></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the Jenkins case, you also need <code class="literal">bats</code> and <code class="literal">shellcheck</code>. They are not
included in the preceding list, because the versions installed by Linux distributions might be old.
That is why this project&#8217;s Gradle tasks download the latest versions of both libraries
for you.</p></td></tr></table></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="concourse-faq" href="#concourse-faq"></a>18.&nbsp;Concourse FAQ</h2></div></div></div><p>This section covers the most commonly asked questions about using Concourse with Spring Cloud Pipeline:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Can I use the pipeline for some other repos?</span></dt><dd>Yes To do so, change the <code class="literal">app-url</code> in <code class="literal">credentials.yml</code>!</dd><dt><span class="term">Does this work for ANY project out of the box?</span></dt><dd>Not really. This is an <code class="literal">opinionated pipeline</code>. That is why we took some
opinionated decisions. See the documentation to learn
what those decisions are.</dd><dt><span class="term">Can I modify this to reuse in my project?</span></dt><dd><p class="simpara">Yes It is an open-source project. The important thing is that the core part of the logic is written in
Bash scripts. That way, in the majority of cases, you could change only the bash scripts without changing the
whole pipeline. <a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines/tree/master/common/src/main/bash" target="_top">You can check out the scripts here.</a></p><p class="simpara">Furthermore, if you want only to customize a particular function under <code class="literal">common/src/main/bash</code>, you can provide your own
function under <code class="literal">common/src/main/bash/&lt;some custom identifier&gt;</code> where <code class="literal">&lt;some custom identifier&gt;</code> is equal to the value of
the <code class="literal">CUSTOM_SCRIPT_IDENTIFIER</code> environment variable. It defaults to <code class="literal">custom</code>.</p></dd><dt><span class="term">I ran out of resources! (PCF Dev)</span></dt><dd><p class="simpara"><a name="resources" href="#resources"></a> When deploying the application to stage or prod, you can get an <code class="literal">Insufficient resources</code> exception. The way to
resolve it is to kill some apps from the test or stage environment. To do so, run the following commands:</p><div class="informalexample"><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre></div><p class="simpara">You can also run <code class="literal">./tools/cf-helper.sh kill-all-apps</code> to remove
all demo-related apps deployed to PCF Dev.</p></dd><dt><span class="term">The rollback step fails due to a missing JAR.</span></dt><dd><p class="simpara">You must have pushed some tags and must have also removed the Artifactory volume that
contained them. To fix this, remove the tags by running the following command:</p><div class="informalexample"><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div></dd><dt><span class="term">Can I see the output of a job from the terminal?</span></dt><dd><p class="simpara">Yes. Assuming that pipeline name is <code class="literal">github-webhook</code> and the job name is
<code class="literal">build-and-upload</code> you can see the output by running the following command:</p><div class="informalexample"><pre class="programlisting">fly watch --job github-webhook/build-and-upload -t docker</pre></div></dd><dt><span class="term">I clicked the job and it is constantly pending.</span></dt><dd><p class="simpara">Most likely, you forgot to click the <code class="literal">play</code> button to
unpause the pipeline. Click the top left, expand the list of pipelines, and click
the <code class="literal">play</code> button next to <code class="literal">github-webhook</code>.</p><p class="simpara">Another problem that might occur is that you need to have the <code class="literal">version</code> branch.
Concourse waits for the <code class="literal">version</code> branch to appear in your repository. So, for
the pipeline to start, ensure that when doing some git operations, you have not
forgotten to create and copy the <code class="literal">version</code> branch too.</p></dd><dt><span class="term">The route is already in use (CF)</span></dt><dd><p class="simpara">If you play around with Jenkins and Concourse you might end up with the routes occupied,
as indicated by a message similar to the following:</p><div class="informalexample"><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre></div><p class="simpara">To fix the problem, you can delete the routes, as follows:</p><div class="informalexample"><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre></div><p class="simpara">You can also run the <code class="literal">./tools/cf-helper.sh delete-routes</code> script.</p></dd><dt><span class="term">I mm unauthorized to deploy infrastructure jars</span></dt><dd>Most likely, you forgot to update your local <code class="literal">settings.xml</code> file with Artifactory&#8217;s
setup. See <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code> file</a>.</dd><dt><span class="term">The <code class="literal">version</code> resource is broken. When I click on it, I get the following error</span></dt><dd></dd></dl></div><div class="informalexample"><pre class="programlisting">resource script <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'/opt/resource/check []'</span> failed: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">exit</span> status <span class="hl-number">128</span>

stderr:
Identity added: /tmp/git-resource-private-key (/tmp/git-resource-private-key)
Cloning into <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'/tmp/git-resource-repo-cache'</span>...
warning: Could not find remote branch version to clone.
fatal: Remote branch version not found in upstream origin</pre></div><p>That means that your repo does not have the <code class="literal">version</code> branch. You need
set it up.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jenkins_faq" href="#jenkins_faq"></a>19.&nbsp;Jenkins FAQ</h2></div></div></div><p>This section provides answers to the most frequently asked questions about using Jenkins with Spring Cloud Pipelines.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Pipeline version contains ${PIPELINE_VERSION}</span></dt><dd><p class="simpara">You can check the Jenkins logs and see the following warning:</p><div class="informalexample"><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre></div><p class="simpara">To fix it, you have to do exactly what the warning suggests. Also, you should ensure that the <code class="literal">Groovy token macro processing</code>
checkbox is set.</p></dd><dt><span class="term">Pipeline version is not passed to the build</span></dt><dd><p class="simpara">You can see that the Jenkins version is properly set. However, in the build version, it is still snapshot and
the <code class="literal">echo "${PIPELINE_VERSION}"</code> does not print anything.</p><p class="simpara">You can check the Jenkins logs and see the following warning:</p><div class="informalexample"><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre></div><p class="simpara">To fix it, you have to do exactly what the warning suggests.</p></dd><dt><span class="term">The build times out with <code class="literal">pipeline.sh</code> information</span></dt><dd><p class="simpara">This is a Docker compose issue. The problem is that for some reason, only in Docker, the execution of
Java hangs. However, it hangs randomly and only the first time you try to run the pipeline.</p><p class="simpara">The solution to this issue is to run the pipeline again. If it passes once,
it will pass for any subsequent build.</p><p class="simpara">Another thing that you can try is to run it with plain Docker. That helps sometimes.</p></dd><dt><span class="term">Can I use the pipeline for some other repositories?</span></dt><dd><p class="simpara">Yes. You can pass the <code class="literal">REPOS</code> variable with a comma-separated list of
<code class="literal">project_name$project_url</code> format. If you do not provide the <code class="literal">PROJECT_NAME</code>, the
repository name is extracted and used as the name of the project.</p><p class="simpara">For example, a <code class="literal">REPOS</code> value equal to <code class="literal"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook" target="_top">https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook</a></code>
results in the creation of pipelines with root names <code class="literal">github-analytics</code> and <code class="literal">github-webhook</code>.</p><p class="simpara">For example, a <code class="literal">REPOS</code> equal to <code class="literal">myanalytics$https://github.com/spring-cloud-samples/github-analytics,myfeed$https://github.com/spring-cloud-samples/atom-feed</code>
results in the creation of pipelines with root names <code class="literal">myanalytics</code> for <code class="literal">github-analytics</code>
and <code class="literal">myfeed</code> for <code class="literal">github-webhook</code>.</p></dd><dt><span class="term">Can this work for ANY project out of the box?</span></dt><dd><p class="simpara">Not really. This is an &#8220;opinionated pipeline&#8221;. That is why we took some
opinionated decisions, such as:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Using Spring Cloud, Spring Cloud Contract Stub Runner, and Spring Cloud Eureka.</li><li class="listitem">Application deployment to Cloud Foundry.</li><li class="listitem"><p class="simpara">Maven, including:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Using the Maven Wrapper.</li><li class="listitem">Artifacts deployment by using <code class="literal">./mvnw clean deploy</code>.</li><li class="listitem">The <code class="literal">stubrunner.ids</code> property to retrieve the list of collaborators for which stubs should be downloaded.</li><li class="listitem">Running smoke tests on a deployed app with the <code class="literal">smoke</code> Maven profile.</li><li class="listitem">Running end to end tests on a deployed app with the <code class="literal">e2e</code> Maven profile.</li></ul></div></li><li class="listitem"><p class="simpara">Gradle (in the <code class="literal">github-analytics</code> application check in the <code class="literal">gradle/pipeline.gradle</code> file), including:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Using the Gradlew Wrapper.</li><li class="listitem">A <code class="literal">deploy</code> task for artifacts deployment.</li><li class="listitem">Running smoke tests on a deployed application with the <code class="literal">smoke</code> task.</li><li class="listitem">Running end to end tests on a deployed application with the <code class="literal">e2e</code> task.</li><li class="listitem">A <code class="literal">groupId</code> task to retrieve group ID.</li><li class="listitem">An <code class="literal">artifactId</code> task to retrieve artifact ID.</li><li class="listitem">A <code class="literal">currentVersion</code> task to retrieve the current version.</li><li class="listitem"><p class="simpara">A <code class="literal">stubIds</code> task to retrieve the list of collaborators for which stubs should be downloaded.</p><p class="simpara">This is the initial approach that can be easily changed in the future.</p></li></ul></div></li></ul></div></dd><dt><span class="term">Can I modify this to reuse in my project?</span></dt><dd>Yes. It is open-source. The important thing is that the core part of the logic is written
in Bash scripts. That way, in the majority of cases, you could change only the bash
scripts without changing the whole pipeline.</dd><dt><span class="term">The rollback step fails due to a missing JAR</span></dt><dd><p class="simpara"><a name="jenkins_tags" href="#jenkins_tags"></a> You must have pushed some tags and have removed the Artifactory volume that
contained them. To fix this, remove the tags by using the following command:</p><div class="informalexample"><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div></dd><dt><span class="term">I want to provide a different JDK version.</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">By default, we assume that you have configured a JDK with an ID of <code class="literal">jdk8</code>.</li><li class="listitem"><p class="simpara">If you want a different one, override the <code class="literal">JDK_VERSION</code> environment variable to point to the proper one.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The docker image comes in with Java installed at <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code>.
You can go to <code class="literal">Global Tools</code> and create a JDK with an ID of <code class="literal">jdk8</code> and set <code class="literal">JAVA_HOME</code>
to <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code>.</p></td></tr></table></div></li></ul></div></dd></dl></div><p>To change the default settings, follow the steps shown in the following images:</p><div class="figure"><a name="d0e9120" href="#d0e9120"></a><p class="title"><b>Figure&nbsp;19.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e9129" href="#d0e9129"></a><p class="title"><b>Figure&nbsp;19.2.&nbsp;Click 'Global Tool'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/global_tool.png" alt="global tool"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e9138" href="#d0e9138"></a><p class="title"><b>Figure&nbsp;19.3.&nbsp;Click 'JDK Installations'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk_installation.png" alt="jdk installation"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e9147" href="#d0e9147"></a><p class="title"><b>Figure&nbsp;19.4.&nbsp;Fill out JDK Installation with path to your JDK</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk.png" alt="jdk"></div></div></div><br class="figure-break"><div class="variablelist"><a name="groovy-token-macro" href="#groovy-token-macro"></a><dl class="variablelist"><dt><span class="term">How can I enable groovy token macro processing?</span></dt><dd>We scripted that. However, if you need to this manually, follow the steps shown in the following images:</dd></dl></div><div class="figure"><a name="d0e9163" href="#d0e9163"></a><p class="title"><b>Figure&nbsp;19.5.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e9172" href="#d0e9172"></a><p class="title"><b>Figure&nbsp;19.6.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e9181" href="#d0e9181"></a><p class="title"><b>Figure&nbsp;19.7.&nbsp;Click 'Allow token macro processing'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/groovy_token.png" alt="groovy token"></div></div></div><br class="figure-break"><div class="variablelist"><dl class="variablelist"><dt><span class="term">How can I make deployment to stage and prod be automatic?</span></dt><dd><p class="simpara">Set the relevant property or environment variable to <code class="literal">true</code>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_STAGE</code> to automatically deploy to stage.</li><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_PROD</code> to automatically deploy to prod.</li></ul></div></dd><dt><span class="term">How can I skip testing API compatibility?</span></dt><dd>Set the <code class="literal">API_COMPATIBILITY_STEP_REQUIRED</code> environment variable
to <code class="literal">false</code> and re-run the seed (you can pick it from the seed
job&#8217;s properties, too).</dd><dt><span class="term">I can&#8217;t tag the repo.</span></dt><dd><p class="simpara">You may get an error similar to the following:</p><div class="informalexample"><pre class="programlisting"><span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> stderr: remote: Invalid username or password.
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> fatal: Authentication failed <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'https://github.com/marcingrzejszczak/github-webhook/'</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:<span class="hl-number">1740</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandWithCredentials(CliGitAPIImpl.java:<span class="hl-number">1476</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.access$<span class="hl-number">300</span>(CliGitAPIImpl.java:<span class="hl-number">63</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl$<span class="hl-number">8.</span>execute(CliGitAPIImpl.java:<span class="hl-number">1816</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.plugins.git.GitPublisher.perform(GitPublisher.java:<span class="hl-number">295</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.tasks.BuildStepMonitor$<span class="hl-number">3.</span>perform(BuildStepMonitor.java:<span class="hl-number">45</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.perform(AbstractBuild.java:<span class="hl-number">779</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.performAllBuildSteps(AbstractBuild.java:<span class="hl-number">720</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Build$BuildExecution.post2(Build.java:<span class="hl-number">185</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.post(AbstractBuild.java:<span class="hl-number">665</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Run.execute(Run.java:<span class="hl-number">1745</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:<span class="hl-number">43</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.ResourceController.execute(ResourceController.java:<span class="hl-number">98</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Executor.run(Executor.java:<span class="hl-number">404</span>)</pre></div><p class="simpara">Most likely, you passed a wrong password. Check the <a class="link" href="#">credentials</a> section
for how to update your credentials.</p></dd><dt><span class="term">I am unauthorized to deploy infrastructure jars.</span></dt><dd>Most likely, you forgot to update your local <code class="literal">settings.xml</code> file with the Artifactory&#8217;s
setup. Check out <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code> file</a>.</dd><dt><span class="term">Signing Artifacts</span></dt><dd>In some cases, it may be required that, when you perform a release, that the artifacts be signed
before you push them to the repository.
To do this, you  need to import your GPG keys into the Docker image that runs Jenkins.
This can be done by placing a file called <code class="literal">public.key</code> that contains your public key
and a file called <code class="literal">private.key</code> that contains your private key in the <code class="literal">seed</code> directory.
These keys are imported by the <code class="literal">init.groovy</code> script runs when Jenkins starts.</dd><dt><span class="term">Using SSH keys for Git</span></dt><dd><p class="simpara">The seed job checks whether an environment variable called <code class="literal">GIT_USE_SSH_KEY</code> is set to <code class="literal">true</code>. If it is <code class="literal">true</code>, the
environment variable called <code class="literal">GIT_SSH_CREDENTIAL_ID</code> is chosen as the one that contains the
ID of the credential that contains SSH private key. By default, <code class="literal">GIT_CREDENTIAL_ID</code> is picked
as the one that contains the username and password to connect to git.</p><p class="simpara">You can set these values in the seed job by filling out the form and toggling a checkbox.</p></dd><dt><span class="term">Deploy to stage fails and does not redeploy a service (Kubernetes).</span></dt><dd>There can be a number of reasons for this issue. Remember, though, that, for stage, we
assume that a sequence of manual steps needs to be performed. We do not
redeploy any existing services, because, most likely, you deliberately
have it set up that way. If, in the logs of your application,
you can see that you cannot connect to a service, first ensure that
the service is forwarding traffic to a pod. Next, if that is not the case,
delete the service and re-run the step in the pipeline. That way,
Spring Cloud Pipelines redeploy the service and the underlying pods.</dd><dt><span class="term">I ran out of resources. (Cloud Foundry)</span></dt><dd><p class="simpara">[jenkins-cf-resources]] When deploying the application to stage or prod, you can get an <code class="literal">Insufficient resources</code> exception. The way to
solve it is to kill some applications from the test and stage environments. To do so, run the following commands:</p><div class="informalexample"><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre></div><p class="simpara">You can also run <code class="literal">./tools/cf-helper.sh kill-all-apps</code> to remove all demo-related apps
deployed to PCF Dev.</p></dd><dt><span class="term">Deploying to test or stage or prod fails with an error about finding space (Cloud Foundry)</span></dt><dd><p class="simpara">You receive an exception similar to the following:</p><div class="informalexample"><pre class="programlisting"><span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> API endpoint:   https://api.local.pcfdev.io (API version: <span class="hl-number">2.58</span>.<span class="hl-number">0</span>)
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> User:           user
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Org:            pcfdev-org
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space:          No space targeted, use <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'cf target -s SPACE'</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> FAILED
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Error finding space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> not found</pre></div><p class="simpara">It means that you forgot to <a class="link" href="#">create the spaces</a> in your PCF Dev installation.</p></dd><dt><span class="term">The route is already in use (Cloud Foundry).</span></dt><dd><p class="simpara">If you play around with Jenkins and Concourse, you can end up with routes that are
already occupied, as identified by errors similar to the following:</p><div class="informalexample"><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre></div><p class="simpara">To resolve the issue, delete the offending routes, by using commands similar to the following:</p><div class="informalexample"><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre></div><p class="simpara">You can also run the <code class="literal">./tools/cf-helper.sh delete-routes</code> script.</p></dd><dt><span class="term">How can I run helper scripts against a real Cloud Foundry instance that I&#8217;m logged into?</span></dt><dd><p class="simpara">Assuming that you are already logged into the cluster, uyou can run the
helper script with the <code class="literal">REUSE_CF_LOGIN=true</code> env variable, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">REUSE_CF_LOGIN=true ./tools/cf-helper.sh setup-prod-infra</pre></div><p class="simpara">This script create the MySQL database and the RabbitMQ service and downloads and deploys Eureka
to the space and organization you are logged into.</p></dd></dl></div></div></div></div></body></html>