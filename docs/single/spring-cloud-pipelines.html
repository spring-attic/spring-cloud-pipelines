<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Cloud Pipelines</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>Spring Cloud Pipelines</h1></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#d0e9"></a></span></dt><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_setup">1.1. Project setup</a></span></dt><dt><span class="section"><a href="#_how_to_use_it">1.2. How to use it?</a></span></dt><dt><span class="section"><a href="#_the_flow">1.3. The flow</a></span></dt><dt><span class="section"><a href="#_environments">1.4. Environments</a></span></dt><dt><span class="section"><a href="#_tests">1.5. Tests</a></span></dt><dd><dl><dt><span class="section"><a href="#_testing_against_stubs">1.5.1. Testing against stubs</a></span></dt><dt><span class="section"><a href="#_general_view">1.5.2. General view</a></span></dt></dl></dd><dt><span class="section"><a href="#_ci_server_worker_prerequisites">1.6. CI Server worker prerequisites</a></span></dt><dt><span class="section"><a href="#_pipeline_descriptor">1.7. Pipeline descriptor</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_opinionated_implementation">2. Opinionated implementation</a></span></dt><dd><dl><dt><span class="section"><a href="#_build">2.1. Build</a></span></dt><dt><span class="section"><a href="#_test">2.2. Test</a></span></dt><dt><span class="section"><a href="#_stage">2.3. Stage</a></span></dt><dt><span class="section"><a href="#_prod">2.4. Prod</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_project_opinions">3. Project opinions</a></span></dt><dd><dl><dt><span class="section"><a href="#_cf_project_opinions">3.1. CF project opinions</a></span></dt><dt><span class="section"><a href="#_kubernetes_project_opinions">3.2. Kubernetes project opinions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#concourse">4. Concourse Pipeline</a></span></dt><dd><dl><dt><span class="section"><a href="#_step_by_step">4.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#_fork_repos">4.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#_start_concourse_and_artifactory">4.1.2. Start Concourse and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploy_the_infra_jars_to_artifactory">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#_start_pcf_dev">4.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#_setup_the_literal_fly_literal_cli">4.1.4. Setup the <code class="literal">fly</code> CLI</a></span></dt><dt><span class="section"><a href="#_setup_your_literal_credentials_yml_literal">4.1.5. Setup your <code class="literal">credentials.yml</code></a></span></dt><dt><span class="section"><a href="#_build_the_pipeline">4.1.6. Build the pipeline</a></span></dt><dt><span class="section"><a href="#_run_the_literal_github_webhook_literal_pipeline">4.1.7. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#_faq">4.2. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="#faq">4.2.1. Can I use the pipeline for some other repos?</a></span></dt><dt><span class="section"><a href="#_will_this_work_for_any_project_out_of_the_box">4.2.2. Will this work for ANY project out of the box?</a></span></dt><dt><span class="section"><a href="#_can_i_modify_this_to_reuse_in_my_project">4.2.3. Can I modify this to reuse in my project?</a></span></dt><dt><span class="section"><a href="#_i_ran_out_of_resources">4.2.4. I ran out of resources!!</a></span></dt><dt><span class="section"><a href="#_the_rollback_step_fails_due_to_missing_jar">4.2.5. The rollback step fails due to missing JAR ?!</a></span></dt><dt><span class="section"><a href="#_can_i_see_the_output_of_a_job_from_the_terminal">4.2.6. Can I see the output of a job from the terminal?</a></span></dt><dt><span class="section"><a href="#_i_clicked_the_job_and_it_s_constantly_pending">4.2.7. I clicked the job and it&#8217;s constantly pending&#8230;&#8203;</a></span></dt><dt><span class="section"><a href="#_the_route_is_already_in_use">4.2.8. The route is already in use</a></span></dt><dt><span class="section"><a href="#_i_m_unauthorized_to_deploy_infrastructure_jars">4.2.9. I&#8217;m unauthorized to deploy infrastructure jars</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_jenkins_pipeline_common">5. Jenkins Pipeline (Common)</a></span></dt><dd><dl><dt><span class="section"><a href="#_project_setup_2">5.1. Project setup</a></span></dt><dt><span class="section"><a href="#_optional_customization_steps">5.2. Optional customization steps</a></span></dt><dd><dl><dt><span class="section"><a href="#deploying-infra">5.2.1. Deploying infra jars to a different location</a></span></dt><dt><span class="section"><a href="#setup-settings-xml">5.2.2. Setup settings.xml for Maven deployment</a></span></dt><dt><span class="section"><a href="#setup-jenkins-env-vars">5.2.3. Setup Jenkins env vars</a></span></dt><dd><dl><dt><span class="section"><a href="#setup-seed-props">Seed properties</a></span></dt><dt><span class="section"><a href="#global-envs">Global envs</a></span></dt></dl></dd><dt><span class="section"><a href="#git-email">5.2.4. Set Git email / user</a></span></dt><dd><dl><dt><span class="section"><a href="#jenkins-credentials-github">Add Jenkins credentials for GitHub</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#_testing_jenkins_scripts">5.3. Testing Jenkins scripts</a></span></dt><dt><span class="section"><a href="#_how_to_work_with_jenkins_job_dsl_plugin">5.4. How to work with Jenkins Job DSL plugin</a></span></dt><dt><span class="section"><a href="#_docker_image">5.5. Docker Image</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-cf">6. Jenkins Pipeline (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-cf">6.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-cf">6.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#start-jenkins-cf">6.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-cf">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#start-pcf-dev-cf">6.1.3. Start PCF Dev</a></span></dt><dt><span class="section"><a href="#jenkins-seed-cf">6.1.4. Run the seed job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-cf">6.1.5. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-cf">6.2. Declarative pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-cf">6.3. Jenkins Cloud Foundry customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-cf">6.3.1. All env vars</a></span></dt><dt><span class="section"><a href="#jenkins-credentials-cf">6.3.2. Jenkins Credentials</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jenkins-pipeline-k8s">7. Jenkins Pipeline (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#step-by-step-k8s">7.1. Step by step</a></span></dt><dd><dl><dt><span class="section"><a href="#fork-repos-k8s">7.1.1. Fork repos</a></span></dt><dt><span class="section"><a href="#start-jenkins-k8s">7.1.2. Start Jenkins and Artifactory</a></span></dt><dd><dl><dt><span class="section"><a href="#deploy-infra-k8s">Deploy the infra JARs to Artifactory</a></span></dt></dl></dd><dt><span class="section"><a href="#_kubernetes_cli_installation">7.1.3. Kubernetes CLI Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-cli-script">Script Installation</a></span></dt></dl></dd><dt><span class="section"><a href="#kubernetes-cli-manual">7.1.4. Manual Installation</a></span></dt><dt><span class="section"><a href="#start-minikube-k8s">7.1.5. Kubernetes Cluster setup</a></span></dt><dd><dl><dt><span class="section"><a href="#kubernetes-minikube-script">Script Installation</a></span></dt><dt><span class="section"><a href="#kubernetes-minikube-manual">Manual Installation</a></span></dt></dl></dd><dt><span class="section"><a href="#_run_minikube">7.1.6. Run Minikube</a></span></dt><dt><span class="section"><a href="#_certificates_and_workers">7.1.7. Certificates and Workers</a></span></dt><dd><dl><dt><span class="section"><a href="#_minikube_certificates_and_workers">Minikube Certificates and Workers</a></span></dt><dt><span class="section"><a href="#_manual_certificates_and_workers_setup">Manual Certificates and Workers Setup</a></span></dt></dl></dd><dt><span class="section"><a href="#_generate_minikube_namespaces">7.1.8. Generate Minikube namespaces</a></span></dt><dt><span class="section"><a href="#jenkins-seed-k8s">7.1.9. Run the seed job</a></span></dt><dt><span class="section"><a href="#jenkins-pipeline-k8s">7.1.10. Run the <code class="literal">github-webhook</code> pipeline</a></span></dt></dl></dd><dt><span class="section"><a href="#declarative-pipeline-k8s">7.2. Declarative pipeline &amp; Blue Ocean</a></span></dt><dt><span class="section"><a href="#optional-steps-k8s">7.3. Jenkins Kubernetes customization</a></span></dt><dd><dl><dt><span class="section"><a href="#all-env-vars-k8s">7.3.1. All env vars</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_faq_2">8. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="#jenkins_faq">8.1. Pipeline version contains ${PIPELINE_VERSION}</a></span></dt><dt><span class="section"><a href="#_pipeline_version_is_not_passed_to_the_build">8.2. Pipeline version is not passed to the build</a></span></dt><dt><span class="section"><a href="#_the_build_times_out_with_literal_pipeline_sh_literal_info">8.3. The build times out with <code class="literal">pipeline.sh</code> info</a></span></dt><dt><span class="section"><a href="#_can_i_use_the_pipeline_for_some_other_repos">8.4. Can I use the pipeline for some other repos?</a></span></dt><dt><span class="section"><a href="#_will_this_work_for_any_project_out_of_the_box_2">8.5. Will this work for ANY project out of the box?</a></span></dt><dt><span class="section"><a href="#_can_i_modify_this_to_reuse_in_my_project_2">8.6. Can I modify this to reuse in my project?</a></span></dt><dt><span class="section"><a href="#_the_rollback_step_fails_due_to_missing_jar_2">8.7. The rollback step fails due to missing JAR ?!</a></span></dt><dt><span class="section"><a href="#_i_want_to_provide_a_different_jdk_version">8.8. I want to provide a different JDK version</a></span></dt><dt><span class="section"><a href="#groovy-token-macro">8.9. Enable Groovy Token Macro Processing</a></span></dt><dd><dl><dt><span class="section"><a href="#_i_want_deployment_to_stage_and_prod_be_automatic">8.9.1. I want deployment to stage and prod be automatic</a></span></dt></dl></dd><dt><span class="section"><a href="#_i_can_t_tag_the_repo">8.10. I can&#8217;t tag the repo!</a></span></dt><dt><span class="section"><a href="#_i_m_unauthorized_to_deploy_infrastructure_jars_2">8.11. I&#8217;m unauthorized to deploy infrastructure jars</a></span></dt><dt><span class="section"><a href="#_signing_artifacts">8.12. Signing Artifacts</a></span></dt><dt><span class="section"><a href="#_i_ran_out_of_resources_cloud_foundry">8.13. I ran out of resources!! (Cloud Foundry)</a></span></dt><dt><span class="section"><a href="#_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry">8.14. Deploying to test / stage / prod fails - error finding space (Cloud Foundry)</a></span></dt><dt><span class="section"><a href="#_the_route_is_already_in_use_cloud_foundry">8.15. The route is already in use (Cloud Foundry)</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_cloud_foundry">9. The demo setup (Cloud Foundry)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_pcf_dev">9.1. Deploying production applications to PCF Dev</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_cf">9.2. Running Prometheus on CF</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_cf">9.3. Running Grafana on CF</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_the_demo_setup_kubernetes">10. The demo setup (Kubernetes)</a></span></dt><dd><dl><dt><span class="section"><a href="#_deploying_production_applications_to_minikube">10.1. Deploying production applications to Minikube</a></span></dt><dt><span class="section"><a href="#_running_prometheus_on_kubernetes">10.2. Running Prometheus on Kubernetes</a></span></dt><dt><span class="section"><a href="#_running_grafana_on_kubernetes">10.3. Running Grafana on Kubernetes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_building_the_project">11. Building the project</a></span></dt><dd><dl><dt><span class="section"><a href="#_prerequisites">11.1. Prerequisites</a></span></dt><dt><span class="section"><a href="#_bats_submodules">11.2. Bats submodules</a></span></dt><dt><span class="section"><a href="#_build_and_test">11.3. Build and test</a></span></dt><dt><span class="section"><a href="#_generate_readme">11.4. Generate readme</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_releasing_the_project">12. Releasing the project</a></span></dt><dd><dl><dt><span class="section"><a href="#_publishing_a_docker_image">12.1. Publishing A Docker Image</a></span></dt></dl></dd></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="d0e9" href="#d0e9"></a></h1></div></div></div><p><span class="emphasis"><em>Documentation Authors: Marcin Grzejszczak</em></span></p><p>Spring, Spring Boot and Spring Cloud are tools that allow developers speed up the
time of creating new business features. It&#8217;s common knowledge however that the
 feature is only valuable if it&#8217;s in production. That&#8217;s why companies
 spend a lot of time and resources on building their own deployment pipelines.</p><p>This project tries to solve the following problems:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Creation of a common deployment pipeline</li><li class="listitem">Propagation of good testing &amp; deployment practices</li><li class="listitem">Speed up the time required to deploy a feature to production</li></ul></div><p>A common way of running, configuring and deploying applications lowers support costs
and time needed by new developers to blend in when they change projects.</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_introduction" href="#_introduction"></a>1.&nbsp;Introduction</h1></div></div></div><p>In the following section we will describe in more depth the rationale
behind the presented opinionated pipeline. We will go through each deployment
step and describe it in details.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup" href="#_project_setup"></a>1.1&nbsp;Project setup</h2></div></div></div><pre class="programlisting">.
&#9500;&#9472;&#9472; common
&#9500;&#9472;&#9472; concourse
&#9500;&#9472;&#9472; docs
&#9492;&#9472;&#9472; jenkins</pre><p>In the <code class="literal">common</code> folder you can find all the Bash scripts containing the pipeline logic. These
scripts are reused by both Concourse and Jenkins pipelines.</p><p>In the <code class="literal">concourse</code> folder you can find all the necessary scripts and setup to run Concourse demo.</p><p>In the <code class="literal">docs</code> section you have the whole documentation of the project.</p><p>In the <code class="literal">jenkins</code> folder you can find all the necessary scripts and setup to run Jenkins demo.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_use_it" href="#_how_to_use_it"></a>1.2&nbsp;How to use it?</h2></div></div></div><p>This repository can be treated as a template for your pipeline. We provide some opinionated
implementation that you can alter to suit your needs. The best approach to use it
to build your production projects would be to download the Spring Cloud Pipelines repository as ZIP, then
init a Git project there and modify it as you wish.</p><pre class="programlisting">$ curl -LOk https://github.com/spring-cloud/spring-cloud-pipelines/archive/v1.<span class="hl-number">0.0</span>.M4.zip
$ unzip v1.<span class="hl-number">0.0</span>.M4.zip
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines-v1.<span class="hl-number">0.0</span>.M4
$ git init
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># modify the pipelines to suit your needs</span>
$ git add .
$ git commit -m <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Initial commit"</span>
$ git remote add origin ${YOUR_REPOSITORY_URL}
$ git push origin master</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Why aren&#8217;t you simply cloning the repo? This is meant to be a seed
for building new, versioned pipelines for you. You don&#8217;t want to have all of our
history dragged along with you, don&#8217;t you?</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_flow" href="#_the_flow"></a>1.3&nbsp;The flow</h2></div></div></div><p>Let&#8217;s take a look at the flow of the opinionated pipeline</p><div class="figure"><a name="d0e75" href="#d0e75"></a><p class="title"><b>Figure&nbsp;1.1.&nbsp;Flow in Concourse</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow_concourse.png" alt="flow concourse"></div></div></div><br class="figure-break"><div class="figure"><a name="d0e84" href="#d0e84"></a><p class="title"><b>Figure&nbsp;1.2.&nbsp;Flow in Jenkins</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/flow.png" alt="flow"></div></div></div><br class="figure-break"><p>We&#8217;ll first describe the overall concept behind the flow and then
we&#8217;ll split it into pieces and describe every piece independently.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_environments" href="#_environments"></a>1.4&nbsp;Environments</h2></div></div></div><p>So we&#8217;re on the same page let&#8217;s define some common vocabulary. We discern 4 typical
environments in terms of running the pipeline.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">build</li><li class="listitem">test</li><li class="listitem">stage</li><li class="listitem">prod</li></ul></div><p><span class="strong"><strong>Build</strong></span> environment is a machine where the building of the application takes place.
It&#8217;s a CI / CD tool worker.</p><p><span class="strong"><strong>Test</strong></span> is an environment where you can deploy an application to test it. It doesn&#8217;t
resemble production, we can&#8217;t be sure of it&#8217;s state (which application is deployed there
and in which version). It can be used by multiple teams at the same time.</p><p><span class="strong"><strong>Stage</strong></span> is an environment that does resemble production. Most likely applications
 are deployed there in versions that correspond to those deployed to production.
 Typically databases there are filled up with (obfuscated) production data. Most
 often this environment is a single, shared one between many teams. In other
 words in order to run some performance, user acceptance tests you have to block
 and wait until the environment is free.</p><p><span class="strong"><strong>Prod</strong></span> is a production environment where we want our tested applications to be deployed
for our customers.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tests" href="#_tests"></a>1.5&nbsp;Tests</h2></div></div></div><p><span class="strong"><strong>Unit tests</strong></span> - tests that are executed on the application during the build phase.
No integrations with databases / HTTP server stubs etc. take place. Generally speaking your application should
 have plenty of these to have fast feedback if your features are working fine.</p><p><span class="strong"><strong>Integration tests</strong></span> - tests that are executed on the built application during the build phase.
Integrations with in memory databases / HTTP server stubs take place. According to the test
pyramid, in most cases you should have not too many of these kind of tests.</p><p><span class="strong"><strong>Smoke tests</strong></span> - tests that are executed on a deployed application. The concept of these tests
is to check the crucial parts of your application are working properly. If you have 100 features
in your application but you gain most money from e.g. 5 features then you could write smoke tests
 for those 5 features. As you can see we&#8217;re talking about smoke tests of an application, not of
 the whole system. In our understanding inside the opinionated pipeline, these tests are
 executed against an application that is surrounded with stubs.</p><p><span class="strong"><strong>End to end tests</strong></span> - tests that are executed on a system composing of multiple applications.
The idea of these tests is to check if the tested feature works when the whole system is set up.
Due to the fact that it takes a lot of time, effort, resources to maintain such an environment
and that often those tests are unreliable (due to many different moving pieces like network
database etc.) you should have a handful of those tests. Only for critical parts of your business.
Since only production is the key verifier of whether your feature works, some companies
don&#8217;t even want to do those and move directly to deployment to production. When your
system contains KPI monitoring and alerting you can quickly react when your deployed application
is not behaving properly.</p><p><span class="strong"><strong>Performance testing</strong></span> - tests executed on an application or set of applications
to check if your system can handle big load of input. In case of our opinionated pipeline
 these tests could be executed either on test (against stubbed environment) or
  stage (against the whole system)</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_testing_against_stubs" href="#_testing_against_stubs"></a>1.5.1&nbsp;Testing against stubs</h3></div></div></div><p>Before we go into details of the flow let&#8217;s take a look at the following example.</p><div class="figure"><a name="d0e157" href="#d0e157"></a><p class="title"><b>Figure&nbsp;1.3.&nbsp;Two monolithic applications deployed for end to end testing</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/monolith.png" alt="monolith"></div></div></div><br class="figure-break"><p>When having only a handful of applications, performing end to end testing is beneficial.
From the operations perspective it&#8217;s maintainable for a finite number of deployed instances.
From the developers perspective it&#8217;s nice to verify the whole flow in the system
for a feature.</p><p>In case of microservices the scale starts to be a problem:</p><div class="figure"><a name="d0e170" href="#d0e170"></a><p class="title"><b>Figure&nbsp;1.4.&nbsp;Many microservices deployed in different versions</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/many_microservices.png" alt="many microservices"></div></div></div><br class="figure-break"><p>The questions arise:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Should I queue deployments of microservices on one testing environment or should I have an environment per microservice?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I queue deployments people will have to wait for hours to have their tests ran - that can be a problem</li></ul></div></li><li class="listitem"><p class="simpara">To remove that issue I can have an environment per microservice</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Who will pay the bills (imagine 100 microservices - each having each own environment).</li><li class="listitem">Who will support each of those environments?</li><li class="listitem">Should we spawn a new environment each time we execute a new pipeline and then wrap it up or should we have
them up and running for the whole day?</li></ul></div></li><li class="listitem"><p class="simpara">In which versions should I deploy the dependent microservices - development or production versions?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">If I have development versions then I can test my application against a feature that is not yet on production.
That can lead to exceptions on production</li><li class="listitem">If I test against production versions then I&#8217;ll never be able to test against a feature under development
anytime before deployment to production.</li></ul></div></li></ul></div><p>One of the possibilities of tackling these problems is to&#8230;&#8203; not do end to end tests.</p><div class="figure"><a name="d0e214" href="#d0e214"></a><p class="title"><b>Figure&nbsp;1.5.&nbsp;Execute tests on a deployed microservice on stubbed dependencies</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>If we stub out all the dependencies of our application then most of the problems presented above
disappear. There is no need to start and setup infrastructure required by the dependant
microservices. That way the testing setup looks like this:</p><div class="figure"><a name="d0e225" href="#d0e225"></a><p class="title"><b>Figure&nbsp;1.6.&nbsp;We&#8217;re testing microservices in isolation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stubbed_dependencies.png" alt="stubbed dependencies"></div></div></div><br class="figure-break"><p>Such an approach to testing and deployment gives the following benefits
(thanks to the usage of <a class="link" href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No need to deploy dependant services</li><li class="listitem">The stubs used for the tests ran on a deployed microservice are the same as those used during integration tests</li><li class="listitem">Those stubs have been tested against the application that produces them (check <a class="link" href="http://cloud.spring.io/spring-cloud-contract/spring-cloud-contract.html" target="_top">Spring Cloud Contract</a> for more information)</li><li class="listitem">We don&#8217;t have many slow tests running on a deployed application - thus the pipeline gets executed much faster</li><li class="listitem">We don&#8217;t have to queue deployments - we&#8217;re testing in isolation thus pipelines don&#8217;t interfere with each other</li><li class="listitem">We don&#8217;t have to spawn virtual machines each time for deployment purposes</li></ul></div><p>It brings however the following challenges:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">No end to end tests before production - you don&#8217;t have the full certainty that a feature is working</li><li class="listitem">First time the applications will talk in a real way will be on production</li></ul></div><p>Like every solution it has its benefits and drawbacks. The opinionated pipeline
 allows you to configure whether you want to follow this flow or not.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_general_view" href="#_general_view"></a>1.5.2&nbsp;General view</h3></div></div></div><p>The general view behind this deployment pipeline is to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">test the application in isolation</li><li class="listitem">test the backwards compatibility of the application in order to roll it back if necessary</li><li class="listitem">allow testing of the packaged app in a deployed environment</li><li class="listitem">allow user acceptance tests / performance tests in a deployed environment</li><li class="listitem">allow deployment to production</li></ul></div><p>Obviously the pipeline could have been split to more steps but it seems that all of the aforementioned
 actions comprise nicely in our opinionated proposal.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_ci_server_worker_prerequisites" href="#_ci_server_worker_prerequisites"></a>1.6&nbsp;CI Server worker prerequisites</h2></div></div></div><p>Spring Cloud Pipelines uses Bash scripts extensively. Below you can find the list of software
that needs to be installed on a CI server worker for the build to pass.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demo setup all of these libraries are already installed.</p></td></tr></table></div><pre class="programlisting"> apt-get -y install \
    bash \
    git \
    tar \
    zip \
    curl \
    ruby \
    wget \
    unzip \
    python \
    jq</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the Jenkins case you will also need <code class="literal">bats</code> and <code class="literal">shellcheck</code>. They are not
presented in the list since the installed versions by Linux distributions might be old.
That&#8217;s why this project&#8217;s Gradle tasks will download latest versions of both libraries
for you.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_descriptor" href="#_pipeline_descriptor"></a>1.7&nbsp;Pipeline descriptor</h2></div></div></div><p>Each application can contain a file called <code class="literal">sc-pipelines.yml</code> with the following structure:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName1</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service1Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service1Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service2Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service2Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName2</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service3Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service3Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service4Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service4Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value</pre><p>For a given environment we declare a list of infrastructure services that we
want to have deployed. Services have</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">type</code> (example: <code class="literal">eureka</code>, <code class="literal">mysql</code>, <code class="literal">rabbitmq</code>, <code class="literal">stubrunner</code>) - this value gets
then applied to the <code class="literal">deployService</code> Bash function</li><li class="listitem"><span class="strong"><strong>[KUBERNETES]</strong></span> for <code class="literal">mysql</code> you can pass the database name via the <code class="literal">database</code>
property</li><li class="listitem"><code class="literal">name</code> - name of the service to get deployed</li><li class="listitem"><code class="literal">coordinates</code> - coordinate that allows you to fetch the binary of the service.
Examples: It can be a maven coordinate <code class="literal">groupid:artifactid:version</code>,
 docker image <code class="literal">organization/nameOfImage</code>, etc.</li><li class="listitem">arbitrary key value pairs - you can customize the services as you wish</li></ul></div><p>The <code class="literal">stubrunner</code> type can also have the <code class="literal">useClasspath</code> flag turned on to <code class="literal">true</code>
or <code class="literal">false</code>.</p><p>Example:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">test</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: rabbitmq
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: rabbitmq-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: mysql
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: mysql-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: eureka-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-eureka:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: stubrunner-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-analytics-stub-runner-boot-classpath-stubs:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useClasspath</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">stage</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: rabbitmq
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: rabbitmq-github
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: mysql
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: mysql-github
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: github-eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-eureka:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1</pre><p>When the deployment to test or deployment to stage occurs, Spring Cloud Pipelines
will:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">for <code class="literal">test</code> environment, delete existing services and redeploy the ones from the list</li><li class="listitem">for <code class="literal">stage</code> environment, if the service is not available it will get deployed. Otherwise
nothing will happen</li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_opinionated_implementation" href="#_opinionated_implementation"></a>2.&nbsp;Opinionated implementation</h1></div></div></div><p>For the demo purposes we&#8217;re providing Docker Compose setup with Artifactory and Concourse / Jenkins tools.
Regardless of the picked CD application for the pipeline to pass one needs either</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>[CLOUD FOUNDRY]</strong></span> a Cloud Foundry instance (for example <a class="link" href="https://run.pivotal.io/" target="_top">Pivotal Web Services</a> or <a class="link" href="https://pivotal.io/pcf-dev" target="_top">PCF Dev</a>)</li><li class="listitem"><span class="strong"><strong>[KUBERNETES]</strong></span> a Kubernetes cluster (for example <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>)</li><li class="listitem">the infrastructure applications deployed to the JAR hosting application (for the demo we&#8217;re providing Artifactory).</li><li class="listitem"><code class="literal">Eureka</code> for Service Discovery</li><li class="listitem"><code class="literal">Stub Runner Boot</code> for running Spring Cloud Contract stubs.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the demos we&#8217;re showing you how to first build the <code class="literal">github-webhook</code> project. That&#8217;s because
the <code class="literal">github-analytics</code> needs the stubs of <code class="literal">github-webhook</code> to pass the tests. Below you&#8217;ll find
references to <code class="literal">github-analytics</code> project since it contains more interesting pieces as far as testing
is concerned.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_build" href="#_build"></a>2.1&nbsp;Build</h2></div></div></div><div class="figure"><a name="d0e466" href="#d0e466"></a><p class="title"><b>Figure&nbsp;2.1.&nbsp;Build and upload artifacts</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/build.png" alt="build"></div></div></div><br class="figure-break"><p>In this step we&#8217;re generating a version of the pipeline, next we&#8217;re
 running unit, integration and contract tests. Finally we&#8217;re:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">publishing a fat jar of the application</li><li class="listitem">publishing a Spring Cloud Contract jar containing stubs of the application</li><li class="listitem"><span class="strong"><strong>[KUBERNETES]</strong></span> uploading a Docker image of the application</li></ul></div><p>During this phase we&#8217;re executing a <code class="literal">Maven</code> build using Maven Wrapper or a <code class="literal">Gradle</code> build using Gradle Wrapper
, with unit and integration tests. We&#8217;re also <span class="strong"><strong>tagging</strong></span> the repository with <code class="literal">dev/${version}</code> format. That way in each
subsequent step of the pipeline we&#8217;re able to retrieve the tagged version. Also we know
exactly which version of the pipeline corresponds to which Git hash.</p><p>Once the artifact got built we&#8217;re running API compatibility check.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">we&#8217;re searching for the latest production deployment</li><li class="listitem">we&#8217;re retrieving the contracts that were used by that deployment</li><li class="listitem">from the contracts we&#8217;re generating API tests to see if the current implementation
is fulfilling the HTTP / messaging contracts that the current production deployment
has defined (we&#8217;re checking backward compatibility of the API)</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_test" href="#_test"></a>2.2&nbsp;Test</h2></div></div></div><div class="figure"><a name="d0e518" href="#d0e518"></a><p class="title"><b>Figure&nbsp;2.2.&nbsp;Smoke test and rollback test on test environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/test.png" alt="test"></div></div></div><br class="figure-break"><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">starting a RabbitMQ service in PaaS</li><li class="listitem">deploying <code class="literal">Eureka</code> infrastructure application to PaaS</li><li class="listitem">downloading the fat jar from Nexus and we&#8217;re uploading it to PaaS. We want the application
to run in isolation (be surrounded by stubs).</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Currently due to port constraints in Cloud Foundry
we cannot run multiple stubbed HTTP services in the cloud so to fix this issue we&#8217;re running
the application with <code class="literal">smoke</code> Spring profile on which you can stub out all HTTP calls to return
a mocked response</p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">if the application is using a database then it gets upgraded at this point via Flyway, Liquibase
or any other tool once the application gets started</li><li class="listitem">from the project&#8217;s Maven or Gradle build we&#8217;re extracting <code class="literal">stubrunner.ids</code> property that contains
all the <code class="literal">groupId:artifactId:version:classifier</code> notation of dependant projects for which
the stubs should be downloaded.</li><li class="listitem">then we&#8217;re uploading <code class="literal">Stub Runner Boot</code> and pass the extracted <code class="literal">stubrunner.ids</code> to it. That way
we&#8217;ll have a running application in Cloud Foundry that will download all the necessary stubs
of our application</li><li class="listitem">from the checked out code we&#8217;re running the tests available under the <code class="literal">smoke</code> profile. In the
case of <code class="literal">GitHub Analytics</code> application we&#8217;re triggering a message from the <code class="literal">GitHub Webhook</code>
application&#8217;s stub, that is sent via RabbitMQ to GitHub Analytics. Then we&#8217;re checking if
message count has increased.</li><li class="listitem">once the tests pass we&#8217;re searching for the last production release. Once the application
is deployed to production we&#8217;re tagging it with <code class="literal">prod/${version}</code> tag. If there is no such tag
(there was no production release) there will be no rollback tests executed. If there was
a production release the tests will get executed.</li><li class="listitem">assuming that there was a production release we&#8217;re checking out the code corresponding to that
release (we&#8217;re checking out the tag), we&#8217;re downloading the appropriate artifact (either JAR for Cloud Foundry
or Docker image for Kubernetes) and we&#8217;re uploading
it to PaaS. <span class="strong"><strong>IMPORTANT</strong></span> the <span class="emphasis"><em>old</em></span> artifact is running against the <span class="strong"><strong>NEW</strong></span> version of the database.</li><li class="listitem">we&#8217;re running the <span class="emphasis"><em>old</em></span> <code class="literal">smoke</code> tests against the freshly deployed application surrounded by stubs.
If those tests pass then we have a high probability that the application is backwards compatible</li><li class="listitem">the default behaviour is that after all of those steps the user can manually click to deploy the
application to a stage environment</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_stage" href="#_stage"></a>2.3&nbsp;Stage</h2></div></div></div><div class="figure"><a name="d0e615" href="#d0e615"></a><p class="title"><b>Figure&nbsp;2.3.&nbsp;End to end tests on stage environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/stage.png" alt="stage"></div></div></div><br class="figure-break"><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">starting a RabbitMQ service in PaaS</li><li class="listitem">deploying <code class="literal">Eureka</code> infrastructure application to PaaS</li><li class="listitem">downloading the artifact (either JAR for Cloud Foundry or Docker image for Kubernetes)
from and we&#8217;re uploading it to PaaS.</li></ul></div><p>Next we have a manual step in which:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">from the checked out code we&#8217;re running the tests available under the <code class="literal">e2e</code> profile. In the
case of <code class="literal">GitHub Analytics</code> application we&#8217;re sending a HTTP message to GitHub Analytic&#8217;s endpoint. Then we&#8217;re checking if
the received message count has increased.</li></ul></div><p>The step is manual by default due to the fact that stage environment is often shared between
teams and some preparations on databases / infrastructure have to take place before running the tests.
Ideally these step should be fully automatic.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prod" href="#_prod"></a>2.4&nbsp;Prod</h2></div></div></div><div class="figure"><a name="d0e656" href="#d0e656"></a><p class="title"><b>Figure&nbsp;2.4.&nbsp;Deployment to production</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/intro/prod.png" alt="prod"></div></div></div><br class="figure-break"><p>The step to deploy to production is manual but ideally it should be automatic.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This step does deployment to production. On production you would assume
that you have the infrastructure running. That&#8217;s why before you run this step you
must execute a script that will provision the services on the production environment.
For <code class="literal">Cloud Foundry</code> just call <code class="literal">tools/pcfdev-helper.sh setup-prod-infra</code> and
for Kubernetes <code class="literal">tools/minikube-helper.sh setup-prod-infra</code></p></td></tr></table></div><p>Here we&#8217;re</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">tagging the Git repo with <code class="literal">prod/${version}</code> tag</li><li class="listitem">downloading the application artifact (either JAR for Cloud Foundry or Docker image for Kubernetes)</li><li class="listitem">we&#8217;re doing Blue Green deployment:</li><li class="listitem"><p class="simpara">for Cloud Foundry</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re renaming the current instance of the app e.g. <code class="literal">fooService</code> to <code class="literal">fooService-venerable</code></li><li class="listitem">we&#8217;re deploying the new instance of the app under the <code class="literal">fooService</code> name</li><li class="listitem">now two instances of the same application are running on production</li></ul></div></li><li class="listitem"><p class="simpara">for Kubernetes</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re deploying a service with the name of the app e.g. <code class="literal">fooService</code></li><li class="listitem">we&#8217;re doing a deployment with the name of the app with version suffix (with the name escaped
to fulfill the DNS name requirements) e.g. <code class="literal">fooService-1-0-0-M1-123-456-VERSION</code></li><li class="listitem">all deployments of the same application have the same label <code class="literal">name</code> equal to app name e.g. <code class="literal">fooService</code></li><li class="listitem">the service is routing the traffic basing on the <code class="literal">name</code> label selector</li><li class="listitem">now two instances of the same application are running on production</li></ul></div></li><li class="listitem"><p class="simpara">in the <code class="literal">Complete switch over</code> which is a manual step</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">we&#8217;re deleting the old instance</li><li class="listitem">remember to run this step only after you have confirmed that both instances are working fine!</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_project_opinions" href="#_project_opinions"></a>3.&nbsp;Project opinions</h1></div></div></div><p>In this section we will go through the assumptions we&#8217;ve made in the project
structure and project properties.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cf_project_opinions" href="#_cf_project_opinions"></a>3.1&nbsp;CF project opinions</h2></div></div></div><p>We&#8217;ve taken the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application built using Maven or Gradle wrappers</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem"><p class="simpara">For Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">example project</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem"><code class="literal">settings.xml</code> contains all the credentials to push code to Artifactory</li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem"><code class="literal">repo.with.binaries</code> property - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property - (Injected by the pipeline) ID of the distribution management. Corresponds to server id in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> property - (Injected by the pipeline) Will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apicompatibility</code> Maven profile</li><li class="listitem"><code class="literal">latest.production.version</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle  (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES</code> env var - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> env var - (Taken from <code class="literal">gradle.properties</code>) Username used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> env var - (Taken from <code class="literal">gradle.properties</code>) Password used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apiCompatibility</code> task</li><li class="listitem"><code class="literal">latestProductionVersion</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_kubernetes_project_opinions" href="#_kubernetes_project_opinions"></a>3.2&nbsp;Kubernetes project opinions</h2></div></div></div><p>We&#8217;ve taken the following opinionated decisions for a Cloud Foundry based project:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application built using Maven or Gradle wrappers</li><li class="listitem">application deployment to Kubernetes</li><li class="listitem">The produced Java Docker image needs to allow passing of system properties via <code class="literal">SYSTEM_PROPS</code> env variable</li><li class="listitem"><p class="simpara">For Maven (<a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">example project</a>):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem"><code class="literal">settings.xml</code> contains all the credentials to push code to Artifactory and Docker repository</li><li class="listitem">artifacts and Docker image deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem"><code class="literal">repo.with.binaries</code> property - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">distribution.management.release.id</code> property - (Injected by the pipeline) ID of the distribution management. Corresponds to server id in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> property - (Injected by the pipeline) Will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor</li><li class="listitem">running API compatibility tests via the <code class="literal">apicompatibility</code> Maven profile</li><li class="listitem"><code class="literal">latest.production.version</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle  (<a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">example project</a> check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES</code> env var - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> env var - (Taken from <code class="literal">gradle.properties</code>) Username used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> env var - (Taken from <code class="literal">gradle.properties</code>) Password used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">DOCKER_URL</code> env var - (Overridable - defaults to DockerHub) URL of the Docker registry</li><li class="listitem"><code class="literal">DOCKER_USERNAME</code> env var - (Taken from <code class="literal">gradle.properties</code>) Username used to send the the Docker image</li><li class="listitem"><code class="literal">DOCKER_PASSWORD</code> env var - (Taken from <code class="literal">gradle.properties</code>) Password used to send the the Docker image</li><li class="listitem"><code class="literal">DOCKER_EMAIL</code> env var - (Taken from <code class="literal">gradle.properties</code>) Email used to send the the Docker image</li><li class="listitem"><code class="literal">deployment.yml</code> contains the Kubernetes deployment descriptor</li><li class="listitem"><code class="literal">service.yml</code> contains the Kubernetes service descriptor</li><li class="listitem">running API compatibility tests via the <code class="literal">apiCompatibility</code> task</li><li class="listitem"><code class="literal">latestProductionVersion</code> property - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="concourse" href="#concourse"></a>4.&nbsp;Concourse Pipeline</h1></div></div></div><p>The repository contains an opinionated pipeline that will build and deploy  - <a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a> application.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github-Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_step_by_step" href="#_step_by_step"></a>4.1&nbsp;Step by step</h2></div></div></div><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#fork">Fork repos</a></li><li class="listitem"><a class="link" href="#start">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="#deploy">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#pcfdev">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#fly">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="#creds">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="#">Run the seed job</a></li><li class="listitem"><a class="link" href="#">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><p>Below you can find <a class="link" href="#">optional</a> steps needed to be taken when you want to customize the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#">Setup Jenkins env vars (if you want to use the demo defaults and you&#8217;re using Docker Machine
just check out the section on how to update the URL to Artifactory)</a></li><li class="listitem"><a class="link" href="#">Add <code class="literal">settings.xml</code> for Jenkins' master (you can skip this if you want to use our defaults)</a></li><li class="listitem"><a class="link" href="#">Setup Jenkins miscs (JDK installation, Groovy macro processing etc.)</a></li><li class="listitem"><a class="link" href="#">Setup Jenkins credentials</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_fork_repos" href="#_fork_repos"></a>4.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="fork" href="#fork"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_start_concourse_and_artifactory" href="#_start_concourse_and_artifactory"></a>4.1.2&nbsp;Start Concourse and Artifactory</h3></div></div></div><p><a name="start" href="#start"></a> Concourse + Artifactory can be run locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/concourse
./setup_docker_compose.sh
./start.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre><p>The <code class="literal">setup_docker_compose.sh</code> script should be executed once only to allow
generation of keys.</p><p>The <code class="literal">192.168.99.100</code> param is an example of an external URL of Concourse
(equal to Docker-Machine ip in this example).</p><p>Then Concourse will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_deploy_the_infra_jars_to_artifactory" href="#_deploy_the_infra_jars_to_artifactory"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="deploy" href="#deploy"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_start_pcf_dev" href="#_start_pcf_dev"></a>4.1.3&nbsp;Start PCF Dev</h3></div></div></div><p><a name="pcfdev" href="#pcfdev"></a> TIP: You can skip this step if you have CF installed and don&#8217;t want to use PCF Dev
The only thing you have to do is to set up spaces.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#resources">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p>You have to download and start PCF Dev. <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">A link how to do it is available here.</a></p><p>The default credentials when using PCF Dev are:</p><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre><p>You can start the PCF dev like this:</p><pre class="programlisting">cf dev start</pre><p>You&#8217;ll have to create 3 separate spaces (email admin, pass admin)</p><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre><p>You can also execute the <code class="literal">./tools/pcfdev-helper.sh setup-spaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_setup_the_literal_fly_literal_cli" href="#_setup_the_literal_fly_literal_cli"></a>4.1.4&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p><a name="fly" href="#fly"></a> If you go to Concourse website you should see sth like this:</p><p>&nbsp;
&nbsp;</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>&nbsp;
&nbsp;</p><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you&#8217;ve downloaded that (and maybe added to your PATH) you can run:</p><pre class="programlisting">fly --version</pre><p>If <code class="literal">fly</code> is properly installed then it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_setup_your_literal_credentials_yml_literal" href="#_setup_your_literal_credentials_yml_literal"></a>4.1.5&nbsp;Setup your <code class="literal">credentials.yml</code></h3></div></div></div><p><a name="creds" href="#creds"></a> The repo comes with <code class="literal">credentials-sample.yml</code> which is set up with sample data (most credentials) are set to be applicable for PCF Dev. Copy this file to a new file <code class="literal">credentials.yml</code> (the file is added to .gitignore so don&#8217;t worry that you&#8217;ll push it with your passwords) and edit it as you wish. For our demo jus setup:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">app-url</code> - url pointing to your forked <code class="literal">github-webhook</code> repo</li><li class="listitem"><code class="literal">github-private-key</code> - your private key to clone / tag GitHub repos</li><li class="listitem"><code class="literal">repo-with-binaries</code> - the IP is set to the defaults for Docker Machine. You should update it to point to your setup</li></ul></div><p>If you don&#8217;t have a Docker Machine just execute <code class="literal">./whats_my_ip.sh</code> script to
get an external IP that you can pass to your <code class="literal">repo-with-binaries</code> instead of the default
Docker Machine IP.</p><p>Below you can see what environment variables are required by the scripts. To the right hand side you can see the default values for PCF Dev that we set in the <code class="literal">credentials-sample.yml</code>.</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for TEST env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for STAGE env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for PROD env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://192.168.99.100:8081/artifactory/libs-release-local" target="_top">http://192.168.99.100:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_HOSTNAME_UUID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>APP_MEMORY_LIMIT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>How much memory should be used by the infra apps (Eureka, Stub Runner etc.)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>256m</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JAVA_BUILDPACK_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the Java buildpack to be used by CF</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://github.com/cloudfoundry/java-buildpack.git#v3.8.1" target="_top">https://github.com/cloudfoundry/java-buildpack.git#v3.8.1</a></p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_build_the_pipeline" href="#_build_the_pipeline"></a>4.1.6&nbsp;Build the pipeline</h3></div></div></div><p>Log in (e.g. for Concourse running at <code class="literal">192.168.99.100</code> - if you don&#8217;t provide any value then <code class="literal">localhost</code> is assumed). If you execute this script  (it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or it&#8217;s in the same folder as the script is):</p><pre class="programlisting">./login.sh <span class="hl-number">192.168</span>.<span class="hl-number">99.100</span></pre><p>Next run the command to create the pipeline.</p><pre class="programlisting">./set_pipeline.sh</pre><p>Then you&#8217;ll create a <code class="literal">github-webhook</code> pipeline under the <code class="literal">docker</code> alias, using the provided <code class="literal">credentials.yml</code> file.
You can override these values in exactly that order (e.g. <code class="literal">./set-pipeline.sh some-project another-target some-other-credentials.yml</code>)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_run_the_literal_github_webhook_literal_pipeline" href="#_run_the_literal_github_webhook_literal_pipeline"></a>4.1.7&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1642" href="#d0e1642"></a><p class="title"><b>Figure&nbsp;4.1.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1655" href="#d0e1655"></a><p class="title"><b>Figure&nbsp;4.2.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1669" href="#d0e1669"></a><p class="title"><b>Figure&nbsp;4.3.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">changeme</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1686" href="#d0e1686"></a><p class="title"><b>Figure&nbsp;4.4.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1697" href="#d0e1697"></a><p class="title"><b>Figure&nbsp;4.5.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1711" href="#d0e1711"></a><p class="title"><b>Figure&nbsp;4.6.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1722" href="#d0e1722"></a><p class="title"><b>Figure&nbsp;4.7.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1736" href="#d0e1736"></a><p class="title"><b>Figure&nbsp;4.8.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1747" href="#d0e1747"></a><p class="title"><b>Figure&nbsp;4.9.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e1758" href="#d0e1758"></a><p class="title"><b>Figure&nbsp;4.10.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_faq" href="#_faq"></a>4.2&nbsp;FAQ</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="faq" href="#faq"></a>4.2.1&nbsp;Can I use the pipeline for some other repos?</h3></div></div></div><p>Sure! Just change the <code class="literal">app-url</code> in <code class="literal">credentials.yml</code>!</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_will_this_work_for_any_project_out_of_the_box" href="#_will_this_work_for_any_project_out_of_the_box"></a>4.2.2&nbsp;Will this work for ANY project out of the box?</h3></div></div></div><p>Not really. This is an <code class="literal">opinionated pipeline</code> that&#8217;s why we took some
opinionated decisions like:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">usage of Spring Cloud, Spring Cloud Contract Stub Runner and Spring Cloud Eureka</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem"><p class="simpara">For Maven:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle (in the <code class="literal">github-analytics</code> application check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div><p>This is the initial approach that can be easily changed in the future.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_can_i_modify_this_to_reuse_in_my_project" href="#_can_i_modify_this_to_reuse_in_my_project"></a>4.2.3&nbsp;Can I modify this to reuse in my project?</h3></div></div></div><p>Sure! It&#8217;s open-source! The important thing is that the core part of the logic is written in
Bash scripts. That way, in the majority of cases, you could change only the bash scripts without changing the
whole pipeline. <a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines/tree/master/common/src/main/bash" target="_top">You can check out the scripts here.</a></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_i_ran_out_of_resources" href="#_i_ran_out_of_resources"></a>4.2.4&nbsp;I ran out of resources!!</h3></div></div></div><p><a name="resources" href="#resources"></a> When deploying the app to stage or prod you can get an exception <code class="literal">Insufficient resources</code>. The way to
 solve it is to kill some apps from test / stage env. To achieve that just call</p><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre><p>You can also execute <code class="literal">./tools/pcfdev-helper.sh kill-all-apps</code> that will remove
all demo-related apps deployed to PCF dev.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_the_rollback_step_fails_due_to_missing_jar" href="#_the_rollback_step_fails_due_to_missing_jar"></a>4.2.5&nbsp;The rollback step fails due to missing JAR ?!</h3></div></div></div><p>You must have pushed some tags and have removed the Artifactory volume that
contained them. To fix this, just remove the tags</p><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_can_i_see_the_output_of_a_job_from_the_terminal" href="#_can_i_see_the_output_of_a_job_from_the_terminal"></a>4.2.6&nbsp;Can I see the output of a job from the terminal?</h3></div></div></div><p>Yes! Assuming that pieline name is <code class="literal">github-webhook</code> and job name is <code class="literal">build-and-upload</code> you can running</p><pre class="programlisting">fly watch --job github-webhook/build-and-upload -t docker</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_i_clicked_the_job_and_it_s_constantly_pending" href="#_i_clicked_the_job_and_it_s_constantly_pending"></a>4.2.7&nbsp;I clicked the job and it&#8217;s constantly pending&#8230;&#8203;</h3></div></div></div><p>Don&#8217;t worry&#8230;&#8203; most likely you&#8217;ve just forgotten to click the <code class="literal">play</code> button to
unpause the pipeline. Click to the top left, expand the list of pipelines and click
the <code class="literal">play</code> button next to <code class="literal">github-webhook</code>.</p><p>Another problem that might occur is that you need to have the <code class="literal">version</code> branch.
Concourse will wait for the <code class="literal">version</code> branch to appear in your repo. So in order for
the pipeline to start ensure that when doing some git operations you haven&#8217;t
forgotten to create / copy the <code class="literal">version</code> branch too.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_the_route_is_already_in_use" href="#_the_route_is_already_in_use"></a>4.2.8&nbsp;The route is already in use</h3></div></div></div><p>If you play around with Jenkins / Concourse you might end up with the routes occupied</p><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre><p>Just delete the routes</p><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre><p>You can also execute the <code class="literal">./tools/pcfdev-helper.sh delete-routes</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_i_m_unauthorized_to_deploy_infrastructure_jars" href="#_i_m_unauthorized_to_deploy_infrastructure_jars"></a>4.2.9&nbsp;I&#8217;m unauthorized to deploy infrastructure jars</h3></div></div></div><p>Most likely you&#8217;ve forgotten to update your local <code class="literal">settings.xml</code> with the Artifactory&#8217;s
setup. Check out <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code></a>.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_jenkins_pipeline_common" href="#_jenkins_pipeline_common"></a>5.&nbsp;Jenkins Pipeline (Common)</h1></div></div></div><p>In this section we will present the common setup of Jenkins for any platform.
We will also provide answers to most frequently asked questions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_project_setup_2" href="#_project_setup_2"></a>5.1&nbsp;Project setup</h2></div></div></div><pre class="programlisting">.
&#9500;&#9472;&#9472; declarative-pipeline
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; Jenkinsfile-sample.groovy
&#9500;&#9472;&#9472; jobs
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_jenkinsfile_empty.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline_sample.groovy
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; jenkins_pipeline_sample_view.groovy
&#9500;&#9472;&#9472; seed
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; gradle.properties
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; init.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; jenkins_pipeline.groovy
&#9474;&nbsp;&nbsp; &#9500;&#9472;&#9472; k8s
&#9474;&nbsp;&nbsp; &#9492;&#9472;&#9472; settings.xml
&#9492;&#9472;&#9472; src
    &#9500;&#9472;&#9472; main
 &nbsp;&nbsp; &#9492;&#9472;&#9472; <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span></pre><p>In the <code class="literal">declarative-pipeline</code> you can find a definition of a <code class="literal">Jenkinsfile-sample.groovy</code> declarative
pipeline. It&#8217;s used together with the Blueocean UI.</p><p>In the <code class="literal">jobs</code> folder you have all the seed jobs that will generate pipelines.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">jenkins_pipeline_empty.groovy</code> - is a template of a pipeline with empty steps using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_jenkinsfile_empty.groovy</code> - is a template of a pipeline with empty steps using the Pipeline plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample.groovy</code> - is an opinionated implementation using the Jenkins Job DSL plugin</li><li class="listitem"><code class="literal">jenkins_pipeline_sample_view.groovy</code> - builds the views for the pipelines</li></ul></div><p>In the <code class="literal">seed</code> folder you have the <code class="literal">init.groovy</code> file which is executed when Jenkins starts.
That way we can configure most of Jenkins options for you (adding credentials, JDK etc.).
<code class="literal">jenkins_pipeline.groovy</code> contains logic to build a seed job (that way you don&#8217;t have to even click that
job - we generate it for you). Under the <code class="literal">k8s</code> folder there are all the configuration
files required for deployment to a Kubernetes cluster.</p><p>In the <code class="literal">src</code> folder you have production and test classes needed for you to build your own pipeline.
Currently we have tests only cause the whole logic resides in the <code class="literal">jenkins_pipeline_sample</code> file.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_optional_customization_steps" href="#_optional_customization_steps"></a>5.2&nbsp;Optional customization steps</h2></div></div></div><p><a name="jenkins_optional" href="#jenkins_optional"></a> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="deploying-infra" href="#deploying-infra"></a>5.2.1&nbsp;Deploying infra jars to a different location</h3></div></div></div><p>It&#8217;s enough to set the <code class="literal">ARTIFACTORY_URL</code> environmental variable before
executing <code class="literal">tools/deploy-infra.sh</code>. Example for deploying to Artifactory at IP <code class="literal">192.168.99.100</code></p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
ARTIFACTORY_URL=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://192.168.99.100:8081/artifactory/libs-release-local"</span> ./tools/deploy-infra.sh</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-settings-xml" href="#setup-settings-xml"></a>5.2.2&nbsp;Setup settings.xml for Maven deployment</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you want to use the default connection to the Docker version
of Artifactory you can skip this step</p></td></tr></table></div><p><a name="jenkins-settings" href="#jenkins-settings"></a> So that <code class="literal">./mvnw deploy</code> works with Artifactory from Docker we&#8217;re
already copying the missing <code class="literal">settings.xml</code> file for you. It looks more or less like this:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>artifactory-local<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>admin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>password<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span></pre><p>If you want to use your own version of Artifactory / Nexus you have to update
the file (it&#8217;s in <code class="literal">seed/settings.xml</code>).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setup-jenkins-env-vars" href="#setup-jenkins-env-vars"></a>5.2.3&nbsp;Setup Jenkins env vars</h3></div></div></div><p><a name="jenkins_env" href="#jenkins_env"></a> If you want to only play around with the demo that we&#8217;ve prepared you have to set <span class="strong"><strong>ONE</strong></span> variable which is the <code class="literal">REPOS</code> variable.
That variable needs to consists of comma separated list of URLs to repositories containing business apps. So you should pass your forked repos URLs.</p><p>You can do it in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">globally via Jenkins global env vars (then when you run the seed that variable will be taken into consideration and proper pipelines will get built)</li><li class="listitem">modify the seed job parameters (you&#8217;ll have to modify the seed job configuration and change the <code class="literal">REPOS</code> property)</li><li class="listitem">provide the repos parameter when running the seed job</li></ul></div><p>For the sake of simplicity let&#8217;s go with the <span class="strong"><strong>last</strong></span> option.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re choosing the global envs, you <span class="strong"><strong>HAVE</strong></span> to remove the other approach
(e.g. if you set the global env for <code class="literal">REPOS</code>, please remove that property in the
seed job</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="setup-seed-props" href="#setup-seed-props"></a>Seed properties</h4></div></div></div><p>Click on the seed job and pick <code class="literal">Build with parameters</code>. Then as presented in the screen below (you&#8217;ll have far more properties to set) just modify the <code class="literal">REPOS</code> property by providing the comma separated list of URLs to your forks. Whatever you set will be parsed by the seed job and passed to the generated Jenkins jobs.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>This is very useful when the repos you want to build differ. E.g. use
different JDK. Then some seeds can set the <code class="literal">JDK_VERSION</code> param to one version
of Java installation and the others to another one.</p></td></tr></table></div><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div><p>In the screenshot we could parametrize the <code class="literal">REPOS</code> and <code class="literal">REPO_WITH_BINARIES</code> params.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="global-envs" href="#global-envs"></a>Global envs</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>This section is presented only for informational purposes - for the sake of demo you can skip it</p></td></tr></table></div><p>You can add env vars (go to configure Jenkins &#8594; Global Properties) for the following
 properties (example with defaults for PCF Dev):</p><p>Example screen:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/env_vars.png" alt="env vars"></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="git-email" href="#git-email"></a>5.2.4&nbsp;Set Git email / user</h3></div></div></div><p>Since our pipeline is setting the git user / name explicitly for the build step
 you&#8217;d have to go to <code class="literal">Configure</code> of the build step and modify the Git name / email.
 If you want to set it globally you&#8217;ll have to remove the section from the build
 step and follow these steps to set it globally.</p><p>You can set Git email / user globally like this:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2186" href="#d0e2186"></a><p class="title"><b>Figure&nbsp;5.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2197" href="#d0e2197"></a><p class="title"><b>Figure&nbsp;5.2.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2208" href="#d0e2208"></a><p class="title"><b>Figure&nbsp;5.3.&nbsp;Fill out Git user information</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/git.png" alt="git"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jenkins-credentials-github" href="#jenkins-credentials-github"></a>Add Jenkins credentials for GitHub</h4></div></div></div><p><a name="jenkins-credentials" href="#jenkins-credentials"></a> The scripts will need to access the credential in order to tag the repo.</p><p>You have to set credentials with id: <code class="literal">git</code>.</p><p>Below you can find instructions on how to set a credential (e.g. for Cloud Foundry <code class="literal">cf-test</code> credential but
remember to provide the one with id <code class="literal">git</code>).</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2240" href="#d0e2240"></a><p class="title"><b>Figure&nbsp;5.4.&nbsp;Click 'Credentials, System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_system.png" alt="credentials system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2251" href="#d0e2251"></a><p class="title"><b>Figure&nbsp;5.5.&nbsp;Click 'Global Credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_global.png" alt="credentials global"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2262" href="#d0e2262"></a><p class="title"><b>Figure&nbsp;5.6.&nbsp;Click 'Add credentials'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_add.png" alt="credentials add"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2273" href="#d0e2273"></a><p class="title"><b>Figure&nbsp;5.7.&nbsp;Fill out the user / password and provide the <code class="literal">git</code> credential ID (in this example <code class="literal">cf-test</code>)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/credentials_example.png" alt="credentials example"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_testing_jenkins_scripts" href="#_testing_jenkins_scripts"></a>5.3&nbsp;Testing Jenkins scripts</h2></div></div></div><p><code class="literal">./gradlew clean build</code></p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>The ran test only checks if your scripts compile.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_how_to_work_with_jenkins_job_dsl_plugin" href="#_how_to_work_with_jenkins_job_dsl_plugin"></a>5.4&nbsp;How to work with Jenkins Job DSL plugin</h2></div></div></div><p>Check out the <a class="link" href="https://github.com/jenkinsci/job-dsl-plugin/wiki/Tutorial---Using-the-Jenkins-Job-DSL" target="_top">tutorial</a>.
Provide the link to this repository in your Jenkins installation.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Remember that views can be overridden that&#8217;s why the suggestion is to contain in one script all the logic needed to build a view
 for a single project (check out that <code class="literal">spring_cloud_views.groovy</code> is building all the <code class="literal">spring-cloud</code> views).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_docker_image" href="#_docker_image"></a>5.5&nbsp;Docker Image</h2></div></div></div><p>If you would like to run the pre-configured Jenkins image somewhere other than your local machine, we
have an image you can pull and use on <a class="link" href="https://hub.docker.com/r/springcloud/spring-cloud-pipeline-jenkins/" target="_top">DockerHub</a>.
The <code class="literal">latest</code> tag corresponds to the latest snapshot build.  You can also find tags
corresponding to stable releases that you can use as well.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>6.&nbsp;Jenkins Pipeline (Cloud Foundry)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Cloud Foundry PaaS</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job Dsl plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics" target="_top">Github-Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-cf" href="#step-by-step-cf"></a>6.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins JOB Dsl based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#jenkins-fork-cf">Fork repos</a></li><li class="listitem"><a class="link" href="#jenkins-start-cf">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-cf">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-pcfdev-cf">Start PCF Dev (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-cf" title="6.1.4&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-cf" title="6.&nbsp;Jenkins Pipeline (Cloud Foundry)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-cf" href="#fork-repos-cf"></a>6.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-cf" href="#jenkins-fork-cf"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-cf" href="#start-jenkins-cf"></a>6.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-cf" href="#jenkins-start-cf"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-cf" href="#deploy-infra-cf"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-cf" href="#jenkins-deploy-cf"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built
and uploaded to Artifactory.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-pcf-dev-cf" href="#start-pcf-dev-cf"></a>6.1.3&nbsp;Start PCF Dev</h3></div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have CF installed and don&#8217;t want to use PCF Dev
The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#">clear some apps from PCF Dev and continue</a>.</p></td></tr></table></div><p><a name="jenkins-pcfdev-cf" href="#jenkins-pcfdev-cf"></a> You have to download and start PCF Dev. <a class="link" href="https://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/install-pcf-dev" target="_top">A link how to do it is available here.</a></p><p>The default credentials when using PCF Dev are:</p><pre class="programlisting">username: user
password: pass
email: user
org: pcfdev-org
space: pcfdev-space
api: api.local.pcfdev.io</pre><p>You can start the PCF dev like this:</p><pre class="programlisting">cf dev start</pre><p>You&#8217;ll have to create 3 separate spaces (email admin, pass admin)</p><pre class="programlisting">cf login -a https://api.local.pcfdev.io --skip-ssl-validation -u admin -p admin -o pcfdev-org

cf create-space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> SpaceDeveloper
cf create-space pcfdev-stage
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-stage SpaceDeveloper
cf create-space pcfdev-prod
cf <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-space-role user pcfdev-org pcfdev-prod SpaceDeveloper</pre><p>You can also execute the <code class="literal">./tools/pcfdev-helper.sh setup-spaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-cf" href="#jenkins-seed-cf"></a>6.1.4&nbsp;Run the seed job</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and `github-analytics'.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2524" href="#d0e2524"></a><p class="title"><b>Figure&nbsp;6.1.&nbsp;Click the 'jenkins-pipeline-seed' job</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2535" href="#d0e2535"></a><p class="title"><b>Figure&nbsp;6.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2546" href="#d0e2546"></a><p class="title"><b>Figure&nbsp;6.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2560" href="#d0e2560"></a><p class="title"><b>Figure&nbsp;6.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-cf" href="#jenkins-pipeline-cf"></a>6.1.5&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2590" href="#d0e2590"></a><p class="title"><b>Figure&nbsp;6.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2601" href="#d0e2601"></a><p class="title"><b>Figure&nbsp;6.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on the <span class="strong"><strong>deploy previous version to stage</strong></span> due to missing jar,
that means that you&#8217;ve forgotten to clear the tags in your repo. Typically that&#8217;s due to the fact that
you&#8217;ve removed the Artifactory volume with deployed JAR whereas a tag in the repo is still pointing there.
<a class="link" href="#">Check out this section on how to remove the tag.</a></p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2622" href="#d0e2622"></a><p class="title"><b>Figure&nbsp;6.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Most likely you will run out of memory so when reaching the stage
environment it&#8217;s good to kill all apps on test. <a class="link" href="#faq" title="4.2.1&nbsp;Can I use the pipeline for some other repos?">Check out the FAQ section for more details</a>!</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2644" href="#d0e2644"></a><p class="title"><b>Figure&nbsp;6.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-cf" href="#declarative-pipeline-cf"></a>6.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>. Here is a step by step guide to run a pipeline via
this approach.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL. E.g. for Docker Machine based setup <code class="literal"><a class="link" href="http://192.168.99.100:8080/blue" target="_top">http://192.168.99.100:8080/blue</a></code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2677" href="#d0e2677"></a><p class="title"><b>Figure&nbsp;6.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2690" href="#d0e2690"></a><p class="title"><b>Figure&nbsp;6.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2704" href="#d0e2704"></a><p class="title"><b>Figure&nbsp;6.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2717" href="#d0e2717"></a><p class="title"><b>Figure&nbsp;6.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2728" href="#d0e2728"></a><p class="title"><b>Figure&nbsp;6.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2741" href="#d0e2741"></a><p class="title"><b>Figure&nbsp;6.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e2752" href="#d0e2752"></a><p class="title"><b>Figure&nbsp;6.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting pipeline from specific stage, after failure. Please
check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently there is no way to introduce manual steps in a performant way. Jenkins is
blocking an executor when manual step is required. That means that you&#8217;ll run out of executors
pretty fast. You can check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">issue</a> for
and this <a class="link" href="http://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-cf" href="#optional-steps-cf"></a>6.3&nbsp;Jenkins Cloud Foundry customization</h2></div></div></div><pre class="literallayout"> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-cf" href="#all-env-vars-cf"></a>6.3.1&nbsp;All env vars</h3></div></div></div><p>The env vars that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for TEST env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for STAGE env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the CF Api for PROD env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>api.local.pcfdev.io</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the test env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the stage env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_ORG</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the org for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-org</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the space for the prod env</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pcfdev-space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://artifactory:8081/artifactory/libs-release-local" target="_top">http://artifactory:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JDK_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdk8</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PIPELINE_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>What should be the version of the pipeline (ultimately also version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:email@example.com" target="_top">email@example.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pivo Tal</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_HOSTNAME_UUID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Additional suffix for the route. In a shared environment the default routes can be already taken</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_STAGE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_PROD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ROLLBACK_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should rollback step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEPLOY_TO_STAGE_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deploy to stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>APP_MEMORY_LIMIT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>How much memory should be used by the infra apps (Eureka, Stub Runner etc.)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>256m</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JAVA_BUILDPACK_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to the Java buildpack to be used by CF</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="https://github.com/cloudfoundry/java-buildpack.git#v3.8.1" target="_top">https://github.com/cloudfoundry/java-buildpack.git#v3.8.1</a></p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-credentials-cf" href="#jenkins-credentials-cf"></a>6.3.2&nbsp;Jenkins Credentials</h3></div></div></div><p>In your scripts we reference the credentials via IDs. These are the defaults for credentials</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CREDENTIAL_ID</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Prod env access</p></th><th style="" align="left" valign="top"><p>cf-prod</p></th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used to tag a git repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>git</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES_CREDENTIALS_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID used for the repo with jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>repo-with-binaries</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Test env access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cf-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CREDENTIAL_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Credential ID for CF Stage env access</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cf-stage</p></td></tr></tbody></table></div><p>If you already have in your system a credential to for example tag a repo
you can use it by passing the value of the property <code class="literal">GIT_CREDENTIAL_ID</code></p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>7.&nbsp;Jenkins Pipeline (Kubernetes)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job Dsl plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github-Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>7.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins JOB Dsl based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="#jenkins-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="#jenkins-start-k8s">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="#jenkins-deploy-k8s">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="#">Start Minikube (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="#jenkins-seed-k8s" title="7.1.9&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="#jenkins-pipeline-k8s" title="7.&nbsp;Jenkins Pipeline (Kubernetes)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>7.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-k8s" href="#jenkins-fork-k8s"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-k8s" href="#start-jenkins-k8s"></a>7.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-k8s" href="#jenkins-start-k8s"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg yourDockerRegistryOrganization yourDockerRegistryUsername yourDockerRegistryPassword yourDockerRegistryEmail</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><p>You need to pass the credentials for the Docker organization (by default we will
search for the Docker images at Docker Hub) so that the pipeline will be able
to push images to your org.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-k8s" href="#deploy-infra-k8s"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-k8s" href="#jenkins-deploy-k8s"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra-k8s.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built,
uploaded to Artifactory and their docker images will be built.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your local Docker process will be reused by the Jenkins instance running
in Docker. That&#8217;s why you don&#8217;t have to push these images to Docker Hub. On the
other hand if you run this sample in a remote Kubernetes cluster the driver
will not be shared by the Jenkins workers so you can consider pushing these
Docker images to Docker Hub too.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_kubernetes_cli_installation" href="#_kubernetes_cli_installation"></a>7.1.3&nbsp;Kubernetes CLI Installation</h3></div></div></div><p>First you&#8217;ll need to install the <code class="literal">kubectl</code> CLI.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-cli-script" href="#kubernetes-cli-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">kubectl</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-kubectl</pre><p>and then the <code class="literal">kubectl</code> will get downloaded</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-manual" href="#kubernetes-cli-manual"></a>7.1.4&nbsp;Manual Installation</h3></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Example for Linux</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Check out <a class="link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_top">this page</a> for more information.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-minikube-k8s" href="#start-minikube-k8s"></a>7.1.5&nbsp;Kubernetes Cluster setup</h3></div></div></div><p>We need a cluster of Kubernetes. The best choice will be <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have Kubernetes cluster installed and don&#8217;t
want to use Minikube The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="#">clear some apps from Minikube and continue</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-script" href="#kubernetes-minikube-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">Minikube</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-minikube</pre><p>and then the <code class="literal">Minikube</code> cluster will get downloaded</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-manual" href="#kubernetes-minikube-manual"></a>Manual Installation</h4></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.</p><p>Example for Linux</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.
Check out <a class="link" href="https://github.com/kubernetes/minikube/releases" target="_top">this page</a> for more info on the installation.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_run_minikube" href="#_run_minikube"></a>7.1.6&nbsp;Run Minikube</h3></div></div></div><p>Just type in <code class="literal">minikube start</code> to start Kubernetes on your local box.</p><p>To add the dashboard just execute <code class="literal">minikube dashboard</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_certificates_and_workers" href="#_certificates_and_workers"></a>7.1.7&nbsp;Certificates and Workers</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_minikube_certificates_and_workers" href="#_minikube_certificates_and_workers"></a>Minikube Certificates and Workers</h4></div></div></div><p>By default if you install Minikube all the certificates get installed in your
<code class="literal">~/.minikube</code> folder. Your <code class="literal">kubectl</code> configuration under <code class="literal">~/.kube/config</code> will also
get updated to use Minikube.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_manual_certificates_and_workers_setup" href="#_manual_certificates_and_workers_setup"></a>Manual Certificates and Workers Setup</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you just want to run the default, demo setup you can skip this section</p></td></tr></table></div><p>To target a given Kubernetes instance one needs to pass around Certificate Authority
key and also user keys.</p><p>You can read more about the instructions on how to generate those keys <a class="link" href="https://coreos.com/kubernetes/docs/latest/openssl.html" target="_top">here</a>.
 Generally speaking if you have a Kubernetes installation (e.g. <code class="literal">minikube</code>) this step
 has already been done for you. Time to reuse those keys on the workers.</p><p>Extracted from the <a class="link" href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html" target="_top">official docs</a>.</p><p>Configure kubectl to connect to the target cluster using the following commands, replacing several values as indicated:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Replace <code class="literal">${MASTER_HOST}</code> with the master node address or name used in previous steps</li><li class="listitem">Replace <code class="literal">${CA_CERT}</code> with the absolute path to the <code class="literal">ca.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_KEY}</code> with the absolute path to the <code class="literal">admin-key.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_CERT}</code> with the absolute path to the <code class="literal">admin.pem</code> created in previous steps</li></ul></div><pre class="screen">$ kubectl config set-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config set-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config set-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_generate_minikube_namespaces" href="#_generate_minikube_namespaces"></a>7.1.8&nbsp;Generate Minikube namespaces</h3></div></div></div><p>With the running Minikube cluster we need to generate namespaces. Just execute the
<code class="literal">./tools/minikube-helper.sh setup-namespaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-k8s" href="#jenkins-seed-k8s"></a>7.1.9&nbsp;Run the seed job</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and `github-analytics'.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3471" href="#d0e3471"></a><p class="title"><b>Figure&nbsp;7.1.&nbsp;Click the 'jenkins-pipeline-seed' job</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3482" href="#d0e3482"></a><p class="title"><b>Figure&nbsp;7.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3493" href="#d0e3493"></a><p class="title"><b>Figure&nbsp;7.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3507" href="#d0e3507"></a><p class="title"><b>Figure&nbsp;7.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>7.1.10&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3537" href="#d0e3537"></a><p class="title"><b>Figure&nbsp;7.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3548" href="#d0e3548"></a><p class="title"><b>Figure&nbsp;7.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on the <span class="strong"><strong>deploy previous version to stage</strong></span> due to missing jar,
that means that you&#8217;ve forgotten to clear the tags in your repo. Typically that&#8217;s due to the fact that
you&#8217;ve removed the Artifactory volume with deployed JAR whereas a tag in the repo is still pointing there.
<a class="link" href="#">Check out this section on how to remove the tag.</a></p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3569" href="#d0e3569"></a><p class="title"><b>Figure&nbsp;7.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Most likely you will run out of memory so when reaching the stage
environment it&#8217;s good to kill all apps on test. <a class="link" href="#faq" title="4.2.1&nbsp;Can I use the pipeline for some other repos?">Check out the FAQ section for more details</a>!</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3591" href="#d0e3591"></a><p class="title"><b>Figure&nbsp;7.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-k8s" href="#declarative-pipeline-k8s"></a>7.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>. Here is a step by step guide to run a pipeline via
this approach.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL. E.g. for Docker Machine based setup <code class="literal"><a class="link" href="http://192.168.99.100:8080/blue" target="_top">http://192.168.99.100:8080/blue</a></code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3624" href="#d0e3624"></a><p class="title"><b>Figure&nbsp;7.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3637" href="#d0e3637"></a><p class="title"><b>Figure&nbsp;7.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3651" href="#d0e3651"></a><p class="title"><b>Figure&nbsp;7.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3664" href="#d0e3664"></a><p class="title"><b>Figure&nbsp;7.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3675" href="#d0e3675"></a><p class="title"><b>Figure&nbsp;7.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3688" href="#d0e3688"></a><p class="title"><b>Figure&nbsp;7.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3699" href="#d0e3699"></a><p class="title"><b>Figure&nbsp;7.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting pipeline from specific stage, after failure. Please
check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently there is no way to introduce manual steps in a performant way. Jenkins is
blocking an executor when manual step is required. That means that you&#8217;ll run out of executors
pretty fast. You can check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">issue</a> for
and this <a class="link" href="http://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-k8s" href="#optional-steps-k8s"></a>7.3&nbsp;Jenkins Kubernetes customization</h2></div></div></div><pre class="literallayout"> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-k8s" href="#all-env-vars-k8s"></a>7.3.1&nbsp;All env vars</h3></div></div></div><p>The env vars that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_ORGANIZATION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the docker organization to which Docker images should be deployed</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scpipelines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-stage</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-prod</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>KUBERNETES_MINIKUBE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Will you connect to Minikube?</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://artifactory:8081/artifactory/libs-release-local" target="_top">http://artifactory:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JDK_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdk8</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PIPELINE_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>What should be the version of the pipeline (ultimately also version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:email@example.com" target="_top">email@example.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pivo Tal</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_STAGE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_PROD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ROLLBACK_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should rollback step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEPLOY_TO_STAGE_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deploy to stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr></tbody></table></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_faq_2" href="#_faq_2"></a>8.&nbsp;FAQ</h1></div></div></div><p>Below you can find the answers to most frequently asked questions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jenkins_faq" href="#jenkins_faq"></a>8.1&nbsp;Pipeline version contains ${PIPELINE_VERSION}</h2></div></div></div><p>You can check the Jenkins logs and you&#8217;ll see</p><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre><p>To fix it you have to do exactly what the warning suggests&#8230;&#8203; Also ensure that the <code class="literal">Groovy token macro processing</code>
checkbox is set.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_version_is_not_passed_to_the_build" href="#_pipeline_version_is_not_passed_to_the_build"></a>8.2&nbsp;Pipeline version is not passed to the build</h2></div></div></div><p>You can see that the Jenkins version is properly set but in the build version is still snapshot and
the <code class="literal">echo "${PIPELINE_VERSION}"</code> doesn&#8217;t print anything.</p><p>You can check the Jenkins logs and you&#8217;ll see</p><pre class="programlisting">WARNING: Skipped parameter `PIPELINE_VERSION` as it is undefined on `jenkins-pipeline-sample-build`.
	Set `-Dhudson.model.ParametersAction.keepUndefinedParameters`=true to allow undefined parameters
	to be injected as environment variables or
	`-Dhudson.model.ParametersAction.safeParameters=[comma-separated list]`
	to whitelist specific parameter names, even though it represents a security breach</pre><p>To fix it you have to do exactly what the warning suggests&#8230;&#8203;</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_build_times_out_with_literal_pipeline_sh_literal_info" href="#_the_build_times_out_with_literal_pipeline_sh_literal_info"></a>8.3&nbsp;The build times out with <code class="literal">pipeline.sh</code> info</h2></div></div></div><p>Docker compose, docker compose, docker compose&#8230;&#8203; The problem is that for some reason, only in Docker, the execution of
Java hangs. But it hangs randomly and only the first time you try to execute the pipeline.</p><p>The solution to this is to run the pipeline again. If once it suddenly, magically passes then
it will pass for any subsequent build.</p><p>Another thing that you can try is to run it with plain Docker. Maybe that will help.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_use_the_pipeline_for_some_other_repos" href="#_can_i_use_the_pipeline_for_some_other_repos"></a>8.4&nbsp;Can I use the pipeline for some other repos?</h2></div></div></div><p>Sure! you can pass <code class="literal">REPOS</code> variable with comma separated list of
<code class="literal">project_name$project_url</code> format. If you don&#8217;t provide the PROJECT_NAME the
repo name will be extracted and used as the name of the project.</p><p>E.g. for <code class="literal">REPOS</code> equal to:</p><p><code class="literal"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook" target="_top">https://github.com/spring-cloud-samples/github-analytics,https://github.com/spring-cloud-samples/github-webhook</a></code></p><p>will result in the creation of pipelines with root names <code class="literal">github-analytics</code> and <code class="literal">github-webhook</code>.</p><p>E.g. for <code class="literal">REPOS</code> equal to:</p><p><code class="literal">foo$https://github.com/spring-cloud-samples/github-analytics,bar$https://github.com/spring-cloud-samples/atom-feed</code></p><p>will result in the creation of pipelines with root names <code class="literal">foo</code> for <code class="literal">github-analytics</code>
and <code class="literal">bar</code> for <code class="literal">github-webhook</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_will_this_work_for_any_project_out_of_the_box_2" href="#_will_this_work_for_any_project_out_of_the_box_2"></a>8.5&nbsp;Will this work for ANY project out of the box?</h2></div></div></div><p>Not really. This is an <code class="literal">opinionated pipeline</code> that&#8217;s why we took some
opinionated decisions like:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">usage of Spring Cloud, Spring Cloud Contract Stub Runner and Spring Cloud Eureka</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem"><p class="simpara">For Maven:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle (in the <code class="literal">github-analytics</code> application check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div><p>This is the initial approach that can be easily changed in the future.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_can_i_modify_this_to_reuse_in_my_project_2" href="#_can_i_modify_this_to_reuse_in_my_project_2"></a>8.6&nbsp;Can I modify this to reuse in my project?</h2></div></div></div><p>Sure! It&#8217;s open-source! The important thing is that the core part of the logic is written
in Bash scripts. That way, in the majority of cases, you could change only the bash
scripts without changing the whole pipeline.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_rollback_step_fails_due_to_missing_jar_2" href="#_the_rollback_step_fails_due_to_missing_jar_2"></a>8.7&nbsp;The rollback step fails due to missing JAR ?!</h2></div></div></div><p><a name="jenkins_tags" href="#jenkins_tags"></a> You must have pushed some tags and have removed the Artifactory volume that
contained them. To fix this, just remove the tags</p><pre class="programlisting">git tag -l | xargs -n <span class="hl-number">1</span> git push --delete origin</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_want_to_provide_a_different_jdk_version" href="#_i_want_to_provide_a_different_jdk_version"></a>8.8&nbsp;I want to provide a different JDK version</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">by default we assume that you have jdk with id <code class="literal">jdk8</code> configured</li><li class="listitem">if you want a different one just override <code class="literal">JDK_VERSION</code> env var and point to the proper one</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The docker image comes in with Java installed at <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code>.
You can go to <code class="literal">Global Tools</code> and create a JDK with <code class="literal">jdk8</code> id and JAVA_HOME
 pointing to <code class="literal">/usr/lib/jvm/java-8-openjdk-amd64</code></p></td></tr></table></div><p>To change the default one just follow these steps:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4356" href="#d0e4356"></a><p class="title"><b>Figure&nbsp;8.1.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4367" href="#d0e4367"></a><p class="title"><b>Figure&nbsp;8.2.&nbsp;Click 'Global Tool'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/global_tool.png" alt="global tool"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4378" href="#d0e4378"></a><p class="title"><b>Figure&nbsp;8.3.&nbsp;Click 'JDK Installations'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk_installation.png" alt="jdk installation"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4389" href="#d0e4389"></a><p class="title"><b>Figure&nbsp;8.4.&nbsp;Fill out JDK Installation with path to your JDK</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/jdk.png" alt="jdk"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>And that&#8217;s it!</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="groovy-token-macro" href="#groovy-token-macro"></a>8.9&nbsp;Enable Groovy Token Macro Processing</h2></div></div></div><p>With scripted that but if you needed to this manually then this is how to do it:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4409" href="#d0e4409"></a><p class="title"><b>Figure&nbsp;8.5.&nbsp;Click 'Manage Jenkins'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/manage_jenkins.png" alt="manage jenkins"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4420" href="#d0e4420"></a><p class="title"><b>Figure&nbsp;8.6.&nbsp;Click 'Configure System'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/configure_system.png" alt="configure system"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e4431" href="#d0e4431"></a><p class="title"><b>Figure&nbsp;8.7.&nbsp;Click 'Allow token macro processing'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/groovy_token.png" alt="groovy token"></div></div></div><br class="figure-break"><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_i_want_deployment_to_stage_and_prod_be_automatic" href="#_i_want_deployment_to_stage_and_prod_be_automatic"></a>8.9.1&nbsp;I want deployment to stage and prod be automatic</h3></div></div></div><p>No problem, just set the property / env var to true</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_STAGE</code> to automatically deploy to stage</li><li class="listitem"><code class="literal">AUTO_DEPLOY_TO_PROD</code> to automatically deploy to prod</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_can_t_tag_the_repo" href="#_i_can_t_tag_the_repo"></a>8.10&nbsp;I can&#8217;t tag the repo!</h2></div></div></div><p>When you get sth like this:</p><pre class="programlisting"><span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> stderr: remote: Invalid username or password.
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> fatal: Authentication failed <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'https://github.com/marcingrzejszczak/github-webhook/'</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span>
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:<span class="hl-number">1740</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandWithCredentials(CliGitAPIImpl.java:<span class="hl-number">1476</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.access$<span class="hl-number">300</span>(CliGitAPIImpl.java:<span class="hl-number">63</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl$<span class="hl-number">8.</span>execute(CliGitAPIImpl.java:<span class="hl-number">1816</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.plugins.git.GitPublisher.perform(GitPublisher.java:<span class="hl-number">295</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.tasks.BuildStepMonitor$<span class="hl-number">3.</span>perform(BuildStepMonitor.java:<span class="hl-number">45</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.perform(AbstractBuild.java:<span class="hl-number">779</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.performAllBuildSteps(AbstractBuild.java:<span class="hl-number">720</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Build$BuildExecution.post2(Build.java:<span class="hl-number">185</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.AbstractBuild$AbstractBuildExecution.post(AbstractBuild.java:<span class="hl-number">665</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Run.execute(Run.java:<span class="hl-number">1745</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:<span class="hl-number">43</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.ResourceController.execute(ResourceController.java:<span class="hl-number">98</span>)
<span class="hl-number">19</span>:<span class="hl-number">01</span>:<span class="hl-number">44</span> 	at hudson.model.Executor.run(Executor.java:<span class="hl-number">404</span>)</pre><p>most likely you&#8217;ve passed a wrong password. Check the <a class="link" href="#">credentials</a> section
on how to update your credentials.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_m_unauthorized_to_deploy_infrastructure_jars_2" href="#_i_m_unauthorized_to_deploy_infrastructure_jars_2"></a>8.11&nbsp;I&#8217;m unauthorized to deploy infrastructure jars</h2></div></div></div><p>Most likely you&#8217;ve forgotten to update your local <code class="literal">settings.xml</code> with the Artifactory&#8217;s
setup. Check out <a class="link" href="#">this section of the docs and update your <code class="literal">settings.xml</code></a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_signing_artifacts" href="#_signing_artifacts"></a>8.12&nbsp;Signing Artifacts</h2></div></div></div><p>In some cases it may be required that when performing a release that the artifacts be signed
before pushing them to the repository.
To do this you will need to import your GPG keys into the Docker image running Jenkins.
This can be done by placing a file called <code class="literal">public.key</code> containing your public key
and a file called <code class="literal">private.key</code> containing your private key in the <code class="literal">seed</code> directory.
These keys will be imported by the <code class="literal">init.groovy</code> script that is run when Jenkins starts.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_i_ran_out_of_resources_cloud_foundry" href="#_i_ran_out_of_resources_cloud_foundry"></a>8.13&nbsp;I ran out of resources!! (Cloud Foundry)</h2></div></div></div><p>[jenkins-cf-resources]] When deploying the app to stage or prod you can get an exception <code class="literal">Insufficient resources</code>. The way to
 solve it is to kill some apps from test / stage env. To achieve that just call</p><pre class="programlisting">cf target -o pcfdev-org -s pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
cf stop github-webhook
cf stop github-eureka
cf stop stubrunner</pre><p>You can also execute <code class="literal">./tools/pcfdev-helper.sh kill-all-apps</code> that will remove all demo-related apps
deployed to PCF dev.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry" href="#_deploying_to_test_stage_prod_fails_error_finding_space_cloud_foundry"></a>8.14&nbsp;Deploying to test / stage / prod fails - error finding space (Cloud Foundry)</h2></div></div></div><p>If you receive a similar exception:</p><pre class="programlisting"><span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> API endpoint:   https://api.local.pcfdev.io (API version: <span class="hl-number">2.58</span>.<span class="hl-number">0</span>)
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> User:           user
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Org:            pcfdev-org
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space:          No space targeted, use <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'cf target -s SPACE'</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> FAILED
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Error finding space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
<span class="hl-number">20</span>:<span class="hl-number">26</span>:<span class="hl-number">18</span> Space pcfdev-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span> not found</pre><p>It means that you&#8217;ve forgotten to <a class="link" href="#">create the spaces</a> in your PCF Dev installation.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_the_route_is_already_in_use_cloud_foundry" href="#_the_route_is_already_in_use_cloud_foundry"></a>8.15&nbsp;The route is already in use (Cloud Foundry)</h2></div></div></div><p>If you play around with Jenkins / Concourse you might end up with the routes occupied</p><pre class="programlisting">Using route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io
Binding github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io to github-webhook...
FAILED
The route github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>.local.pcfdev.io is already in use.</pre><p>Just delete the routes</p><pre class="programlisting">yes | cf delete-route local.pcfdev.io -n github-webhook-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-eureka-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n stubrunner-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>
yes | cf delete-route local.pcfdev.io -n github-webhook-stage
yes | cf delete-route local.pcfdev.io -n github-eureka-stage
yes | cf delete-route local.pcfdev.io -n github-webhook-prod
yes | cf delete-route local.pcfdev.io -n github-eureka-prod</pre><p>You can also execute the <code class="literal">./tools/pcfdev-helper.sh delete-routes</code></p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_demo_setup_cloud_foundry" href="#_the_demo_setup_cloud_foundry"></a>9.&nbsp;The demo setup (Cloud Foundry)</h1></div></div></div><p><a class="link" href="https://github.com/spring-cloud-samples/github-webhook/" target="_top">Github webhook code</a></p><p><a class="link" href="https://github.com/spring-cloud-samples/github-analytics/" target="_top">Github analytics code</a></p><div class="figure"><a name="d0e4549" href="#d0e4549"></a><p class="title"><b>Figure&nbsp;9.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e4577" href="#d0e4577"></a><p class="title"><b>Figure&nbsp;9.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e4592" href="#d0e4592"></a><p class="title"><b>Figure&nbsp;9.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_pcf_dev" href="#_deploying_production_applications_to_pcf_dev"></a>9.1&nbsp;Deploying production applications to PCF Dev</h2></div></div></div><p>In the real world scenario we wouldn&#8217;t want to automatically provision services like
RabbitMQ, MySQL or Eureka each time we deploy a new application to production. Typically
production is provisioned manually (using automated solutions). In our case, before
you deploy to production you can provision the <code class="literal">pcfdev-prod</code> space using the
 <code class="literal">pcfdev-helper.sh</code>. Just call</p><pre class="programlisting">$ ./pcfdev-helper.sh setup-prod-infra</pre><p>What will happen is that the CF CLI will login to PCF Dev, target <code class="literal">pcfdev-prod</code> space,
setup RabbitMQ (under <code class="literal">rabbitmq-github</code> name), MySQL (under <code class="literal">mysql-github-analytics</code> name)
and Eureka (under <code class="literal">github-eureka</code> name).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_cf" href="#_running_prometheus_on_cf"></a>9.2&nbsp;Running Prometheus on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/prometheus-on-PCF" target="_top">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p><p>Go to <a class="link" href="https://prometheus.io/download/" target="_top">https://prometheus.io/download/</a> and download linux binary. Then call:</p><pre class="screen">cf push sc-pipelines-prometheus -b binary_buildpack -c './prometheus -web.listen-address=:8080' -m 64m</pre><p>Also <code class="literal">localhost:9090</code> in <code class="literal">prometheus.yml</code> should be <code class="literal">localhost:8080</code>.</p><p>The file should look like this to work with the demo setup (change <code class="literal">github-analytics-sc-pipelines.cfapps.io</code>
to your <code class="literal">github-analytics</code> installation).</p><pre class="programlisting"># my global config
global:
  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
      monitor: 'codelab-monitor'

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first.rules"
  # - "second.rules"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:8080']

  - job_name: 'demo-app'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    metrics_path: '/prometheus'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['github-analytics-sc-pipelines.cfapps.io']</pre><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-prometheus.cfapps.io/" target="_top">here</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_cf" href="#_running_grafana_on_cf"></a>9.3&nbsp;Running Grafana on CF</h2></div></div></div><p>You can check out <a class="link" href="https://github.com/making/cf-grafana" target="_top">Toshiaki Maki&#8217;s code</a> on how to automate Prometheus installation on CF.</p><p>Download tarball from <a class="link" href="https://grafana.com/grafana/download?platform=linux" target="_top">https://grafana.com/grafana/download?platform=linux</a>
Next set <code class="literal">http_port = 8080</code> in <code class="literal">conf/default.ini</code>. Then call</p><pre class="screen">cf push sc-pipelines-grafana -b binary_buildpack -c './bin/grafana-server web' -m 64m</pre><p>The demo is using Grafana Dashboard with ID <code class="literal">2471</code>.</p><p>A deployed version for the Spring Cloud Pipelines demo is available <a class="link" href="https://sc-pipelines-grafana.cfapps.io/" target="_top">here</a></p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_demo_setup_kubernetes" href="#_the_demo_setup_kubernetes"></a>10.&nbsp;The demo setup (Kubernetes)</h1></div></div></div><p><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes/" target="_top">Github webhook code</a></p><p><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github analytics code</a></p><div class="figure"><a name="d0e4711" href="#d0e4711"></a><p class="title"><b>Figure&nbsp;10.1.&nbsp;Github Webhook listens to HTTP calls and sends a message to Github Analytics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo.png" alt="demo"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>For the demo scenario we have two applications. <code class="literal">Github Analytics</code> and <code class="literal">Github Webhook</code>.
Let&#8217;s imagine a case where Github is emitting events via HTTP. <code class="literal">Github Webhook</code> has
an API that could register to such hooks and receive those messages. Once this happens
 <code class="literal">Github Webhook</code> sends a message by RabbitMQ to a channel. <code class="literal">Github Analytics</code> is
 listening to those messages and stores them in a MySQL database.</p><div class="figure"><a name="d0e4739" href="#d0e4739"></a><p class="title"><b>Figure&nbsp;10.2.&nbsp;Github Analytics exposes metrics that are polled by Prometheus</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_metrics.png" alt="demo metrics"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p><code class="literal">Github Analytics</code> has its KPIs (Key Performance Indicators) monitored. In the case
of that application the KPI is number of issues.</p><div class="figure"><a name="d0e4754" href="#d0e4754"></a><p class="title"><b>Figure&nbsp;10.3.&nbsp;Grafana alerts Slack over Prometheus metrics</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/demo/demo_alerting.png" alt="demo alerting"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><p>Let&#8217;s assume that if we go below the threshold of X issues then an alert should be
sent to Slack.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_deploying_production_applications_to_minikube" href="#_deploying_production_applications_to_minikube"></a>10.1&nbsp;Deploying production applications to Minikube</h2></div></div></div><p>In the real world scenario we wouldn&#8217;t want to automatically provision services like
RabbitMQ, MySQL or Eureka each time we deploy a new application to production. Typically
production is provisioned manually (using automated solutions). In our case, before
you deploy to production you can provision the <code class="literal">sc-pipelines-prod</code> namespace using the
 <code class="literal">minikube-helper.sh</code>. Just call</p><pre class="programlisting">$ ./minikube-helper.sh setup-prod-infra</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_prometheus_on_kubernetes" href="#_running_prometheus_on_kubernetes"></a>10.2&nbsp;Running Prometheus on Kubernetes</h2></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_running_grafana_on_kubernetes" href="#_running_grafana_on_kubernetes"></a>10.3&nbsp;Running Grafana on Kubernetes</h2></div></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_building_the_project" href="#_building_the_project"></a>11.&nbsp;Building the project</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_prerequisites" href="#_prerequisites"></a>11.1&nbsp;Prerequisites</h2></div></div></div><p>As prerequisites you need to have <a class="link" href="http://www.shellcheck.net/" target="_top">shellcheck</a>,
<a class="link" href="https://github.com/sstephenson/bats" target="_top">bats</a>, <a class="link" href="https://stedolan.github.io/jq/" target="_top">jq</a>
 and <a class="link" href="https://rubyinstaller.org/downloads/" target="_top">ruby</a> installed. If you&#8217;re on a Linux
 machine then <code class="literal">bats</code> and <code class="literal">shellcheck</code> will be installed for you.</p><p>To install the required software on Linux just type the following commands</p><pre class="programlisting">$ sudo apt-get install -y ruby jq</pre><p>If you&#8217;re on a Mac then just execute these commands to install the missing software</p><pre class="programlisting">$ brew install jq
$ brew install ruby
$ brew install bats
$ brew install shellcheck</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_bats_submodules" href="#_bats_submodules"></a>11.2&nbsp;Bats submodules</h2></div></div></div><p>To make <code class="literal">bats</code> work properly we needed to attach Git submodules. To have them
initialized either clone with appropriate command</p><pre class="programlisting">$ git clone --recursive https://github.com/spring-cloud/spring-cloud-pipelines.git</pre><p>or if you have already cloned the project and are just pulling changes</p><pre class="programlisting">$ git submodule init
$ git submodule update</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_build_and_test" href="#_build_and_test"></a>11.3&nbsp;Build and test</h2></div></div></div><p>Once you have installed all the prerequisites you can execute</p><pre class="programlisting">./gradlew clean build</pre><p>to build and test the project.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_generate_readme" href="#_generate_readme"></a>11.4&nbsp;Generate readme</h2></div></div></div><p>To generate readme just run</p><pre class="programlisting">./gradlew generateDocs</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_releasing_the_project" href="#_releasing_the_project"></a>12.&nbsp;Releasing the project</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_publishing_a_docker_image" href="#_publishing_a_docker_image"></a>12.1&nbsp;Publishing A Docker Image</h2></div></div></div><p>When doing a release you also need to push a Docker image to Dockerhub.
From the project root, run the following commands replacing <code class="literal">&lt;version&gt;</code> with the
version of the release.</p><pre class="programlisting">docker login
docker build -t springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt; ./jenkins
docker push springcloud/spring-cloud-pipeline-jenkins:&lt;version&gt;</pre></div></div></div></body></html>