<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>7.&nbsp;Jenkins Pipeline (Kubernetes)</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="up" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="prev" href="multi_jenkins-pipeline-cf.html" title="6.&nbsp;Jenkins Pipeline (Cloud Foundry)"><link rel="next" href="multi__faq_2.html" title="8.&nbsp;FAQ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.&nbsp;Jenkins Pipeline (Kubernetes)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi_jenkins-pipeline-cf.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__faq_2.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>7.&nbsp;Jenkins Pipeline (Kubernetes)</h1></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter we assume that you perform deployment of your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="jenkins" href="#jenkins"></a> The Spring Cloud Pipelines repository contains job definitions and the opinionated setup pipeline using <a class="link" href="https://wiki.jenkins-ci.org/display/JENKINS/Job+DSL+Plugin" target="_top">Jenkins Job Dsl plugin</a>. Those jobs will form an empty pipeline and a sample, opinionated one that you can use in your company.</p><p>All in all there are the following projects taking part in the whole <code class="literal">microservice setup</code> for this demo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github-Analytics</a> - the app that has a REST endpoint and uses messaging. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a> - project that emits messages that are used by Github Analytics. Our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a> - simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a> - Stub Runner Boot server to be used for tests with Github Analytics. Uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>7.1&nbsp;Step by step</h2></div></div></div><p>This is a guide for Jenkins JOB Dsl based pipeline.</p><p>If you want to just run the demo as far as possible using PCF Dev and Docker Compose</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="multi_jenkins-pipeline-k8s.html#jenkins-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="multi_jenkins-pipeline-k8s.html#jenkins-start-k8s">Start Jenkins and Artifactory</a></li><li class="listitem"><a class="link" href="multi_jenkins-pipeline-k8s.html#jenkins-deploy-k8s">Deploy infra to Artifactory</a></li><li class="listitem"><a class="link" href="">Start Minikube (if you don&#8217;t want to use an existing one)</a></li><li class="listitem"><a class="link" href="multi_jenkins-pipeline-k8s.html#jenkins-seed-k8s" title="7.1.9&nbsp;Run the seed job">Run the seed job</a></li><li class="listitem"><a class="link" href="multi_jenkins-pipeline-k8s.html" title="7.&nbsp;Jenkins Pipeline (Kubernetes)">Run the <code class="literal">github-webhook</code> pipeline</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>7.1.1&nbsp;Fork repos</h3></div></div></div><p><a name="jenkins-fork-k8s" href="#jenkins-fork-k8s"></a> There are 4 apps that are composing the pipeline</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only these. That&#8217;s because only then will your user be able to tag and push the tag to repo.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-jenkins-k8s" href="#start-jenkins-k8s"></a>7.1.2&nbsp;Start Jenkins and Artifactory</h3></div></div></div><p><a name="jenkins-start-k8s" href="#jenkins-start-k8s"></a> Jenkins + Artifactory can be ran locally. To do that just execute the
<code class="literal">start.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/jenkins
./start.sh yourGitUsername yourGitPassword yourForkedGithubOrg yourDockerRegistryOrganization yourDockerRegistryUsername yourDockerRegistryPassword yourDockerRegistryEmail</pre><p>Then Jenkins will be running on port <code class="literal">8080</code> and Artifactory <code class="literal">8081</code>.
The provided parameters will be passed as env variables to Jenkins VM
and credentials will be set in your set. That way you don&#8217;t have to do
any manual work on the Jenkins side. In the above parameters, the third parameter
could be yourForkedGithubOrg or yourGithubUsername. Also the <code class="literal">REPOS</code> env variable will
contain your GitHub org in which you have the forked repos.</p><p>You need to pass the credentials for the Docker organization (by default we will
search for the Docker images at Docker Hub) so that the pipeline will be able
to push images to your org.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="deploy-infra-k8s" href="#deploy-infra-k8s"></a>Deploy the infra JARs to Artifactory</h4></div></div></div><p><a name="jenkins-deploy-k8s" href="#jenkins-deploy-k8s"></a> When Artifactory is running, just execute the <code class="literal">tools/deploy-infra.sh</code> script from this repo.</p><pre class="programlisting">git clone https://github.com/spring-cloud/spring-cloud-pipelines
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> spring-cloud-pipelines/
./tools/deploy-infra-k8s.sh</pre><p>As a result both <code class="literal">eureka</code> and <code class="literal">stub runner</code> repos will be cloned, built,
uploaded to Artifactory and their docker images will be built.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Your local Docker process will be reused by the Jenkins instance running
in Docker. That&#8217;s why you don&#8217;t have to push these images to Docker Hub. On the
other hand if you run this sample in a remote Kubernetes cluster the driver
will not be shared by the Jenkins workers so you can consider pushing these
Docker images to Docker Hub too.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_kubernetes_cli_installation" href="#_kubernetes_cli_installation"></a>7.1.3&nbsp;Kubernetes CLI Installation</h3></div></div></div><p>First you&#8217;ll need to install the <code class="literal">kubectl</code> CLI.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-cli-script" href="#kubernetes-cli-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">kubectl</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-kubectl</pre><p>and then the <code class="literal">kubectl</code> will get downloaded</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kubernetes-cli-manual" href="#kubernetes-cli-manual"></a>7.1.4&nbsp;Manual Installation</h3></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Example for Linux</p><pre class="programlisting">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl</pre><p>Check out <a class="link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_top">this page</a> for more information.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="start-minikube-k8s" href="#start-minikube-k8s"></a>7.1.5&nbsp;Kubernetes Cluster setup</h3></div></div></div><p>We need a cluster of Kubernetes. The best choice will be <a class="link" href="https://github.com/kubernetes/minikube" target="_top">Minikube</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can skip this step if you have Kubernetes cluster installed and don&#8217;t
want to use Minikube The only thing you have to do is to set up spaces.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>It&#8217;s more than likely that you&#8217;ll run out of resources when you reach stage step.
Don&#8217;t worry! Keep calm and <a class="link" href="">clear some apps from Minikube and continue</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-script" href="#kubernetes-minikube-script"></a>Script Installation</h4></div></div></div><p>You can use the <code class="literal">tools/minikube-helper.sh</code> script to install <code class="literal">Minikube</code>. Just call</p><pre class="programlisting">$ ./tools/minikube-helper download-minikube</pre><p>and then the <code class="literal">Minikube</code> cluster will get downloaded</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="kubernetes-minikube-manual" href="#kubernetes-minikube-manual"></a>Manual Installation</h4></div></div></div><p>Example for OSX</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.</p><p>Example for Linux</p><pre class="programlisting">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.<span class="hl-number">20.0</span>/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</pre><p>Feel free to leave off the <code class="literal">sudo mv minikube /usr/local/bin</code> if you would like to add minikube to your path manually.
Check out <a class="link" href="https://github.com/kubernetes/minikube/releases" target="_top">this page</a> for more info on the installation.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_run_minikube" href="#_run_minikube"></a>7.1.6&nbsp;Run Minikube</h3></div></div></div><p>Just type in <code class="literal">minikube start</code> to start Kubernetes on your local box.</p><p>To add the dashboard just execute <code class="literal">minikube dashboard</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_certificates_and_workers" href="#_certificates_and_workers"></a>7.1.7&nbsp;Certificates and Workers</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_minikube_certificates_and_workers" href="#_minikube_certificates_and_workers"></a>Minikube Certificates and Workers</h4></div></div></div><p>By default if you install Minikube all the certificates get installed in your
<code class="literal">~/.minikube</code> folder. Your <code class="literal">kubectl</code> configuration under <code class="literal">~/.kube/config</code> will also
get updated to use Minikube.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_manual_certificates_and_workers_setup" href="#_manual_certificates_and_workers_setup"></a>Manual Certificates and Workers Setup</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If you just want to run the default, demo setup you can skip this section</p></td></tr></table></div><p>To target a given Kubernetes instance one needs to pass around Certificate Authority
key and also user keys.</p><p>You can read more about the instructions on how to generate those keys <a class="link" href="https://coreos.com/kubernetes/docs/latest/openssl.html" target="_top">here</a>.
 Generally speaking if you have a Kubernetes installation (e.g. <code class="literal">minikube</code>) this step
 has already been done for you. Time to reuse those keys on the workers.</p><p>Extracted from the <a class="link" href="https://coreos.com/kubernetes/docs/latest/configure-kubectl.html" target="_top">official docs</a>.</p><p>Configure kubectl to connect to the target cluster using the following commands, replacing several values as indicated:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Replace <code class="literal">${MASTER_HOST}</code> with the master node address or name used in previous steps</li><li class="listitem">Replace <code class="literal">${CA_CERT}</code> with the absolute path to the <code class="literal">ca.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_KEY}</code> with the absolute path to the <code class="literal">admin-key.pem</code> created in previous steps</li><li class="listitem">Replace <code class="literal">${ADMIN_CERT}</code> with the absolute path to the <code class="literal">admin.pem</code> created in previous steps</li></ul></div><pre class="screen">$ kubectl config set-cluster default-cluster --server=https://${MASTER_HOST} --certificate-authority=${CA_CERT}
$ kubectl config set-credentials default-admin --certificate-authority=${CA_CERT} --client-key=${ADMIN_KEY} --client-certificate=${ADMIN_CERT}
$ kubectl config set-context default-system --cluster=default-cluster --user=default-admin
$ kubectl config use-context default-system</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_generate_minikube_namespaces" href="#_generate_minikube_namespaces"></a>7.1.8&nbsp;Generate Minikube namespaces</h3></div></div></div><p>With the running Minikube cluster we need to generate namespaces. Just execute the
<code class="literal">./tools/minikube-helper.sh setup-namespaces</code> to do this.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-seed-k8s" href="#jenkins-seed-k8s"></a>7.1.9&nbsp;Run the seed job</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and `github-analytics'.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3471" href="#d0e3471"></a><p class="title"><b>Figure&nbsp;7.1.&nbsp;Click the 'jenkins-pipeline-seed' job</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_click.png" alt="seed click"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3482" href="#d0e3482"></a><p class="title"><b>Figure&nbsp;7.2.&nbsp;Click the 'Build with parameters'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_run.png" alt="seed run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3493" href="#d0e3493"></a><p class="title"><b>Figure&nbsp;7.3.&nbsp;The <code class="literal">REPOS</code> parameter should already contain your forked repos (you&#8217;ll have more properties than the ones in the screenshot)</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed.png" alt="seed"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3507" href="#d0e3507"></a><p class="title"><b>Figure&nbsp;7.4.&nbsp;This is how the results of seed should look like</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_built.png" alt="seed built"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jenkins-pipeline-k8s" href="#jenkins-pipeline-k8s"></a>7.1.10&nbsp;Run the <code class="literal">github-webhook</code> pipeline</h3></div></div></div><p>We already create the seed job for you but you&#8217;ll have to run it. When you do
run it you have to provide some properties. By default we create a seed that
has all the properties options, but you can delete most of it. If you
set the properties as global env variables you have to remove them from the
seed.</p><p>Anyways, to run the demo just provide in the <code class="literal">REPOS</code> var the comma separated
 list of URLs of the 2 aforementioned forks of <code class="literal">github-webhook</code> and <code class="literal">github-analytics</code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3537" href="#d0e3537"></a><p class="title"><b>Figure&nbsp;7.5.&nbsp;Click the 'github-webhook' view</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/seed_views.png" alt="seed views"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3548" href="#d0e3548"></a><p class="title"><b>Figure&nbsp;7.6.&nbsp;Run the pipeline</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_run.png" alt="pipeline run"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>If your build fails on the <span class="strong"><strong>deploy previous version to stage</strong></span> due to missing jar,
that means that you&#8217;ve forgotten to clear the tags in your repo. Typically that&#8217;s due to the fact that
you&#8217;ve removed the Artifactory volume with deployed JAR whereas a tag in the repo is still pointing there.
<a class="link" href="">Check out this section on how to remove the tag.</a></p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3569" href="#d0e3569"></a><p class="title"><b>Figure&nbsp;7.7.&nbsp;Click the manual step to go to stage (remember about killing the apps on test env). To do this click the <span class="strong">ARROW</span> next to the job name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_manual.png" alt="pipeline manual"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Most likely you will run out of memory so when reaching the stage
environment it&#8217;s good to kill all apps on test. <a class="link" href="multi_concourse.html#faq" title="4.2.1&nbsp;Can I use the pipeline for some other repos?">Check out the FAQ section for more details</a>!</p></td></tr></table></div><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3591" href="#d0e3591"></a><p class="title"><b>Figure&nbsp;7.8.&nbsp;The full pipeline should look like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/pipeline_finished.png" alt="pipeline finished"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declarative-pipeline-k8s" href="#declarative-pipeline-k8s"></a>7.2&nbsp;Declarative pipeline &amp; Blue Ocean</h2></div></div></div><p>You can also use the <a class="link" href="https://jenkins.io/doc/book/pipeline/syntax/" target="_top">declarative pipeline</a> approach with the
<a class="link" href="https://jenkins.io/projects/blueocean/" target="_top">Blue Ocean UI</a>. Here is a step by step guide to run a pipeline via
this approach.</p><p>The Blue Ocean UI is available under the <code class="literal">blue/</code> URL. E.g. for Docker Machine based setup <code class="literal"><a class="link" href="http://192.168.99.100:8080/blue" target="_top">http://192.168.99.100:8080/blue</a></code>.</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3624" href="#d0e3624"></a><p class="title"><b>Figure&nbsp;7.9.&nbsp;Open Blue Ocean UI and click on <code class="literal">github-webhook-declarative-pipeline</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_1.png" alt="blue 1"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3637" href="#d0e3637"></a><p class="title"><b>Figure&nbsp;7.10.&nbsp;Your first run will look like this. Click <code class="literal">Run</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_2.png" alt="blue 2"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3651" href="#d0e3651"></a><p class="title"><b>Figure&nbsp;7.11.&nbsp;Enter parameters required for the build and click <code class="literal">run</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_3.png" alt="blue 3"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3664" href="#d0e3664"></a><p class="title"><b>Figure&nbsp;7.12.&nbsp;A list of pipelines will be shown. Click your first run.</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_4.png" alt="blue 4"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3675" href="#d0e3675"></a><p class="title"><b>Figure&nbsp;7.13.&nbsp;State if you want to go to production or not and click <code class="literal">Proceed</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_5.png" alt="blue 5"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3688" href="#d0e3688"></a><p class="title"><b>Figure&nbsp;7.14.&nbsp;The build is in progress&#8230;&#8203;</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_6.png" alt="blue 6"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e3699" href="#d0e3699"></a><p class="title"><b>Figure&nbsp;7.15.&nbsp;The pipeline is done!</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/jenkins/blue_7.png" alt="blue 7"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>There is no possibility of restarting pipeline from specific stage, after failure. Please
check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-33846" target="_top">issue</a> for more information</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Currently there is no way to introduce manual steps in a performant way. Jenkins is
blocking an executor when manual step is required. That means that you&#8217;ll run out of executors
pretty fast. You can check out this <a class="link" href="https://issues.jenkins-ci.org/browse/JENKINS-36235" target="_top">issue</a> for
and this <a class="link" href="http://stackoverflow.com/questions/42561241/how-to-wait-for-user-input-in-a-declarative-pipeline-without-blocking-a-heavywei" target="_top">StackOverflow question</a>
for more information.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="optional-steps-k8s" href="#optional-steps-k8s"></a>7.3&nbsp;Jenkins Kubernetes customization</h2></div></div></div><pre class="literallayout"> All the steps below are not necessary to run the demo. They are needed only
when you want to do some custom changes.</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="all-env-vars-k8s" href="#all-env-vars-k8s"></a>7.3.1&nbsp;All env vars</h3></div></div></div><p>The env vars that are used in all of the jobs are as follows:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default value</th></tr></thead><tfoot><tr><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>BUILD_OPTIONS</p></th><th style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Additional options you would like to pass to the Maven / Gradle build</p></th><th style="" align="left" valign="top">&nbsp;</th></tr></tfoot><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DOCKER_REGISTRY_ORGANIZATION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the docker organization to which Docker images should be deployed</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scpipelines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_API_URL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL of the API of the Kubernetes cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>192.168.99.100:8443</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CA</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the certificate authority for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/ca.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_CERT</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client certificate for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.crt</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLIENT_KEY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to the client key for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>/usr/share/jenkins/cert/apiserver.key</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the cluster for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_CLUSTER_USERNAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the user for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_SYSTEM_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the system for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>minikube</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_TEST_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for test environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-test</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_STAGE_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for stage environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-stage</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAAS_PROD_NAMESPACE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Namespace for prod environment</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>sc-pipelines-prod</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>KUBERNETES_MINIKUBE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Will you connect to Minikube?</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REPO_WITH_BINARIES</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>URL to repo with the deployed jars</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="http://artifactory:8081/artifactory/libs-release-local" target="_top">http://artifactory:8081/artifactory/libs-release-local</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>M2_SETTINGS_REPO_ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The id of server from Maven settings.xml</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>artifactory-local</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JDK_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the JDK installation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdk8</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PIPELINE_VERSION</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>What should be the version of the pipeline (ultimately also version of the jar)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.0.0.M1-${GROOVY,script ="new Date().format('yyMMdd_HHmmss')"}-VERSION</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_EMAIL</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The email used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="mailto:email@example.com" target="_top">email@example.com</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GIT_NAME</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name used by Git to tag repo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Pivo Tal</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_STAGE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to stage be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AUTO_DEPLOY_TO_PROD</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deployment to prod be automatic</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ROLLBACK_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should rollback step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEPLOY_TO_STAGE_STEP_REQUIRED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Should deploy to stage step be present</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td></tr></tbody></table></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi_jenkins-pipeline-cf.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__faq_2.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6.&nbsp;Jenkins Pipeline (Cloud Foundry)&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-pipelines.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;8.&nbsp;FAQ</td></tr></table></div></body></html>