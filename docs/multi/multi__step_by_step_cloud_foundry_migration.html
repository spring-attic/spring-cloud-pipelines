<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>6.&nbsp;Step-by-step Cloud Foundry Migration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="up" href="multi__spring_cloud_pipelines.html" title="Part&nbsp;I.&nbsp;Spring Cloud Pipelines"><link rel="prev" href="multi__customizing_the_project.html" title="5.&nbsp;Customizing the Project"><link rel="next" href="multi_concourse-pipeline-cf.html" title="7.&nbsp;Concourse Pipeline (Cloud Foundry)"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.&nbsp;Step-by-step Cloud Foundry Migration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi__customizing_the_project.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;I.&nbsp;Spring Cloud Pipelines</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi_concourse-pipeline-cf.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_step_by_step_cloud_foundry_migration" href="#_step_by_step_cloud_foundry_migration"></a>6.&nbsp;Step-by-step Cloud Foundry Migration</h2></div></div></div><p>This section details how to migrate applications such that they become compatible with  Spring Cloud Pipelines.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_preview" href="#_preview"></a>6.1&nbsp;Preview</h2></div></div></div><p><a class="link" href="https://docs.google.com/presentation/d/e/2PACX-1vSsEHn8cJfz8oWIwwUhdULt7nZzz3bBLK7OqM8UInkZ0LbQBCpPdhMoxsYGPe_90h9OvCu7dFlAimMJ/pub?start=false&amp;loop=false&amp;delayms=3000" target="_top">Click here</a> to
check out the slides by <a class="link" href="https://twitter.com/ciberkleid" target="_top">Cora Iberkleid</a> where she
migrates a set of applications to be compliant with Spring Cloud Pipelines.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_introduction_2" href="#_introduction_2"></a>6.2&nbsp;Introduction</h2></div></div></div><p>This tutorial covers refactoring applications to be compatible with, and take advantage of, Spring Cloud Pipelines.</p><p>As an example, we use a simple three-tier application, shown in the following image:</p><div class="figure"><a name="d0e2074" href="#d0e2074"></a><p class="title"><b>Figure&nbsp;6.1.&nbsp;Use Case - Logical View</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_logical.png" alt="use case logical"></div></div></div><br class="figure-break"><p>At the end of this tutorial, you will be able to quickly create a Concourse pipeline for each application and run successfully through a full lifecycle, from source code commit to production deployment, following the lifecycle stages for testing and deployment recommended by Spring Cloud Pipelines. You will be able to improve application code bases with organized test coverage, a contract-based API, and a versioned database schema, letting Spring Cloud Pipelines carry out stubbed testing and ensure backward compatibility for API and database schema changes.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_initial_state" href="#_sample_application_initial_state"></a>6.3&nbsp;Sample Application&#8201;&#8212;&#8201;Initial State</h2></div></div></div><p>The sample application is implemented by using Spring Boot applications for the UI and service tiers and MySQL for the database.</p><p>The apps are built with Maven and manually pushed to Cloud Foundry. They leverage the three Pivotal Spring Cloud Services: Config Server, Service Discovery, and Circuit Breaker Dashboard. We use Rabbit to propagate Config Server refresh triggers.</p><p>The source code for the two Spring Boot applications is stored on GitHub, as is the backing repo for Config Server.</p><p>The following image shows an implementation view of the applications and their ancillary services:</p><div class="figure"><a name="d0e2096" href="#d0e2096"></a><p class="title"><b>Figure&nbsp;6.2.&nbsp;Use Case - Implementation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/use_case_implementation.png" alt="use case implementation"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_application_end_state" href="#_sample_application_end_state"></a>6.4&nbsp;Sample Application&#8201;&#8212;&#8201;End State</h2></div></div></div><p>Throughout this tutorial, we add Concourse and JFrog Bintray to manage the application lifecycle.</p><p>We also refactor the applications so that they become compatible with Spring Cloud Pipelines requirements and recommendations, including adding and organizing tests and introducing database versioning by using Flyway and introducing API contracts by using Spring Cloud Contract.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_toolset" href="#_tutorial_toolset"></a>6.5&nbsp;Tutorial&#8201;&#8212;&#8201;Toolset</h2></div></div></div><p>Throughout this tutorial, we use the following tools:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><span class="strong"><strong>GitHub</strong></span>: Sample application source code and configuration repositories, a sample stubrunner application repository, and the Spring Cloud Pipelines code base, including the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top"><code class="literal">greeting-ui</code></a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top"><code class="literal">fortune-service</code></a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">`app-confi`g</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top"><code class="literal">cloudfoundry-stub-runner-boot</code></a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top"><code class="literal">spring-cloud-pipelines</code></a></li></ul></div></li><li class="listitem"><span class="strong"><strong>Pivotal Web Services</strong></span>: Publicly hosted Cloud Foundry offering <a class="link" href="https://run.pivotal.io" target="_top">free trial accounts</a> and including MySQL, Rabbit, and Pivotal Spring Cloud Services in the Marketplace</li><li class="listitem"><span class="strong"><strong>Concourse</strong></span></li><li class="listitem"><span class="strong"><strong>JFrog Bintray</strong></span>: Publicly hosted Maven repository offering free <a class="link" href="https://bintray.com/signup/oss" target="_top">OSS accounts</a></li><li class="listitem"><span class="strong"><strong>Client Tools</strong></span>: On your local machine, you need an IDE as well as the mvn, git, cf, and fly (Concourse) CLIs</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_overview" href="#_tutorial_overview"></a>6.6&nbsp;Tutorial&#8201;&#8212;&#8201;Overview</h2></div></div></div><p>We separate the migration steps into three stages:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara"><span class="strong"><strong>Scaffolding</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Minimal refactoring to be compatible with basic Spring Cloud Pipelines requirements.</li><li class="listitem">At the end of this stage, each application has a corresponding pipeline on Concourse. The pipelines successfully build the applications, store the artifacts in Bintray, tag the GitHub repositories, and deploy the applications to the Test, Stage, and Prod spaces in Cloud Foundry.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Tests</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add and organize tests to be compatible with Spring Cloud Pipelines recommendations.</li><li class="listitem">Incorporate flyway for database schema versioning and initial data loading.</li><li class="listitem">At the end of this stage, the pipelines trigger unit and integration tests during the Build stage, smoke tests in the Test environment, and end-to-end tests in the Stage environment. The pipelines also ensure backward compatibility for the database, such that you can safely roll back the backend service application, even after the database schema has been updated.</li></ul></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>Contracts</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Incorporate Spring Cloud Contract to define the API between the UI and service apps and auto-generate tests and stubs.</li><li class="listitem">At the end of this stage, the pipelines catch breaking API changes during the Build stage and ensure backward compatibility for the API, such that you can safely roll back the backend service (producer) app, even after an API change.</li></ul></div></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tutorial_step_by_step" href="#_tutorial_step_by_step"></a>6.7&nbsp;Tutorial&#8201;&#8212;&#8201;Step-by-step</h2></div></div></div><p>The remainder of this chapter is the actual tutorial, which consists of a preparation stage and three main stages:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-prep" title="6.7.1&nbsp;Prep: Before you begin">Section&nbsp;6.7.1, &#8220;Prep: Before you begin&#8221;</a></li><li class="listitem"><a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-stage-one" title="6.7.2&nbsp;Stage One: Scaffolding">Section&nbsp;6.7.2, &#8220;Stage One: Scaffolding&#8221;</a></li><li class="listitem"><a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-stage-two" title="6.7.3&nbsp;Stage Two: Tests">Section&nbsp;6.7.3, &#8220;Stage Two: Tests&#8221;</a></li><li class="listitem"><a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-stage-three" title="6.7.4&nbsp;Stage Three: Contracts">Section&nbsp;6.7.4, &#8220;Stage Three: Contracts&#8221;</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-prep" href="#tutorial-prep"></a>6.7.1&nbsp;Prep: Before you begin</h3></div></div></div><p>If you want to simply review the migration steps explained below, you can look at the various branches in the <a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a> and <a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a> repositories. A branch represents the end-state of each stage, as the following image shows:</p><div class="figure"><a name="d0e2243" href="#d0e2243"></a><p class="title"><b>Figure&nbsp;6.3.&nbsp;GitHub Branches</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/github_branches.png" alt="github branches"></div></div></div><br class="figure-break"><p>If you want to use this tutorial as a hands-on lab, fork each of the following repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/ciberkleid/greeting-ui" target="_top">greeting-ui</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/fortune-service" target="_top">fortune-service</a></li><li class="listitem"><a class="link" href="https://github.com/ciberkleid/app-config" target="_top">app-config</a></li></ul></div><p>Then create a new directory on your local machine. You may name it anything you like. We refer to it as <code class="literal">$SCP_HOME</code> throughout this tutorial.</p><p>In <code class="literal">$SCP_HOME</code>, clone your forks of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, as well as the following two repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top">cloudfoundry-stub-runner-boot</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-pipelines" target="_top">spring-cloud-pipelines</a></li></ul></div><p>Finally, create a directory called <code class="literal">$SCP_HOME/credentials</code>. Leave it empty for now.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-one" href="#tutorial-stage-one"></a>6.7.2&nbsp;Stage One: Scaffolding</h3></div></div></div><p>In this stage, we make minimal changes to satisfy basic Spring Cloud Pipelines requirements so that the applications can run through the entire pipeline without error. We make &#8220;scaffolding&#8221; changes only&#8201;&#8212;&#8201;no code changes.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>You must complete the steps in this stage for both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_1_create_github_branches" href="#_1_1_create_github_branches"></a>1.1 Create GitHub Branches</h4></div></div></div><p>Create branches in GitHub by using the following git commands:</p><div class="informalexample"><pre class="programlisting">git branch version
git checkout -b sc-pipelines</pre></div><p>The <code class="literal">version</code> branch is required to exist, though it can be created as an empty branch. It is used by Spring Coud Pipelines to generate a version number for each new pipeline execution.</p><p>The <code class="literal">sc-pipelines</code> branch is optional and can be named anything you wish. The intention is for you to use it as a working branch for the changes suggested in this tutorial (hence, you should both create it and check it out).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_2_add_maven_wrapper" href="#_1_2_add_maven_wrapper"></a>1.2 Add Maven Wrapper</h4></div></div></div><p>This step covers how to add the Maven wrapper (which lets your users build without having Maven on the path). To add the Maven wrapper, run the following command:</p><div class="informalexample"><pre class="programlisting">mvn -N io.takari:maven:wrapper</pre></div><p>This commands adds four files to a project:</p><div class="informalexample"><pre class="screen">.
&#9500;&#9472;&#9472; mvnw
&#9500;&#9472;&#9472; mvnw.cmd
&#9492;&#9472;&#9472; .mvn
    &#9492;&#9472;&#9472; wrapper
     &nbsp;&nbsp; &#9500;&#9472;&#9472; maven-wrapper.jar
     &nbsp;&nbsp; &#9492;&#9472;&#9472; maven-wrapper.properties</pre></div><p>Make sure all four files are tracked by Git. One way to do so is to add the following lines to the <code class="literal">.gitignore</code> file:</p><div class="informalexample"><pre class="screen">#Exceptions
!/mvnw
!/mvnw.cmd
!/.mvn/wrapper/maven-wrapper.jar
!/.mvn/wrapper/maven-wrapper.properties</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_3_create_the_bintray_maven_repository_package" href="#_1_3_create_the_bintray_maven_repository_package"></a>1.3 Create the Bintray Maven Repository Package</h4></div></div></div><p>We use Bintray as the Maven repository. Bintray requires that a package exist before any application artifacts can be uploaded.</p><p>Log into the Bintray UI and create the packages as follows (you can use the &#8220;Import from GitHub&#8221; option to create these):</p><div class="figure"><a name="d0e2357" href="#d0e2357"></a><p class="title"><b>Figure&nbsp;6.4.&nbsp;Bintray Packages</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/bintray_packages.png" alt="bintray packages"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_4_configure_distribution_management_by_using_the_bintray_maven_repository" href="#_1_4_configure_distribution_management_by_using_the_bintray_maven_repository"></a>1.4 Configure Distribution Management by Using the Bintray Maven Repository</h4></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>You must do this step for both application repositories.</p></td></tr></table></div><p>Edit the application <code class="literal">pom.xml</code> files. Make sure that the Bintray URLs match the URLs of the corresponding packages created in the previous step. The values you use should differ from the following example in that they should point to your repository:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distribution.management.release.url&gt;</span>https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distribution.management.release.url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span>

...

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;distributionManagement&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>${distribution.management.release.id}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;url&gt;</span>${distribution.management.release.url}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/url&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/repository&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/distributionManagement&gt;</span></pre></div><p>Though not required by Spring Cloud Pipelines, it makes sense to also configure your local maven settings with the credentials to your Bintray maven repository. To do so, edit your maven settings file (usually <code class="literal">~/.m2/settings.xml</code>). If the file does not exist, create it.</p><p>Note that the <code class="literal">id</code> must match the <code class="literal">id</code> specified in the previous step. Also, make sure to use your username and API token (not your account password) instead of the sample values shown in the following example:</p><div class="informalexample"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;settings&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;servers&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;server&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>bintray<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;username&gt;</span>ciberkleid<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/username&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;password&gt;</span>my-super-secret-api-token<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/password&gt;</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/server&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/servers&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/settings&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_5_push_changes_to_github" href="#_1_5_push_changes_to_github"></a>1.5 Push Changes to GitHub</h4></div></div></div><p>Push the changes you made in the preceding step to GitHub. You should be pushing the following to each of the two application repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Four new Maven wrapper files</li><li class="listitem">A modified <code class="literal">.gitignore</code> file</li><li class="listitem">A modified <code class="literal">pom.xml</code> file</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_6_add_a_spring_cloud_pipelines_credentials_file" href="#_1_6_add_a_spring_cloud_pipelines_credentials_file"></a>1.6 Add a Spring Cloud Pipelines Credentials File</h4></div></div></div><p>In <code class="literal">$SCP_HOME/credentials</code>, make two copies of the <code class="literal">$SCP_HOME/spring-cloud-pipelines/concourse/credentials-sample-cf.yml</code> file. Rename them as <code class="literal">credentials-fortune-service.yml</code> and <code class="literal">credentials-greeting-ui.yml</code>.</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>These files will contain credentials to your GitHub repository, your Bintray repository, and your Cloud Foundry foundation. Hence, we opt to put them in a separate directory. You may choose to store these files in a private Git repository, but do not push them to a public repository.</p></td></tr></table></div><p>Edit the Git properties of each credentials file. Make sure to replace the sample values shown in our example. For <code class="literal">tools-branch</code>, you can use a fixed release (use v1.0.0.M8 or later for Cloud Foundry). Leave the other values as they are. We update those in later steps. The following listing shows a credentials file:</p><div class="informalexample"><pre class="programlisting">app-url: git@github.com:ciberkleid/fortune-service.git
app-branch: sc-pipelines
tools-scripts-url: https://github.com/spring-cloud/spring-cloud-pipelines.git
tools-branch: master
build-options: ""

github-private-key: |
  -----BEGIN RSA PRIVATE KEY-----
  MIIJKQIBAAKCAgEAvwkL97vBllOSE39Wa5ppczT1cr5Blmkhadfoa1Va2/IBVyvk
  NJ9PqoTI+BahF2EgzweyiDSvKsstlTsG7QgiM9So8Voi2PlDOrXL6uOfCuAS/G8X
  ...
  -----END RSA PRIVATE KEY-----
git-email: ciberkleid@pivotal.io
git-name: Cora Iberkleid</pre></div><p>Edit the Maven repository properties of each credentials file. Make sure to replace the sample values shown in our example. Bintray requires separate URLs for uploads and downloads. If you use a different artifact repository, such as Artifactory or Nexus, and the repository URL is the same for uploads and downloads, you do not need to set <code class="literal">repo-with-binaries-for-upload</code>. The following listing shows the values to add or edit in your credentials file:</p><div class="informalexample"><pre class="programlisting">m2-settings-repo-id: bintray
m2-settings-repo-username: ciberkleid
m2-settings-repo-password: my-super-secret-api-token

repo-with-binaries: https://ciberkleid:my-super-secret-api-token@dl.bintray.com/ciberkleid/maven-repo

repo-with-binaries-for-upload: https://api.bintray.com/maven/ciberkleid/maven-repo/fortune-service</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_7_set_the_concourse_pipeline" href="#_1_7_set_the_concourse_pipeline"></a>1.7 Set the Concourse Pipeline</h4></div></div></div><p>At this point, all of the build jobs, which run on Concourse workers, should succeed.</p><p>To verify this, log in to your Concourse target and set the Concourse pipelines. Update the target name in the following example:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set greeting-ui pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p greeting-ui -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-greeting-ui.yml"</span> -n

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Set fortune-service pipeline</span>
fly -t myTarget <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span>-pipeline -p fortune-service -c <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/spring-cloud-pipelines/concourse/pipeline.yml"</span> -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${SCP_HOME}/credentials/credentials-fortune-service.yml"</span> -n</pre></div><p>Log into the Concourse UI and un-pause the pipelines. Start each pipeline. You should see that the build jobs all succeed, similar to the following image:</p><div class="figure"><a name="d0e2465" href="#d0e2465"></a><p class="title"><b>Figure&nbsp;6.5.&nbsp;Build Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_build_success.png" alt="concourse build success"></div></div></div><br class="figure-break"><p>In addition, you should see a new <code class="literal">dev/&lt;version_number&gt;</code> tag in each GitHub repository and see the app jars uploaded into Bintray.</p><p>The test, stage, and prod jobs fail, because we have not yet added scaffolding for deployment to Cloud Foundry. We do that next.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_8_add_cloud_foundry_manifest" href="#_1_8_add_cloud_foundry_manifest"></a>1.8 Add Cloud Foundry manifest</h4></div></div></div><p>If you are deploying to Cloud Foundry, you may already be routinely including manifest files with your applications. Our sample applications did not have manifest files, so we add them now.</p><p>In the <code class="literal">greeting-ui</code> repository, create a <code class="literal">manifest.yml</code> file as follows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: greeting-ui
  timeout: 120
  services:
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>In the <code class="literal">fortune-service</code> repository, create a <code class="literal">manifest.yml</code> file as follows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>The <code class="literal">TRUST_CERTS</code> variable is used by the Pivotal Spring Cloud Services (Config Server, Service Registry, and Circuit Breaker Dashboard), which we use in this example. The value specified in the preceding example assumes deployment to Pivotal Web Services. Update it accordingly if you are deploying to a different Cloud Foundry foundation, or you can leave it out altogether if you are replacing the Pivotal Spring Cloud Services with alternative implementations (for example, deploying the services as applications and exposing them as user-provided services).</p><p>If you wishi, you can add additional values to the manifest files&#8201;&#8212;&#8201;for example, if additional values are useful for any manual deployment you may still want to do or if you need additional values in your Spring Cloud Pipelines deployment. For example, the following file could be an alternative <code class="literal">manifest.yml</code> for <code class="literal">fortune-service</code>:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  instances: 3
  memory: 1024M
  buildpack: https://github.com/cloudfoundry/java-buildpack.git
  random-route: true
  path: ./target/fortune-service-0.0.1-SNAPSHOT.jar
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: someProfile
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div><p>Note that Spring Cloud Pipelines ignores <code class="literal">random-route</code> and <code class="literal">path</code>. <code class="literal">instances</code> is honored in stage and prod but is overridden with a value of 1 for test.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_9_add_the_spring_cloud_pipelines_manifest" href="#_1_9_add_the_spring_cloud_pipelines_manifest"></a>1.9 Add the Spring Cloud Pipelines Manifest</h4></div></div></div><p>The Cloud Foundry manifest created in the previous step includes the logical names of the services to which the applications should be bound, but it does not describe how the services can be provisioned. Hence, we add a second manifest file so that Spring Cloud Pipelines can provision the services.</p><p>Add a file called <code class="literal">sc-pipelines.yml</code> to each application and include the same list of services as in the corresponding <code class="literal">manifest.yml</code>. Add the necessary details such that Spring Cloud Pipelines can construct a <code class="literal">cf create-service</code> command.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The `type: broker' parameter in the next example instructs Spring Cloud Pipelines to provision a service by using `cf create-service'. Other service types are also supported: cups, syslog, route, app, and stubrunner.</p></td></tr></table></div><p>More specifically, for <code class="literal">greeting-ui</code>, create an <code class="literal">sc-pipelines.yml</code> file with the following content:</p><div class="informalexample"><pre class="programlisting">test:
  services:
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre></div><p>The <code class="literal">sc-pipelines.yml</code> file for <code class="literal">fortune-service</code> is similar, with the addition of the <code class="literal">fortune-db</code> service, as follows:</p><div class="informalexample"><pre class="programlisting">test:
  # list of required services
  services:
    - name: fortune-db
      type: broker
      broker: cleardb
      plan: spark
      useExisting: true
    - name: config-server
      type: broker
      broker: p-config-server
      plan: standard
      params:
        git:
          uri: https://github.com/ciberkleid/app-config
      useExisting: true
    - name: cloud-bus
      type: broker
      broker: cloudamqp
      plan: lemur
      useExisting: true
    - name: service-registry
      type: broker
      broker: p-service-registry
      plan: standard
      useExisting: true
    - name: circuit-breaker-dashboard
      type: broker
      broker: p-circuit-breaker-dashboard
      plan: standard
      useExisting: true</pre></div><p>The values in the preceding two examples assume deployment to Pivotal Web Services. If you are deploying to a different Cloud Foundry foundation, update the values accordingly. Also, make sure to replace the <code class="literal">config-server</code> URI with the address of your fork of the <a class="link" href="https://github.com/ciberkleid/app-config" target="_top"><code class="literal">app-config</code></a> repository.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the <code class="literal">useExisting: true</code> parameter in the preceding example. By default, Spring Cloud Pipelines deletes and re-creates services in the <code class="literal">test</code> space. To override this behavior and re-use existing services, we set <code class="literal">useExisting: true</code>. This is helpful in cases where services  may take time to provision and initialize, where there is no risk in re-using them between pipeline runs, or where it is desirable to retain the service instance from the last pipeline run (for example, a database migration).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_10_push_changes_to_github" href="#_1_10_push_changes_to_github"></a>1.10 Push changes to GitHub</h4></div></div></div><p>Push the preceding changes to GitHub. You should be pushing the following to each of the two application repositories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">A new app manifest file</li><li class="listitem">A new sc-pipelines manifest file</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_11_create_cloud_foundry_orgs_and_spaces" href="#_1_11_create_cloud_foundry_orgs_and_spaces"></a>1.11 Create Cloud Foundry Orgs and Spaces</h4></div></div></div><p>Spring Cloud Pipelines requires that the Cloud Foundry test, stage, and prod spaces exist before a pipeline is run. If you wish, you can use different foundations, orgs, and users for each. For simplicity, in this example, we use a single foundation (PWS), a single org, and a single user.</p><p>You can name the orgs and spaces anything you like. Each app requires its own test space. The stage and prod spaces are shared.</p><p>For this example, use the following commands to create spaces:</p><div class="informalexample"><pre class="programlisting">cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-greeting-ui
cf create-space scp-<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">test</span>-fortune-service
cf create-space scp-stage
cf create-space scp-prod</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_12_create_cloud_foundry_stage_and_prod_service_instances" href="#_1_12_create_cloud_foundry_stage_and_prod_service_instances"></a>1.12 Create Cloud Foundry Stage and Prod Service Instances</h4></div></div></div><p>Spring Cloud Pipelines dynamically creates the services in the test spaces, as defined by the <code class="literal">sc-pipelines.yml</code> file we created previously. Optionally, you can add a second section to the <code class="literal">sc-pipelines.yml</code> file for the stage environment, and these are created dynamically as well. However, you must always crate prod manually.</p><p>For this example, we create both the stage and prod services manually.</p><p>Create the services listed in the application manifest files in both <code class="literal">scp-stage</code> and <code class="literal">scp-prod</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_13_update_the_spring_cloud_pipelines_credentials_file" href="#_1_13_update_the_spring_cloud_pipelines_credentials_file"></a>1.13 Update the Spring Cloud Pipelines Credentials File</h4></div></div></div><p>Update the <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> credentials files with Cloud Foundry information. Replace values in the next example as appropriate for your Cloud Foundry environment.</p><p>Notice that the test space name specified is a prefix, unlike the stage and prod space names, which are literals. Spring Cloud Pipelines append the application name to the test space name, thereby matching the test space names we created manually. The stage and prod space names are not prefixes and are not altered by Spring Cloud Pipelines.</p><p>Note also the <code class="literal">paas-hostname-uuid</code>. The value is included in each created route. This value is optional, but it is useful in shared or multi-tenant environments (such as PWS), as it helps to ensure routes are unique. Change it to a unique uuid.</p><p>The following example shows an updated credentials file:</p><div class="informalexample"><pre class="programlisting">pipeline-descriptor: sc-pipelines.yml

paas-type: cf

paas-hostname-uuid: cyi

# test values
paas-test-api-url: https://api.run.pivotal.io
paas-test-username: ciberkleid@pivotal.io
paas-test-password: secret
paas-test-org: S1Pdemo12
paas-test-space-prefix: scp-test

# stage values
paas-stage-api-url: https://api.run.pivotal.io
paas-stage-username: ciberkleid@pivotal.io
paas-stage-password: my-super-secret-password
paas-stage-org: S1Pdemo12
paas-stage-space: scp-stage

# prod values
paas-prod-api-url: https://api.run.pivotal.io
paas-prod-username: ciberkleid@pivotal.io
paas-prod-password: my-super-secret-password
paas-prod-org: S1Pdemo12
paas-prod-space: scp-prod</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_1_14_update_the_concourse_pipeline_with_updated_credentials_files" href="#_1_14_update_the_concourse_pipeline_with_updated_credentials_files"></a>1.14 Update the Concourse Pipeline with Updated Credentials Files</h4></div></div></div><p>Set the Concourse pipelines again, as we did previously, to update them with the values added to the credentials files. The test, stage, and prod jobs should all now succeed and result in output similar to the following image:</p><div class="figure"><a name="d0e2673" href="#d0e2673"></a><p class="title"><b>Figure&nbsp;6.6.&nbsp;Test, Stage, &amp; Prod Success</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/concourse_test_stage_prod_success.png" alt="concourse test stage prod success"></div></div></div><br class="figure-break"><p>On Cloud Foundry, you should now see the apps deployed in the test, stage, and prod spaces. The following image shows the deployment of <code class="literal">fortune-service</code> to its dedicated test space:</p><div class="figure"><a name="d0e2687" href="#d0e2687"></a><p class="title"><b>Figure&nbsp;6.7.&nbsp;Cloud Foundry Test and Prod Deployment</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/cf_test_and_prod_deployed.png" alt="cf test and prod deployed"></div></div></div><br class="figure-break"><p>Notice that the five services declared in its manifest files (<code class="literal">sc-pipelines.yml</code> for provisioning and <code class="literal">manifest.yml</code> for binding) have also been automatically provisioned. The image also shows the deployment of the same app to the shared prod space. Notice that the instance of the previous version has been renamed as <code class="literal">venerable</code> and stopped. If a rollback were deemed necessary, the <code class="literal">prod-rollback</code> job in the pipeline could be triggered to remove the currently running version, remove the <code class="literal">prod/&lt;version_number&gt;</code> tag from GitHub, and re-start the former (<code class="literal">venerable</code>) version.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_one_recap_and_next_steps" href="#_stage_one_recap_and_next_steps"></a>Stage One Recap and Next Steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">By adding the basic scaffolding needed to enable Spring Cloud Pipelines to manage the lifecycle of <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code> from source code commit to production deploy, we have made it possible for the application development teams to instantly and easily create pipelines for each application by using a common, standardized template.</li><li class="listitem"><p class="simpara">We can count on the pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Automatically provision services in test spaces and, optionally, in stage spaces as well.</li><li class="listitem">Dynamically clean up the test spaces between pipeline executions.</li><li class="listitem">Upload the app artifacts to the maven repo (for example, Bintray).</li><li class="listitem">Tag the git repositories with <code class="literal">dev/&lt;version_number&gt;</code> and <code class="literal">prod/&lt;version_number&gt;</code>.</li></ul></div></li><li class="listitem">After each successful pipeline run, we can, if necessary, to roll back to the last deployed version byusing the <code class="literal">prod-rollback</code> job.</li></ul></div><p>These accomplishments are extremely valuable. However, to derive confidence and reliability from the pipelines, we need to incorporate testing. We do this in Stage Two of the application migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-two" href="#tutorial-stage-two"></a>6.7.3&nbsp;Stage Two: Tests</h3></div></div></div><p>In this stage, we enable Spring Cloud Pipelines to execute tests so that we can increase confidence in the code being deployed. We do so by adding test profiles to the <code class="literal">pom.xml</code> files and then organizing or adding tests in a way that corresponds to the profiles. By doing so, we establish standards around testing across development teams in the enterprise.</p><p>We will also enable database schema versioning in this stage, thereby providing the foundation for rollback testing during schema changes.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_1_add_maven_profiles" href="#_2_1_add_maven_profiles"></a>2.1 Add Maven Profiles</h4></div></div></div><p>For both <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>, add a <code class="literal">profiles</code> section to the <code class="literal">pom.xml</code> file, as shown in the next listing. Note that we are adding four profiles:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><code class="literal">default</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For unit and integration tests. Note that this profile includes all tests except those that are explicitly called by the smoke and e2e profiles.</li><li class="listitem">Tests matching this profile run during the build-and-upload job.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">apicompatibility</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For ensuring backward compatibility in case of API changes. Note that this is not effective until Stage Three, when we will add contracts. However, we add this profile now to ensure the api compatibility check during the <code class="literal">build-and-upload</code> job does not run other tests.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">smoke</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the application deployed in the test space.</li></ul></div></li><li class="listitem"><p class="simpara"><code class="literal">e2e</code></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">For tests to be run against the application deployed in the stage space.</li></ul></div></li></ul></div><p>The following listing shows the necessary <code class="literal">profiles</code> element of a <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profiles&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>smoke<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>smoke/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>e2e<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>e2e/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profiles&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_2_add_and_organize_tests" href="#_2_2_add_and_organize_tests"></a>2.2 Add and Organize Tests</h4></div></div></div><p>Next, we ensure that we have a matching test package structure in our apps, as the following image shows:</p><div class="figure"><a name="d0e2843" href="#d0e2843"></a><p class="title"><b>Figure&nbsp;6.8.&nbsp;Test Package Structure</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/test_package_structure.png" alt="test package structure"></div></div></div><br class="figure-break"><p>Note that we are creating matching packages only for the default, smoke, and e2e profiles. We will address the package for the <code class="literal">apicompatibility</code> profile in Stage Three.</p><p>When working with your own applications, if you have existing tests, you would move the files into one of these packages now and rename them so that they are included by the filters declared in the profiles (that is, the file names end in <code class="literal">Test.java</code> or <code class="literal">Tests.java</code>)</p><p>In the case of our sample apps, we have no tests, so we add some now.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_default_tests" href="#__literal_fortune_service_literal_default_tests"></a><code class="literal">fortune-service</code> Default Tests</h5></div></div></div><p>Add your unit and integration tests so that they match the default profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These are run on Concourse against the <code class="literal">fortune-service</code> application that runs on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we add two tests, one that loads the context and another that verifies the number of rows expected in the database. The following example defines these tests:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.assertj.core.api.Assertions.assertThat;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">static</span> org.junit.Assert.*;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = FortuneServiceApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> JdbcTemplate template;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> testDefaultSettings() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {
        assertThat(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.template.queryForObject(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"SELECT COUNT(*) from FORTUNE"</span>,
                Integer.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>)).isEqualTo(<span class="hl-number">7</span>);
    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_smoke_tests" href="#__literal_fortune_service_literal_smoke_tests"></a><code class="literal">fortune-service</code> Smoke Tests</h5></div></div></div><p>Add your smoke tests so that they match the smoke profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-test-fortune-service</code> space. Two versions of these tests are executed against the application:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">the current version, in the <code class="literal">test-smoke</code> job.</li><li class="listitem">the latest prod version, in the <code class="literal">test-rollback-smoke</code> job.</li></ul></div><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e2925" href="#d0e2925"></a><p class="title"><b>Figure&nbsp;6.9.&nbsp;fortune-service Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_smoke_tests.png" alt="fortune service smoke tests"></div></div></div><br class="figure-break"><p>In the test environment, we choose to verify that <code class="literal">fortune-service</code> is retrieving a fortune from <code class="literal">fortune-db</code>, and not returning its Hystrix fallback response. The following example defines this test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_fortune_service_literal_end_to_end_literal_e2e_literal_tests" href="#__literal_fortune_service_literal_end_to_end_literal_e2e_literal_tests"></a><code class="literal">fortune-service</code> End-to-end (<code class="literal">e2e</code>) Tests</h5></div></div></div><p>Add your end-to-end tests so that they match the <code class="literal">e2e</code> profile, as defined in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file. These tests run on Concourse against the <code class="literal">fortune-service</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">greeting-ui</code> is also present.</p><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e2975" href="#d0e2975"></a><p class="title"><b>Figure&nbsp;6.10.&nbsp;fortune-service E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_e2e_tests.png" alt="fortune service e2e tests"></div></div></div><br class="figure-break"><p>In the <code class="literal">e2e</code> environment, we choose to use a string replacement to obtain the URL for <code class="literal">greeting-ui</code>. We also choose to verify that we hit <code class="literal">fortune-db</code> and do not receive Hystrix fallback responses from either application. The following example shows this test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// The app is running in CF but the tests are executed from Concourse worker,</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// so the test will deduce the url to greeting-ui: it will assume the same host</span>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// as fortune-service, and simply replace "fortune-service" with "greeting-ui" in the url</span>

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl.replace(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"fortune-service"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"greeting-ui"</span>) + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback responses from both fortune and greeting</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"The fortuneteller will be back soon."</span>);
	}

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_default_tests" href="#__literal_greeting_ui_literal_default_tests"></a><code class="literal">greeting-ui</code> Default Tests</h5></div></div></div><p>Add your unit and integration tests so that they match the default profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application that runs on the Concourse worker in the <code class="literal">build-and-upload</code> job.</p><p>As an example, we add one test that loads the context:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class)</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> GreetingUIApplicationTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> contextLoads() <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> Exception {

    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_smoke_tests" href="#__literal_greeting_ui_literal_smoke_tests"></a><code class="literal">greeting-ui</code> Smoke Tests</h5></div></div></div><p>Add your smoke tests so that they match the smoke profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-test-greeting-ui</code> space. Two versions of these tests run against the app:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The current version, in the <code class="literal">test-smoke</code> job.</li><li class="listitem">The latest prod version, in the <code class="literal">test-rollback-smoke</code> job.</li></ul></div><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e3056" href="#d0e3056"></a><p class="title"><b>Figure&nbsp;6.11.&nbsp;greeting-ui Smoke Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_smoke_tests.png" alt="greeting ui smoke tests"></div></div></div><br class="figure-break"><p>Since <code class="literal">fortune-service</code> is not deployed to the <code class="literal">scp-test-greeting-ui</code> space, we expect to receive the Hystrix fallback response defined in <code class="literal">greeting-ui</code>. Hence, our smoke test validates that condition:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

    <em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

    RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fallback_fortune() {
        ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
                .getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

        BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Expect the hystrix fallback response</span>
        BDDAssertions.then(response.getBody()).contains(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
    }

}</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="__literal_greeting_ui_literal_end_to_end_literal_e2e_literal_tests" href="#__literal_greeting_ui_literal_end_to_end_literal_e2e_literal_tests"></a><code class="literal">greeting-ui</code> End-to-end (<code class="literal">e2e</code>) Tests</h5></div></div></div><p>Add your end-to-end tests so that they match the <code class="literal">e2e</code> profile, as defined in the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file. These run on Concourse against the <code class="literal">greeting-ui</code> application deployed in the Cloud Foundry <code class="literal">scp-stage</code> space. This space is shared, so we assume <code class="literal">fortune-service</code> is also present.</p><p>The following image shows the tests in Concourse:</p><div class="figure"><a name="d0e3109" href="#d0e3109"></a><p class="title"><b>Figure&nbsp;6.12.&nbsp;greeting-ui E2E Tests</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_e2e_tests.png" alt="greeting ui e2e tests"></div></div></div><br class="figure-break"><p>In the <code class="literal">e2e</code> environment, we choose to verify that we hit <code class="literal">fortune-service</code> and do not receive the Hystrix fallback response from <code class="literal">greeting-ui</code>. The following example shows the test:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> e2e;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = E2eTests.class,
		webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> E2eTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_3_enable_database_versioning" href="#_2_3_enable_database_versioning"></a>2.3 Enable Database Versioning</h4></div></div></div><p>At this point, we also incorporate <a class="link" href="https://flywaydb.org/" target="_top">Flyway</a>, an OSS database migration tool, to track database schema versions and handle schema changes and data loading.</p><p>This change needs to be made only to <code class="literal">fortune-service</code>, since <code class="literal">fortune-service</code> owns the interaction with <code class="literal">fortune-db</code>.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_add_flyway_dependency" href="#_add_flyway_dependency"></a>Add Flyway Dependency</h5></div></div></div><p>We first add the Flyway dependency to the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code>. We need not add a version as Spring Boot takes care of that for us. The following listing shows the Flyway dependency:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.flywaydb<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>flyway-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_create_flyway_migration" href="#_create_flyway_migration"></a>Create Flyway Migration</h5></div></div></div><p>Next, we create a migration directory and our initial migration file, following Flyway&#8217;s file naming convention. The following image shows the name of the file in context:</p><div class="figure"><a name="d0e3170" href="#d0e3170"></a><p class="title"><b>Figure&nbsp;6.13.&nbsp;fortune-service Flyway File Name</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_file_name.png" alt="fortune service flyway file name"></div></div></div><br class="figure-break"><p>Note that the filename specifies the version (<code class="literal">V1</code>), followed by two underscore characters.</p><p>We place our <code class="literal">CREATE TABLE</code> and <code class="literal">INSERT</code> statements in our <code class="literal">src/main/resources/db/migration/V1__init.sql</code> file, as the following listing shows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">CREATE</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">TABLE</span> fortune (
  id <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">BIGINT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">PRIMARY</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">KEY</span> AUTO_INCREMENT,
  text <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">varchar</span>(<span class="hl-number">255</span>) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">not</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">null</span>
);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do what works.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Do the right thing.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Always be kind.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You learn from your mistakes... You will learn a lot today.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You can always find happiness at work on Friday.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'You will be hungry again in one hour.'</span>);

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INSERT</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">INTO</span> fortune (text) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">VALUES</span> (<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'Today will be an awesome day!'</span>);</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_disable_jpa_ddl_initialization" href="#_disable_jpa_ddl_initialization"></a>Disable JPA DDL Initialization</h5></div></div></div><p>Because we rely on Flyway to create and populate the schema, we need to disable JPA-based database initialization. We can set <code class="literal">ddl-auto</code> to <code class="literal">validate</code>, which validates the schema against the application entities and throws an error in case of a mismatch but does not actually generate the schema. The following snippet shows how to do so:</p><div class="informalexample"><pre class="programlisting">spring:
  jpa:
    hibernate:
      ddl-auto: validate</pre></div><p>There are a few options for where to store the <code class="literal">ddl-auto</code> configuration, both in terms of location (in the <code class="literal">fortune-service</code> app or on the <code class="literal">app-config</code> GitHub repo) and in terms of file name. For this example, update the <code class="literal">application.yml</code> in the <code class="literal">fortune-service</code> app for local testing. Additionally, save these values in a new file called <code class="literal">application-flyway.yml</code> on your fork of <a class="link" href="https://github.com/ciberkleid/app-config" target="_top"><code class="literal">app-config</code></a>.</p><p>By convention, <code class="literal">fortune-service</code> picks up the configurations in <code class="literal">application-flyway.yml</code> if the string <code class="literal">flyway</code> is in the list of active Spring profiles. Consequently, we can add <code class="literal">flyway</code> to the <code class="literal">SPRING_PROFILES_ACTIVE</code> environment variable in the <code class="literal">fortune-service</code> <code class="literal">manifest.yml</code>, as the following listing shows:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: fortune-service
  timeout: 120
  services:
  - fortune-db
  - config-server
  - cloud-bus
  - service-registry
  - circuit-breaker-dashboard
  env:
    SPRING_PROFILES_ACTIVE: flyway
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_remove_non_flyway_data_loading" href="#_remove_non_flyway_data_loading"></a>Remove Non-Flyway Data Loading</h5></div></div></div><p>We can now remove the old code that populated the database. In our sample app, this was found in the <code class="literal">io.pivotal.FortuneServiceApplication</code> class. The following listing shows the code we now remove:</p><div class="informalexample"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    CommandLineRunner loadDatabase(FortuneRepository fortuneRepo) {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> args -&gt; {
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            logger.debug("loading database..");</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(1L, "Do what works."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(2L, "Do the right thing."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(3L, "Always be kind."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(4L, "You learn from your mistakes... You will learn a lot today."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(5L, "You can always find happiness at work on Friday."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(6L, "You will be hungry again in one hour."));</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//            fortuneRepo.save(new Fortune(7L, "Today will be an awesome day!"));</span>
            logger.debug(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"record count: {}"</span>, fortuneRepo.count());
            fortuneRepo.findAll().forEach(x -&gt; logger.debug(x.toString()));
        };

    }</pre></div><p>We also no longer need the <code class="literal">Fortune</code> entity constructors, so we can comment these out in the <code class="literal">io.pivotal.fortune.Fortune</code> class as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune() {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    public Fortune(Long id, String text) {</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        super();</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.id = id;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//        this.text = text;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">//    }</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_flyway_integration_summary" href="#_flyway_integration_summary"></a>Flyway Integration Summary</h5></div></div></div><p>With that, we have completed the setup for Flyway, and our database schema is now versioned. From this point onward, Spring Boot calls <code class="literal">Flyway.migrate()</code> to perform the database migration. As long as we follow Flyway conventions for future schema changes, Flyway takes care of tracking the schema version and migrating the database for us.</p><p>From a rollback perspective, Spring Cloud Pipelines includes two jobs in the <code class="literal">test</code> phase (<code class="literal">test-rollback-deploy</code> and <code class="literal">test-rollback-smoke</code>), wherein it validates that the latest prod jar works against the newly updated database. The purpose is to ensure that we can roll back the application in prod if a problem is discovered after the prod database schema has been updated and avoid the burden of rolling back the database.</p><p>See <a class="link" href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-use-a-higher-level-database-migration-tool" target="_top">Spring Boot database initialization with Flyway</a> for further information, including Flyway configuration options.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_4_push_changes_to_github" href="#_2_4_push_changes_to_github"></a>2.4 Push Changes to GitHub</h4></div></div></div><p>For <code class="literal">greeting-ui</code>, you should push the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/java/e2e/E2eTests.java</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/GreetingUIApplicationTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li></ul></div><p>For <code class="literal">fortune-service</code>, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/java/e2e/E2eTests.java</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/FortuneServiceApplicationTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li><li class="listitem"><code class="literal">src/main/resources/db/migration/V1__init.sql</code></li><li class="listitem"><code class="literal">src/main/resources/application.yml</code></li><li class="listitem"><code class="literal">manifest.yml</code></li><li class="listitem"><code class="literal">src/main/java/io/pivotal/FortuneServiceApplication.java</code></li><li class="listitem"><code class="literal">src/main/java/io/pivotal/fortune/Fortune.java</code></li></ul></div><p>For <code class="literal">app-config</code>, you should be pushing the following new:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">application-flyway.yml</code></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_2_5_re_run_the_pipelines" href="#_2_5_re_run_the_pipelines"></a>2.5 Re-run the Pipelines</h4></div></div></div><p>Run through the pipelines again and view the output for the jobs that run the default, smoke, and end-to-end (<code class="literal">e2e</code>) tests. You should see that the tests we added in this stage were run.</p><p>As you run through the pipelines a second time, you should see the smoke tests from the latest prod version run against the database in the <code class="literal">test-rollback-smoke</code> job. In this case, there is no schema upgrade. Nonetheless, the tests confirm that the latest prod version of the app can be used with the current database schema.</p><p>You can see the database version information stored in the database by Flyway either by querying the database itself or by hitting the flyway endpoint on the <code class="literal">fortune-service</code> URL. The following image shows an example from the <code class="literal">scp-stage</code> environment:</p><div class="figure"><a name="d0e3406" href="#d0e3406"></a><p class="title"><b>Figure&nbsp;6.14.&nbsp;fortune-service Flyway Schema Info</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_flyway_schema_info.png" alt="fortune service flyway schema info"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_two_recap_and_next_steps" href="#_stage_two_recap_and_next_steps"></a>Stage Two Recap and Next Steps</h4></div></div></div><p>What have we accomplished?</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Increased the effectiveness of the pipelines and our confidence in them by integrating our applications with the testing strategy built into Spring Cloud Pipelines.</li><li class="listitem">Established a standard approach to organizing tests, which brings consistency within and across development teams.</li><li class="listitem">Enabled auto-managed database versioning and backward compatibility testing that alleviates database schema management throughout the release management lifecycle.</li></ul></div><p>We can now add any unit, integration, smoke, and end-to-end tests to our code base and have a high level of reliability and confidence in our pipelines. We are also better positioned to ensure that our development teams conform to these practices, given the structure established by Spring Cloud Pipelines and the fast feedback and visibility we gain from the pipelines as they execute the tests.</p><p>However, we could benefit further by incorporating contracts to define and test the API integration points between applications. We do this in Stage Three of the application migration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tutorial-stage-three" href="#tutorial-stage-three"></a>6.7.4&nbsp;Stage Three: Contracts</h3></div></div></div><p>In this stage, we introduce contract-based programming practices into our sample application. Doing so improves API management capabilities, including defining, communicating, and testing API semantics. It also lets us catch breaking API changes (that is, we can validate API backward compatibility) in the build phase. This extends the effectiveness of the pipelines, encourages better communication and programming practices across development teams, and provides faster feedback to developers.</p><p>We will integrate Spring Cloud Contract and add contracts, stubs, and a stub runner. We will also now complete and make use of the <code class="literal">apicompatibility</code> profile defined in <a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-stage-two" title="6.7.3&nbsp;Stage Two: Tests">Section&nbsp;6.7.3, &#8220;Stage Two: Tests&#8221;</a>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_1_create_a_contract" href="#_3_1_create_a_contract"></a>3.1 Create a Contract</h4></div></div></div><p>We start by creating the contract for the interaction between <code class="literal">greeting-ui</code> and <code class="literal">fortune-service</code>. The contract should describe the following expectation: <code class="literal">greeting-ui</code> makes a <code class="literal">GET</code> request to the root URL of <code class="literal">fortune-service</code> and expects a response with status 200 and a string (<code class="literal">new fortune</code>) in the body</p><p>We code this buy using groovy syntax as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.spec.Contract

Contract.make {
    description(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"
</span>should <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> a fortune string
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">""</span><span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">")
</span>    request {
        method GET()
        url <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>
    }
    response {
        status <span class="hl-number">200</span>
        body <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"new fortune"</span>
    }
}</pre></div><p>Save this contract in the <code class="literal">fortune-service</code> code base in the following location (which is compliant with Spring Cloud Contract convention): <code class="literal">src/test/resources/contracts/&lt;service-name&gt;/&lt;contract-file&gt;</code>. The following image shows the contract file in its location within an IDE:</p><div class="figure"><a name="d0e3482" href="#d0e3482"></a><p class="title"><b>Figure&nbsp;6.15.&nbsp;fortune-service Flyway Contract File</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_contract_file.png" alt="fortune service contract file"></div></div></div><br class="figure-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can optionally enable your IDE to assist with contract syntax by adding the Spring Cloud Contract Verifier to your <code class="literal">pom.xml</code> file. It is pluggable, and includes groovy and pact by default. The following element shows the dependency to add:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_2_create_a_base_class_for_contract_tests" href="#_3_2_create_a_base_class_for_contract_tests"></a>3.2 Create a Base Class for Contract Tests</h4></div></div></div><p>Now that we have a coded contract, we want to enable auto-generation of contract-based tests. The auto-generation, which we will configure in the next steps, requires a base class that stubs out the service that satisfies the API call, so that we can run the test without external dependencies (for example, the database). The objective is to focus on testing API semantics.</p><p>We create the base class in the <code class="literal">fortune-service</code> test package as follows:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.restassured.module.mockmvc.RestAssuredMockMvc;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Before;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.mockito.BDDMockito;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> BaseClass {

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> setup() {
        FortuneService service = BDDMockito.mock(FortuneService.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
        BDDMockito.given(service.getFortune()).willReturn(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
        RestAssuredMockMvc.standaloneSetup(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> FortuneController(service));
    }
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_3_enable_automated_contract_based_testing" href="#_3_3_enable_automated_contract_based_testing"></a>3.3 Enable Automated Contract-based Testing</h4></div></div></div><p>Now that we have a contract and a base class, we can use the Spring Cloud Contract Maven plugin to auto-generate contract tests, stubs, and a stub jar.</p><p>First we add the Spring Cloud Contract version to the list of properties in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file, since we will reference it when we enable the Spring Cloud Contract maven plugin. To do so, we add the <code class="literal">&lt;spring-cloud-contract.version&gt;</code> to the <code class="literal">properties</code> element, as follows:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;spring-cloud-contract.version&gt;</span>1.2.1.RELEASE<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/spring-cloud-contract.version&gt;</span>
...
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre></div><p>Next, we edit the <code class="literal">default</code> profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract maven plugin.</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests.</li><li class="listitem">Configure it to place auto-generated tests in the <code class="literal">io.pivotal.fortune.contracttests</code> test package.</li></ul></div><p>Note that the package of the contract tests is included by the <code class="literal">include</code> filter in the <code class="literal">default</code> profile, so these tests run against the application during the <code class="literal">build-and-upload</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the application conforms to the contract.</p><p>The following listing shows the complete profile:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>default<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activation&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;activeByDefault&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activeByDefault&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/activation&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;excludes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/smoke/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;exclude&gt;</span>**/e2e/**<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/exclude&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/excludes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre></div><p>When the app is built, the Spring Cloud Contract maven plugin also now produces a stub and a stub jar that contains the contract and stub. This stub jar is uploaded to Bintray, along with the usual app jar. As we see shortly, this stub jar can be used by the <code class="literal">greeting-ui</code> development team while they wait for <code class="literal">fortune-service</code> to be completed. In other words, this gives the <code class="literal">greeting-ui</code> development team a producer to test against that is based on a mutually agreed-upon contract without the lead time of having to wait for <code class="literal">fortune-service</code> team to implement anything more than a base class and without having to manually stub out calls to <code class="literal">fortune-service</code> based on arbitrary or static responses.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Package the project locally (run <code class="literal">mvn package</code>) to observe the tests, stubs, and stub jar that the Spring Cloud Contract Maven plugin generates. See the following image for reference:</p></td></tr></table></div><div class="figure"><a name="d0e3604" href="#d0e3604"></a><p class="title"><b>Figure&nbsp;6.16.&nbsp;Generated Tests and Stubs</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_generated_tests.png" alt="fortune service generated tests"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_4_enable_backward_compatibility_api_check" href="#_3_4_enable_backward_compatibility_api_check"></a>3.4 Enable backward compatibility API check</h4></div></div></div><p>To enable Spring Cloud Pipelines to catch any breaking API changes during the the API compatibility check in the <code class="literal">build-and-upload</code> job, we add the Spring Cloud Contract Maven plugin to the <code class="literal">apicompatibility</code> profile as well.</p><p>In this case, we want the plugin to generate tests based on contracts outside of the project (the ones from the latest prod version), so we configure the plugin to download the latest prod stub jar, which contains the old contract. The plugin uses the old contract and the specified base class (which, in our example, is the same as the one in the previous step) to generate contract tests. These tests are run against the new code to validate that it is still compatible with consumers that comply with the prior contract. This ensures backward compatibility for the API.</p><p>In short, we edit the <code class="literal">apicompatibility</code> profile in the <code class="literal">fortune-service</code> <code class="literal">pom.xml</code> file to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Add a plugin block for Spring Cloud Contract Maven plugin.</li><li class="listitem">Configure it to download the latest prod stub jar from Bintray to obtain the old contract.</li><li class="listitem">Configure it to use our base class (<code class="literal">io.pivotal.fortune.BaseClass</code>) to generate tests (we use the same one as in the prior step).</li><li class="listitem">Configure it to place auto-generated tests in the <code class="literal">io.pivotal.fortune.contracttests</code> test package.</li></ul></div><p>Note that the package of the contract tests matches the <code class="literal">include</code> filter in the <code class="literal">apicompatibility</code> profile, so these tests run against the app during the the API compatibility check during the <code class="literal">build-and-upload</code> job. For <code class="literal">fortune-service</code>, this serves to validate that the app conforms to the old contract.</p><p>The following listing shows the complete profile:</p><div class="informalexample"><pre class="programlisting">    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;profile&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;id&gt;</span>apicompatibility<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/id&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;build&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugins&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;includes&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Tests.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;include&gt;</span>**/contracttests/**/*Test.java<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/include&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/includes&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Spring Cloud Contract maven plugin --&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;plugin&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${spring-cloud-contract.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;extensions&gt;</span>true<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/extensions&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;configuration&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsRepositoryUrl&gt;</span>${repo.with.binaries}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsRepositoryUrl&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractDependency&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>${project.groupId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>${project.artifactId}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;classifier&gt;</span>stubs<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/classifier&gt;</span>
                <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;version&gt;</span>${latest.production.version}<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/version&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractDependency&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;contractsPath&gt;</span>/<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/contractsPath&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;baseClassForTests&gt;</span>io.pivotal.fortune.BaseClass<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/baseClassForTests&gt;</span>
              <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;basePackageForTests&gt;</span>io.pivotal.fortune.contracttests<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/basePackageForTests&gt;</span>
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/configuration&gt;</span>
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugin&gt;</span>
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/plugins&gt;</span>
      <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/build&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/profile&gt;</span></pre></div><p>Spring Cloud Pipelines dynamically injects the values for <code class="literal">${repo.with.binaries}</code> and <code class="literal">${latest.production.version}</code>. You can run this locally by providing these values manually as system properties in the Maven command.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_5_push_changes_to_github" href="#_3_5_push_changes_to_github"></a>3.5 Push Changes to GitHub</h4></div></div></div><p>All changes in Stage Three thus far are in <code class="literal">fortune-service</code>. At this point, you should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">src/test/resources/contracts/greeting-ui/shouldReturnAFortune.groovy</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/fortune/BaseClass.java</code></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_6_re_run_the_literal_fortune_service_literal_pipeline" href="#_3_6_re_run_the_literal_fortune_service_literal_pipeline"></a>3.6 Re-run the <code class="literal">fortune-service</code> Pipeline</h4></div></div></div><p>Run through the <code class="literal">fortune-service</code> pipeline to generate stubs. The following output from the <code class="literal">build-and-upload</code> job shows the auto-generation of tests and stubs:</p><div class="figure"><a name="d0e3718" href="#d0e3718"></a><p class="title"><b>Figure&nbsp;6.17.&nbsp;fortune-service build-and-upload Test and Stub Generation</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/fortune_service_build_and_upload_test_and_stub_generation.png" alt="fortune service build and upload test and stub generation"></div></div></div><br class="figure-break"><p>You should also see output in the <code class="literal">build-and-upload</code> job that shows the execution of these tests against the code.</p><p>Additionally, you should see the stub jar uploaded to Bintray along with the usual app jar.</p><p>Finally, as you run through the pipeline a second time, you should see that the contract tests from the latest prod version run against the new code in the output of the the API compatibility check during the <code class="literal">build-and-upload</code> job. In this case, there is no API change. Nonetheless, the tests confirm that the latest prod version of the API can be used with the current code base.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_7_enable_stubs_for_integration_tests" href="#_3_7_enable_stubs_for_integration_tests"></a>3.7 Enable Stubs for Integration Tests</h4></div></div></div><p>Now we turn our attention to <code class="literal">greeting-ui</code>.</p><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the build phase, both with and without stubs:</p><div class="figure"><a name="d0e3752" href="#d0e3752"></a><p class="title"><b>Figure&nbsp;6.18.&nbsp;greeting-ui Build Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_build_flow.png" alt="greeting ui build flow"></div></div></div><br class="figure-break"><p>Without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract. In this case, the stubs are loaded into the <code class="literal">greeting-ui</code> process. This leads us to our next task: Loading the stubs produced by <code class="literal">fortune-service</code>.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_enable_the_in_process_stub_runner" href="#_enable_the_in_process_stub_runner"></a>Enable the in-process Stub Runner</h5></div></div></div><p>To load the stubs into the <code class="literal">greeting-ui</code> process, we must enable the Spring Cloud Contract Stub Runner dependency. This dependency start ans in-process stub runner that automatically configures Wiremock.</p><p>Add the following dependency to the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-starter-contract-stub-runner<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
 <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;scope&gt;</span>test<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/scope&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_add_integration_tests_aligned_with_the_contract" href="#_add_integration_tests_aligned_with_the_contract"></a>Add Integration Tests Aligned with the Contract</h5></div></div></div><p>Next, we add integration tests to <code class="literal">greeting-ui</code> to test for the expected response declared in the contract.</p><p>Add the following class to the <code class="literal">test</code> package in <code class="literal">greeting-ui</code>:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> io.pivotal.fortune;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> io.pivotal.GreetingUIApplication;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.cloud.contract.stubrunner.spring.AutoConfigureStubRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = GreetingUIApplication.class, webEnvironment = SpringBootTest.WebEnvironment.NONE,
        properties = {"spring.application.name=greeting-ui", "spring.cloud.circuit.breaker.enabled=false", "hystrix.stream.queue.enabled=false"})</span></em>
<em><span class="hl-annotation" style="color: gray">@AutoConfigureStubRunner(ids = {"io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION"},
        repositoryRoot = "${REPO_WITH_BINARIES}"
        //workOffline = true
)</span></em>

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> FortuneServiceTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> FortuneService fortuneService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> shouldSendRequestToFortune() {
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// when</span>
        String fortune = fortuneService.getFortune();
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// then</span>
        BDDAssertions.then(fortune).isEqualTo(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"foo fortune"</span>);
    }

}</pre></div><p>At this point, we can get through the build phase for <code class="literal">greeting-ui</code>, and the integration tests run against the <code class="literal">fortune-service</code> stubs that runs in the <code class="literal">greeting-ui</code> process on the Concourse worker.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Notice the configuration of <code class="literal">@AutoConfigureStubRunner</code>. You can replace the version with a <code class="literal">+</code> sign if using Artifactory or Nexus and it automatically chooses the latest available version on the maven repo.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Setting <code class="literal">workOffline=true</code> (commented out but shown earlier for informational purposes) would make the stub runner get the stubs from the local Maven repository. This is useful for local testing. Alternatively, set the <code class="literal">$REPO_WITH_BINARIES</code> environment variable to the value used in the credentials file before doing a local Maven build. Then the local build will download the stubs from your remote Maven repository (for example, Bintray).</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_8_enable_stubs_for_smoke_tests" href="#_3_8_enable_stubs_for_smoke_tests"></a>3.8 Enable Stubs for Smoke Tests</h4></div></div></div><p>The following image compares the path of a request through <code class="literal">greeting-ui</code> in the test phase, both with and without stubs. Note that in the build phase, where the app process runS on the Concourse worker, we ran the stubs in the same process. In the test environment (Cloud Foundry), we run the stubs in a separate process by using a standalone stub runner application. The following image shows the test flow for the <code class="literal">greeting-ui</code> application:</p><div class="figure"><a name="d0e3850" href="#d0e3850"></a><p class="title"><b>Figure&nbsp;6.19.&nbsp;greeting-ui Test Flow</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_test_flow.png" alt="greeting ui test flow"></div></div></div><br class="figure-break"><p>As in the build phase, without stubs, we expect the response to be the Hystrix fallback response that is hard-coded in <code class="literal">greeting-ui</code>. With stubs, however, we can expect the response that was declared in the contract.</p><p>We rely on Spring Cloud Pipelines to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Deploy a stub runner application.</li><li class="listitem">Provide the stub runner application with the necessary information to download the stubs.</li><li class="listitem">Open a port on the stub runner application for each stub.</li></ul></div><p>We rely on the stub runner application to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Download the stubs from our Maven repository (Bintray).</li><li class="listitem">Expose each stub on a separate port.</li><li class="listitem">Register each stub in the Service Discovery server.</li></ul></div><p>The following steps describe how to configure stubs for smoke tests.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_a_stand_alone_stub_runner_app_jar" href="#_provide_a_stand_alone_stub_runner_app_jar"></a>Provide a Stand-alone Stub Runner App Jar</h5></div></div></div><p>In the <a class="link" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-prep" title="6.7.1&nbsp;Prep: Before you begin">Prep step</a> for this tutorial, you cloned the <a class="link" href="https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot" target="_top"><code class="literal">cloudfoundry-stub-runner-boot</code></a> repo to your local machine. The next step is to build this application and upload it to Bintray to make the jar available to Spring Cloud Pipelines.</p><p>As mentioned in <a class="xref" href="multi__step_by_step_cloud_foundry_migration.html#tutorial-stage-one" title="6.7.2&nbsp;Stage One: Scaffolding">Section&nbsp;6.7.2, &#8220;Stage One: Scaffolding&#8221;</a> of this tutorial, Bintray requires that a package exist before any application artifacts can be uploaded. Log into the Bintray UI and create a package for <code class="literal">cloudfoundry-stub-runner-boot</code>. If you forked this repo, you can use the <code class="literal">Import from GitHub</code> option. Otherwise, create the package manually and choose any license (for example, Apache 2.0).</p><p>Now you are ready to build and upload this app to Bintray. Edit the following script (which shows cloning, building, and uploading) to match your Bintray URL, the Bintray ID in your <code class="literal">~/.m2/settings/xml</code> file, and the <code class="literal">cloudfoundry-stub-runner-boot</code> repository URL (if you chose to fork it):</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Edit to match your Bintray URL and M2 repo ID setting (check your ~/.m2/settings.xml file)</span>
MAVEN_REPO_URL=https://api.bintray.com/maven/ciberkleid/maven-repo/cloudfoundry-stub-runner-boot
MAVEN_REPO_ID=bintray

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Clone cloudfoundry-stub-runner-boot</span>
git clone https://github.com/spring-cloud-samples/cloudfoundry-stub-runner-boot.git
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">cd</span> cloudfoundry-stub-runner-boot

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment"># Build and upload</span>
./mvnw clean deploy -Ddistribution.management.release.url=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_URL}"</span> -Ddistribution.management.release.id=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"${MAVEN_REPO_ID}"</span></pre></div><p>You should now see the <code class="literal">cloudfoundry-stub-runner-boot</code> artifacts uploaded on Bintray.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_stand_alone_stub_runner_application_manifest" href="#_provide_stand_alone_stub_runner_application_manifest"></a>Provide Stand-alone Stub Runner Application Manifest</h5></div></div></div><p>Next, we add a manifest file for the stub runner application for deployment to Cloud Foundry.</p><p>Place this file in the <code class="literal">greeting-ui</code> repo. The file name and location can be your choice. For this example, we use <code class="literal">sc-pipelines/manifest-stubrunner.yml</code>. The following image shows the file in the appropriate folder:</p><div class="figure"><a name="d0e3941" href="#d0e3941"></a><p class="title"><b>Figure&nbsp;6.20.&nbsp;greeting-ui Stub Runner Manifest</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stubrunner_manifest.png" alt="greeting ui stubrunner manifest"></div></div></div><br class="figure-break"><p>We populate this <code class="literal">manifest-stubrunner.yml</code> with the content shown in the next listing so that the stub runner binds to <code class="literal">service-registry</code>. The stub runner registers the <code class="literal">fortune-service</code> stub there so that <code class="literal">greeting-ui</code> can discover it in the same way it discovers the actual <code class="literal">fortune-service</code> app endpoint in stage and prod. From the <code class="literal">greeting-ui</code> perspective, there is no difference in how it interacts with Eureka and the stub runner application in test and the way it interacts with Eureka and the <code class="literal">fortune-service</code> application in stage and prod. The following listing shows the content of <code class="literal">manifest-stubrunner.yml</code>:</p><div class="informalexample"><pre class="programlisting">---
applications:
- name: stubrunner
  timeout: 120
  services:
  - service-registry
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    TRUST_CERTS: api.run.pivotal.io
----</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_a_stub_runner_jar_and_manifest_information_to_the_pipeline" href="#_provide_a_stub_runner_jar_and_manifest_information_to_the_pipeline"></a>Provide a Stub Runner Jar and Manifest Information to the Pipeline</h5></div></div></div><p>Now that we have a jar file and a manifest file for our stub runner application, we need to provide this information to our <code class="literal">greeting-ui</code> pipeline so that the pipeline downloads the jar from Bintray and deploys it to Cloud Foundry. We do this through the <code class="literal">greeting-ui</code> <code class="literal">sc-pipelines.yml</code> file. We add an entry to the list of services in the <code class="literal">test</code> section, as follows:</p><div class="informalexample"><pre class="programlisting">    - name: stubrunner
      type: stubrunner
      coordinates: io.pivotal:cloudfoundry-stub-runner-boot:0.0.1.M1
      pathToManifest: sc-pipelines/manifest-stubrunner.yml</pre></div><p>Notice that <code class="literal">name</code> matches the name of the application in <code class="literal">manifest-stubrunner.yml</code>, <code class="literal">coordinates</code> corresponds to the jar coordinates of the Maven repository, and <code class="literal">pathToManifest</code> matches our chosen fie name for the stub runner application manifest.</p><p>Note also the <code class="literal">type</code> is set to <code class="literal">stubrunner</code>, which Spring Cloud Pipelines will recognize as a stanalone stub runner app and treat accordingly.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_provide_stub_configuration_for_the_stub_runner_application" href="#_provide_stub_configuration_for_the_stub_runner_application"></a>Provide Stub Configuration for the Stub Runner Application</h5></div></div></div><p>The final steps in the configuration of the stand-alone stub runner app are as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Enable the stub runner app to download the <code class="literal">fortune-service</code> stub from Bintray.</li><li class="listitem">Open a second port on the container to receive requests for this stub.</li></ul></div><p>To accomplish this, we put stub and port configuration information into the properties section of the <code class="literal">greeting-ui</code> <code class="literal">pom.xml</code> file, by using a property called <code class="literal">stubrunner.ids</code>. This property can accept a list of stubrunner IDs. However, for this tutorial, we only have one, as follows:</p><div class="informalexample"><pre class="programlisting">  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;properties&gt;</span>
...
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">&lt;!--Tell stub runner app to start this stub--&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;stubrunner.ids&gt;</span>io.pivotal:fortune-service:1.0.0.M1-20180102_203542-VERSION:stubs:10000<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/stubrunner.ids&gt;</span>
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/properties&gt;</span></pre></div><p>Spring Cloud Pipelines uses this information in two ways:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">It provides this information to the stub runner application through the application&#8217;s environment variables.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Spring Cloud Pipelines also provides the <code class="literal">$REPO_WITH_BINARIES</code> as an environment variable for the stub runner application.</li><li class="listitem">The stub runner application uses this information to download the stub from Bintray and expose it on the specified port.</li></ul></div></li><li class="listitem"><p class="simpara">It opens the additional port specified on the stub runner app and map a new route to it.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">The format for each route is <code class="literal">&lt;stub-runner-app-name&gt;-&lt;hostname-uuid&gt;-&lt;env&gt;-&lt;app-name&gt;-&lt;port&gt;.&lt;domain&gt;</code>.</li><li class="listitem">In our example, this would be <code class="literal">stubrunner-cyi-test-greeting-ui-10000.cfapps.io</code>.</li></ul></div></li></ul></div><p>Since we bound our stub runner application to <code class="literal">service-registry</code> (Eureka), the stub runner application registers the stub URL under the <code class="literal">FORTUNE-SERVICE</code> application name on Eureka, as the following image shows:</p><div class="figure"><a name="d0e4090" href="#d0e4090"></a><p class="title"><b>Figure&nbsp;6.21.&nbsp;greeting-ui Stub Runner Eureka Registration</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/cf-migration/greeting_ui_stub_runner_eureka_registration.png" alt="greeting ui stub runner eureka registration"></div></div></div><br class="figure-break"><p>This completes the process of configuring the stand-alone stub runner application.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>You can automate the port configuration by Spring Cloud Pipelines in the future such that you need not include the port in <code class="literal">stubrunner.ids</code>. However, for the moment, we are required to specify the port each stub should use.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_edit_smoke_tests_to_align_with_the_contract" href="#_edit_smoke_tests_to_align_with_the_contract"></a>Edit Smoke Tests to Align with the Contract</h5></div></div></div><p>Finally, we edit our smoke tests for <code class="literal">greeting-ui</code> to ensure the response does not contain the Hystrix fallback, since we are now expecting a response from the stub. The following listing shows the edited smoke tests:</p><div class="informalexample"><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">package</span> smoke;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.assertj.core.api.BDDAssertions;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.Test;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.junit.runner.RunWith;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.http.ResponseEntity;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">import</span> org.springframework.web.client.RestTemplate;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringBootTest(classes = SmokeTests.class,
        webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableAutoConfiguration</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span> SmokeTests {

	<em><span class="hl-annotation" style="color: gray">@Value("${application.url}")</span></em> String applicationUrl;

	RestTemplate restTemplate = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> RestTemplate();

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> should_return_a_fortune() {
		ResponseEntity&lt;String&gt; response = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.restTemplate
				.getForEntity(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"http://"</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">this</span>.applicationUrl + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"/"</span>, String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);

		BDDAssertions.then(response.getStatusCodeValue()).isEqualTo(<span class="hl-number">200</span>);

		<span xmlns:d="http://docbook.org/ns/docbook" class="hl-comment">// Filter out the known Hystrix fallback response</span>
		BDDAssertions.then(response.getBody()).doesNotContain(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"This fortune is no good. Try another."</span>);
	}

}</pre></div><p>In this case, in contrast to the integration test we created earlier for <code class="literal">greeting-ui</code>, we do not include <code class="literal">@AutoConfigureStubRunner</code>, because we are using a standalone stub runner application.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_3_9_push_changes_to_github" href="#_3_9_push_changes_to_github"></a>3.9 Push Changes to GitHub</h4></div></div></div><p>Push contract-based changes for <code class="literal">greeting-ui</code>. You should be pushing the following new or modified files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">pom.xml</code></li><li class="listitem"><code class="literal">sc-pipelines.yml</code></li><li class="listitem"><code class="literal">sc-pipelines/manifest-stubrunner.yml</code></li><li class="listitem"><code class="literal">src/test/java/io/pivotal/fortune/FortuneServiceTests.java</code></li><li class="listitem"><code class="literal">src/test/java/smoke/SmokeTests.java</code></li></ul></div><p>At this point, we can run through the full pipeline for <code class="literal">greeting-ui</code> and leverage the contract-based stub in both the build and test environments.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stage_three_recap" href="#_stage_three_recap"></a>Stage Three Recap</h4></div></div></div><p>What have we accomplished?</p><p>By implementing a contract-driven approach with auto-generation of tests and stubs, we have introduced a clean, structured, and reliable way to define, communicate, document, manage, and test APIs. The benefits include the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Inter-team communication can be simpler.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Consumer and producer teams can now communicate requirements through coded contracts.</li><li class="listitem">The inventory of contracts serves as a record and reference of the agreed-upon APIs.</li></ul></div></li><li class="listitem"><p class="simpara">Developer productivity will increase.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Producers can quickly and easily generate contract-based stubs.</li><li class="listitem">Consumers no longer have to manually stub out APIs and write tests with arbitrary hard-coded responses. Instead, they can use the auto-generated stubs and test for contract-based responses.</li><li class="listitem">Both producers and consumers can validate their code complies with the contract.</li><li class="listitem">Producers can verify backward compatibility of API changes.</li><li class="listitem">Troubleshooting will be easier.</li><li class="listitem">Failure and feedback will be faster.</li></ul></div></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_conclusion" href="#_conclusion"></a>6.8&nbsp;Conclusion</h2></div></div></div><p>This concludes the tutorial on migrating apps for Spring Cloud Pipelines for Cloud Foundry.</p><p>Moving forward, the refactoring work shown here can be incorporated into your and your team&#8217;s standard practices. We recommend the following practices:</p><p><span class="strong"><strong>Good:</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use Maven or Gradle wrappers.</li><li class="listitem">Include a Cloud Foundry manifest file in your application repository.</li><li class="listitem">Include a pipeline descriptor (<code class="literal">sc-manifest.yml</code>) in your app repository.</li><li class="listitem">Create an empty <code class="literal">version</code> branch in your application repository.</li><li class="listitem">Include artifact repository configuration in the <code class="literal">pom.xml</code> file.</li><li class="listitem">Align your Cloud Foundry spaces with the Spring Cloud Pipelines model (isolated test space and shared stage and prod spaces).</li></ul></div><p><span class="strong"><strong>Better</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Include <code class="literal">default</code>, <code class="literal">apicompatibility</code>, <code class="literal">smoke</code>, and <code class="literal">e2e</code> profiles in the <code class="literal">pom.xml</code> file.</li><li class="listitem">Organize tests accordingly in your application repository.</li></ul></div><p><span class="strong"><strong>Best</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Use a database migration tool, such as Flyway.</li><li class="listitem">Use contract-based API programming.</li></ul></div><p>Implementing all the <span class="strong"><strong>&#8220;good&#8221;</strong></span> practices positions you to instantly create pipelines for your applications by using Spring Cloud Pipelines. This is a huge win in terms of consistency and productivity and standardization across development teams. Of course, this is an open source project, so you can modify it to meet your needs.</p><p>Implementing the <span class="strong"><strong>&#8220;better&#8221;</strong></span> practices ensures the proper tests get run at the proper time. At that point, you can add as much test coverage as you need to have high confidence in your pipelines.</p><p>Implementing the <span class="strong"><strong>&#8220;best&#8221;</strong></span> practices gives you additional confidence in your pipeline and encourages better programming practices for database version and API management across development teams. It also gives you higher confidence in your pipelines and lets you avoid the cumbersome business of rolling back a database.</p><p>Happy coding!</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi__customizing_the_project.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="multi__spring_cloud_pipelines.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi_concourse-pipeline-cf.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.&nbsp;Customizing the Project&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-pipelines.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;7.&nbsp;Concourse Pipeline (Cloud Foundry)</td></tr></table></div></body></html>