<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>1.&nbsp;The opinionated pipeline</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="up" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="prev" href="multi_pr01.html" title=""><link rel="next" href="multi__introduction.html" title="2.&nbsp;Introduction"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">1.&nbsp;The opinionated pipeline</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi_pr01.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__introduction.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_opinionated_pipeline" href="#_the_opinionated_pipeline"></a>1.&nbsp;The opinionated pipeline</h1></div></div></div><p>This repo contains an <span class="strong"><strong>opinionated pipeline</strong></span> to deploy a Spring Cloud based microservice.
We&#8217;ve taken the following opinionated decisions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">application built using Maven or Gradle wrappers</li><li class="listitem">application deployment to Cloud Foundry</li><li class="listitem"><p class="simpara">For Maven:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Maven Wrapper</li><li class="listitem">artifacts deployment by <code class="literal">./mvnw clean deploy</code></li><li class="listitem"><code class="literal">stubrunner.ids</code> property to retrieve list of collaborators for which stubs should be downloaded</li><li class="listitem"><code class="literal">repo.with.binaries</code> - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">distribution.management.release.id</code> - (Injected by the pipeline) ID of the distribution management. Corresponds to server id in <code class="literal">settings.xml</code></li><li class="listitem"><code class="literal">distribution.management.release.url</code> - (Injected by the pipeline) Will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apicompatibility</code> Maven profile</li><li class="listitem"><code class="literal">latest.production.version</code> - (Injected by the pipeline) will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> Maven profile</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> Maven profile</li></ul></div></li><li class="listitem"><p class="simpara">For Gradle (in the <code class="literal">github-analytics</code> application check the <code class="literal">gradle/pipeline.gradle</code> file):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">usage of Gradlew Wrapper</li><li class="listitem"><code class="literal">deploy</code> task for artifacts deployment</li><li class="listitem"><code class="literal">REPO_WITH_BINARIES</code> - (Injected by the pipeline) will contain the URL to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_USERNAME</code> - (Injected by the pipeline) Username used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem"><code class="literal">M2_SETTINGS_REPO_PASSWORD</code> - (Injected by the pipeline) Password used to send the binary to the repo containing binaries (e.g. Artifactory)</li><li class="listitem">running API compatibility tests via the <code class="literal">apiCompatibility</code> task</li><li class="listitem"><code class="literal">latestProductionVersion</code> - (Injected by the pipeline) property will contain the latest production version for the repo (retrieved from Git tags)</li><li class="listitem">running smoke tests on a deployed app via the <code class="literal">smoke</code> task</li><li class="listitem">running end to end tests on a deployed app via the <code class="literal">e2e</code> task</li><li class="listitem"><code class="literal">groupId</code> task to retrieve group id</li><li class="listitem"><code class="literal">artifactId</code> task to retrieve artifact id</li><li class="listitem"><code class="literal">currentVersion</code> task to retrieve the current version</li><li class="listitem"><code class="literal">stubIds</code> task to retrieve list of collaborators for which stubs should be downloaded</li></ul></div></li></ul></div><p>This is the initial approach that can be easily changed since all the core
deployment logic is done in a form of Bash scripts.</p><p>You can go through the setup of the demo environment for</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="multi_concourse.html" title="3.&nbsp;Concourse Pipeline">Concourse</a></li><li class="listitem"><a class="link" href="multi__jenkins_dsl_pipeline.html#jenkins">Jenkins using Jenkins Job DSL plugin</a></li></ul></div><p>Each of these setups are available under the folders <code class="literal">jenkins</code> and
<code class="literal">concourse</code> respectively.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_ci_server_worker_prerequisites" href="#_ci_server_worker_prerequisites"></a>1.1&nbsp;CI Server worker prerequisites</h2></div></div></div><p>Spring Cloud Pipelines uses Bash scripts extensively. Below you can find the list of software
that needs to be installed on a CI server worker for the build to pass</p><pre class="programlisting"> apt-get -y install \
    bash \
    git \
    tar \
    zip \
    curl \
    ruby \
    wget \
    unzip \
    python \
    jq</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_pipeline_descriptor" href="#_pipeline_descriptor"></a>1.2&nbsp;Pipeline descriptor</h2></div></div></div><p>Each application can contain a file called <code class="literal">sc-pipelines.yml</code> with the following structure:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName1</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service1Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service1Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service2Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service2Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">lowercaseEnvironmentName2</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service3Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service3Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          coordinates</span>: value
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">        - type</span>: service4Type
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          name</span>: service4Name
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">          key</span>: value</pre><p>For a given environment we declare a list of infrastructure services that we
want to have deployed. Services have</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">type</code> (example: <code class="literal">eureka</code>, <code class="literal">mysql</code>, <code class="literal">rabbitmq</code>, <code class="literal">stubrunner</code>) - this value gets
then applied to the <code class="literal">deployService</code> Bash function</li><li class="listitem"><code class="literal">name</code> - name of the service to get deployed</li><li class="listitem"><code class="literal">coordinates</code> - coordinate that allows you to fetch the binary of the service.
Examples: It can be a maven coordinate <code class="literal">groupid:artifactid:version</code>,
 docker image <code class="literal">organization/nameOfImage</code>, etc.</li><li class="listitem">arbitrary key value pairs - you can customize the services as you wish</li></ul></div><p>The <code class="literal">stubrunner</code> type can also have the <code class="literal">useClasspath</code> flag turned on to <code class="literal">true</code>
or <code class="literal">false</code>.</p><p>Example:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">test</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: rabbitmq
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: rabbitmq-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: mysql
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: mysql-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: eureka-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-eureka:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: stubrunner
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: stubrunner-github-webhook
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-analytics-stub-runner-boot-classpath-stubs:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      useClasspath</span>: <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">true</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">stage</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">  services</span>:
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: rabbitmq
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: rabbitmq-github
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: mysql
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: mysql-github
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">    - type</span>: eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      name</span>: github-eureka
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-attribute">      coordinates</span>: com.example.eureka:github-eureka:<span class="hl-number">0.0</span>.<span class="hl-number">1.</span>M1</pre><p>When the deployment to test or deployment to stage occurs, Spring Cloud Pipelines
will:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">for <code class="literal">test</code> environment, delete existing services and redeploy the ones from the list</li><li class="listitem">for <code class="literal">stage</code> environment, if the service is not available it will get deployed. Otherwise
nothing will happen</li></ul></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi_pr01.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__introduction.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-pipelines.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;2.&nbsp;Introduction</td></tr></table></div></body></html>